<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Quiz - Android Audio Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1c2c; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .container {
            background: white; border-radius: 20px; padding: 20px;
            max-width: 500px; width: 100%; text-align: center;
        }
        .target-char { font-size: 100px; font-weight: bold; color: #2d3436; line-height: 1.1; }
        
        .debug-panel {
            background: #222; color: #0f0; font-family: monospace;
            padding: 10px; border-radius: 8px; margin: 15px 0; font-size: 13px;
            text-align: left; border-left: 4px solid #444;
        }
        .bar-container { 
            background: #444; height: 10px; border-radius: 5px; 
            margin-top: 5px; overflow: hidden; 
        }
        .bar-fill { 
            background: #0f0; height: 100%; width: 0%; 
            transition: width 0.1s; 
        }
        .energy-bar { background: #ff0; }

        /* FFT Debug Visualizer */
        .fft-debug {
            background: #000; padding: 10px; border-radius: 8px;
            margin-top: 10px;
        }
        .fft-canvas {
            width: 100%; height: 120px; background: #111;
            border-radius: 5px;
        }

        canvas { 
            width: 100%; height: 60px; background: #f8f9fa; 
            border-radius: 8px; margin-top: 10px; 
        }

        .status { 
            padding: 12px; border-radius: 10px; margin: 10px 0; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; font-size: 12px; }
        
        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn-main { background: #667eea; color: white; }
        .btn-secondary { background: #eee; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; font-weight: bold;">
        <span>Score: <span id="score">0</span></span>
        <span>Question: <span id="qCount">0</span></span>
    </div>

    <div id="targetDisplay" class="target-char">?</div>
    
    <div class="debug-panel">
        <div>ðŸŽ¯ DÃ©tectÃ© : <span id="bestLabel">---</span></div>
        <div id="bestScoreText">Confiance : 0%</div>
        <div class="bar-container"><div id="scoreBar" class="bar-fill"></div></div>
        <div style="margin-top: 8px;">ðŸ”Š Ã‰nergie : <span id="energyLevel">0%</span></div>
        <div class="bar-container"><div id="energyBar" class="bar-fill energy-bar"></div></div>
        <div style="margin-top: 8px; color: #888;">
            Sample Rate: <span id="sampleRate">?</span> Hz
        </div>
    </div>

    <!-- FFT Spectrum Visualizer -->
    <div class="fft-debug">
        <div style="color: #0f0; font-family: monospace; font-size: 11px; margin-bottom: 5px;">
            ðŸ“Š Spectre FFT (Debug Android)
        </div>
        <canvas id="fftCanvas" class="fft-canvas"></canvas>
    </div>

    <div id="status" class="status info">
        Chargement... Ce mode affiche le spectre FFT pour diagnostiquer Android.
    </div>

    <canvas id="vizCanvas"></canvas>

    <button id="actionBtn" class="btn-main" disabled>DÃ‰MARRER</button>
    <button id="skipBtn" class="btn-secondary" style="display:none">PASSER Ã€ LA SUIVANTE</button>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/";
    const HIRAGANAS = ['ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ'];

    let recognizer, analyser, dataArray, freqArray, animationId;
    let currentTarget = "", score = 0, questionCount = 0, currentAudioEnergy = 0;
    let audioContext;

    const ENERGY_THRESHOLD = 0.006; // Ton rÃ©glage optimal
    const MIN_CONFIDENCE = 0.3;

    async function init() {
        try {
            recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Sensei prÃªt ! Mode diagnostic Android activÃ©.";
            document.getElementById('actionBtn').disabled = false;
        } catch (e) { 
            document.getElementById('status').innerText = "Erreur chargement."; 
            console.error(e);
        }
    }

    async function startQuiz() {
        document.getElementById('actionBtn').style.display = "none";
        document.getElementById('skipBtn').style.display = "block";
        
        // ðŸ”¥ FIX ANDROID : Contraintes audio STRICTES
        const constraints = {
            audio: {
                echoCancellation: false,        // DÃ‰SACTIVÃ‰ pour Android
                noiseSuppression: false,        // DÃ‰SACTIVÃ‰ pour Android
                autoGainControl: false,         // DÃ‰SACTIVÃ‰
                sampleRate: { ideal: 44100 },   // ðŸ”¥ FORCER 44.1kHz
                channelCount: { ideal: 1 }      // Mono
            }
        };
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // ðŸ”¥ FORCER le sample rate dans l'AudioContext
            audioContext = new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: 44100  // CRITIQUE pour Android
            });
            
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.7; // LÃ©gÃ¨rement rÃ©duit
            source.connect(analyser);
            
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            freqArray = new Uint8Array(analyser.frequencyBinCount);
            
            // Afficher le sample rate rÃ©el
            document.getElementById('sampleRate').innerText = audioContext.sampleRate;
            
            draw();

            await recognizer.listen(result => {
                const labels = recognizer.wordLabels();
                let maxScore = 0, winner = "";

                for (let i = 0; i < labels.length; i++) {
                    if (result.scores[i] > maxScore) {
                        maxScore = result.scores[i];
                        winner = labels[i];
                    }
                }

                // Anti-hallucination simple
                if (currentAudioEnergy < ENERGY_THRESHOLD) {
                    document.getElementById('bestLabel').innerText = "ðŸš« Silence";
                    document.getElementById('bestScoreText').innerText = "Confiance : 0%";
                    document.getElementById('scoreBar').style.width = "0%";
                    return;
                }

                document.getElementById('bestLabel').innerText = winner;
                const pct = Math.round(maxScore * 100);
                document.getElementById('bestScoreText').innerText = `Confiance : ${pct}%`;
                document.getElementById('scoreBar').style.width = pct + "%";

                if (winner === currentTarget && maxScore > MIN_CONFIDENCE) {
                    handleWin();
                }
            }, { 
                probabilityThreshold: 0.6,  // RÃ©duit pour Android
                overlapFactor: 0.5 
            });

            nextQuestion();
            
        } catch (err) {
            alert("Erreur accÃ¨s micro : " + err.message);
            console.error(err);
        }
    }

    function nextQuestion() {
        questionCount++;
        document.getElementById('qCount').innerText = questionCount;
        currentTarget = HIRAGANAS[Math.floor(Math.random() * HIRAGANAS.length)];
        document.getElementById('targetDisplay').innerText = currentTarget;
        document.getElementById('status').innerText = "Je vous Ã©coute...";
        document.getElementById('status').className = "status";
    }

    function handleWin() {
        score++;
        document.getElementById('score').innerText = score;
        document.getElementById('status').innerText = "BIEN VU !";
        document.getElementById('status').className = "status success";
        setTimeout(nextQuestion, 1500);
    }

    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        analyser.getByteFrequencyData(freqArray); // ðŸ”¥ RÃ©cupÃ¨re aussi les frÃ©quences
        
        // Calcul Ã©nergie
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const normalized = (dataArray[i] - 128) / 128;
            sum += normalized * normalized;
        }
        currentAudioEnergy = Math.sqrt(sum / dataArray.length);
        
        const energyPct = Math.min(100, Math.round(currentAudioEnergy * 1000));
        document.getElementById('energyLevel').innerText = energyPct + "%";
        document.getElementById('energyBar').style.width = energyPct + "%";
        
        // Oscilloscope
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = currentAudioEnergy > ENERGY_THRESHOLD ? '#667eea' : '#ccc';
        ctx.beginPath();
        const sliceWidth = canvas.width / dataArray.length;
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * canvas.height / 2;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            x += sliceWidth;
        }
        ctx.stroke();

        // ðŸ”¥ NOUVEAU : FFT Spectrum (pour dÃ©bugger Android)
        drawFFT();
    }

    function drawFFT() {
        const canvas = document.getElementById('fftCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, width, height);

        const barWidth = width / freqArray.length * 2;
        let x = 0;

        for (let i = 0; i < freqArray.length; i++) {
            const barHeight = (freqArray[i] / 255) * height;
            
            // Gradient de couleur selon frÃ©quence
            const hue = (i / freqArray.length) * 240; // Bleu â†’ Rouge
            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.fillRect(x, height - barHeight, barWidth, barHeight);
            
            x += barWidth;
        }
    }

    document.getElementById('actionBtn').onclick = startQuiz;
    document.getElementById('skipBtn').onclick = nextQuestion;
    init();
</script>
</body>
</html>
