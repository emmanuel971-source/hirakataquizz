<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <base target="_top">
  <title>Hira-Kata-Quizzz Zen</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #F8F1E9; /* Blanc cass√©, papier washi */
      font-family: 'Noto Sans JP', sans-serif;
      color: #4A4E69; /* Gris violet naturel */
      display: flex;
      flex-direction: column;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      opacity: 0.1;
      z-index: -1;
    }

    h1 {
      margin: 0.5em 0;
      font-size: 1.8em;
      text-align: center;
      color: #4A4E69;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    @media screen and (max-width: 400px),
           screen and (-webkit-min-device-pixel-ratio: 2),
           screen and (min-resolution: 192dpi) {
      h1 {
        font-size: 2.5em;
        margin: 0.3em 0;
      }
    }

    @media screen and (-webkit-min-device-pixel-ratio: 2) and (max-width: 800px) {
      h1 {
        font-size: 2em;
        margin: 0.15em 0;
      }
    }

    /* Barre de progression */
    #progressBarContainer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5em;
      margin: 1em auto 0.3em auto;
      max-width: 40ch;
      width: 100%;
    }

    .progress-bar-track {
      position: relative;
      height: 16px;
      background: linear-gradient(to right, #A3BFFA, #FDC1C5); /* Bleu c√©ramique √† rose sakura */
      border-radius: 6px;
      flex: 1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-marker {
      position: absolute;
      top: 25%;
      left: 0;
      transform: translate(-50%, -75%);
      font-size: 2em;
      transition: left 1.5s ease;
      color: #636E72; /* Gris pierre */
    }

    .side-emoji {
      font-size: 1.6em;
      line-height: 1;
      color: #636E72;
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      100% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .level {
      font-size: 1.1em;
      margin: 0.5em 0;
      color: #4A4E69;
      text-align: center;
    }

    /* Syst√®me d'√©toiles pour les hiraganas */
    .level-hiraganas {
      margin: 1em auto;
      max-width: 800px;
      flex-shrink: 0;
    }

    .hiraganas-grid {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 0.5em;
    }

    .hiragana-card {
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      padding: 10px;
      background: #FFFFFF; /* Fond blanc */
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .hiragana-card.completed {
      background: #DDE6D5; /* Vert matcha clair */
      animation: completedPulse 2s ease-in-out infinite;
    }

    @keyframes completedPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .hiragana-char {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 6px;
      color: #4A4E69;
      text-shadow: 0 0 3px rgba(74, 78, 105, 0.3);
    }

    .hiragana-card.completed .hiragana-char {
      color: #A8D5BA; /* Vert matcha */
      text-shadow: 0 0 5px rgba(168, 213, 186, 0.5);
    }

    .stars-container {
      display: flex;
      justify-content: center;
      gap: 2px;
    }

    .star {
      width: 12px;
      height: 12px;
      background: #E8ECEF; /* Gris clair */
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      transition: all 0.3s ease;
    }

    .star.filled {
      background: #FDC1C5; /* Rose sakura */
    }

    .star.new-star {
      animation: starFill 0.5s ease-in-out;
    }

    .hiragana-card.completed .star.filled {
      background: #A8D5BA; /* Vert matcha */
      animation: starGlow 2s ease-in-out infinite;
    }

    @keyframes starFill {
      0% { transform: scale(0) rotate(180deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    @keyframes starGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }

    /* Animation p√©tales de cerisier */
    .sakura {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #FDC1C5; /* Rose sakura */
      border-radius: 50%;
      pointer-events: none;
      animation: sakuraFall 3s linear forwards;
      z-index: 10;
    }

    @keyframes sakuraFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }

    /* Syst√®me d'√©toiles pour mobile/iPad */
    @media screen and (max-width: 768px), screen and (-webkit-min-device-pixel-ratio: 2) {
      .level-hiraganas {
        max-width: none;
        width: 100%;
        padding: 0 2em;
        box-sizing: border-box;
      }

      .hiraganas-grid {
        gap: 60px;
      }

      .hiragana-card {
        transform: scale(1.1);
      }

      .hiragana-char {
        font-size: 4em;
        margin-bottom: 10px;
      }

      .stars-container {
        gap: 2px;
      }

      .star {
        width: 24px;
        height: 24px;
      }
    }

    @media screen and (-webkit-min-device-pixel-ratio: 2) and (max-width: 800px) {
      .level-hiraganas {
        max-width: none;
        width: 100%;
        padding: 0 2em;
        box-sizing: border-box;
      }

      .hiraganas-grid {
        width: 100%;
        box-sizing: border-box;
        justify-content: space-evenly;
        gap: 40px;
      }

      .hiragana-char {
        font-size: 6em;
        margin-bottom: 10px;
      }

      .stars-container {
        gap: 2px;
      }

      .star {
        width: 14px;
        height: 14px;
      }
    }

    /* Zone de quiz */
    .quiz-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 0;
      padding-bottom: 2em;
    }

    .question {
      font-size: 3.5em;
      font-weight: bold;
      margin: 0.5em 0;
      height: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4A4E69;
      text-shadow: 0 0 5px rgba(74, 78, 105, 0.2);
    }

    .answers {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8em;
      margin-bottom: 1em;
    }

    @media screen and (max-width: 768px), screen and (-webkit-min-device-pixel-ratio: 2) {
      .quiz-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        min-height: 0;
        padding-bottom: 2em;
      }

      .question {
        font-size: 10em;
        margin: 0.5em 0;
        height: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 0 10px rgba(74, 78, 105, 0.2);
      }

      .answers {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.8em;
        margin-bottom: 1em;
        width: 100%;
        box-sizing: border-box;
        padding: 0 1em;
      }
    }

    /* Boutons style zen */
    .arcade-button {
      position: relative;
      background: #A3BFFA; /* Bleu c√©ramique */
      border: 1px solid #636E72;
      border-radius: 12px;
      padding: 0.8em 1.5em;
      color: #4A4E69;
      font-size: 1.4em;
      line-height: 1;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      min-width: 120px;
      text-align: center;
      pointer-events: auto;
    }

    .arcade-button:hover {
      background: #7F9CF5; /* Bleu plus vif */
      transform: translateY(-2px);
    }

    .arcade-button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .arcade-button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      pointer-events: none;
    }

    .arcade-button.clicked-glow {
      box-shadow: 0 0 10px #A8D5BA;
      animation: glowPulse 1s ease-in-out;
    }

    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 10px #A8D5BA; }
      50% { box-shadow: 0 0 15px #A8D5BA; }
    }

    @media screen and (max-width: 768px), 
           screen and (-webkit-min-device-pixel-ratio: 2), 
           screen and (min-resolution: 192dpi) {
      button, a, input, textarea {
        -webkit-tap-highlight-color: transparent;
      }

      .arcade-button {
        font-size: 4em;
        aspect-ratio: 1 / 0.6;
        width: 100%;
        box-sizing: border-box;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
    }

    /* Zone de r√©sultats */
    .result {
      animation: fadeIn 0.4s ease-in;
      font-size: 1.3em;
      line-height: 1.4em;
      margin: 0.5em auto;
      min-height: 4.5em;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #4A4E69;
      width: 100%;
      max-width: 800px;
    }

    .result-line {
      width: 100%;
      text-align: center;
    }

    .result-line.highlight {
      margin-top: 0.5em;
      font-size: 1.1em;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #continueBtn {
      margin: 1em auto;
      height: 3em;
      visibility: hidden;
      display: block;
    }

    #boutonPleinEcran, #boutonInstaller {
      margin: 0.5em auto;
      display: block;
    }

    .correct {
      background: #A8D5BA !important; /* Vert matcha */
      color: #4A4E69 !important;
      border-color: #6B8E23 !important;
      animation: correctGlow 0.6s ease-in-out;
    }

    .incorrect {
      background: #FDC1C5 !important; /* Rose sakura */
      color: #4A4E69 !important;
      border-color: #C71585 !important;
      animation: incorrectFade 0.6s ease-in-out;
    }

    @keyframes correctGlow {
      0% { box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
      50% { box-shadow: 0 0 15px #A8D5BA; }
      100% { box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    }

    @keyframes incorrectFade {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    @media screen and (max-width: 768px), 
           screen and (-webkit-min-device-pixel-ratio: 2), 
           screen and (min-resolution: 192dpi) {
      .result {
        margin-top: 5em;
        max-width: 100%;
        padding: 0 1em;
      }

      .result-line {
        font-size: 4em;
        width: 100%;
        text-align: center;
      }

      .result-line.highlight {
        margin-top: 1.2em;
        font-size: 3em;
      }

      #continueBtn {
        margin: 2em auto;
        height: 3em;
        visibility: hidden;
      }
    }

    /* Responsive optimisations */
    @media (max-width: 768px) {
      .hiraganas-grid {
        gap: 15px;
      }
      .hiragana-char {
        font-size: 1.8em;
      }
      .question {
        font-size: 2.8em;
      }
      .arcade-button {
        padding: 0.6em 1.2em;
        font-size: 1em;
      }
    }

    @media (max-height: 700px) {
      .hiragana-char {
        font-size: 1.6em;
        margin-bottom: 4px;
      }
      .question {
        font-size: 2.5em;
        margin: 0.3em 0;
      }
      .answers {
        gap: 0.6em;
        margin-bottom: 0.8em;
      }
      .arcade-button {
        padding: 0.6em 1.2em;
      }
    }

    @media (max-height: 600px) {
      .hiragana-char {
        font-size: 1.4em;
      }
      .stars-container {
        gap: 1px;
      }
      .star {
        width: 10px;
        height: 10px;
      }
      .question {
        font-size: 2.2em;
      }
      .progress-marker {
        font-size: 1.6em;
      }
      .side-emoji {
        font-size: 1.4em;
      }
    }

    @media screen and (max-width: 768px), screen and (-webkit-min-device-pixel-ratio: 2) {
      #progressBarContainer {
        max-width: 80%;
        margin: 1.5em auto 0.5em auto;
        gap: 1em;
      }

      .progress-bar-track {
        height: 32px;
        border-radius: 12px;
      }

      .progress-marker {
        font-size: 4.5em;
        top: 30%;
      }

      .side-emoji {
        font-size: 2.5em;
      }

      .level {
        font-size: 2.5em;
        margin: 0.4em 0;
      }
    }

    @media screen and (-webkit-min-device-pixel-ratio: 2) and (max-width: 800px) {
      #progressBarContainer {
        max-width: 80%;
        margin: 1.5em auto 0.5em auto;
        gap: 1em;
      }

      .progress-bar-track {
        height: 32px;
        border-radius: 12px;
      }

      .progress-marker {
        font-size: 4.5em;
        top: 30%;
      }

      .side-emoji {
        font-size: 2.5em;
      }

      .level {
        font-size: 1.5em;
        margin: 0.1em 0;
      }
    }
  </style>
</head>
<body>
  <h1>üå∏ Hira-Kata-Quizzz Zen üéç</h1>

  <div id="progressBarContainer"></div>

  <div class="level" id="levelDisplay">Niveau actuel : 1</div>

  <div class="level-hiraganas">
    <div class="hiraganas-grid" id="hiraganaCards"></div>
  </div>

  <div class="quiz-container">
    <div class="question" id="question">load...</div>
    <div>
      <div class="answers" id="choices1"></div>
      <div class="answers" id="choices2"></div>
    </div>
    <div>
      <div class="result" id="result"></div>
      <button class="arcade-button" id="continueBtn" onclick="nextQuestion()">üåø Continuer</button>
      <button class="arcade-button" id="boutonPleinEcran">Plein √©cran</button>
      <button class="arcade-button" id="boutonInstaller" style="display: none;">Ajouter √† l'√©cran d'accueil</button>
    </div>
  </div>

  <script>
    let HiraganaList = [];
    let current = {};
    let selections = { first: null, second: null };
    let targetFields = [];
    let isAnswered = false;
    let niveauActif = 1;
    let previousValidationStates = new Map();
    let activeSparks = [];
    let globalParticleCount = 0;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

    function logError(msg) {
      console.warn(msg);
    }

    function triggerSakuraFall(container) {
      console.log('Triggering sakura fall');
      for (let i = 0; i < 20; i++) {
        const sakura = document.createElement("div");
        sakura.className = "sakura";
        sakura.style.left = Math.random() * 100 + "vw";
        sakura.style.top = "-10px";
        sakura.style.animationDelay = Math.random() + "s";
        document.body.appendChild(sakura);
        setTimeout(() => sakura.remove(), 4000);
      }
    }

    // Audio (volume r√©duit pour ambiance zen)
    let audioContext;
    let audioInitialized = false;

    function initAudio() {
      try {
        if (!audioInitialized) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          audioInitialized = true;
        }
      } catch (error) {
        console.error("Erreur lors de l'initialisation audio:", error.message);
      }
    }

    function getValidatedCountForLevel(level) {
      return HiraganaList.filter(h => parseInt(h.Niveau) === level && parseInt(h.Validation) >= 5).length;
    }

    function playMarioCoin() {
      initAudio();
      const notes = [659.25, 1046.50];
      const durations = [0.1, 0.2];
      notes.forEach((freq, i) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.05, audioContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + durations[i]);
          osc.start();
          osc.stop(audioContext.currentTime + durations[i]);
        }, i * 100);
      });
    }

    function playSuccess90s() {
      initAudio();
      const baseFreq = 587.33;
      const osc1 = audioContext.createOscillator();
      const gain1 = audioContext.createGain();
      const osc2 = audioContext.createOscillator();
      const gain2 = audioContext.createGain();
      osc1.connect(gain1);
      osc2.connect(gain2);
      gain1.connect(audioContext.destination);
      gain2.connect(audioContext.destination);
      osc1.type = 'sine';
      osc2.type = 'sine';
      osc1.frequency.value = baseFreq;
      osc2.frequency.setValueAtTime(baseFreq * 1.5, audioContext.currentTime);
      osc2.frequency.exponentialRampToValueAtTime(baseFreq * 3, audioContext.currentTime + 0.3);
      gain1.gain.setValueAtTime(0.03, audioContext.currentTime);
      gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      gain2.gain.setValueAtTime(0.01, audioContext.currentTime);
      gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      osc1.start();
      osc2.start();
      osc1.stop(audioContext.currentTime + 0.4);
      osc2.stop(audioContext.currentTime + 0.3);
    }

    function playFail() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.04, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.4);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.4);
    }

    function playFireworkSound() {
      if (!audioInitialized) initAudio();
      try {
        const frequencies = [329.63, 415.30, 523.25, 659.25];
        frequencies.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'triangle';
            osc.frequency.value = freq;
            filter.type = 'lowpass';
            filter.frequency.value = freq * 2;
            gain.gain.setValueAtTime(0.03, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            osc.start();
            osc.stop(audioContext.currentTime + 0.4);
          }, i * 150);
        });
      } catch (error) {
        logError('Erreur Firework: ' + error.message);
      }
    }

    function playfireworksound2() {
      if (!audioInitialized) initAudio();
      try {
        const sequence = [554.37, 659.25, 830.61, 987.77];
        sequence.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.035, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc.start();
            osc.stop(audioContext.currentTime + 0.2);
          }, i * 100);
        });
      } catch (error) {
        logError('Erreur fireworksound 2: ' + error.message);
      }
    }

    function playfireworksound3() {
      if (!audioInitialized) initAudio();
      try {
        const sequence = [659.25, 783.99, 987.77, 1174.66];
        sequence.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.035, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc.start();
            osc.stop(audioContext.currentTime + 0.2);
          }, i * 100);
        });
      } catch (error) {
        logError('Erreur fireworksound 3: ' + error.message);
      }
    }

    function playfireworksound4() {
      if (!audioInitialized) initAudio();
      try {
        const sequence = [783.99, 987.77, 1174.66, 1396.91];
        sequence.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.035, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc.start();
            osc.stop(audioContext.currentTime + 0.2);
          }, i * 100);
        });
      } catch (error) {
        logError('Erreur fireworksound 4: ' + error.message);
      }
    }

    function playLevelUp() {
      if (!audioInitialized) initAudio();
      try {
        const sequence = [523.25, 659.25, 783.99, 1046.50];
        const flourish = [783.99, 1046.50, 1318.51];
        sequence.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.04, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
            osc.start();
            osc.stop(audioContext.currentTime + 0.12);
          }, i * 120);
        });
        flourish.forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.04, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            osc.start();
            osc.stop(audioContext.currentTime + 0.1);
          }, 480 + i * 100);
        });
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          const mod = audioContext.createOscillator();
          const modGain = audioContext.createGain();
          mod.connect(modGain);
          modGain.connect(osc.frequency);
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.type = 'sine';
          mod.type = 'sine';
          osc.frequency.value = 1318.51;
          mod.frequency.value = 5;
          modGain.gain.value = 10;
          gain.gain.setValueAtTime(0.04, audioContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2.0);
          osc.start();
          mod.start();
          osc.stop(audioContext.currentTime + 2.0);
          mod.stop(audioContext.currentTime + 2.0);
        }, 780);
      } catch (error) {
        logError('Erreur Level Up: ' + error.message);
      }
    }

    function drawStar(ctx, x, y, radius, rotation = 0) {
      const points = 5;
      const outerRadius = radius;
      const innerRadius = radius / 2;
      ctx.beginPath();
      for (let i = 0; i < points * 2; i++) {
        const r = i % 2 === 0 ? outerRadius : innerRadius;
        const angle = (i * Math.PI / points) + rotation - Math.PI / 2;
        ctx.lineTo(
          x + r * Math.cos(angle),
          y + r * Math.sin(angle)
        );
      }
      ctx.closePath();
      ctx.fill();
    }

    function triggerAdvancedFirework(container) {
      initAudio();
      const validatedCount = getValidatedCountForLevel(niveauActif);
      triggerSakuraFall(container);
      if (validatedCount === 0) {
        playFireworkSound();
      } else if (validatedCount === 1) {
        playfireworksound2();
      } else if (validatedCount === 2) {
        playfireworksound3();
      } else if (validatedCount === 3) {
        playfireworksound4();
      } else if (validatedCount === 4) {
        playLevelUp();
        triggerLevelUpAnimation(container);
      }
    }

    function getMaxLevel(list) {
      if (!list || list.length === 0) return 1;
      return Math.max(...list.map(k => parseInt(k.Niveau) || 1));
    }

    function updateStarsForHiragana(hiraganaId, newValidation) {
      console.log(`Updating stars for hiragana ID ${hiraganaId} with validation ${newValidation}`);
      const cards = document.querySelectorAll('.hiragana-card');
      cards.forEach(card => {
        const hiraganaChar = card.querySelector('.hiragana-char').textContent;
        const hiragana = HiraganaList.find(h => h.Hiragana === hiraganaChar && h.ID == hiraganaId);
        if (hiragana) {
          const stars = card.querySelectorAll('.star');
          const previousValidation = previousValidationStates.get(hiraganaId) || 0;

          stars.forEach((star, index) => {
            if (index < newValidation && !star.classList.contains('filled')) {
              star.classList.add('filled', 'new-star');
              setTimeout(() => star.classList.remove('new-star'), 500);
            } else if (index < newValidation) {
              star.classList.add('filled');
            } else {
              star.classList.remove('filled', 'new-star');
            }
          });

          if (newValidation >= 5 && previousValidation < 5) {
            if (isMobile) {
              triggerLightFirework(card);
            } else {
              triggerAdvancedFirework(card);
            }
          }

          if (newValidation >= 5) {
            card.classList.add('completed');
          } else {
            card.classList.remove('completed');
          }

          previousValidationStates.set(hiraganaId, newValidation);
        }
      });
    }

    function renderHiraganaCards(list, niveau) {
      const container = document.getElementById("hiraganaCards");
      if (!container) return;
      const hiraganas = list.filter(h => parseInt(h.Niveau) === niveau);
      container.innerHTML = "";
      hiraganas.forEach(hiragana => {
        const validation = parseInt(hiragana.Validation || 0);
        const isCompleted = validation >= 5;
        const card = document.createElement("div");
        card.className = `hiragana-card ${isCompleted ? 'completed' : ''}`;
        card.innerHTML = `
          <div class="hiragana-char">${hiragana.Hiragana}</div>
          <div class="stars-container">
            ${Array.from({length: 5}, (_, i) =>
              `<div class="star ${i < validation ? 'filled' : ''}"></div>`
            ).join('')}
          </div>
        `;
        container.appendChild(card);
        previousValidationStates.set(parseInt(hiragana.ID), validation);
      });
    }

    function renderProgressBar(currentLevel, maxLevel) {
      const container = document.getElementById("progressBarContainer");
      if (!container) return;

      container.innerHTML = "";

      const leftEmoji = document.createElement("span");
      leftEmoji.textContent = "üåø";
      leftEmoji.className = "side-emoji";

      const rightEmoji = document.createElement("span");
      rightEmoji.textContent = "üéç";
      rightEmoji.className = "side-emoji";

      const barTrack = document.createElement("div");
      barTrack.className = "progress-bar-track";

      const marker = document.createElement("div");
      marker.className = "progress-marker";
      marker.innerText = "üå∏";

      const pct = maxLevel > 1 ? ((currentLevel - 1) / (maxLevel - 1)) * 100 : 0;
      marker.style.left = `${Math.min(100, Math.max(0, pct))}%`;

      barTrack.appendChild(marker);
      container.appendChild(leftEmoji);
      container.appendChild(barTrack);
      container.appendChild(rightEmoji);
    }

    function determineNiveauActif(list) {
      if (!list || list.length === 0) return 1;
      let maxNiveau = Math.max(...list.map(k => parseInt(k.Niveau) || 1));

      for (let n = 1; n <= maxNiveau; n++) {
        const kanjisNiveau = list.filter(k => parseInt(k.Niveau) === n);
        const kanjisValides = kanjisNiveau.filter(k => parseInt(k.Validation) >= 5);
        if (kanjisValides.length < kanjisNiveau.length) {
          return n;
        }
      }
      return maxNiveau;
    }

    function updateLevelProgress(list, niveau) {
      renderHiraganaCards(list, niveau);
    }

    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyunFkM7h0FV_xu1GRa4uOiuxeggNSVY1HRCzNungo8QonzHznN0TRNLDOEEOtfQu_8FQ/exec';

    async function callAPI(action, data = null) {
      try {
        if (action === 'updateStats') {
          const params = new URLSearchParams({ 
            action, 
            id: data.id, 
            scorePoints: data.scorePoints 
          });
          const response = await fetch(`${WEB_APP_URL}?${params}`);
          return await response.json();
        } else {
          const response = await fetch(`${WEB_APP_URL}?action=${action}`);
          return await response.json();
        }
      } catch (error) {
        logError('Erreur API: ' + error.message);
        return { error: error.message };
      }
    }

    async function initGame() {
      console.log('Initializing game');
      const data = await callAPI('getHiraganas');
      if (data.error) {
        logError('Erreur lors du chargement: ' + data.error);
        return;
      }
      
      HiraganaList = data;
      niveauActif = determineNiveauActif(HiraganaList);
      document.getElementById("levelDisplay").innerText = `Niveau actuel : ${niveauActif}`;
      updateLevelProgress(HiraganaList, niveauActif);
      renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
      nextQuestion();
    }

    function nextQuestion() {
      console.log('Next question');
      document.getElementById("result").innerText = "";
      document.getElementById("continueBtn").style.visibility = "hidden";
      selections = { first: null, second: null };
      isAnswered = false;

      const kanas = HiraganaList.filter(k =>
        parseInt(k.Niveau) === niveauActif && parseInt(k.Validation || 0) < 5
      );

      if (kanas.length === 0) {
        const nouveauNiveau = determineNiveauActif(HiraganaList);
        if (nouveauNiveau !== niveauActif) {
          niveauActif = nouveauNiveau;
          document.getElementById("levelDisplay").innerText = `Niveau actuel : ${niveauActif}`;
          renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
          updateLevelProgress(HiraganaList, niveauActif);
          nextQuestion();
          return;
        }
      }

      const finalKanas = kanas.length > 0 ? kanas : HiraganaList.filter(k => parseInt(k.Niveau) === niveauActif);

      const currentWeights = finalKanas.map(k => {
        const validation = parseInt(k.Validation || 0);
        return Math.max(0.1, 5 - validation + 0.5);
      });

      const sum = currentWeights.reduce((a, b) => a + b, 0);
      const rand = Math.random() * sum;
      let acc = 0;
      for (let i = 0; i < finalKanas.length; i++) {
        acc += currentWeights[i];
        if (rand < acc) {
          current = finalKanas[i];
          break;
        }
      }

      const modes = [
        { question: "Hiragana", options1: "Katakana", options2: "Romaji" },
        { question: "Katakana", options1: "Hiragana", options2: "Romaji" },
        { question: "Romaji", options1: "Hiragana", options2: "Katakana" }
      ];
      const mode = modes[Math.floor(Math.random() * modes.length)];
      targetFields = [mode.options1, mode.options2];

      document.getElementById("question").innerText = current[mode.question];
      renderChoices("choices1", generateChoices(mode.options1), "first");
      renderChoices("choices2", generateChoices(mode.options2), "second");
    }

    function generateChoices(field) {
      const others = HiraganaList.filter(k => k !== current && parseInt(k.Niveau) === niveauActif);
      const values = [current[field], ...others.sort(() => 0.5 - Math.random()).slice(0, 3).map(k => k[field])];
      return values.sort(() => 0.5 - Math.random());
    }

    function renderChoices(id, options, slot) {
      console.log(`Rendering choices for ${id}:`, options);
      const container = document.getElementById(id);
      container.innerHTML = "";
      options.forEach(text => {
        const btn = document.createElement("button");
        btn.innerText = text;
        btn.className = "arcade-button";
        btn.onclick = () => {
          console.log(`Button clicked: ${text} for slot ${slot}`);
          if (selections[slot] !== null || isAnswered) {
            console.log(`Click ignored: slot=${selections[slot]}, isAnswered=${isAnswered}`);
            return;
          }
          selections[slot] = text;
          console.log(`Selection updated:`, selections);

          btn.classList.add("clicked-glow");

          container.querySelectorAll("button").forEach(b => {
            b.disabled = true;
            if (b !== btn) b.style.opacity = 0.5;
          });
          checkAnswer();
        };
        container.appendChild(btn);
      });
    }

    async function checkAnswer() {
      console.log('Checking answer:', selections);
      if (selections.first && selections.second && !isAnswered) {
        isAnswered = true;
        const correct1 = current[targetFields[0]];
        const correct2 = current[targetFields[1]];
        let score = 0;
        const containers = [document.getElementById("choices1"), document.getElementById("choices2")];
        const correctAnswers = [correct1, correct2];
        const userSelections = [selections.first, selections.second];

        containers.forEach(container => {
          container.querySelectorAll("button").forEach(btn => {
            btn.classList.remove("clicked-glow");
          });
        });

        containers.forEach((container, index) => {
          const buttons = container.querySelectorAll("button");
          buttons.forEach(btn => {
            btn.classList.remove("correct", "incorrect");
            if (btn.innerText === correctAnswers[index]) {
              btn.disabled = false;
              btn.style.opacity = '1';
              btn.classList.add("correct");
              if (btn.innerText === userSelections[index]) {
                score += 0.5;
              }
            } else if (btn.innerText === userSelections[index]) {
              btn.disabled = false;
              btn.style.opacity = '1';
              btn.classList.add("incorrect");
            }
          });
        });

        const currentValidation = parseInt(current.Validation || 0);
        let newValidation = currentValidation;

        if (score === 1) {
          newValidation = Math.min(5, currentValidation + 1);
        } else if (score === 0.5) {
          newValidation = Math.max(0, currentValidation - 1);
        } else {
          newValidation = Math.max(0, currentValidation - 2);
        }

        const isFinalValidation = score === 1 && currentValidation < 5 && newValidation >= 5;

        updateStarsForHiragana(parseInt(current.ID), newValidation);

        const hiraganaIndex = HiraganaList.findIndex(h => h.ID == current.ID);
        if (hiraganaIndex !== -1) {
          HiraganaList[hiraganaIndex].Validation = newValidation.toString();
        }

        let emoji = "", resultText = "";
        if (score === 1) {
          const emojisOK = ["üå∏", "üéç", "üçµ", "ü™¥"];
          emoji = emojisOK[Math.floor(Math.random() * emojisOK.length)];
          resultText = isFinalValidation ? "Valid√© ! üéâ" : "Parfait !";
          if (isFinalValidation) {
            playMarioCoin();
            triggerSakuraFall(document.body);
          } else {
            playMarioCoin();
          }
        } else if (score === 0.5) {
          const emojisMid = ["ü™®", "üåø", "ü™µ"];
          emoji = emojisMid[Math.floor(Math.random() * emojisMid.length)];
          resultText = "Presque...";
          playSuccess90s();
        } else {
          const emojisBad = ["üçÇ", "üå´Ô∏è", "ü™®"];
          emoji = emojisBad[Math.floor(Math.random() * emojisBad.length)];
          resultText = "Pas tout √† fait...";
          playFail();
        }

        document.getElementById("result").innerHTML = `
          <div class="result-line">${emoji} ${resultText} ${emoji}</div>
          <div class="result-line highlight">
            üëâ Bonnes r√©ponses : <strong>${correct1}</strong> ‚Äì <strong>${correct2}</strong>
          </div>`;

        if (score === 1) {
          document.getElementById("result").innerHTML += "<br><small style='color: #6B8E23;'></small>";
          setTimeout(nextQuestion, 1500);
        } else {
          document.getElementById("continueBtn").style.visibility = "visible";
        }

        callAPI('updateStats', { id: parseInt(current.ID), scorePoints: score })
          .then(response => {
            if (response.error) {
              console.warn('Erreur sauvegarde:', response.error);
            } else {
              console.log('‚úÖ Score sauvegard√© en arri√®re-plan');
            }
          })
          .catch(error => {
            console.error('Erreur lors de la sauvegarde:', error);
          });
      } else {
        console.log('Answer check skipped:', { first: selections.first, second: selections.second, isAnswered });
      }
    }

    function triggerLightFirework(card) {
      const halo = document.createElement("div");
      halo.style.position = "absolute";
      halo.style.width = "30px";
      halo.style.height = "30px";
      halo.style.borderRadius = "50%";
      halo.style.background = "radial-gradient(circle, rgba(253,193,197,0.9), rgba(253,193,197,0.1))";
      halo.style.transform = "translate(-50%, -50%) scale(1)";
      halo.style.opacity = "1";
      halo.style.pointerEvents = "none";
      halo.style.zIndex = "10";

      const rect = card.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      halo.style.left = `${cx}px`;
      halo.style.top = `${cy}px`;
      document.body.appendChild(halo);

      halo.animate([
        { transform: "translate(-50%, -50%) scale(1)", opacity: 1 },
        { transform: "translate(-50%, -50%) scale(4)", opacity: 0 }
      ], {
        duration: 800,
        easing: "ease-out"
      }).onfinish = () => halo.remove();

      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const sakura = document.createElement("div");
          sakura.className = "sakura";
          const offsetX = (Math.random() - 0.5) * 80;
          const offsetY = (Math.random() - 0.5) * 80;
          sakura.style.left = `${cx + offsetX}px`;
          sakura.style.top = `${cy + offsetY}px`;
          sakura.style.animationDuration = "1.5s";
          document.body.appendChild(sakura);
          setTimeout(() => sakura.remove(), 1500);
        }, i * 250);
      }

      const validatedCount = getValidatedCountForLevel(niveauActif);
      if (validatedCount === 0) {
        playFireworkSound();
      } else if (validatedCount === 1) {
        playfireworksound2();
      } else if (validatedCount === 2) {
        playfireworksound3();
      } else if (validatedCount === 3) {
        playfireworksound4();
      } else if (validatedCount === 4) {
        playLevelUp();
        triggerLevelUpAnimation(card);
      }
    }

    function triggerLevelUpAnimation(container) {
      const toHide = ['#question', '#choices1', '#choices2'];
      toHide.forEach(id => {
        const el = document.querySelector(id);
        if (el) el.style.visibility = 'hidden';
      });

      for (let group = 0; group < 3; group++) {
        setTimeout(() => {
          for (let i = 0; i < 3; i++) {
            const sakura = document.createElement('div');
            sakura.className = 'sakura';
            sakura.style.top = `${15 + Math.random() * 50}%`;
            sakura.style.left = `${20 + Math.random() * 60}%`;
            sakura.style.animationDuration = "2s";
            container.appendChild(sakura);
            setTimeout(() => sakura.remove(), 2000);
          }
        }, group * 300);
      }

      setTimeout(() => {
        toHide.forEach(id => {
          const el = document.querySelector(id);
          if (el) {
            el.style.visibility = 'visible';
            el.style.opacity = 0;
            el.animate([
              { opacity: 0 },
              { opacity: 1 }
            ], {
              duration: 600,
              fill: 'forwards'
            });
          }
        });
      }, 3000);

      const msgWrapper = document.createElement("div");
      msgWrapper.style.position = "fixed";
      msgWrapper.style.top = "30%";
      msgWrapper.style.left = "0";
      msgWrapper.style.width = "100vw";
      msgWrapper.style.textAlign = "center";
      msgWrapper.style.zIndex = 9999;
      msgWrapper.style.pointerEvents = "none";
      document.body.appendChild(msgWrapper);

      const msg = document.createElement("div");
      msg.innerText = "„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ";
      msg.style.display = "inline-block";
      msg.style.fontSize = "5em";
      msg.style.fontWeight = "bold";
      msg.style.color = "#4A4E69";
      msg.style.textShadow = "0 0 10px #A8D5BA";
      msg.style.writingMode = "horizontal-tb";
      msg.style.whiteSpace = "nowrap";
      msgWrapper.appendChild(msg);

      msg.animate([
        { transform: "translateY(0)", opacity: 1 },
        { transform: "translateY(-40px)", opacity: 0 }
      ], {
        duration: 5000,
        easing: "ease-out"
      }).onfinish = () => msgWrapper.remove();

      for (let i = 0; i < 30; i++) {
        const sakura = document.createElement("div");
        sakura.className = "sakura";
        sakura.style.left = Math.random() * 100 + "vw";
        sakura.style.top = "-10px";
        sakura.style.backgroundColor = ["#FDC1C5", "#A8D5BA", "#A3BFFA"][Math.floor(Math.random() * 3)];
        sakura.style.opacity = Math.random() * 0.9 + 0.1;
        sakura.style.zIndex = 5000;
        sakura.style.animation = `sakuraFall ${2 + Math.random() * 2}s linear ${Math.random()}s forwards`;
        document.body.appendChild(sakura);
        setTimeout(() => sakura.remove(), 5000);
      }

      const marker = document.querySelector(".progress-marker");
      if (marker) {
        marker.animate([
          { transform: "translate(-50%, -50%) rotate(0deg) scale(1)" },
          { transform: "translate(-50%, -50%) rotate(180deg) scale(2)" },
          { transform: "translate(-50%, -50%) rotate(360deg) scale(1)" }
        ], {
          duration: 1000,
          easing: "ease-in-out"
        });
      }
    }

    // Fullscreen API
    document.getElementById('boutonPleinEcran').addEventListener('click', () => {
      console.log('Requesting fullscreen');
      const element = document.documentElement;
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    });

    // PWA installation
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('Before install prompt triggered');
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('boutonInstaller').style.display = 'block';
    });

    document.getElementById('boutonInstaller').addEventListener('click', () => {
      console.log('Install button clicked');
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('PWA install√©e');
        }
        deferredPrompt = null;
      });
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(
          (registration) => {
            console.log('Service Worker enregistr√©:', registration);
          },
          (error) => {
            console.log('√âchec Service Worker:', error);
          }
        );
      });
    }

    window.onload = () => {
      console.log('Window loaded, starting game');
      initGame();
    };
  </script>
</body>
</html>
