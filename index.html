<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Hiragana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      border: 2px solid #333;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      border-color: #999;
      cursor: not-allowed;
    }
    #kana {
      font-size: 4rem;
      margin-top: 1.5rem;
      min-height: 5rem;
    }
    #raw {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    #error {
      margin-top: 1rem;
      color: red;
    }
    #debug {
      margin-top: 2rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.85rem;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Prononce un hiragana</h1>
  <p>Prononce simplement la syllabe : "ka", "shi", "tsu"...</p>
  <button id="mic">Parler</button>
  <div id="kana">â€”</div>
  <div id="raw"></div>
  <div id="error"></div>
  <div id="debug"></div>

<script>
  const micBtn = document.getElementById("mic");
  const kanaDiv = document.getElementById("kana");
  const rawDiv = document.getElementById("raw");
  const errorDiv = document.getElementById("error");
  const debugDiv = document.getElementById("debug");

  function addDebug(msg, isError = false) {
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div style="color: ${isError ? 'red' : '#333'}">[${time}] ${msg}</div>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
  }

  addDebug("Script chargÃ©");

  // VÃ©rification HTTPS
  if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
    errorDiv.textContent = "âš ï¸ HTTPS requis pour la reconnaissance vocale";
    micBtn.disabled = true;
    addDebug("HTTPS non dÃ©tectÃ©", true);
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    errorDiv.textContent = "âŒ Reconnaissance vocale non supportÃ©e";
    micBtn.disabled = true;
    addDebug("SpeechRecognition non disponible", true);
  } else {
    addDebug("SpeechRecognition disponible âœ“");
    
    const recognition = new SpeechRecognition();
    
    // â­ CHANGEMENT CLÃ‰ : utiliser le franÃ§ais pour capter les syllabes
    recognition.lang = "fr-FR";
    
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 3; // On augmente pour avoir plus de variantes

    // Mapping complet hiragana
    const kanaMap = {
      // Voyelles
      "a": "ã‚", "ah": "ã‚",
      "i": "ã„", "y": "ã„",
      "u": "ã†", "ou": "ã†", "hou": "ã†",
      "e": "ãˆ", "eh": "ãˆ",
      "o": "ãŠ", "oh": "ãŠ",
      
      // K
      "ka": "ã‹", "ca": "ã‹", "kah": "ã‹",
      "ki": "ã", "qui": "ã", "key": "ã",
      "ku": "ã", "cou": "ã", "kou": "ã",
      "ke": "ã‘", "keh": "ã‘",
      "ko": "ã“", "koh": "ã“",
      
      // S
      "sa": "ã•", "sah": "ã•",
      "shi": "ã—", "si": "ã—", "chi": "ã—", "she": "ã—",
      "su": "ã™", "sou": "ã™", "sue": "ã™",
      "se": "ã›", "seh": "ã›",
      "so": "ã", "soh": "ã",
      
      // T
      "ta": "ãŸ", "tah": "ãŸ",
      "chi": "ã¡", "tchi": "ã¡", "ti": "ã¡",
      "tsu": "ã¤", "tsou": "ã¤", "tu": "ã¤", "tsue": "ã¤", "sou": "ã¤",
      "te": "ã¦", "teh": "ã¦",
      "to": "ã¨", "toh": "ã¨",
      
      // N
      "na": "ãª", "nah": "ãª",
      "ni": "ã«", "nhi": "ã«",
      "nu": "ã¬", "nou": "ã¬",
      "ne": "ã­", "neh": "ã­",
      "no": "ã®", "noh": "ã®",
      
      // H
      "ha": "ã¯", "hah": "ã¯",
      "hi": "ã²", "hee": "ã²",
      "fu": "ãµ", "hu": "ãµ", "fou": "ãµ", "hou": "ãµ",
      "he": "ã¸", "heh": "ã¸",
      "ho": "ã»", "hoh": "ã»",
      
      // M
      "ma": "ã¾", "mah": "ã¾",
      "mi": "ã¿", "mee": "ã¿",
      "mu": "ã‚€", "mou": "ã‚€",
      "me": "ã‚", "meh": "ã‚",
      "mo": "ã‚‚", "moh": "ã‚‚",
      
      // Y
      "ya": "ã‚„", "yah": "ã‚„",
      "yu": "ã‚†", "you": "ã‚†",
      "yo": "ã‚ˆ", "yoh": "ã‚ˆ",
      
      // R
      "ra": "ã‚‰", "rah": "ã‚‰", "la": "ã‚‰",
      "ri": "ã‚Š", "ree": "ã‚Š", "li": "ã‚Š",
      "ru": "ã‚‹", "rou": "ã‚‹", "lou": "ã‚‹",
      "re": "ã‚Œ", "reh": "ã‚Œ", "leh": "ã‚Œ",
      "ro": "ã‚", "roh": "ã‚", "loh": "ã‚",
      
      // W
      "wa": "ã‚", "wah": "ã‚",
      "wo": "ã‚’", "woh": "ã‚’",
      "n": "ã‚“", "nn": "ã‚“",
      
      // G
      "ga": "ãŒ", "gah": "ãŒ",
      "gi": "ãŽ", "gui": "ãŽ",
      "gu": "ã", "gou": "ã",
      "ge": "ã’", "gueh": "ã’",
      "go": "ã”", "goh": "ã”",
      
      // Z
      "za": "ã–", "zah": "ã–",
      "ji": "ã˜", "zi": "ã˜", "dji": "ã˜",
      "zu": "ãš", "zou": "ãš",
      "ze": "ãœ", "zeh": "ãœ",
      "zo": "ãž", "zoh": "ãž",
      
      // D
      "da": "ã ", "dah": "ã ",
      "de": "ã§", "deh": "ã§",
      "do": "ã©", "doh": "ã©",
      
      // B
      "ba": "ã°", "bah": "ã°",
      "bi": "ã³", "bee": "ã³",
      "bu": "ã¶", "bou": "ã¶",
      "be": "ã¹", "beh": "ã¹",
      "bo": "ã¼", "boh": "ã¼",
      
      // P
      "pa": "ã±", "pah": "ã±",
      "pi": "ã´", "pee": "ã´",
      "pu": "ã·", "pou": "ã·",
      "pe": "ãº", "peh": "ãº",
      "po": "ã½", "poh": "ã½"
    };

    micBtn.onclick = () => {
      addDebug("Bouton cliquÃ©");
      kanaDiv.textContent = "ðŸŽ§ Ã‰coute...";
      rawDiv.textContent = "";
      errorDiv.textContent = "";
      micBtn.disabled = true;
      micBtn.textContent = "Ã‰coute en cours...";
      
      try {
        recognition.start();
        addDebug("Reconnaissance dÃ©marrÃ©e");
      } catch (e) {
        addDebug(`Erreur: ${e.message}`, true);
        errorDiv.textContent = `Erreur: ${e.message}`;
        micBtn.disabled = false;
        micBtn.textContent = "Parler";
      }
    };

    recognition.onresult = (event) => {
      addDebug("RÃ©sultat reÃ§u");
      
      // On vÃ©rifie toutes les alternatives
      let allTranscripts = [];
      for (let i = 0; i < event.results[0].length; i++) {
        allTranscripts.push(event.results[0][i].transcript.toLowerCase().trim());
      }
      
      const mainTranscript = allTranscripts[0];
      const confidence = event.results[0][0].confidence;

      addDebug(`Reconnu: "${mainTranscript}" (${(confidence * 100).toFixed(0)}%)`);
      if (allTranscripts.length > 1) {
        addDebug(`Alternatives: ${allTranscripts.slice(1).join(', ')}`);
      }

      rawDiv.textContent = `Reconnu : "${mainTranscript}" (${(confidence * 100).toFixed(0)}%)`;

      // On cherche une correspondance dans toutes les alternatives
      let found = false;
      for (const transcript of allTranscripts) {
        // Nettoyage du transcript
        let cleaned = transcript
          .replace(/[.,!?;]/g, '') // Enlever la ponctuation
          .replace(/c'est\s+/gi, '')
          .replace(/c\s+/gi, '')
          .replace(/le\s+/gi, '')
          .replace(/la\s+/gi, '')
          .trim();

        addDebug(`Recherche: "${cleaned}"`);

        if (kanaMap[cleaned]) {
          kanaDiv.textContent = kanaMap[cleaned];
          kanaDiv.style.color = "green";
          found = true;
          addDebug(`âœ“ Match: ${cleaned} â†’ ${kanaMap[cleaned]}`);
          break;
        }
      }

      if (!found) {
        kanaDiv.textContent = "â“";
        kanaDiv.style.color = "#666";
        addDebug("Aucune correspondance trouvÃ©e");
      }

      setTimeout(() => {
        kanaDiv.style.color = "black";
      }, 1500);
    };

    recognition.onerror = (event) => {
      addDebug(`Erreur: ${event.error}`, true);
      let message = "";
      switch (event.error) {
        case "no-speech":
          message = "Aucun son dÃ©tectÃ©";
          break;
        case "audio-capture":
          message = "ProblÃ¨me avec le micro";
          break;
        case "not-allowed":
          message = "AccÃ¨s au micro refusÃ©";
          break;
        default:
          message = `Erreur : ${event.error}`;
      }
      errorDiv.textContent = `âŒ ${message}`;
      kanaDiv.textContent = "â€”";
    };

    recognition.onend = () => {
      addDebug("Reconnaissance terminÃ©e");
      micBtn.disabled = false;
      micBtn.textContent = "Parler";
    };
  }
</script>
</body>
</html>
