<script>
        // --- REMPLACE PAR TON LIEN ---
      //    const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/"; 
</script>        
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labo Calibrage v2 - Gain R√©el</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .val { font-weight: bold; color: #007bff; font-family: monospace; }
        #vumeter { width: 100%; height: 15px; background: #e0e0e0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        #vulevel { height: 100%; width: 0%; background: #4caf50; transition: width 0.05s; }
        input[type=range] { width: 90%; margin: 15px 0; }
        button { padding: 15px 25px; font-size: 16px; border-radius: 8px; border: none; background: #007bff; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üõ†Ô∏è Calibrage du Gain</h2>
        <button id="btn-start">D√©marrer le test</button>
    </div>

    <div class="card">
        <div>Gain appliqu√© : <span id="gain-display" class="val">1.0</span>x</div>
        <input type="range" id="gain-slider" min="1" max="30" step="0.5" value="1">
        
        <div>Volume Micro (RMS) : <span id="rms-display" class="val">0.0000</span></div>
        <div id="vumeter"><div id="vulevel"></div></div>
    </div>

    <div class="card">
        <h3>D√©tection IA</h3>
        <div id="res-1" style="font-size: 1.4rem; color: #28a745;">---</div>
        <div id="res-2" style="font-size: 1rem; color: #6c757d;">---</div>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/"; 
        
        let audioContext, gainNode, analyser, dataArray;
        let recognizer;

        async function init() {
            // 1. Cr√©ation de l'AudioContext
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false // On essaie de d√©sactiver les aides Android
                } 
            });

            // 2. Cha√Æne de traitement : Source -> Gain -> Analyser
            const source = audioContext.createMediaStreamSource(stream);
            gainNode = audioContext.createGain();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Float32Array(analyser.fftSize);

            source.connect(gainNode);
            gainNode.connect(analyser);
            // On ne connecte pas √† audioContext.destination pour √©viter le larsen.

            // 3. Charger Teachable Machine
            recognizer = speechCommands.create("BROWSER_FFT", undefined, URL + "model.json", URL + "metadata.json");
            await recognizer.ensureModelLoaded();

            // 4. Lancer l'analyse RMS en continu
            draw();

            // 5. Lancer l'√©coute IA
            const labels = recognizer.wordLabels();
            recognizer.listen(result => {
                const scores = Array.from(result.scores).map((s, i) => ({ label: labels[i], score: s }));
                scores.sort((a, b) => b.score - a.score);

                document.getElementById('res-1').innerHTML = `<b>${scores[0].label}</b> (${(scores[0].score * 100).toFixed(1)}%)`;
                document.getElementById('res-2').innerHTML = `2. ${scores[1].label} (${(scores[1].score * 100).toFixed(1)}%)`;
            }, { 
                probabilityThreshold: 0.1,
                overlapFactor: 0.5
            });
        }

        function draw() {
            analyser.getFloatTimeDomainData(dataArray);
            
            // Calcul du RMS r√©el sur les √©chantillons temporels
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i] * dataArray[i];
            }
            let rms = Math.sqrt(sum / dataArray.length);
            
            // Affichage
            document.getElementById('rms-display').innerText = rms.toFixed(5);
            let barWidth = Math.min(100, rms * 500); // Sensibilit√© de la barre
            document.getElementById('vulevel').style.width = barWidth + "%";
            document.getElementById('vulevel').style.background = barWidth > 80 ? "#ffc107" : (barWidth > 95 ? "#dc3545" : "#4caf50");

            requestAnimationFrame(draw);
        }

        document.getElementById('btn-start').onclick = () => {
            init();
            document.getElementById('btn-start').disabled = true;
        };

        document.getElementById('gain-slider').oninput = (e) => {
            const val = e.target.value;
            document.getElementById('gain-display').innerText = val;
            if (gainNode) gainNode.gain.value = parseFloat(val);
        };
    </script>
</body>
</html>

