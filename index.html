<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Quiz - Diagnostic Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1c2c; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .container {
            background: white; border-radius: 20px; padding: 20px;
            max-width: 500px; width: 100%; text-align: center;
        }
        .target-char { font-size: 100px; font-weight: bold; color: #2d3436; line-height: 1.1; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            background: #eee; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .tab.active { background: #667eea; color: white; }
        .panel { display: none; }
        .panel.active { display: block; }
        .debug-panel {
            background: #222; color: #0f0; font-family: monospace;
            padding: 10px; border-radius: 8px; margin: 15px 0; font-size: 13px;
            text-align: left; border-left: 4px solid #444;
        }
        .bar-container { background: #444; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .bar-fill { background: #0f0; height: 100%; width: 0%; transition: width 0.1s; }
        .energy-bar { background: #ff0; }
        .fft-debug { background: #000; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .fft-canvas { width: 100%; height: 100px; background: #111; border-radius: 5px; }
        .slider-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: left; }
        .slider-item { margin: 10px 0; }
        .slider-item label { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        .slider-item input[type="range"] { width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; }
        .calibration-step { background: #fff3cd; padding: 20px; border-radius: 12px; margin: 15px 0; border-left: 4px solid #ffc107; }
        .calibration-char { font-size: 80px; font-weight: bold; color: #2d3436; }
        .measurements { background: #e9ecef; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px; text-align: left; }
        canvas { width: 100%; height: 60px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; }
        .status { padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; font-size: 14px; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-small { padding: 8px 15px; width: auto; font-size: 14px; }
        .btn-capture { background: #ff4757; color: white; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('game')">üéÆ Jeu</button>
        <button class="tab" onclick="switchTab('calibration')">‚öôÔ∏è Calibration</button>
        <button class="tab" onclick="switchTab('settings')">üéõÔ∏è R√©glages</button>
    </div>

    <div id="gamePanel" class="panel active">
        <div style="display: flex; justify-content: space-between; font-weight: bold;">
            <span>Score: <span id="score">0</span></span>
            <span>Question: <span id="qCount">0</span></span>
        </div>

        <div id="targetDisplay" class="target-char">?</div>
        
        <div class="debug-panel">
            <div>üéØ D√©tect√© : <span id="bestLabel">---</span></div>
            <div id="bestScoreText">Confiance : 0%</div>
            <div class="bar-container"><div id="scoreBar" class="bar-fill"></div></div>
            <div style="margin-top: 8px;">üîä √ânergie : <span id="energyLevel">0%</span></div>
            <div class="bar-container"><div id="energyBar" class="bar-fill energy-bar"></div></div>
            <div style="margin-top: 8px; color: #888; font-size: 11px;">
                Sample Rate: <span id="sampleRate">?</span> Hz
            </div>
        </div>

        <div class="fft-debug">
            <div style="color: #0f0; font-family: monospace; font-size: 11px; margin-bottom: 5px;">
                üìä Spectre FFT (Diagnostic Live)
            </div>
            <canvas id="fftCanvas" class="fft-canvas"></canvas>
            <button id="captureBtn" class="btn-capture btn-small">üì∏ CAPTURER SPECTRE (JSON)</button>
        </div>

        <div id="status" class="status info">Chargement...</div>
        <canvas id="vizCanvas"></canvas>

        <button id="actionBtn" class="btn-main" disabled>D√âMARRER</button>
        <button id="skipBtn" class="btn-secondary" style="display:none">PASSER</button>
    </div>

    <div id="calibrationPanel" class="panel">
        <h3 style="margin-bottom: 15px;">üéØ Calibration Audio</h3>
        <div class="calibration-step">
            <div>Prononcez clairement :</div>
            <div class="calibration-char" id="calibChar">„ÅÇ</div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">√âtape <span id="calibStep">1</span>/5</div>
        </div>
        <div class="debug-panel">
            <div>üéØ D√©tection : <span id="calibDetected">---</span></div>
            <div>Confiance : <span id="calibConfidence">0%</span></div>
            <div class="bar-container"><div id="calibConfBar" class="bar-fill"></div></div>
            <div style="margin-top: 8px;">üîä √ânergie : <span id="calibEnergy">0%</span></div>
            <div class="bar-container"><div id="calibEnergyBar" class="bar-fill energy-bar"></div></div>
        </div>
        <div class="fft-debug">
            <canvas id="calibFftCanvas" class="fft-canvas"></canvas>
        </div>
        <div class="measurements">
            <strong>üìä Mesures :</strong>
            <div id="calibResults">Aucune mesure</div>
        </div>
        <canvas id="calibCanvas" style="height: 50px;"></canvas>
        <button id="startCalibBtn" class="btn-main" disabled>LANCER CALIBRATION</button>
        <button id="nextCalibBtn" class="btn-success" style="display:none">VALIDER & SUIVANT</button>
        <button id="applyCalibBtn" class="btn-success" style="display:none">APPLIQUER</button>
    </div>

    <div id="settingsPanel" class="panel">
        <h3 style="margin-bottom: 15px;">üéõÔ∏è R√©glages Avanc√©s</h3>
        <div class="slider-group">
            <div class="slider-item">
                <label><span>üîä Seuil √ânergie Audio</span><span id="energyThresholdVal">0.006</span></label>
                <input type="range" id="energyThreshold" min="0" max="0.01" step="0.0001" value="0.006">
            </div>
            <div class="slider-item">
                <label><span>üéØ Confiance Min.</span><span id="minConfidenceVal">0.30</span></label>
                <input type="range" id="minConfidence" min="0.1" max="0.9" step="0.05" value="0.30">
            </div>
            <div class="slider-item">
                <label><span>üéöÔ∏è Lissage (smoothing)</span><span id="smoothingVal">0.7</span></label>
                <input type="range" id="smoothing" min="0" max="0.95" step="0.05" value="0.7">
            </div>
        </div>
        <div class="fft-debug">
            <canvas id="settingsFftCanvas" class="fft-canvas"></canvas>
        </div>
        <button class="btn-success btn-small" onclick="saveSettings()">üíæ SAUVEGARDER</button>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/";
    const HIRAGANAS = ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä'];

    let recognizer, analyser, dataArray, freqArray, animationId;
    let currentTarget = "", score = 0, questionCount = 0, currentAudioEnergy = 0;
    let audioContext, currentMode = "game";
    
    let config = {
        energyThreshold: 0.006,
        minConfidence: 0.30,
        halluThreshold: 0.92,
        smoothing: 0.7,
        probThreshold: 0.6
    };

    let calibrationData = [];
    let calibrationStep = 0;

    async function init() {
        try {
            recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Sensei pr√™t !";
            document.getElementById('actionBtn').disabled = false;
            document.getElementById('startCalibBtn').disabled = false;
            loadSettings();
            initSliders();
        } catch (e) { 
            document.getElementById('status').innerText = "Erreur chargement."; 
            console.error(e);
        }
    }

    async function setupAudio() {
        const constraints = {
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                sampleRate: { ideal: 44100 }
            }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 1024;
        analyser.smoothingTimeConstant = config.smoothing;
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.fftSize);
        freqArray = new Uint8Array(analyser.frequencyBinCount);
        return audioContext.sampleRate;
    }

    async function startQuiz() {
        document.getElementById('actionBtn').style.display = "none";
        document.getElementById('skipBtn').style.display = "block";
        currentMode = "game";
        const sr = await setupAudio();
        document.getElementById('sampleRate').innerText = sr;
        
        drawGame();

        await recognizer.listen(result => {
            const labels = recognizer.wordLabels();
            let maxScore = 0, winner = "";

            for (let i = 0; i < labels.length; i++) {
                if (result.scores[i] > maxScore) {
                    maxScore = result.scores[i];
                    winner = labels[i];
                }
            }

            if (currentAudioEnergy < config.energyThreshold) {
                document.getElementById('bestLabel').innerText = "üö´ Silence";
                return;
            }

            document.getElementById('bestLabel').innerText = winner;
            const pct = Math.round(maxScore * 100);
            document.getElementById('bestScoreText').innerText = `Confiance : ${pct}%`;
            document.getElementById('scoreBar').style.width = pct + "%";

            if (winner === currentTarget && maxScore > config.minConfidence) {
                handleWin();
            }
        }, { probabilityThreshold: config.probThreshold, overlapFactor: 0.5 });

        nextQuestion();
    }

    // --- LOGIQUE DE CAPTURE POUR DIAGNOSTIC ---
    document.getElementById('captureBtn').onclick = () => {
        if (!freqArray) return;
        const snapshot = {
            device: navigator.userAgent,
            sampleRate: audioContext.sampleRate,
            timestamp: new Date().toISOString(),
            fftData: Array.from(freqArray)
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(snapshot));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "diag_spectre_" + (navigator.platform.replace(/\s/g, '_')) + ".json");
        dl.click();
    };

    function handleWin() {
        score++;
        document.getElementById('score').innerText = score;
        document.getElementById('status').innerText = "BIEN VU !";
        document.getElementById('status').className = "status success";
        setTimeout(nextQuestion, 1500);
    }

    function nextQuestion() {
        questionCount++;
        document.getElementById('qCount').innerText = questionCount;
        currentTarget = HIRAGANAS[Math.floor(Math.random() * HIRAGANAS.length)];
        document.getElementById('targetDisplay').innerText = currentTarget;
        document.getElementById('status').innerText = "Je vous √©coute...";
        document.getElementById('status').className = "status info";
    }

    function drawGame() {
        animationId = requestAnimationFrame(drawGame);
        if (!analyser || currentMode !== "game") return;
        analyser.getByteTimeDomainData(dataArray);
        analyser.getByteFrequencyData(freqArray);
        
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const normalized = (dataArray[i] - 128) / 128;
            sum += normalized * normalized;
        }
        currentAudioEnergy = Math.sqrt(sum / dataArray.length);
        const energyPct = Math.min(100, Math.round(currentAudioEnergy * 1000));
        document.getElementById('energyLevel').innerText = energyPct + "%";
        document.getElementById('energy
