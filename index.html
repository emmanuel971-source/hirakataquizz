   <script>
//        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
//        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";
   </script>

<!DOCTYPE html>
<html>
<head>
    <title>Test Hiragana Direct</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; text-align: center; }
        #status { font-weight: bold; font-size: 1.2em; margin: 20px 0; color: #4CAF50; }
        .controls { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        button { width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #log-container { text-align: left; background: #000; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; margin-top: 20px; border: 1px solid #444; }
        .log-entry { border-bottom: 1px solid #222; padding: 5px 0; }
        input[type=range] { width: 80%; margin: 10px 0; }
    </style>
</head>
<body>

    <h1>Marathon Hiragana</h1>
    
    <div class="controls">
        <div id="status">Prêt à commencer</div>
        
        <label>Gain (Volume):</label><br>
        <input type="range" id="gain" min="1" max="50" value="10"><br>
        
        <label>Seuil de détection (Threshold):</label><br>
        <input type="range" id="threshold" min="0" max="100" value="85"><br>
        
        <button id="startButton" onclick="startMarathon()">LANCER LE TEST</button>
    </div>

    <div id="log-container"></div>

    <script>
        // --- CONFIGURATION ---
        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";

        let recognizer;
        let isRunning = false;

        async function init() {
            const checkpointURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";
            recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Modèle chargé ! Appuyez sur Start.";
        }

        async function startMarathon() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('startButton').disabled = true;
            document.getElementById('startButton').style.background = "#555";
            runCycle();
        }

        async function runCycle() {
            if (!isRunning) return;

            try {
                // 1. Demander le prochain fichier
                const res = await fetch(`${SERVER_URL}/get_next`, {
                    headers: { "ngrok-skip-browser-warning": "69" }
                });
                const data = await res.json();
                
                document.getElementById('status').innerText = "Attente du son : " + data.expected;

                // 2. Faire jouer le son par le PC
                await fetch(`${SERVER_URL}/play`, { 
                    method: 'POST',
                    headers: { "ngrok-skip-browser-warning": "69" }
                });

                // 3. Écouter sur Android
                const result = await listenOnce();

                // 4. Envoyer le log au serveur
                await fetch(`${SERVER_URL}/log`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        "ngrok-skip-browser-warning": "69"
                    },
                    body: JSON.stringify({
                        expected: data.expected,
                        filename: data.filename,
                        top1: result.word,
                        score1: result.score,
                        rms: result.rms,
                        gain: document.getElementById('gain').value
                    })
                });

                addLog(data.expected, data.filename, result.word, result.score);

                // Recommencer après un petit délai
                setTimeout(runCycle, 1500);

            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "Erreur de connexion";
                isRunning = false;
            }
        }

        async function listenOnce() {
            return new Promise(resolve => {
                const threshold = document.getElementById('threshold').value / 100;
                
                recognizer.listen(result => {
                    const scores = Array.from(result.scores);
                    const maxScore = Math.max(...scores);
                    const wordIndex = scores.indexOf(maxScore);
                    const word = recognizer.wordLabels()[wordIndex];
                    
                    recognizer.stopListening();
                    
                    resolve({
                        word: maxScore > threshold ? word : "---",
                        score: Math.round(maxScore * 100),
                        rms: 0 // Simplifié
                    });
                }, { 
                    probabilityThreshold: 0.1, 
                    overlapFactor: 0,
                    invokeCallbackOnNoiseAndUnknown: true 
                });
            });
        }

        function addLog(expected, file, got, score) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = "log-entry";
            const status = (expected === got) ? "✅" : "❌";
            entry.innerHTML = `${status} <b>${expected}</b> (${file}) -> IA a dit <b>${got}</b> (${score}%)`;
            container.insertBefore(entry, container.firstChild);
        }

        init();
    </script>
</body>
</html>


