<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Audio IA</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        #start-btn { padding: 15px 25px; font-size: 18px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #start-btn:disabled { background: #bdc3c7; }
        #journal { margin-top: 30px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .log-entry { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; }
        .log-num { color: #7f8c8d; font-weight: bold; margin-right: 10px; }
    </style>
</head>
<body>

    <h2>Analyse Audio (3 secondes)</h2>
    
    <button id="start-btn">üé§ Lancer une analyse</button>

    <div id="status" style="margin-top: 15px; font-style: italic; color: #34495e;">Pr√™t.</div>
    
    <div id="journal">
        <strong>Journal des d√©tections :</strong>
        <div id="log-container"></div>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/"; 
        let recognizer;
        let logCount = 0;

        async function initModel() {
            if (!recognizer) {
                const checkpointURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
                await recognizer.ensureModelLoaded();
            }
        }

        document.getElementById('start-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-btn');
            const status = document.getElementById('status');
            const logContainer = document.getElementById('log-container');

            btn.disabled = true;
            status.innerText = "Initialisation...";

            try {
                await initModel();

                // Gestion AudioContext pour Mobile
                const audioContext = tf.backend().audioContext || new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                status.innerText = "√âcoute en cours (3s)...";
                
                let bestDetection = { label: "", score: 0 };
                const classLabels = recognizer.wordLabels();

                // D√©marrage de l'√©coute
                recognizer.listen(result => {
                    const scores = result.scores;
                    for (let i = 0; i < scores.length; i++) {
                        // On ignore la classe "Bruit de fond" (souvent la 1√®re ou contient "Background")
                        // pour ne capturer que les sons significatifs
                        if (scores[i] > bestDetection.score && !classLabels[i].toLowerCase().includes("background") && !classLabels[i].toLowerCase().includes("bruit")) {
                            bestDetection.label = classLabels[i];
                            bestDetection.score = scores[i];
                        }
                    }
                }, { probabilityThreshold: 0.7 });

                // On attend 3 secondes
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Arr√™t
                await recognizer.stopListening();
                
                // Ajout au journal
                logCount++;
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const time = new Date().toLocaleTimeString();
                
                if (bestDetection.score > 0) {
                    entry.innerHTML = `<span class="log-num">#${logCount}</span> [${time}] <b>${bestDetection.label}</b> - ${(bestDetection.score * 100).toFixed(1)}%`;
                } else {
                    entry.innerHTML = `<span class="log-num">#${logCount}</span> [${time}] Aucun son significatif d√©tect√©.`;
                }
                
                logContainer.prepend(entry); // Ajoute en haut de la liste
                status.innerText = "Analyse termin√©e.";

            } catch (err) {
                status.innerText = "Erreur : " + err.message;
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
