<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <base target="_top">
  <style>
:root {
--brown-primary: #8B6F47; --beige-light: #F5E8C7; --beige-background: #F8F1E9; --green-primary: #A8D5BA; --green-light: #DDE6D5; --green-pale: #d4edda; --green-dark: #355E3B; --green-medium: #8BC34A; --green-bright: #4CAF50; --green-gradient-start: #66BB6A; --green-gradient-end: #81C784; --green-subtle-1: #f9fdf9; --green-subtle-2: #f5faf5; --green-subtle-3: #f0f8f0; --green-subtle-4: #ebf5eb; --pink-primary: #FDC1C5; --pink-pale: #f8d7da; --pink-light: #f8e7e6; --red-progress: #ff6b6b; --red-progress-light: #ff8e8e; --pink-subtle-1: #fdfafa; --pink-subtle-2: #fcf5f5; --pink-subtle-3: #faf0f1; --pink-subtle-4: #f8ebec; --white: #FFFFFF; --gray-very-light: #E8ECEF; --gray-light: #e0e0e0; --gray-medium: #ccc; --gray-dark: #636E72; --gray-text: #3c3f41; --blue-light: #d1e7ff; --blue-dark: #1a3c66; --blue-gradient-start: #E0F7FA; --yellow-pale: #fff3cd; --yellow-dark: #664d1a; --orange-pale: #ffe4b5; --orange-dark: #663b1a; --shadow-brown-light: rgba(139, 111, 71, 0.3); --shadow-brown-medium: rgba(139, 111, 71, 0.4); --shadow-brown-strong: rgba(139, 111, 71, 0.5); --shadow-black-light: rgba(0, 0, 0, 0.1); --shadow-black-medium: rgba(0, 0, 0, 0.15); --shadow-black-strong: rgba(0, 0, 0, 0.2); --shadow-black-dark: rgba(0, 0, 0, 0.25); --overlay-white-10: rgba(255, 255, 255, 0.1); --overlay-white-20: rgba(255, 255, 255, 0.2); --overlay-white-30: rgba(255, 255, 255, 0.3); --overlay-white-50: rgba(255, 255, 255, 0.5); --overlay-bg: rgba(248, 241, 233, 0.95); --overlay-green-08: rgba(168, 213, 186, 0.08); --overlay-green-05: rgba(168, 213, 186, 0.05); --overlay-green-03: rgba(139, 111, 71, 0.03); --overlay-green-10: rgba(168, 213, 186, 0.1); --overlay-green-20: rgba(168, 213, 186, 0.2); --overlay-green-30: rgba(168, 213, 186, 0.3); --overlay-green-40: rgba(168, 213, 186, 0.4); --overlay-green-50: rgba(168, 213, 186, 0.5); --overlay-pink-10: rgba(253, 193, 197, 0.1); --overlay-pink-50: rgba(253, 193, 197, 0.5); --overlay-red-10: rgba(220, 53, 69, 0.1); --overlay-green-success: rgba(40, 167, 69, 0.1);
}
html {touch-action: pan-x pan-y; -ms-touch-action: pan-x pan-y;}
* {user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;}
body {background: var(--beige-background); font-family: 'Noto Sans JP', sans-serif; color: var(--brown-primary); font-family: sans-serif; text-align: center; padding: 0.5em 1em 1em 1em; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;}
body::before {content: ''; position: absolute; top: 0; left: 0; background: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); opacity: 0.1; z-index: -1;}
h1 {margin: 0.5em 0; font-size: 1.8em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light);}
h2 {margin: 0.1em 0; font-size: 2.5em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light); margin-bottom: 5px;}
.menu {gap: 15px;}
#welcome {display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center;}
.panda-logo {font-size: 12em; cursor: pointer; transition: transform 0.3s ease; animation: pandaPulse 2s ease-in-out infinite;}
.panda-logo:hover {transform: scale(1.1);}
@keyframes pandaPulse {0%, 100% { transform: scale(1); } 50% { transform: scale(1.20); }}
.welcome-title {font-size: 2.5em; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light); margin-top: 50px; margin-bottom: 5px;}
.welcome-subtitle {font-size: 1.2em; color: var(--brown-primary); opacity: 0.8;}
.loading-dots {font-size: 1.5em; color: var(--brown-primary); margin-top: 30px; animation: loadingDots 1.5s infinite; margin-bottom: 1px;}
@keyframes loadingDots {0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; }}
.hidden {display: none !important;}
#unlock-progress-container{position:fixed!important;top:12px;left:50%;transform:translateX(-50%);width:90vw;max-width:600px;margin:0 auto;padding:6px 10px;background:var(--overlay-white-10);border-radius:12px;box-sizing:border-box}
.unlock-progress-bar{position:relative;height:12px;background:var(--gray-light);border:2px solid var(--gray-medium);border-radius:10px;overflow:hidden}
.unlock-progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--red-progress),var(--red-progress-light));border-radius:8px;transition:width .4s ease;position:relative}
.unlock-progress-fill.proche-deblocage{animation:pulse-unlock 1s infinite}
@keyframes pulse-unlock{0%,100%{box-shadow:0 0 8px rgba(255,107,107,.6)}50%{box-shadow:0 0 20px rgba(255,107,107,1)}}@keyframes pulse-unlock {0%, 100% { background: linear-gradient(90deg, var(--green-bright), var(--green-gradient-start)); } 50% { background: linear-gradient(90deg, var(--green-gradient-start), var(--green-gradient-end)); }}
#progressBarContainer {display: flex; align-items: center; justify-content: space-between; gap: 0.5em; margin: 1em auto 0.3em auto; max-width: 50ch; width: 100%; margin-bottom: 10px;}
.progress-bar-track {position: relative; height: 16px; background: linear-gradient(to right, var(--blue-gradient-start), var(--green-dark)); border-radius: 6px; flex: 1; box-shadow: 0 2px 4px var(--shadow-black-light);}
.progress-marker {position: absolute; top: 45%; left: 0; transform: translate(-50%, -50%); font-size: 2em; transition: left 1.5s ease; color: var(--gray-dark);}
.side-emoji {font-size: 1.6em; line-height: 1; color: var(--gray-dark);}
@keyframes pulse {0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.2); }}
.level {font-size: 1.6em; margin: 0.4em 0; margin-bottom: 50px;}
.level-hiraganas {margin: 1em auto; max-width: 800px; flex-shrink: 0; margin-bottom: 25px;}
.hiraganas-grid {display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 0.5em;}
.hiragana-card {text-align: center; transition: all 0.3s ease; position: relative; padding: 10px; background: var(--white); border-radius: 8px; box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium);}
.hiragana-card.completed {background: var(--green-light); animation: completedPulse 2s ease-in-out infinite;}
@keyframes completedPulse {0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); }}
.hiragana-char {font-size: 2.2em; font-weight: bold; margin-bottom: 6px; color: var(--brown-primary); text-shadow: 0 0 3px var(--shadow-brown-light);}
.hiragana-card.completed .hiragana-char {color: var(--green-primary); text-shadow: 0 0 5px var(--overlay-green-50); animation: starGlow 2s ease-in-out infinite;}
.stars-container {display: flex; justify-content: center; gap: 2px;}
.star {width: 12px; height: 12px; background: var(--gray-very-light); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); transition: all 0.3s ease;}
.star.filled {background: var(--pink-primary);}
.star.new-star {animation: starFill 0.5s ease-in-out;}
.hiragana-card.completed .star.filled {background: var(--green-primary); animation: starGlow 2s ease-in-out infinite;}
@keyframes starFill {0% { transform: scale(0) rotate(180deg); } 100% { transform: scale(1) rotate(0deg); }}
@keyframes starGlow {0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); }}
.firework {position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0.5em; height: 0.5em; background: transparent; pointer-events: none; animation: fireworkExplosion 700ms ease-out forwards; z-index: 10;}
@keyframes fireworkExplosion {0% { box-shadow: 0 0 #ff0, 0 0 #f00, 0 0 #0ff; opacity: 1; transform: translateX(-50%) scale(1); } 100% { box-shadow: 0 -40px #ff0, 30px -30px #f00, 40px 0 #0ff, 30px 30px #0f0, 0 40px #00f, -30px 30px #f0f, -40px 0 #fff, -30px -30px #ff0; opacity: 0; transform: translateX(-50%) scale(0.5); }}
.sakura {position: absolute; width: 100px; height: 10px; background: var(--pink-primary); border-radius: 50%; pointer-events: none; animation: sakuraFall 3s linear forwards; z-index: 10;}
@keyframes sakuraFall {0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }}
.quiz-container {flex: 1; display: flex; flex-direction: column; justify-content: space-between; min-height: 0; padding-bottom: 2em;}
.question {font-size: 4em; font-weight: bold; margin: 0.5em 0; height: 1.2em; display: flex; align-items: center; justify-content: center; color: var(--brown-primary); text-shadow: 1px 1px 2px var(--shadow-brown-medium); margin-bottom: 53px;}
.answers {display: flex; flex-wrap: wrap; justify-content: center; gap: 0.8em; margin-bottom: 1em;}
.sakura {width: 12px; height: 12px;}
.arcade-button {position: relative; background: var(--beige-light); border: 2px solid transparent; border-radius: 10px; padding: 0.8em 1.5em; color: var(--brown-primary); font-size: 1.4em; line-height: 1.2; white-space: normal; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px var(--shadow-black-strong), inset 0 2px 2px var(--overlay-white-30); transition: all 0.15s ease; text-shadow: 0 0 8px var(--shadow-brown-strong); overflow: hidden; min-width: 120px; text-align: center;}
.arcade-button::before {content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to bottom, var(--overlay-white-20), rgba(255, 255, 255, 0)); border-top-left-radius: 10px; border-top-right-radius: 10px; pointer-events: none;}
.arcade-button:hover {transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 10px var(--shadow-black-dark), inset 0 2px 2px var(--overlay-white-30);}
.arcade-button:active {transform: translateY(2px) scale(0.98); box-shadow: 0 2px 4px var(--shadow-black-strong), inset 0 1px 1px var(--overlay-white-30);}
.arcade-button:disabled {cursor: not-allowed; opacity: 0.8;}
.arcade-button.clicked {opacity: 1 !important; cursor: default;}
.arcade-button.clicked-glow {text-shadow: 0 0 12px var(--green-primary), 0 0 4px var(--green-primary); animation: glowPulse 1s ease-in-out infinite;}
.arcade-button.correct {background: var(--overlay-green-50) !important; color: var(--brown-primary); border-color: var(--green-primary); background-image: none !important; animation: correctGlow 0.6s ease-in-out; opacity: 1 !important;}
.arcade-button.correct::before {display: none;}
.arcade-button.incorrect {background: var(--overlay-pink-50) !important; color: var(--brown-primary); border-color: var(--pink-primary); background-image: none !important; animation: incorrectShake 0.6s ease-in-out; opacity: 1 !important;}
.arcade-button.incorrect::before {display: none;}
@keyframes glowPulse {0%, 100% { text-shadow: 0 0 12px var(--green-primary), 0 0 4px var(--green-primary); } 50% { text-shadow: 0 0 18px var(--green-primary), 0 0 6px var(--green-primary); }}
@keyframes correctGlow {0% { box-shadow: 0 4px 8px var(--shadow-black-strong), inset 0 2px 2px var(--overlay-white-30); } 50% { box-shadow: 0 6px 10px var(--shadow-black-dark), 0 0 20px rgba(168, 213, 186, 0.6); } 100% { box-shadow: 0 4px 8px var(--shadow-black-strong), inset 0 2px 2px var(--overlay-white-30); }}
@keyframes incorrectShake {0% { transform: translateX(0); } 10% { transform: translateX(-8px); } 20% { transform: translateX(8px); } 30% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 50% { transform: translateX(-4px); } 60% { transform: translateX(4px); } 70% { transform: translateX(-2px); } 80% { transform: translateX(2px); } 90% { transform: translateX(-1px); } 100% { transform: translateX(0); }}
.result {animation: fadeIn 0.4s ease-in; font-size: 1.3em; line-height: 1.4em; margin: 0.5em 0 0.2em 0; min-height: 4.5em; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: var(--brown-primary);}
.result-line.highlight {color: var(--brown-primary);}
@keyframes fadeIn {from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }}
#continueBtn {visibility: hidden; margin: 0.5em auto; display: block; width: fit-content;}
#boutonInstaller {margin: 0.5em auto; height: 3em; display: none;}
@keyframes confettiFall {0% { transform: translateY(0); } 100% { transform: translateY(110vh) rotate(720deg); }}
body.shake {animation: screenShake 0.4s ease-in-out;}
@keyframes screenShake {0% { transform: translate(0px, 0px); } 25% { transform: translate(4px, -4px); } 50% { transform: translate(-4px, 4px); } 75% { transform: translate(4px, 4px); } 100% { transform: translate(0px, 0px); }}
.hamburger {position: fixed; background: var(--white); border: none; border-radius: 8px; color: var(--brown-primary); padding: 12px; cursor: pointer; z-index: 1000; box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;}
.menu.active ~ .hamburger {display: none;}
.hamburger-icon {display: flex; flex-direction: column; gap: 4px; width: 20px; height: 16px;}
.hamburger-bar {width: 100%; height: 3px; background: var(--shadow-brown-light); border-radius: 2px; transition: all 0.3s ease;}
#menu-message {text-align: center !important; font-size: 2.5em !important; font-weight: 700 !important; color: var(--brown-primary) !important; border: none !important; padding: 15px !important; margin-bottom: 30px !important; border-radius: 8px !important; line-height: 1.3 !important; display: block; z-index: 1001; opacity: 0; transform: translateY(-10px); transition: opacity .45s ease, transform .45s ease;}
.menu.active #menu-message {opacity: 1; transform: translateY(0);}
.menu {position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: var(--overlay-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; transform: translateX(100%); transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; opacity: 0; z-index: 999;}
.menu.active {transform: translateX(0); opacity: 1;}
.menu .arcade-button {width: 300px !important; height: 80px !important; min-height: 80px !important; max-height: 80px !important; line-height: 80px !important; padding: 0 1.5em !important; font-size: 1.6em !important; box-sizing: border-box !important;}
.arcade-button.disabled {background: var(--gray-light) !important; color: #999999 !important; cursor: not-allowed !important; opacity: 0.6; border-color: var(--gray-medium) !important;}
.arcade-button.disabled:hover {transform: none !important; box-shadow: 0 4px 8px var(--shadow-black-strong) !important;}
.options-menu, .options-sub {display: flex; flex-direction: column !important; align-items: center; gap: 15px; width: 100%;}
.options-sub .arcade-button, .options-menu .arcade-button {width: 300px !important;}
.options-sub .arcade-button:first-child {margin-bottom: 20px;}
.options-sub {opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease;}
.options-sub.active {opacity: 1; transform: translateY(0);}
.section {display: none;}
.section.active {display: flex; flex-direction: column; height: 100vh;}
#revision-question {font-size: 1.5em; margin-top: 50px; margin-bottom: 30px; color: var(--brown-primary); text-shadow: 1px 1px 2px var(--shadow-brown-medium);}
.char-correct {background-color: var(--green-pale); border-radius: 5px; padding: 2px 4px;}
.char-incorrect {background-color: var(--pink-light); border-radius: 5px; padding: 2px 4px;}
.pulsing {animation: revisionPulse 0.8s infinite;}
@keyframes revisionPulse {0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); }}
#revision-input-display {font-size: 2em; margin: 0 auto 10px auto; height: 65px; padding: 10px; border: 2px solid transparent; border-radius: 8px; width: 300px; text-align: center; background: var(--white); box-shadow: 0 4px 8px var(--shadow-black-light); display: flex; align-items: center; justify-content: center; overflow: hidden;}
.revision-keyboard {display: grid; grid-template-columns: repeat(5, 60px); gap: 8px; justify-content: center; margin-bottom: 10px; margin-top: 0;}
.revision-key {width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; border-radius: 10px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 1.2em; position: relative; overflow: hidden; touch-action: manipulation; background: linear-gradient(145deg, var(--overlay-white-30), var(--overlay-white-10)); box-shadow: inset 0 2px 4px var(--shadow-black-light), 0 4px 8px var(--shadow-black-medium); text-shadow: 0 1px 2px var(--shadow-black-strong);}
.revision-key:active, .revision-key.active {animation: pressAndRelease 0.3s ease forwards;}
.revision-key::after {content: ''; position: absolute; width: 100px; height: 100px; background: linear-gradient(45deg, transparent, var(--overlay-white-50), transparent); transform: translateX(-100%) rotate(45deg); transition: transform 0.3s ease; pointer-events: none;}
.revision-key:active::after, .revision-key.active::after {transform: translateX(100%) rotate(45deg);}
@keyframes pressAndRelease {0% { transform: translateY(0); box-shadow: inset 0 2px 4px var(--shadow-black-light), 0 4px 8px var(--shadow-black-medium); } 50% { transform: translateY(3px); box-shadow: inset 0 2px 4px var(--shadow-black-strong), 0 1px 2px var(--shadow-black-light); } 100% { transform: translateY(0); box-shadow: inset 0 2px 4px var(--shadow-black-light), 0 4px 8px var(--shadow-black-medium); }}
.revision-key:nth-child(-n+5) {background-color: var(--blue-light); color: var(--blue-dark);}
.revision-key:nth-child(6), .revision-key:nth-child(7) {background-color: var(--yellow-pale); color: var(--yellow-dark);}
.revision-key:nth-child(8) {background-color: var(--blue-light); color: var(--blue-dark);}
.revision-key:nth-child(9), .revision-key:nth-child(10) {background-color: var(--pink-light); color: #661a1a;}
.revision-key:nth-child(n+11):nth-child(-n+15) {background-color: var(--green-pale); color: #1a6642;}
.revision-key:nth-child(n+16):nth-child(-n+20) {background-color: var(--orange-pale); color: var(--orange-dark);}
.revision-key:nth-child(n+21):nth-child(-n+24) {background-color: var(--gray-light); color: var(--gray-text);}
.revision-key:nth-child(25) {background-color: var(--white); color: #333333;}
#revision-message {margin-top: 10px; margin-bottom: 10px; font-size: 1.8em; color: var(--brown-primary); min-height: 1.5em;}
.char-card {display: inline-flex; padding: 15px; margin: 5px; border-radius: 8px; min-width: 60px; min-height: 60px; text-align: center; font-size: 2.2em; font-weight: bold; color: var(--brown-primary); text-shadow: 0 0 3px var(--shadow-brown-light); background: var(--white); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); transition: all 0.4s ease; align-items: center; justify-content: center;}
.char-correct-1 {background: var(--green-subtle-1); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 2px rgba(139, 195, 74, 0.1);}
.char-correct-2 {background: var(--green-subtle-2); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 3px rgba(139, 195, 74, 0.15);}
.char-correct-3 {background: var(--green-subtle-3); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(139, 195, 74, 0.2);}
.char-correct-4 {background: var(--green-subtle-4); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 5px rgba(139, 195, 74, 0.25);}
.char-incorrect-1 {background: var(--pink-subtle-1); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 2px var(--overlay-pink-10);}
.char-incorrect-2 {background: var(--pink-subtle-2); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 3px rgba(253, 193, 197, 0.15);}
.char-incorrect-3 {background: var(--pink-subtle-3); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(253, 193, 197, 0.2);}
.char-incorrect-4 {background: var(--pink-subtle-4); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 5px rgba(253, 193, 197, 0.25);}
.pulsing {animation: pulse-revision 1.8s infinite ease-in-out;}
@keyframes pulse-revision {0% { transform: scale(1); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); } 50% { transform: scale(1.08); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 4px 8px var(--shadow-black-strong), 0 0 8px var(--shadow-brown-light); } 100% { transform: scale(1); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); }}
#mode2 .title {margin: 0.5em 0; font-size: 1.8em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light);}
.account-section {padding: 2em; max-width: 500px; margin: 0 auto; text-align: center;}
.pseudo-display {font-size: 2.5em; font-weight: bold; color: var(--brown-primary); margin: 1em 0; padding: 0.5em; background: var(--white); border-radius: 12px; box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); min-height: 1.5em; display: flex; align-items: center; justify-content: center;}
.pin-input-container {margin: 2em 0;}
.pin-input {font-size: 2em; padding: 0.5em; width: 200px; text-align: center; border: 2px solid var(--brown-primary); border-radius: 8px; background: var(--white); box-shadow: 0 4px 8px var(--shadow-black-light);}
.pin-input:focus {outline: none; border-color: var(--green-primary); box-shadow: 0 6px 12px var(--overlay-green-40);}
.pin-label {font-size: 1.2em; color: var(--brown-primary); margin-bottom: 0.5em; display: block;}
.account-info {margin: 2em auto; padding: 1em; background: var(--overlay-white-50); border-radius: 8px; max-width: 460px; width: 100%; text-align: center; box-sizing: border-box;}
.account-info-line {font-size: 1.2em; color: var(--brown-primary); margin: 0.8em 0;}
.button-group {display: flex; flex-direction: column; gap: 1em; margin: 2em auto 0; max-width: 400px; width: 100%; padding: 0 1em; box-sizing: border-box;}
.error-message {color: #dc3545; font-size: 1.1em; margin: 1em auto; padding: 0.5em; background: var(--overlay-red-10); border-radius: 8px; max-width: 400px; text-align: center;}
.success-message {color: #28a745; font-size: 1.1em; margin: 1em 0; padding: 0.5em; background: var(--overlay-green-success); border-radius: 8px;}
/* Loader zen */
html,body{height:100%;margin:0;padding:0}body{display:flex;align-items:center;justify-content:center;min-height:100dvh;overflow:hidden}
.zen-loader-container{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;opacity:1;transition:opacity .6s ease}.zen-loader-container.hidden{opacity:0;pointer-events:none}
.zen-circle-loader { width: 120px; height: 120px; border: 4px solid rgba(139, 111, 71, 0.2); border-top-color: var(--brown-primary); border-radius: 50%; animation: zen-spin 1.5s ease-in-out infinite; display: flex; align-items: center; justify-content: center; }
.bamboo-leaf { font-size: 3em; animation: leaf-float 2s ease-in-out infinite; }
@keyframes zen-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes leaf-float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(180deg); } }
.zen-loader-text { margin-top: 30px; font-size: 1.3em; color: var(--brown-primary); animation: pulse-text 1.5s ease-in-out infinite; }
@keyframes pulse-text { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
.welcome-animation-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100vw;position:fixed;top:0;left:0;background:linear-gradient(135deg,#f5f5dc 0%,#e8e8d0 100%)!important;overflow:hidden;z-index:9999}#welcome-screen {position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9998;}
.welcome-user-title {font-size: 3em; color: var(--brown-primary); text-shadow: 0 0 20px var(--overlay-pink-50); animation: welcome-fade-in 1s ease-out; z-index: 10; text-align: center; padding: 0 20px;}
.welcome-user-subtitle {font-size: 1.5em; color: var(--brown-primary); opacity: 0.8; margin-top: 20px; animation: welcome-fade-in 1s ease-out 0.5s both; z-index: 10; text-align: center; padding: 0 20px;}
@keyframes welcome-fade-in {0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); }}
.sakura-rain {position: absolute; width: 100%; height: 100%; pointer-events: none;}
.validation-bubble {position: absolute; top: -22px; right: -22px; padding: 6px 10px; border-radius: 10px; font-weight: bold; font-size: 1em; color: var(--brown-primary); background: var(--white); box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(139, 111, 71, 0.15); opacity: 0; transform: scale(0.8); pointer-events: none; transition: opacity 0.6s ease, transform 0.6s ease, background 0.6s ease; z-index: 999;}
.validation-bubble.show {opacity: 1; transform: scale(1);}
.validation-bubble.fade-out {opacity: 0; transform: scale(0.8);}
.validation-bubble.green-1 { background: var(--green-subtle-1); }
.validation-bubble.green-2 { background: var(--green-subtle-2); }
.validation-bubble.green-3 { background: var(--green-subtle-3); }
.validation-bubble.green-4 { background: var(--green-subtle-4); }
.validation-bubble.red-1 { background: var(--pink-subtle-1); }
.validation-bubble.red-2 { background: var(--pink-subtle-2); }
.validation-bubble.red-3 { background: var(--pink-subtle-3); }
.validation-bubble.red-4 { background: var(--pink-subtle-4); }
.validation-bubble.green-1, .validation-bubble.green-2, .validation-bubble.green-3, .validation-bubble.green-4 {box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(139, 195, 74, 0.2);}
.validation-bubble.red-1, .validation-bubble.red-2, .validation-bubble.red-3, .validation-bubble.red-4 {box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(253, 193, 197, 0.2);}
.stats-filters {display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 2em auto 1em auto; max-width: 1000px; padding: 0 1em;}
.filter-btn {font-size: 1em !important; padding: 0.6em 1.2em !important; min-width: auto !important; height: auto !important; line-height: normal !important;}
.filter-btn.active {background: var(--overlay-green-30) !important; border-color: var(--green-primary) !important;}
.stats-table-container {padding-top: 70px; margin: 1em auto 2em auto; max-width: 1000px; padding: 0 1em; max-height: 60vh; overflow-y: auto; position: relative; padding: 1em; box-sizing: border-box;}
.stats-table {width: 100%; background: var(--white); border-radius: 12px 12px 0 0; box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); border-collapse: separate; border-spacing: 0; box-shadow: none;}
.stats-table thead {background: rgba(139, 111, 71, 0.1); position: sticky; top: 0;}
.stats-table th {padding: 1em; text-align: center; font-weight: bold; color: var(--brown-primary); border-bottom: 2px solid rgba(139, 111, 71, 0.2); background: rgba(139, 111, 71, 0.1);}
.stats-table td {padding: 1em; color: var(--brown-primary); text-align: center; border-bottom: 1px solid rgba(139, 111, 71, 0.1); font-size: 1.2em;}
.stats-table tbody tr {transition: background 0.2s ease;}
.stats-table tbody tr:hover {background: rgba(139, 111, 71, 0.05);}
.status-emoji {font-size: 1.8em; display: inline-block;}
.stats-table tbody tr.acquired {background: var(--overlay-green-08);}
.stats-table tbody tr.review {background: var(--overlay-green-05);}
.stats-table tbody tr.progress {background: var(--overlay-green-03);}
.pseudo-input-wrapper {margin: 20px auto; display: flex; justify-content: center; width: 100%; padding: 0 20px; box-sizing: border-box;}
.pseudo-input {width: 100%; max-width: 300px; padding: 15px 20px; font-size: 1.8em; font-weight: bold; text-align: center; color: var(--brown-primary); background: var(--overlay-green-10); border: 3px solid var(--brown-primary); border-radius: 15px; outline: none; transition: all 0.3s ease; font-family: inherit; box-sizing: border-box;}
.pseudo-input:focus {background: var(--overlay-green-20); border-color: var(--green-primary); box-shadow: 0 0 15px var(--overlay-green-50); transform: scale(1.02);}
.pseudo-input::placeholder {color: var(--shadow-brown-medium); font-style: italic;}
.secondary-button {background: rgba(139, 111, 71, 0.1) !important; border: 2px solid var(--brown-primary) !important; color: var(--brown-primary) !important; font-size: 0.9em !important;}
.secondary-button:hover {background: rgba(139, 111, 71, 0.2) !important; transform: scale(1.02);}
.onboarding-step {display: none; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; max-width: 500px; margin: 0 auto; padding: 20px; box-sizing: border-box;}
.onboarding-step.active {display: block; opacity: 1;}
.onboarding-title {font-size: 2em; color: var(--brown-primary); text-align: center; margin-bottom: 30px; text-shadow: 0 2px 4px var(--shadow-black-light);}
.onboarding-content {background: var(--overlay-green-05); border-radius: 20px; padding: 30px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);}
.onboarding-subtitle {text-align: center; font-size: 1.2em; color: var(--brown-primary); margin-bottom: 30px; opacity: 0.8;}
.onboarding-buttons {display: flex; flex-direction: column; gap: 15px; margin: 30px auto 0; max-width: 400px; width: 100%; box-sizing: border-box;}
.large-button {font-size: 1.3em !important; padding: 20px 30px !important; min-height: 70px;}
.primary-button {background: linear-gradient(135deg, var(--green-primary), var(--green-medium)) !important; box-shadow: 0 4px 15px var(--overlay-green-40);}
.primary-button:hover {transform: scale(1.05); box-shadow: 0 6px 20px rgba(168, 213, 186, 0.6);}
.small-button {font-size: 0.9em !important; padding: 10px 20px !important;}
.confirmation-box {background: var(--overlay-green-10); border: 2px solid var(--green-primary); border-radius: 15px; padding: 25px; margin: 20px 0; text-align: center;}
.confirmation-question {font-size: 1.1em; color: var(--brown-primary); margin-bottom: 10px;}
.confirmation-date {font-size: 1.8em; font-weight: bold; color: var(--brown-primary); margin: 10px 0;}
.warning-box {background: var(--overlay-pink-10); border: 2px solid var(--pink-primary); border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;}
.warning-box p {color: #dc3545; font-weight: bold; margin: 0; font-size: 0.95em;}
.pin-example {font-size: 0.9em; color: var(--brown-primary); margin-top: 10px; text-align: center; opacity: 0.7;}
.birthdate-selectors {display: flex; gap: 15px; justify-content: center; margin: 20px 0;}
.selector-group {display: flex; flex-direction: column; gap: 8px; flex: 1; max-width: 150px;}
.selector-label {font-size: 0.9em; color: var(--brown-primary); font-weight: bold; text-align: center;}
.birthdate-select {width: 100%; padding: 12px 10px; font-size: 1.2em; font-weight: bold; text-align: center; color: var(--brown-primary); background: var(--overlay-green-10); border: 3px solid var(--brown-primary); border-radius: 10px; outline: none; cursor: pointer; transition: all 0.3s ease; font-family: inherit; box-sizing: border-box;}
.birthdate-select:focus {background: var(--overlay-green-20); border-color: var(--green-primary); box-shadow: 0 0 15px var(--overlay-green-50); transform: scale(1.02);}
.birthdate-select option {background: var(--beige-background); color: var(--brown-primary); padding: 10px;}
@media (min-width: 769px) {.hamburger {top: 20px; left: 20px; width: 44px; height: 44px;}.hamburger:hover .hamburger-bar {background: var(--brown-primary);}.hamburger:hover {box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 4px 8px var(--shadow-black-strong); transform: translateY(-1px);}#unlock-progress-container{top:16px}.unlock-progress-bar{height:16px}}
@media (max-width: 480px) and (-webkit-min-device-pixel-ratio: 2) {h1 {font-size: 1.4em; margin: 0.1em 0;} h2 {font-size: 1.4em; margin: 0 0;} .menu {gap: 10px;} .panda-logo {font-size: 8em;} .welcome-title {font-size: 1.4em;} .welcome-subtitle {font-size: 1em;} .loading-dots {font-size: 1.4em;} #unlock-progress-container{top:10px;padding:5px 8px}.unlock-progress-bar{height:8px;border-width:1px} #progressBarContainer {max-width: 90%; margin: 1.5em auto 0.5em auto; gap: 1em;} .progress-bar-track {height: 12px; border-radius: 4px;} .progress-marker {font-size: 2.0em; top: 45%; transform: translate(-50%, -50%);} .side-emoji {font-size: 1.2em;} .level {font-size: 1.0em; margin: 0.4em 0; margin-bottom: 25px;} #quiz {overflow-x: hidden; width: 100%; box-sizing: border-box;} .level-hiraganas {width: 100%; padding: 0; margin: 0; box-sizing: border-box;} .hiraganas-grid {width: 95%; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; box-sizing: border-box;} .hiragana-card {flex: 1 1 calc((100% - 24px) / 5); min-width: 0; height: 80px; text-align: center; transition: all 0.3s ease; position: relative; padding: 8px 2px; background: var(--white); border-radius: 6px; box-shadow: 0 2px 4px var(--shadow-black-strong), 0 1px 2px var(--shadow-black-light); display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box;} .hiragana-char {font-size: 1.4em; margin-bottom: 0; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word; flex-grow: 1; display: flex; align-items: center; justify-content: center;} .stars-container {display: flex; justify-content: center; gap: 1px; width: 100%; padding: 0; margin-top: auto;} .star {width: 10px; height: 10px; flex-shrink: 0;} .quiz-container {flex: 1; display: flex; flex-direction: column; justify-content: flex-start; min-height: 0; padding-bottom: 2em;} .question {font-size: 3em; font-weight: bold; margin: 0.5em 0; height: 1.2em; display: flex; align-items: center; justify-content: center; text-shadow: 1px 1px 2px var(--shadow-brown-medium);} .answers {display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; width: 98%; padding: 0; margin: 0 auto 0.6em auto; box-sizing: border-box;} .answers .arcade-button {flex: 1; min-width: 0; width: 100%; font-size: 1.30em; aspect-ratio: 1 / 0.6; box-sizing: border-box; padding: 6px 4px; border-radius: 3px; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; text-align: center;} button, a, input, textarea {-webkit-tap-highlight-color: transparent;} .sakura {width: 10px; height: 10px;} .result {margin-top: 1em; text-align: center; word-break: break-word; white-space: normal; display: block; min-height: auto;} .result > * {width: 100%;} .result-line {font-size: 1.2em; width: 100%; text-align: center;} .result-line.highlight {line-height: 1.0; margin-top: 0.5em; font-size: 1.0em;} #continueBtn {margin-top: 1em; margin-bottom: 1em; height: 3em; border-radius: 8px; border: 4px solid transparent;} #boutonInstaller {margin-top: 1em; margin-bottom: 1em; height: 3em;} .hamburger {position: fixed !important; bottom: 10px !important; right: 10px !important; left: auto !important; top: auto !important; width: 40px !important; height: 40px !important; padding: 10px; display: flex; box-sizing: border-box;} .hamburger-icon {width: 30px; height: 22px; gap: 6px;} .hamburger-bar {height: 4px; background: var(--shadow-brown-medium);} #menu-message {font-size: 1.2em !important; padding: 10px !important; margin-bottom: 100px !important; line-height: 1.2 !important;} .menu .arcade-button {width: 700px !important; font-size: 1.4em !important; padding: 0.2em 1em !important; line-height: 60px !important; height: 60px !important; max-height: 60px !important; border: 2px solid transparent;} @supports (-webkit-appearance: none) {.menu .arcade-button {width: min(80vw, 700px) !important; height: 60px !important; max-height: 60px !important; line-height: 60px !important; padding: 0.2em 1em !important; border: 2px solid transparent;}} #revision-question {font-size: 1em; margin-top: 35px;} #revision-input-display {height: 23px; font-size: 1.8em; width: 80%; padding: 05px; position: fixed; bottom: calc(85vw + 83px); left: 50%; transform: translateX(-50%);} #revision-message {position: fixed; bottom: calc(85vw + 130px); left: 50%; transform: translateX(-50%); width: 80%; text-align: center; line-height: 1.0; font-size: 1.0em; margin-bottom: 0; font-weight: bold;} .revision-keyboard {gap: 7px; grid-template-columns: repeat(5, 1fr); width: 85%; padding: 0 5px; position: fixed; bottom: calc(60px - 5vw); left: 50%; transform: translateX(-50%);} .revision-key {width: 100%; height: auto; aspect-ratio: 1; min-width: 50px; font-size: clamp(2.5em, 8vw, 5em); font-weight: bold; line-height: 1;} .char-card {display: inline-flex; padding: 5px; margin: 5px; border-radius: 8px; min-width: 60px; min-height: 60px; text-align: center; font-size: 2.2em; font-weight: bold; color: var(--brown-primary); text-shadow: 0 0 3px var(--shadow-brown-light);} #mode2 .title {margin: 0.1em 0; font-size: 1em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light);} .account-section {padding: 1em;} .pseudo-display {font-size: 1.8em; padding: 0.4em;} .pin-input {font-size: 1.5em; width: 150px;} .pin-label {font-size: 1em;} .account-info-line {font-size: 1em;} .zen-circle-loader {width: 80px; height: 80px; border: 3px solid rgba(139, 111, 71, 0.2); border-top-color: var(--brown-primary);} .bamboo-leaf {font-size: 2em;} .zen-loader-text {font-size: 1em; margin-top: 20px;} .welcome-user-title {font-size: 1.8em;} .welcome-user-subtitle {font-size: 1.1em; margin-top: 15px;} .validation-bubble {top: -14px; right: -14px; padding: 4px 7px; border-radius: 6px; font-size: 0.8em; box-shadow: 0 3px 6px var(--shadow-black-strong), 0 1px 3px var(--shadow-black-light), inset 0 0 3px rgba(139, 111, 71, 0.1);} .stats-filters {gap: 5px; margin: 1em auto 0.5em auto;} .filter-btn {font-size: 0.85em !important; padding: 0.5em 0.8em !important;} .stats-table-container {box-shadow: 0 6px 12px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium); border-radius: 12px; background: white; margin: 0.5em auto 1em auto; max-height: 50vh;} .stats-table th, .stats-table td {padding: 0.6em 0.3em; font-size: 0.9em;} .stats-table th {font-size: 0.8em; padding: 0.8em 0.3em;} .status-emoji {font-size: 1.5em;} .onboarding-step {padding: 15px 10px;} .onboarding-title {font-size: 1.4em; margin-bottom: 20px;} .onboarding-content {padding: 20px 15px;} .onboarding-subtitle {font-size: 1em; margin-bottom: 20px;} .large-button {font-size: 1em !important; padding: 15px 20px !important; min-height: 55px; width: 100%; box-sizing: border-box;} .small-button {font-size: 0.85em !important; padding: 8px 15px !important;} .pseudo-input-wrapper {padding: 0 10px;} .pseudo-input {font-size: 1.4em; padding: 12px 15px; max-width: 100%;} .pin-input {font-size: 1.8em; padding: 12px 15px; max-width: 200px;} .confirmation-date {font-size: 1.3em;} .confirmation-box {padding: 20px 15px;} .warning-box {padding: 12px;} .warning-box p {font-size: 0.85em;} .onboarding-buttons {gap: 12px; margin-top: 20px;} .birthdate-selectors {gap: 10px;} .selector-group {max-width: 130px;} .birthdate-select {font-size: 1em; padding: 10px 8px;}}
@media (min-width: 481px) and (max-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) {h1 {font-size: 2.2em; margin: 0.15em 0;} h2 {font-size: 2.5em; margin: 0.15em 0;} .menu {gap: 15px;} .panda-logo {font-size: 15em;} .welcome-title {font-size: 3em;} .welcome-subtitle {font-size: 2em;} .loading-dots {font-size: 2.5em;} .unlock-progress-bar{height:14px} #progressBarContainer {max-width: 80%; margin: 1.2em auto 0.3em auto; gap: 1em;} .progress-bar-track {height: 20px; border-radius: 8px;} .progress-marker {font-size: 3.2em; top: 45%; transform: translate(-50%, -50%);} .side-emoji {font-size: 2.0em;} .level {font-size: 1.2em; margin: 0.4em 0; margin-bottom: 30px;} #quiz {overflow-x: hidden; width: 100%; box-sizing: border-box;} .level-hiraganas {width: 100%; padding: 0; margin: 0; box-sizing: border-box;} .hiraganas-grid {width: 95%; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; box-sizing: border-box;} .hiragana-card {flex: 1 1 calc((100% - 40px) / 5); min-width: 0; height: 120px; text-align: center; transition: all 0.3s ease; position: relative; padding: 8px 2px; background: var(--white); border-radius: 6px; box-shadow: 0 2px 4px var(--shadow-black-strong), 0 1px 2px var(--shadow-black-light); display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box;} .hiragana-char {font-size: 2.8em; margin-bottom: 0; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word; flex-grow: 1; display: flex; align-items: center; justify-content: center;} .stars-container {display: flex; justify-content: center; gap: 4px; width: 100%; padding: 0; margin-top: auto;} .star {width: 16px; height: 16px; flex-shrink: 0;} .quiz-container {flex: 1; display: flex; flex-direction: column; justify-content: flex-start; min-height: 0; padding-bottom: 0.5em;} .question {font-size: 3.5em; font-weight: bold; margin: 0.5em 0; height: 1.2em; display: flex; align-items: center; justify-content: center; text-shadow: 1px 1px 2px var(--shadow-brown-medium);} .answers {display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 95%; padding: 0; margin: 0 auto 0.5em auto; box-sizing: border-box;} .answers .arcade-button {flex: 1; min-width: 0; width: 98%; font-size: 2.5em; aspect-ratio: 1 / 0.5; box-sizing: border-box; padding: 8px 4px; border-radius: 8px; border: 4px solid transparent; display: flex; align-items: center; justify-content: center; text-align: center;} button, a, input, textarea {-webkit-tap-highlight-color: transparent;} .sakura {width: 10px; height: 10px;} .result {margin-top: 1em; text-align: center; word-break: break-word; white-space: normal; display: block; min-height: auto;} .result > * {width: 100%;} .result-line {font-size: 1.8em; width: 100%; text-align: center;} .result-line.highlight {line-height: 1.8; margin-top: 0.4em; font-size: 1.8em;} #continueBtn {font-size: 1.8em; margin-top: 1em; margin-bottom: 0.1em; height: 2.4em; border: 4px solid transparent;} #boutonInstaller {margin-top: 1em; margin-bottom: 1em; height: 3em;} .hamburger {position: fixed !important; bottom: 20px !important; right: 20px !important; left: auto !important; top: auto !important; width: 66px !important; height: 66px !important; padding: 20px; display: flex; box-sizing: border-box;} .hamburger-icon {width: 36px; height: 28px; gap: 6px;} .hamburger-bar {height: 4px; background: var(--shadow-brown-medium);} #menu-message {font-size: 2.6em !important; padding: 8px !important; margin-bottom: 120px !important; line-height: 1.2 !important;} .menu .arcade-button {width: 400px !important; font-size: 2.6em !important; padding: 0.2em 1em !important; line-height: 100px !important; height: 100px !important; max-height: 100px !important; border: 5px solid transparent;} @supports (-webkit-appearance: none) {.menu .arcade-button {width: min(80vw, 400px) !important; height: 100px !important; max-height: 100px !important; line-height: 50px !important; padding: 0.2em 1em !important; border: 5px solid transparent;}} #revision-question {font-size: 1em; margin-top: 50px;} #revision-input-display {height: 40px; font-size: 1.8em; width: 60%; padding: 05px; position: fixed; bottom: calc(60vw + 120px); left: 50%; transform: translateX(-50%);} #revision-message {position: fixed; bottom: calc(60vw + 185px); left: 50%; transform: translateX(-50%); width: 60%; text-align: center; line-height: 1.0; font-size: 1.5em; margin-bottom: 0; font-weight: bold;} .revision-keyboard {gap: 7px; grid-template-columns: repeat(5, 1fr); width: 60%; padding: 0 5px; position: fixed; bottom: calc(120px - 5vw); left: 50%; transform: translateX(-50%);} .revision-key {width: 100%; height: auto; aspect-ratio: 1; min-width: 50px; font-size: clamp(2.5em, 8vw, 5em); font-weight: bold; line-height: 1;} .char-card {display: inline-flex; padding: 3px; margin: 3px; border-radius: 8px; min-width: 100px; min-height: 100px; text-align: center; font-size: 4em; font-weight: bold; color: var(--brown-primary); text-shadow: 0 0 3px var(--shadow-brown-light);} #mode2 .title {margin: 0.1em 0; font-size: 1em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light);} .pseudo-display {font-size: 2.2em;} .pin-input {font-size: 1.8em; width: 180px;} .zen-circle-loader {width: 100px; height: 100px;} .bamboo-leaf {font-size: 2.5em;} .zen-loader-text {font-size: 1.2em;} .welcome-user-title {font-size: 2.5em;} .welcome-user-subtitle {font-size: 1.3em;} .validation-bubble {top: -20px; right: -20px; padding: 5px 8px; border-radius: 8px; font-size: 1.2em; box-shadow: 0 5px 10px var(--shadow-black-dark), 0 3px 6px var(--shadow-black-medium), inset 0 0 4px rgba(139, 111, 71, 0.15);} .filter-btn {font-size: 1.2em !important; padding: 0.7em 1em !important;} .stats-table-container {max-height: 55vh;} .stats-table th, .stats-table td {padding: 0.9em; font-size: 1.1em;} .status-emoji {font-size: 1.6em;} .onboarding-buttons {width: 400px !important; display: flex; flex-direction: column; gap: 15px; margin-top: 30px;}}
@media screen and (max-width: 768px), screen and (-webkit-min-device-pixel-ratio: 2) {#mode2 .title {margin: 0.1em 0; font-size: 1em; text-align: center; color: var(--brown-primary); text-shadow: 0 1px 2px var(--shadow-brown-light);}}  
@supports(padding-top:env(safe-area-inset-top)){#unlock-progress-container{top:max(12px,env(safe-area-inset-top))}}
/* ====================== MON JARDIN ====================== */
#stats h1 { margin-bottom: 0.2em; font-size: 2.2em; }
.garden-legend { position: sticky; top: 0; background: var(--beige-background); padding: 0.6em 1em; font-size: 1em; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10; opacity: 0; transition: opacity 0.4s; display: flex; justify-content: center; gap: 2em; border-bottom: 2px solid var(--brown-primary); }
.garden-legend.visible { opacity: 1; }
.garden-container { flex: 1; overflow-y: auto; background: #F8F1E9; position: relative; -webkit-overflow-scrolling: touch; }
.garden-ground { min-height: 100%; padding: 2em 1em 2em; display: flex; flex-direction: column-reverse; gap: 4em; align-items: center; background: #F8F1E9; overflow: visible; }
.garden-level { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.8em; justify-items: center; max-width: 100%; }
.garden-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; width: 100%; aspect-ratio: 1; min-width: 0; }
.garden-item:hover { transform: scale(1.15); }
.garden-plant { font-size: 3.4em; margin-bottom: 0.1em; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); transition: all 0.4s ease; }
.garden-hiragana { font-size: 1.4em; font-weight: bold; color: var(--brown-primary); }
.garden-decor { position: absolute; font-size: 3em; opacity: 0.4; pointer-events: none; z-index: 1; }
.garden-bug { display: flex; align-items: center; justify-content: center; opacity: 0.85; }
.garden-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; pointer-events: none; }
.garden-modal.visible { opacity: 1; visibility: visible; pointer-events: auto; }
.garden-card { background: var(--white); padding: 2em 2.5em; border-radius: 20px; text-align: center; max-width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
.garden-card h2 { margin: 0 0 0.5em; font-size: 3.5em; }
.garden-card .katakana { font-size: 2.2em; margin: 0.6em 0; color: #8B6F47; }
.garden-card .romaji { font-size: 1.8em; margin: 0.8em 0; color: #555; }
.garden-card .info { margin: 1em 0; font-size: 1.2em; }
.garden-card .close-btn { margin-top: 1.5em; padding: 0.8em 2em; font-size: 1.2em; }
@media (max-width: 480px) and (-webkit-min-device-pixel-ratio: 2) { .garden-plant { font-size: 2.0em; } .garden-bug { font-size: 0.8em; } .garden-hiragana { font-size: 1.0em; } .garden-level { gap: 0.5em; grid-template-columns: repeat(5, 1fr); padding: 0 0.5em; width: 95%; } .garden-item { aspect-ratio: 1; } }
@media (min-width: 481px) and (max-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) { .garden-plant { font-size: 2.7em; } .garden-hiragana { font-size: 1.2em; } .garden-level { gap: 1.4em; } .garden-legend { gap: 1em; font-size: 0.9em; } }

  </style>
</head>
<body>
  <script>
  console.log('üîç TEST - Langue navigateur:', navigator.language);
  console.log('üîç TEST - localStorage avant:', localStorage.getItem('appLanguage'));
</script>
  <!-- Bouton hamburger  <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>  -->
<!-- Bouton hamburger -->
<button class="hamburger" onclick="toggleMenu()">

  <div class="hamburger-icon">
    <div class="hamburger-bar"></div>
    <div class="hamburger-bar"></div>
    <div class="hamburger-bar"></div>
  </div>
</button>
<!-- Menu -->

<nav class="menu" id="menu">
<!--   <div id="menu-message" class="menu-message"></div>  -->
  <button class="arcade-button" onclick="showSection('quiz')" data-i18n="menu_learn">Apprendre</button>
  <button class="arcade-button" id="revision-button" onclick="showSection('mode2')" data-i18n="menu_revision">Mode r√©visions</button>
  <button class="arcade-button" onclick="showSection('stats')" data-i18n="menu_stats">Mes stats</button>
  <button class="arcade-button" onclick="showSection('options')" data-i18n="menu_options">Options</button>
  <button class="arcade-button" onclick="showSection('account')" data-i18n="account_title">Mon compte</button>
<!--   <button class="arcade-button" onclick="toggleMenu()" data-i18n="menu_close">Fermer</button>  -->
</nav>

<!-- Section Page d'accueil -->
<div id="welcome" class="section active">
  <div class="panda-logo" onclick="">üêº</div>
  <h1 class="welcome-title" data-i18n="welcome_title">üéåüå∏ Kanas-Zen-Garden üå∏üéå</h1>
  <p class="welcome-subtitle" data-i18n="welcome_subtitle">Apprenez √† lire le Japonais</p>
  <div class="loading-dots" id="loadingText" data-i18n="welcome_loading_dots">(Chargement... )</div>

<!-- ‚úÖ NOUVEAU : Barre de progression -->
<div id="loading-progress-container" style="display: none; width: 80%; max-width: 400px; margin: 20px auto;">
  <div style="background: rgba(139, 111, 71, 0.2); border-radius: 10px; overflow: hidden; height: 10px;">
    <div id="loading-progress-fill" style="background: linear-gradient(90deg, #d4edda, #d4edda); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
  </div>
<!--   <div id="loading-message" style="text-align: center; margin-top: 10px; font-size: 1em; color: #8B6F47;"></div> -->
</div>
</div>
  <!-- Section Menu -->


<!-- Section Quiz -->
<div id="quiz" class="section">
<!--   <h1 data-i18n="quiz_title">üéå‚õ©Ô∏è Apprenez les Kanas ‚õ©Ô∏èüéå</h1>  -->
  <div id="progressBarContainer"></div>
  <div class="level" id="levelDisplay"><span data-i18n="quiz_level_display">Niveau actuel :</span> <span id="levelNumber">1</span></div>
    <div class="level-hiraganas">
      <div class="hiraganas-grid" id="hiraganaCards"></div>
    </div>
    <div class="quiz-container">
      <div class="question" id="question" data-i18n="quiz_question_load">load...</div>
      <div>
        <div class="answers" id="choices1"></div>
        <div class="answers" id="choices2"></div>
      </div>
      <div>
        <div class="result" id="result"></div>
  <button class="arcade-button" id="continueBtn" onclick="nextQuestion()" data-i18n="quiz_continue">üå± OK... j'ai capt√© üå±</button>
  <button class="arcade-button" id="boutonInstaller" data-i18n="quiz_install">Ajouter √† l'√©cran d'accueil</button>
</div>
    </div>
  </div>

  <!-- Section Mode Katakana -->
<!-- Section Mode r√©visions -->
<div id="mode2" class="section">
<!--  <h2 data-i18n="revision_title">üéå‚õ©Ô∏è R√©viser les Kanas ‚õ©Ô∏èüéå</h2>  -->
<div id="unlock-progress-container" class="unlock-progress-container" style="display: none;">
  <div class="unlock-progress-bar">
    <div class="unlock-progress-fill" id="unlock-progress-fill"></div>
  </div>
</div>

  <div id="revision-question"></div>
  
  <div id="revision-input-display"></div>
    <div class="revision-keyboard">
    <div class="revision-key">a</div>
    <div class="revision-key">i</div>
    <div class="revision-key">u</div>
    <div class="revision-key">e</div>
    <div class="revision-key">o</div>
    <div class="revision-key">k</div>
    <div class="revision-key">g</div>
    <div class="revision-key">y</div>
    <div class="revision-key">h</div>
    <div class="revision-key">f</div>
    <div class="revision-key">t</div>
    <div class="revision-key">ts</div>
    <div class="revision-key">d</div>
    <div class="revision-key">b</div>
    <div class="revision-key">p</div>
    <div class="revision-key">s</div>
    <div class="revision-key">sh</div>
    <div class="revision-key">z</div>
    <div class="revision-key">j</div>
    <div class="revision-key">ch</div>
    <div class="revision-key">m</div>
    <div class="revision-key">n</div>
    <div class="revision-key">r</div>
    <div class="revision-key">w</div>
    <div class="revision-key" id="revision-back">‚Üê</div>
  </div>
 <div id="revision-message"></div> 
</div>

<!-- Section Options -->
<div id="options" class="section">
  <h1 data-i18n="options_title">Options</h1>
  <div class="options-menu">
    <button class="arcade-button" onclick="showSubOptions('difficulty')" data-i18n="options_difficulty">Difficult√©</button>
    <button class="arcade-button" onclick="showSubOptions('sound')" data-i18n="options_sound">Son</button>
    <button class="arcade-button" onclick="showSubOptions('language')" data-i18n="options_language">Langue</button>
  </div>

  <!-- Sous-rubrique Difficult√© -->
  <div id="options-difficulty" class="options-sub hidden">
    <button class="arcade-button" onclick="backToOptions()" data-i18n="options_back">‚Üê Retour</button>
    <h2 data-i18n="options_difficulty">Difficult√©</h2>
    <button class="arcade-button" onclick="setDifficulty(6)" data-i18n="difficulty_easy">Facile (6)</button>
    <button class="arcade-button" onclick="setDifficulty(8)" data-i18n="difficulty_medium">Moyen (8)</button>
    <button class="arcade-button" onclick="setDifficulty(10)" data-i18n="difficulty_hard">Hard (10)</button>
  </div>

  <!-- Sous-rubrique Son -->
  <div id="options-sound" class="options-sub hidden">
    <button class="arcade-button" onclick="backToOptions()" data-i18n="options_back">‚Üê Retour</button>
    <h2 data-i18n="options_sound">Son</h2>
    <p>üîä Ici tu pourras ajouter des r√©glages (volume, mute, etc.)</p>
  </div>
<!-- Sous-rubrique Langue -->
<div id="options-language" class="options-sub hidden">
  <button class="arcade-button" onclick="backToOptions()"><span data-i18n="options_back">‚Üê Retour</span></button>
  <h2 data-i18n="options_language">Langue</h2>
  <button class="arcade-button" onclick="setLanguage('fr')">üá´üá∑ Fran√ßais</button>
  <button class="arcade-button" onclick="setLanguage('en')">üá¨üáß English</button>
  <button class="arcade-button" onclick="setLanguage('es')">üá™üá∏ Espa√±ol</button>
</div>
</div>
<!-- ========================================
     HTML √Ä AJOUTER APR√àS LA SECTION OPTIONS
     ======================================== -->

<!-- Section Mon compte -->
<div id="account" class="section">
  <h1 data-i18n="account_title">Mon compte</h1>
  
  <div class="account-section">
    <div class="account-info">
      <div class="account-info-line">
  üêº <strong data-i18n="account_pseudo_label">Pseudo :</strong> <span id="account-pseudo" data-i18n="account_default_value">-</span>
</div>
<div class="account-info-line">
  üìä <strong data-i18n="account_level_label">Niveau :</strong> <span id="account-level" data-i18n="account_default_value">-</span>
</div>
    </div>

    <div class="button-group">
      <button class="arcade-button" onclick="showChangeDevice()" data-i18n="account_change_device">
        üì± Changer d'appareil
      </button>

    </div>
  </div>
</div>

<!-- Section Cr√©ation de compte - √âTAPE 1 : Choix du  -->
<div id="create-account" class="section">
  <div id="onboarding-step-1" class="onboarding-step active">
    <h1 class="onboarding-title" data-i18n="onboarding_welcome">Bienvenue ! üå∏</h1>
    
    <div class="onboarding-content">
      <p class="onboarding-subtitle" data-i18n="onboarding_subtitle">Commen√ßons ton voyage zen</p>
      
      <div class="onboarding-buttons">
        <button class="arcade-button large-button" onclick="goToStep(2)" data-i18n="onboarding_create">
          üéã Cr√©er un compte
        </button>
        <button class="arcade-button secondary-button large-button" onclick="showLoginFromOnboarding()" data-i18n="onboarding_login">
          üîê J'ai d√©j√† un compte
        </button>
      </div>
    </div>
  </div>

  <!-- √âTAPE 2 : Choix du pseudo -->
  <div id="onboarding-step-2" class="onboarding-step">
    <h1 class="onboarding-title" data-i18n="onboarding_pseudo_title">Choisissons ton pseudo zen üêº</h1>
    
    <div class="onboarding-content">
      <div class="pseudo-input-wrapper">
<input 
  type="text" 
  id="pseudo-input" 
  class="pseudo-input" 
  data-i18n-placeholder="pseudo_input_placeholder"
  placeholder="Ton pseudo..."
  maxlength="20"
/>
      </div>
<!-- ‚úÖ AJOUT√â : Honeypot (pi√®ge √† bot) -->
<input 
  type="text" 
  id="website" 
  name="website" 
  style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;"
  tabindex="-1"
  autocomplete="off"
  aria-hidden="true"
/>
      <div id="create-error" class="error-message" style="display: none;"></div>

      <div class="onboarding-buttons">
        <button class="arcade-button" onclick="generateNewPseudo()" data-i18n="onboarding_regenerate">
          üîÑ Changer de pseudo
        </button>
        <button class="arcade-button primary-button" onclick="validatePseudoAndContinue()" data-i18n="onboarding_next">
          Suivant ‚û°Ô∏è
        </button>
      </div>
    </div>
  </div>

<!-- √âTAPE 3 : Saisie du PIN -->
<div id="onboarding-step-3" class="onboarding-step">
  <h1 class="onboarding-title" data-i18n="onboarding_pin_title">S√©curise ton compte üîê</h1>
  
  <div class="onboarding-content">
    <p class="onboarding-subtitle" data-i18n="onboarding_pin_subtitle">Entre ta date de naissance</p>
    
    <div class="birthdate-selectors">
      <div class="selector-group">
        <label class="selector-label" data-i18n="onboarding_day">Jour</label>
        <select id="birth-day" class="birthdate-select">
          <option value="">--</option>
        </select>
      </div>
      
      <div class="selector-group">
        <label class="selector-label" data-i18n="onboarding_month">Mois</label>
        <select id="birth-month" class="birthdate-select">
          <option value="">--</option>
        </select>
      </div>
    </div>

    <div id="pin-error" class="error-message" style="display: none;"></div>

    <div class="onboarding-buttons">
      <button class="arcade-button secondary-button small-button" onclick="goToStep(2)">
        ‚Üê <span data-i18n="onboarding_back">Retour</span>
      </button>
      <button class="arcade-button primary-button" onclick="validateBirthdateAndContinue()" data-i18n="onboarding_next">
        Suivant ‚û°Ô∏è
      </button>
    </div>
  </div>
</div>

  <!-- √âTAPE 4 : Confirmation -->
  <div id="onboarding-step-4" class="onboarding-step">
    <h1 class="onboarding-title" data-i18n="onboarding_confirm_title">Confirme ta date üìÖ</h1>
    
    <div class="onboarding-content">
      <div class="confirmation-box">
        <p class="confirmation-question" data-i18n="onboarding_confirm_question">Tu es n√©(e) le</p>
<p class="confirmation-date">
  <span id="confirm-date-display" class="date-value"></span>
  <span> ?</span>
</p>


        </div>

      <div class="warning-box">
        <p data-i18n="onboarding_warning">‚ö†Ô∏è Cette date te servira √† r√©cup√©rer ton compte</p>
      </div>

      <div class="onboarding-buttons">
        <button class="arcade-button secondary-button" onclick="goToStep(3)" data-i18n="onboarding_correct">
          ‚úèÔ∏è Corriger
        </button>
        <button class="arcade-button primary-button" onclick="finalizeAccount()" data-i18n="onboarding_confirm">
          ‚úÖ C'est correct
        </button>
      </div>
    </div>
  </div>
</div>
<!-- √âcran de chargement cr√©ation compte -->
<div id="account-creation-loader" class="section" style="display: none;">
  <div class="zen-loader-container">
    <div class="zen-circle-loader">
      <div class="bamboo-leaf">üçÉ</div>
    </div>
    <p class="zen-loader-text" data-i18n="loader_preparing">Pr√©paration de ton jardin zen...</p>
  </div>
</div>

<!-- √âcran de bienvenue -->
<div id="welcome-screen" class="section" style="display: none;">
  <div class="welcome-animation-container">
    <div class="sakura-rain"></div>
    <h1 class="welcome-user-title"></h1>
    <p class="welcome-user-subtitle" data-i18n="welcome_journey_starts">Ton voyage commence maintenant üå∏</p>
  </div>
</div> 
  
</div>

<!-- Section Connexion (changement d'appareil) -->
<div id="login" class="section">
  <h1 data-i18n="login_title">Connexion üîê</h1>
  
  <div class="account-section">
    <p data-i18n="login_subtitle">Retrouve ton compte</p>

      <!-- Pseudo -->
      <div class="pseudo-input-wrapper">
  <!--        <label class="selector-label" data-i18n="login_pseudo_label">Ton pseudo</label> -->
        <input 
  type="text" 
  id="login-pseudo" 
  class="pseudo-input" 
  data-i18n-placeholder="login_pseudo_placeholder"
  placeholder="ton pseudo"
/>
      </div>

      <!-- Date de naissance (m√™me style que l'onboarding) -->
     <p data-i18n="login_pin_label">Ta date d'anniversaire :</p>

      <div class="birthdate-selectors" style="margin-top: 20px;">
        <div class="selector-group">
          <label class="selector-label" data-i18n="onboarding_day">Jour</label>
          <select id="login-birth-day" class="birthdate-select">
            <option value="">--</option>
          </select>
        </div>
        
        <div class="selector-group">
          <label class="selector-label" data-i18n="onboarding_month">Mois</label>
          <select id="login-birth-month" class="birthdate-select">
            <option value="">--</option>
          </select>
        </div>
      </div>

      <div id="login-error" class="error-message" style="display: none;"></div>
      <div id="login-success" class="success-message" style="display: none;"></div>

      <div class="onboarding-buttons">
        <button class="arcade-button primary-button" onclick="loginUser()" data-i18n="login_connect">
          üéã Me connecter
        </button>
      
      </div>
    </div>
  </div>
</div>

<div id="login-loader" class="section" style="display: none;">
  <div class="zen-loader-container">
    <div class="zen-circle-loader">
      <div class="bamboo-leaf">üçÉ</div>
    </div>
    <p class="zen-loader-text" data-i18n="loader_preparing">Pr√©paration de ton jardin zen...</p>
  </div>
</div>
    <!-- Section Mes Stats -->
<!-- Section Mon Jardin -->
<div id="stats" class="section">
<!--  <h1 data-i18n="stats_title">Mon Jardin</h1>  -->

<!-- L√©gende sticky -->
<div id="garden-legend" class="garden-legend">
  <span><span>üå±</span> <span data-i18n="garden_legend_learning">En cours</span></span>
  <span><span>üåø</span> <span data-i18n="garden_legend_practice">√Ä entretenir</span></span>
  <span><span>üå∏</span> <span data-i18n="garden_legend_mastered">Ma√Ætris√©</span></span>
</div>

  <!-- Jardin scrollable -->
  <div class="garden-container">
    <div class="garden-ground" id="garden-ground">
      <!-- G√©n√©r√© par JS -->
    </div>

    <!-- Quelques d√©cors fixes (tu peux en ajouter/supprimer) -->
<!-- D√©cors zen en vrais √©mojis (tu peux en ajouter/supprimer √† l'infini) -->
<!-- 
<div class="garden-decor" style="top:8%;left:4%;font-size:3.8em;transform:rotate(-12deg);">üéã</div>
<div class="garden-decor" style="bottom:12%;right:6%;font-size:4.2em;transform:rotate(20deg);">üåæ</div>
<div class="garden-decor" style="top:25%;left:2%;font-size:3em;">üåµ</div>
<div class="garden-decor" style="bottom:30%;right:2%;font-size:3.5em;transform:rotate(8deg);">üå≥</div>
<div class="garden-decor" style="top:45%;right:8%;font-size:2.8em;transform:rotate(-15deg);">üçÇ</div>
<div class="garden-decor" style="bottom:5%;left:10%;font-size:4.5em;opacity:0.5;">üéã</div>
<div class="garden-decor" style="top:15%;left:12%;font-size:3.2em;transform:rotate(25deg);">üéç</div>
  </div>
-->
<!-- Flashcard modale zen -->
<div id="garden-modal" class="garden-modal" onclick="closeGardenModal()">
  <div class="garden-card" onclick="event.stopPropagation()"> <!-- emp√™che la fermeture si on clique dedans -->
    <div id="modal-plant" style="font-size:3.2em; margin-bottom:0.4em;"></div>
    <h2 id="modal-hiragana" style="margin:0.2em 0; font-size:3em;"></h2>
    <div class="katakana" id="modal-katakana" style="font-size:1.8em; color:#8B6F47;"></div>
    <div class="romaji" id="modal-romaji" style="font-size:1.6em; color:#555;"></div>
    <div class="info" style="margin-top:1em;">
      Niveau <span id="modal-level"></span> ‚Ä¢ 
      Score actuel = <span id="modal-validation"></span>
    </div>
  </div>
</div>
</div>
  <script>
   
    // === SYST√àME DE TRADUCTION ===
const translations = {
  fr: {
    // Menu
    menu_learn: "Apprendre",
    menu_revision: "Mode r√©visions",
    menu_options: "Options",
    menu_close: "Fermer",
    
    // Page d'accueil
    welcome_title: "üéåüå∏ Kanas-Zen-Garden üå∏üéå",
    welcome_subtitle: "Apprenez √† lire le Japonais",
    welcome_loading: "Chargement...",
    welcome_touch: "Touchez le panda pour entrer !",
    
    // Quiz
    quiz_title: "üéå‚õ©Ô∏è Apprenez les Kanas ‚õ©Ô∏èüéå",
    quiz_level: "Niveau actuel :",
    quiz_continue: "üå± OK... j'ai capt√© üå±",
    quiz_install: "Ajouter √† l'√©cran d'accueil",
    
    // R√©visions
    revision_title: "üéå‚õ©Ô∏è R√©viser les Kanas ‚õ©Ô∏èüéå",
    
    // Options
    options_title: "Options",
    options_difficulty: "Difficult√©",
    options_sound: "Son",
    options_language: "Langue",
    options_back: "‚Üê Retour",
    
    // Difficult√©
    difficulty_easy: "Facile (6)",
    difficulty_medium: "Moyen (8)",
    difficulty_hard: "Hard (10)",
    difficulty_set: "Difficult√© r√©gl√©e sur :",
    
    // Messages
    msg_perfect: "Parfait !",
    msg_validated: "Valid√© ! üéâ",
    msg_almost: "Presque...",
    msg_notquite: "Pas tout √† fait...",
    msg_correct: "üëâ Bonne r√©ponse :",
    msg_level_up: "üçÉLEVEL UP!üéã",
    
    // Messages menu
    menu_msg_blocked: "Mode Apprendre bloqu√©",
    menu_msg_unblocked: "Mode Apprendre d√©bloqu√© !",
    menu_msg_still_blocked: "Mode Apprendre encore bloqu√©",
    menu_msg_revision_unlocked: "üéÆ Mode r√©visions d√©bloqu√© üéÆ",
    
    // R√©vision disponibilit√©
    revision_available_level4: "Mode r√©vision disponible √† partir du niveau 4",
    revision_no_items: "Aucun item disponible pour r√©vision",

     // Mon compte
  account_title: "Mon compte",
  account_change_device: "üì± Changer d'appareil",
  
    // Onboarding
    onboarding_welcome: "Bienvenue ! üå∏",
    onboarding_subtitle: "Commen√ßons ton apprentissage",
    onboarding_create: "Cr√©er un compte",
    onboarding_login: "J'ai d√©j√† un compte",
    onboarding_pseudo_title: "Choisis ton pseudo üêº",
    onboarding_regenerate: "?",
    onboarding_next: "OK",
    onboarding_back: "Retour",
    onboarding_pin_title: "S√©curise ton compte üîê",
    onboarding_pin_subtitle: "Entre ta date de naissance",
    onboarding_pin_example: "Exemple : n√©(e) le 12 mai ‚Üí 1205",
    onboarding_confirm_title: "Confirmation",
    onboarding_confirm_question: "Tu es n√©(e) le",
    onboarding_warning: "‚ö†Ô∏è Cette date te servira √† r√©cup√©rer ton compte en cas de besoin",
    onboarding_correct: "Corriger",
    onboarding_confirm: "C'est correct !",
    rate_limit_error: "üö´ Trop de tentatives. Veuillez r√©essayer dans quelques minutes.",
    wait_seconds: "‚è±Ô∏è Veuillez r√©essayer dans",
    second: "seconde",
    seconds: "secondes",
    onboarding_day: "Jour",
    onboarding_month: "Mois",
    onboarding_pin_subtitle: "Entre ta date de naissance",
    
    // Mon Parcours (anciennement Stats)
    menu_stats: "Mon jardin",
    stats_title: "üêº Mon jardin",
    stats_filter_all: "Tous",
    stats_filter_acquired: "Ma√Ætris√©",
    stats_filter_review: "√Ä entretenir",
    stats_filter_progress: "En cours",
    stats_table_hiragana: "Hiragana",
    stats_table_katakana: "Kata/trad.",
    stats_table_romaji: "Romaji",
    stats_table_status: "Statut",
    garden_legend_learning: "En cours",
    garden_legend_practice: "√Ä entretenir",
    garden_legend_mastered: "Ma√Ætris√©",
  
  // Connexion
  login_title: "Connexion üîê",
  create_account_already_have: "J'ai d√©j√† un compte",
  login_subtitle: "Retrouve ton compte",
  login_pseudo_label: "Ton pseudo",
  login_pin_label: "Ta date d'anniversaire :",
  login_connect: "Me connecter",
  create_account_confirm_yes: "‚úÖ Oui, c'est correct", // FR
  create_account_correct_pin: "‚úèÔ∏è Non, corriger", // FR  
  welcome_loading_dots: "(Chargement... )",
quiz_level_display: "Niveau actuel :",
quiz_question_load: "load...",
options_sound_description: "üîä Ici tu pourras ajouter des r√©glages (volume, mute, etc.)",
account_pseudo_label: "Pseudo :",
account_level_label: "Niveau :",
account_default_value: "-",
pseudo_input_placeholder: "Ton pseudo...",
confirm_date_question_mark: "?",
login_pseudo_placeholder: "ton pseudo",
loader_preparing: "Pr√©paration de ton jardin zen...",
welcome_journey_starts: "Ton voyage commence maintenant üå∏",  

    // Erreurs
    error_pseudo_too_short: "Le pseudo doit contenir au moins 2 caract√®res",
    error_pseudo_too_long: "Le pseudo ne peut pas d√©passer 20 caract√®res",
    error_pseudo_invalid_chars: "Le pseudo ne peut contenir que des lettres et des chiffres (pas d'espaces ni de caract√®res sp√©ciaux)",
    error_select_date: "Veuillez s√©lectionner un jour et un mois",
    error_invalid_day: "Ce mois ne peut pas avoir",
    error_invalid_day_suffix: "jours",
    error_please_wait: "‚è±Ô∏è Veuillez patienter encore",
    error_second: "seconde",
    error_seconds: "secondes",
    error_before_validate: "avant de valider...",
    error_suspicious_activity: "Activit√© suspecte d√©tect√©e",
    error_connection: "Erreur de connexion",
    error_enter_pseudo: "Veuillez entrer votre pseudo",
    error_select_birthdate: "Veuillez s√©lectionner votre date de naissance",
    error_wrong_credentials: "Pseudo ou date de naissance incorrect",
    error_token_update: "Erreur lors de la mise √† jour du token",
    stats_no_items: "Aucun item dans cette cat√©gorie",
    
    // Loaders
    loader_meditation: "üßò M√©ditation en cours...",
    loader_tea: "üçµ Pr√©paration du th√© matcha...",
    loader_cherry: "üå∏ Plantation des cerisiers...",
    loader_garden: "üéã Arrangement du jardin zen...",
    loader_ceremony: "üéå Pr√©paration de la c√©r√©monie...",
    
    // Bienvenue
    welcome_user: "Bienvenue",
    welcome_back: "Bon retour",
    
    // Proverbes
    proverb_1: "Un voyage de mille lieues commence toujours par un premier pas üå∏",
    proverb_2: "La patience est la cl√© de la joie üçÉ",
    proverb_3: "Chaque jour est une nouvelle chance d'apprendre üéã",
    proverb_4: "M√™me un voyage de mille kilom√®tres commence par un pas üë£",
    proverb_5: "Le vent ne laisse pas de trace, mais il transforme le ciel üå¨Ô∏è",
    proverb_6: "Le savoir est un tr√©sor qui suit partout celui qui le poss√®de üíé",
    proverb_7: "Un petit progr√®s chaque jour m√®ne au succ√®s üå±",
    proverb_8: "La pers√©v√©rance est la m√®re du succ√®s üèîÔ∏è",
    proverb_9: "Qui grimpe lentement grimpe s√ªrement üßó",
    proverb_10: "Le chemin est plus important que la destination üõ§Ô∏è",
    proverb_11: "Mieux vaut tard que jamais ‚è∞",
    proverb_12: "Quand le vent cesse, les feuilles se reposent ‚Äî ainsi va l'esprit apais√© üçÇ",
    proverb_13: "Dans la goutte de ros√©e, tout l'univers se refl√®te üíß",
    proverb_14: "Le silence n'est pas vide ‚Äî il est plein de r√©ponses üïäÔ∏è",
    proverb_15: "Une pierre immobile dans le ruisseau apprend le passage du temps ‚õ∞Ô∏è",
    proverb_16: "Aff√ªte ton esprit comme on polit un sabre ‚Äî lentement, patiemment ‚öîÔ∏è",
    proverb_17: "Ce n'est pas la force, mais la constance, qui fend la pierre üíß",
    proverb_18: "Chaque jour, avance d'un pas invisible mais r√©el üë£",
    proverb_19: "La fleur n'ouvre pas ses p√©tales en un seul matin üå∏",
    proverb_20: "Chaque expert √©tait autrefois un d√©butant üåü",
    proverb_21: "L'√©chec est le fondement de la r√©ussite üå∏",
    proverb_22: "M√™me l'ombre d'un arbre parle du soleil üå≥",
    proverb_23: "La brume cache la montagne, mais la montagne demeure ‚õ∞Ô∏è",
    proverb_24: "Le parfum du th√© n'a pas besoin de paroles üçµ",
    proverb_25: "La discipline n'est pas une cha√Æne, mais une cl√© üóùÔ∏è",
    
    // Quiz
    quiz_current_level: "Niveau actuel :",
    quiz_correct_answer: "üëâ Bonne r√©ponse :",
    quiz_answer_separator: "‚Äî",
    
    // R√©vision
    revision_ok: "OK",
    revision_wrong: "Faux",
    revision_correct_answer: "üëâ Bonne r√©ponse :",

        // Mois
    month_01: "janvier",
    month_02: "f√©vrier",
    month_03: "mars",
    month_04: "avril",
    month_05: "mai",
    month_06: "juin",
    month_07: "juillet",
    month_08: "ao√ªt",
    month_09: "septembre",
    month_10: "octobre",
    month_11: "novembre",
    month_12: "d√©cembre",

        // Compte
    account_level_in_progress: "(en cours)",
    
  },
  
  en: {
    // Menu
    menu_learn: "Learn",
    menu_revision: "Revision Mode",
    menu_options: "Options",
    menu_close: "Close",
    
    // Welcome page
    welcome_title: "üéåüå∏ Kanas-Zen-Garden üå∏üéå",
    welcome_subtitle: "Learn to read Japanese",
    welcome_loading: "Loading...",
    welcome_touch: "Touch the panda to enter!",
    
    // Quiz
    quiz_title: "üéå‚õ©Ô∏è Learn the Kanas ‚õ©Ô∏èüéå",
    quiz_level: "Current level:",
    quiz_continue: "üå± OK... got it üå±",
    quiz_install: "Add to home screen",
    
    // Revision
    revision_title: "üéå‚õ©Ô∏è Review the Kanas ‚õ©Ô∏èüéå",
    
    // Options
    options_title: "Options",
    options_difficulty: "Difficulty",
    options_sound: "Sound",
    options_language: "Language",
    options_back: "‚Üê Back",
    
    // Difficulty
    difficulty_easy: "Easy (6)",
    difficulty_medium: "Medium (8)",
    difficulty_hard: "Hard (10)",
    difficulty_set: "Difficulty set to:",
    
    // Messages
    msg_perfect: "Perfect!",
    msg_validated: "Validated! üéâ",
    msg_almost: "Almost...",
    msg_notquite: "Not quite...",
    msg_correct: "üëâ Correct answer:",
    msg_level_up: "üçÉLEVEL UP!üéã",
    
    // Menu messages
    menu_msg_blocked: "Learn Mode blocked",
    menu_msg_unblocked: "Learn Mode unblocked!",
    menu_msg_still_blocked: "Learn Mode still blocked",
    menu_msg_revision_unlocked: "üéÆ Revision mode unlocked üéÆ",
    
    // Revision availability
    revision_available_level4: "Revision mode available from level 4",
    revision_no_items: "No items available for revision",

    // My account
  account_title: "My Account",
  account_change_device: "üì± Change Device",
  
    // Onboarding
    onboarding_welcome: "Welcome! üå∏",
    onboarding_subtitle: "Let's begin your learning",
    onboarding_create: "Create an account",
    onboarding_login: "I already have an account",
    onboarding_pseudo_title: "Choose your nickname üêº",
    onboarding_regenerate: "?",
    onboarding_next: "Okay",
    onboarding_back: "Back",
    onboarding_pin_title: "Secure your account üîê",
    onboarding_pin_subtitle: "Enter your birth date",
    onboarding_pin_example: "Example: born May 12th ‚Üí 1205",
    onboarding_confirm_title: "Confirmation",
    onboarding_confirm_question: "You were born on",
    onboarding_warning: "‚ö†Ô∏è This date will allow you to recover your account if needed",
    onboarding_correct: "Correct",
    onboarding_confirm: "That's correct",
    rate_limit_error: "üö´ Too many attempts. Please try again in a few minutes.",
    wait_seconds: "‚è±Ô∏è Please wait",
    second: "second",
    seconds: "seconds",
    onboarding_day: "Day",
    onboarding_month: "Month",
    onboarding_pin_subtitle: "Enter your birth date",
    // Mon Parcours
    menu_stats: "My Garden",
    stats_title: "üêº My Garden",
    stats_filter_all: "All",
    stats_filter_acquired: "Mastered",
    stats_filter_review: "To practice",
    stats_filter_progress: "Learning",
    stats_table_hiragana: "Hiragana",
    stats_table_katakana: "Kata/trad.",
    stats_table_romaji: "Romaji",
    stats_table_status: "Status",
    garden_legend_learning: "Learning",
    garden_legend_practice: "Practice",
    garden_legend_mastered: "Mastered",
 
  // Login
  login_title: "Login üîê",
    
  login_subtitle: "Find your account",
  login_pseudo_label: "Your nickname",
  login_pin_label: "Your Birthdate :",
  login_connect: "üéã Connect",
  create_account_confirm_yes: "‚úÖ Yes, that's correct", // EN
  create_account_correct_pin: "‚úèÔ∏è No, correct it", // EN  
  welcome_loading_dots: "(Loading... )",
quiz_level_display: "Current level:",
quiz_question_load: "load...",
options_sound_description: "üîä Here you can add settings (volume, mute, etc.)",
account_pseudo_label: "Nickname:",
account_level_label: "Level:",
account_default_value: "-",
pseudo_input_placeholder: "Your nickname...",
confirm_date_question_mark: "?",
login_pseudo_placeholder: "your nickname",
loader_preparing: "Preparing your zen garden...",
welcome_journey_starts: "Your journey begins now üå∏",  

    // Errors
    error_pseudo_too_short: "Nickname must contain at least 2 characters",
    error_pseudo_too_long: "Nickname cannot exceed 20 characters",
    error_pseudo_invalid_chars: "Nickname can only contain letters and numbers (no spaces or special characters)",
    error_select_date: "Please select a day and month",
    error_invalid_day: "This month cannot have",
    error_invalid_day_suffix: "days",
    error_please_wait: "‚è±Ô∏è Please wait",
    error_second: "second",
    error_seconds: "seconds",
    error_before_validate: "before validating...",
    error_suspicious_activity: "Suspicious activity detected",
    error_connection: "Connection error",
    error_enter_pseudo: "Please enter your nickname",
    error_select_birthdate: "Please select your birth date",
    error_wrong_credentials: "Incorrect nickname or birth date",
    error_token_update: "Error updating token",
    stats_no_items: "No items in this category",
    
    // Loaders
    loader_meditation: "üßò Meditating...",
    loader_tea: "üçµ Preparing matcha tea...",
    loader_cherry: "üå∏ Planting cherry trees...",
    loader_garden: "üéã Arranging zen garden...",
    loader_ceremony: "üéå Preparing ceremony...",
    
    // Welcome
    welcome_user: "Welcome",
    welcome_back: "Welcome back",
    
    // Proverbs
    proverb_1: "A journey of a thousand miles begins with a single step üå∏",
    proverb_2: "Patience is the key to joy üçÉ",
    proverb_3: "Every day is a new chance to learn üéã",
    proverb_4: "Even a journey of a thousand kilometers begins with one step üë£",
    proverb_5: "The wind leaves no trace, but it transforms the sky üå¨Ô∏è",
    proverb_6: "Knowledge is a treasure that follows its owner everywhere üíé",
    proverb_7: "A little progress each day leads to success üå±",
    proverb_8: "Perseverance is the mother of success üèîÔ∏è",
    proverb_9: "Who climbs slowly, climbs surely üßó",
    proverb_10: "The path is more important than the destination üõ§Ô∏è",
    proverb_11: "Better late than never ‚è∞",
    proverb_12: "When the wind stops, the leaves rest ‚Äî so goes the peaceful mind üçÇ",
    proverb_13: "In the dewdrop, the entire universe is reflected üíß",
    proverb_14: "Silence is not empty ‚Äî it is full of answers üïäÔ∏è",
    proverb_15: "A still stone in the stream learns the passage of time ‚õ∞Ô∏è",
    proverb_16: "Sharpen your mind like polishing a sword ‚Äî slowly, patiently ‚öîÔ∏è",
    proverb_17: "It is not strength, but consistency, that splits the stone üíß",
    proverb_18: "Each day, move forward with an invisible but real step üë£",
    proverb_19: "The flower doesn't open its petals in a single morning üå∏",
    proverb_20: "Every expert was once a beginner üåü",
    proverb_21: "Failure is the foundation of success üå∏",
    proverb_22: "Even the shadow of a tree speaks of the sun üå≥",
    proverb_23: "The mist hides the mountain, but the mountain remains ‚õ∞Ô∏è",
    proverb_24: "The fragrance of tea needs no words üçµ",
    proverb_25: "Discipline is not a chain, but a key üóùÔ∏è",
    
    // Quiz
    quiz_current_level: "Current level:",
    quiz_correct_answer: "üëâ Correct answer:",
    quiz_answer_separator: "‚Äî",
    
    // Revision
    revision_ok: "OK",
    revision_wrong: "Wrong",
    revision_correct_answer: "üëâ Correct answer:",

        // Months
    month_01: "January",
    month_02: "February",
    month_03: "March",
    month_04: "April",
    month_05: "May",
    month_06: "June",
    month_07: "July",
    month_08: "August",
    month_09: "September",
    month_10: "October",
    month_11: "November",
    month_12: "December",

     // Account
    account_level_in_progress: "(in progress)",
    
    
  },
  
  es: {
    // Menu
    menu_learn: "Aprender",
    menu_revision: "Modo revisi√≥n",
    menu_options: "Opciones",
    menu_close: "Cerrar",
    
    // P√°gina de bienvenida
    welcome_title: "üéåüå∏ Kanas-Zen-Garden üå∏üéå",
    welcome_subtitle: "Aprende a leer Japon√©s",
    welcome_loading: "Cargando...",
    welcome_touch: "¬°Toca el panda para entrar!",
    
    // Quiz
    quiz_title: "üéå‚õ©Ô∏è Aprende los Kanas ‚õ©Ô∏èüéå",
    quiz_level: "Nivel actual:",
    quiz_continue: "üå± OK... lo entend√≠ üå±",
    quiz_install: "A√±adir a pantalla de inicio",
    
    // Revisi√≥n
    revision_title: "üéå‚õ©Ô∏è Revisar los Kanas ‚õ©Ô∏èüéå",
    
    // Opciones
    options_title: "Opciones",
    options_difficulty: "Dificultad",
    options_sound: "Sonido",
    options_language: "Idioma",
    options_back: "‚Üê Volver",
    
    // Dificultad
    difficulty_easy: "F√°cil (6)",
    difficulty_medium: "Medio (8)",
    difficulty_hard: "Dif√≠cil (10)",
    difficulty_set: "Dificultad ajustada a:",
    
    // Mensajes
    msg_perfect: "¬°Perfecto!",
    msg_validated: "¬°Validado! üéâ",
    msg_almost: "Casi...",
    msg_notquite: "No del todo...",
    msg_correct: "üëâ Respuesta correcta:",
    msg_level_up: "üçÉ¬°SUBIDA DE NIVEL!üéã",
    
    // Mensajes del men√∫
    menu_msg_blocked: "Modo Aprender bloqueado",
    menu_msg_unblocked: "¬°Modo Aprender desbloqueado!",
    menu_msg_still_blocked: "Modo Aprender a√∫n bloqueado",
    menu_msg_revision_unlocked: "üéÆ Modo revisi√≥n desbloqueado üéÆ",
    
    // Disponibilidad revisi√≥n
    revision_available_level4: "Modo revisi√≥n disponible desde el nivel 4",
    revision_no_items: "No hay elementos disponibles para revisi√≥n",
     // Mi cuenta
  account_title: "Mi Cuenta",
  account_change_device: "üì± Cambiar de Dispositivo",
  
    // Onboarding
    onboarding_welcome: "¬°Bienvenido! üå∏",
    onboarding_subtitle: "Comencemos tu aprendizaje",
    onboarding_create: "Crear una cuenta",
    onboarding_login: "Ya tengo una cuenta",
    onboarding_pseudo_title: "Elige tu apodo üêº",
    onboarding_regenerate: "?",
    onboarding_next: "Bueno",
    onboarding_back: "Volver",
    onboarding_pin_title: "Asegura tu cuenta üîê",
    onboarding_pin_subtitle: "Ingresa tu fecha de nacimiento",
    onboarding_pin_example: "Ejemplo: nacido el 12 de mayo ‚Üí 1205",
    onboarding_confirm_title: "Confirmaci√≥n",
    onboarding_confirm_question: "Naciste el",
    onboarding_warning: "‚ö†Ô∏è Esta fecha le permitir√° recuperar su cuenta si es necesario",
    onboarding_correct: "Corregir",
    onboarding_confirm: "Es correcto",
    rate_limit_error: "üö´ Demasiados intentos. Int√©ntalo de nuevo en unos minutos.",
    wait_seconds: "‚è±Ô∏è Por favor espera",
    second: "segundo",
    seconds: "segundos",
    onboarding_day: "D√≠a",
    onboarding_month: "Mes",
    onboarding_pin_subtitle: "Ingresa tu fecha de nacimiento",
    // Mon Parcours
    menu_stats: "Mi Jardin",
    stats_title: "üêº Mi Jardin",
    stats_filter_all: "Todos",
    stats_filter_acquired: "Dominado",
    stats_filter_review: "A practicar",
    stats_filter_progress: "Aprendiendo",
    stats_table_hiragana: "Hiragana",
    stats_table_katakana: "Kata/trad.",
    stats_table_romaji: "Romaji",
    stats_table_status: "Estado",
    garden_legend_learning: "En curso",
    garden_legend_practice: "Repasar",
    garden_legend_mastered: "Dominado",
    
  // Conexi√≥n
  login_title: "Conexi√≥n üîê",
  login_subtitle: "Encuentra tu cuenta",
  login_pseudo_label: "Tu apodo",
  login_pin_label: "Tu fecha de nacimiento :",
  login_connect: "üéã Conectarme",
  create_account_confirm_yes: "‚úÖ S√≠, es correcto", // ES
  create_account_correct_pin: "‚úèÔ∏è No, corregir", // ES  
  welcome_loading_dots: "(Cargando... )",
quiz_level_display: "Nivel actual:",
quiz_question_load: "load...",
options_sound_description: "üîä Aqu√≠ podr√°s a√±adir ajustes (volumen, silenciar, etc.)",
account_pseudo_label: "Apodo:",
account_level_label: "Nivel:",
account_default_value: "-",
pseudo_input_placeholder: "Tu apodo...",
confirm_date_question_mark: "?",
login_pseudo_placeholder: "tu apodo",
loader_preparing: "Preparando tu jard√≠n zen...",
welcome_journey_starts: "Tu viaje comienza ahora üå∏",

    // Errores
    error_pseudo_too_short: "El apodo debe contener al menos 2 caracteres",
    error_pseudo_too_long: "El apodo no puede exceder 20 caracteres",
    error_pseudo_invalid_chars: "El apodo solo puede contener letras y n√∫meros (sin espacios ni caracteres especiales)",
    error_select_date: "Por favor seleccione un d√≠a y mes",
    error_invalid_day: "Este mes no puede tener",
    error_invalid_day_suffix: "d√≠as",
    error_please_wait: "‚è±Ô∏è Por favor espere",
    error_second: "segundo",
    error_seconds: "segundos",
    error_before_validate: "antes de validar...",
    error_suspicious_activity: "Actividad sospechosa detectada",
    error_connection: "Error de conexi√≥n",
    error_enter_pseudo: "Por favor ingrese su apodo",
    error_select_birthdate: "Por favor seleccione su fecha de nacimiento",
    error_wrong_credentials: "Apodo o fecha de nacimiento incorrecta",
    error_token_update: "Error al actualizar el token",
    stats_no_items: "No hay elementos en esta categor√≠a",
    
    // Cargadores
    loader_meditation: "üßò Meditando...",
    loader_tea: "üçµ Preparando t√© matcha...",
    loader_cherry: "üå∏ Plantando cerezos...",
    loader_garden: "üéã Arreglando jard√≠n zen...",
    loader_ceremony: "üéå Preparando ceremonia...",
    
    // Bienvenida
    welcome_user: "Bienvenido",
    welcome_back: "Bienvenido de nuevo",
    
    // Proverbios
    proverb_1: "Un viaje de mil millas comienza con un solo paso üå∏",
    proverb_2: "La paciencia es la clave de la alegr√≠a üçÉ",
    proverb_3: "Cada d√≠a es una nueva oportunidad para aprender üéã",
    proverb_4: "Incluso un viaje de mil kil√≥metros comienza con un paso üë£",
    proverb_5: "El viento no deja huella, pero transforma el cielo üå¨Ô∏è",
    proverb_6: "El conocimiento es un tesoro que sigue a su due√±o a todas partes üíé",
    proverb_7: "Un peque√±o progreso cada d√≠a conduce al √©xito üå±",
    proverb_8: "La perseverancia es la madre del √©xito üèîÔ∏è",
    proverb_9: "Quien sube lentamente, sube con seguridad üßó",
    proverb_10: "El camino es m√°s importante que el destino üõ§Ô∏è",
    proverb_11: "M√°s vale tarde que nunca ‚è∞",
    proverb_12: "Cuando el viento se detiene, las hojas descansan ‚Äî as√≠ va la mente en paz üçÇ",
    proverb_13: "En la gota de roc√≠o, se refleja todo el universo üíß",
    proverb_14: "El silencio no est√° vac√≠o ‚Äî est√° lleno de respuestas üïäÔ∏è",
    proverb_15: "Una piedra inm√≥vil en el arroyo aprende el paso del tiempo ‚õ∞Ô∏è",
    proverb_16: "Afila tu mente como se pule una espada ‚Äî lentamente, pacientemente ‚öîÔ∏è",
    proverb_17: "No es la fuerza, sino la constancia, la que parte la piedra üíß",
    proverb_18: "Cada d√≠a, avanza con un paso invisible pero real üë£",
    proverb_19: "La flor no abre sus p√©talos en una sola ma√±ana üå∏",
    proverb_20: "Cada experto fue una vez un principianteüåü",
proverb_21: "El fracaso es el fundamento del √©xito üå∏",
proverb_22: "Incluso la sombra de un √°rbol habla del sol üå≥",
proverb_23: "La niebla oculta la monta√±a, pero la monta√±a permanece ‚õ∞Ô∏è",
proverb_24: "El aroma del t√© no necesita palabras üçµ",
proverb_25: "La disciplina no es una cadena, sino una llave üóùÔ∏è",
// Quiz
quiz_current_level: "Nivel actual:",
quiz_correct_answer: "üëâ Respuesta correcta:",
quiz_answer_separator: "‚Äî",

// Revisi√≥n
revision_ok: "OK",
revision_wrong: "Falso",
revision_correct_answer: "üëâ Respuesta correcta:",

        
    // Meses
    month_01: "enero",
    month_02: "febrero",
    month_03: "marzo",
    month_04: "abril",
    month_05: "mayo",
    month_06: "junio",
    month_07: "julio",
    month_08: "agosto",
    month_09: "septiembre",
    month_10: "octubre",
    month_11: "noviembre",
    month_12: "diciembre",
    
    // Cuenta
    account_level_in_progress: "(en progreso)"
 
    
  }
};


// Langue actuelle (d√©tection auto ou sauvegard√©e)
let currentLanguage = localStorage.getItem('appLanguage') || detectBrowserLanguage();

// ‚úÖ AJOUT√â : D√©tection automatique de la langue du navigateur
function detectBrowserLanguage() {
  // R√©cup√©rer la langue du navigateur
  const browserLang = navigator.language || navigator.userLanguage;
  
  console.log('üåç Langue du navigateur d√©tect√©e:', browserLang);
  
  // Extraire le code langue (ex: "fr-FR" ‚Üí "fr", "es-ES" ‚Üí "es")
  const langCode = browserLang.toLowerCase().split('-')[0];
  
  // Mapping vers les langues support√©es
  if (langCode === 'fr') {
    console.log('‚úÖ Fran√ßais d√©tect√©');
    return 'fr';
  } else if (langCode === 'es') {
    console.log('‚úÖ Espagnol d√©tect√©');
    return 'es';
  } else {
    console.log('‚úÖ Langue par d√©faut: Anglais');
    return 'en';
  }
}

// Fonction pour obtenir une traduction
function t(key) {
  return translations[currentLanguage][key] || translations['fr'][key] || key;
}
// Fonction pour obtenir la bonne valeur Katakana selon la langue
function getLocalizedKatakana(item) {
  if (currentLanguage === 'en' && item.KatakanaEN) {
    return item.KatakanaEN;
  } else if (currentLanguage === 'es' && item.KatakanaES) {
    return item.KatakanaES;
  }
  return item.Katakana; // Fallback sur fran√ßais
}
// Fonction pour changer de langue
function setLanguage(lang) {
  if (translations[lang]) {
    currentLanguage = lang;
    localStorage.setItem('appLanguage', lang);
    
    // ‚úÖ NOUVEAU : R√©g√©n√©rer les tables Katakana avec la nouvelle langue
    if (HiraganaList.length > 0) {
      revisionKatakanaTable = generateRevisionKatakanaTable(HiraganaList);
      console.log(`üîÑ Table katakana r√©g√©n√©r√©e pour langue ${lang}:`, Object.keys(revisionKatakanaTable).length, "entr√©es");
    }
    
    updateAllTexts();
    if (revisionMode.isActive) {
  startRevisionQuestion();
} else {
  nextQuestion();
}
  }
}
// Fonction pour mettre √† jour tous les textes de l'interface
function updateAllTexts() {
  // Mettre √† jour tous les √©l√©ments avec data-i18n
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    element.textContent = t(key);
  });
  
  // ‚úÖ AJOUT√â : Mettre √† jour les placeholders
  updatePlaceholders();
  
  // Mettre √† jour le niveau actuel
  const levelDisplay = document.getElementById("levelDisplay");
  if (levelDisplay) {
    levelDisplay.innerText = `${t('quiz_level')} ${niveauActif}`;
  }
  
  // Mettre √† jour les titres des sections
  updateSectionTitles();
  
  // Mettre √† jour les messages du menu si visible
  updateMenuMessage();
  
  // Mettre √† jour le message de chargement si pr√©sent
  const loadingText = document.getElementById("loadingText");
  if (loadingText && (loadingText.textContent.includes("Chargement") || loadingText.textContent.includes("Loading") || loadingText.textContent.includes("Cargando"))) {
    if (gameDataLoaded) {
      loadingText.textContent = t('welcome_touch');
    } else {
      loadingText.textContent = `(${t('welcome_loading')})`;
    }
  }
}

// Fonction auxiliaire pour mettre √† jour les titres
function updateSectionTitles() {
  // Titre page d'accueil
  const welcomeTitle = document.querySelector('.welcome-title');
  if (welcomeTitle) welcomeTitle.textContent = t('welcome_title');
  
  const welcomeSubtitle = document.querySelector('.welcome-subtitle');
  if (welcomeSubtitle) welcomeSubtitle.textContent = t('welcome_subtitle');
}    
     // Ajout du support pour les √©v√©nements tactiles
    document.querySelectorAll('.revision-key').forEach(key => {
      key.addEventListener('touchstart', function() {
        this.classList.add('active');
        setTimeout(() => {
          this.classList.remove('active');
        }, 300); // Correspond √† la dur√©e de l'animation (0.3s)
      });
    });
// ========================================
// GESTION UTILISATEUR - √Ä AJOUTER DANS <script>
// ========================================

// Variables globales utilisateur
let currentUser = null;
let currentPseudoProposal = null;
let userToken = null;
// ‚úÖ AJOUT√â : Protection anti-bot
let stepTimestamps = {};
let sessionStartTime = null;
let userInteractions = {
  clicks: 0,
  keystrokes: 0,
  mouseMovements: 0
};
// ========================================
// INITIALISATION AU CHARGEMENT
// ========================================
async function initUserSystem() {
  

  userToken = localStorage.getItem('userToken');
  
  if (userToken) {
    const result = await callAPI('getUserByToken', { token: userToken });
    
    if (result.success) {
      currentUser = result.user;
      
      // ‚úÖ R√âINITIALISER LE CONTEXTE
      resetGameContext();
      
      await loadUserProgress();
      console.log('‚úÖ Utilisateur connect√©:', currentUser.pseudo);
      updateAccountDisplay();
    } else {
      console.warn('‚ö†Ô∏è Token invalide, cr√©ation de compte n√©cessaire');
      localStorage.removeItem('userToken');
      userToken = null;
    }
  }
}
// ========================================
// CACHE DE PSEUDOS - √Ä AJOUTER APR√àS currentUser, currentPseudoProposal, userToken
// ========================================
let pseudoCache = [];
let currentPseudoIndex = 0;

// G√©n√©rer un batch de 10 pseudos localement
// G√©n√©rer un batch de 10 pseudos localement
// ‚úÖ VERSION FINALE avec vraie combinaison al√©atoire
function generatePseudoBatch() {
  const wordListsStr = localStorage.getItem('wordLists');
  if (!wordListsStr) {
    console.error('‚ùå WordLists non disponibles dans localStorage');
    return [];
  }
  
  let wordLists;
  try {
    wordLists = JSON.parse(wordListsStr);
  } catch (e) {
    console.error('‚ùå Erreur parsing wordLists:', e);
    return [];
  }
  
  console.log('üì¶ Structure wordLists:', Object.keys(wordLists));
  
  // ‚úÖ NOUVEAU : Extraire les listes jpn et eng
  let jpnWords, engWords;
  
  if (Array.isArray(wordLists)) {
    // Structure: [{jpn: "...", eng: "..."}, ...]
    jpnWords = wordLists.map(item => item.jpn);
    engWords = wordLists.map(item => item.eng);
  } else if (wordLists.jpn && wordLists.eng) {
    // Structure: {jpn: [...], eng: [...]}
    jpnWords = wordLists.jpn;
    engWords = wordLists.eng;
  } else {
    console.error('‚ùå Structure wordLists non reconnue:', wordLists);
    return [];
  }
  
  // ‚úÖ G√âN√âRATION avec tirage al√©atoire IND√âPENDANT
  const batch = [];
  for (let i = 0; i < 10; i++) {
    const randomJpn = jpnWords[Math.floor(Math.random() * jpnWords.length)];
    const randomEng = engWords[Math.floor(Math.random() * engWords.length)];
    
    batch.push({
      pseudo: randomJpn + randomEng,
      jpnWord: randomJpn,
      engWord: randomEng
    });
  }
  
  console.log(`‚úÖ Batch de ${batch.length} pseudos g√©n√©r√©s avec combinaisons al√©atoires`);
  console.log('üé≤ Exemples:', batch.slice(0, 3).map(p => p.pseudo));
  
  return batch;
}
// Initialiser le cache au premier affichage de create-account
function initPseudoCache() {
  if (pseudoCache.length === 0) {
    pseudoCache = generatePseudoBatch();
    currentPseudoIndex = 0;
  }
  
  // Initialiser avec le premier pseudo
  const pseudoInput = document.getElementById('pseudo-input');
  if (pseudoInput && pseudoCache.length > 0) {
    pseudoInput.value = pseudoCache[0].pseudo;
    currentPseudoProposal = pseudoCache[0];
    currentPseudoIndex = 1;
  }
  
  // S'assurer que l'√©tape 1 est active
  document.querySelectorAll('.onboarding-step').forEach(step => {
    step.classList.remove('active');
  });
  document.getElementById('onboarding-step-1').classList.add('active');
  
  // Initialiser protection anti-bot
  sessionStartTime = Date.now();
  stepTimestamps = { 1: Date.now() };
  userInteractions = { clicks: 0, keystrokes: 0, mouseMovements: 0 };
  
  // ‚úÖ RETIR√â : La d√©tection de langue se fait maintenant dans initGame/window.onload
  
  console.log('üõ°Ô∏è Session anti-bot initialis√©e');
}
// ========================================
// G√âN√âRATION DE PSEUDO - REMPLACER LA FONCTION EXISTANTE
// ========================================
async function generateNewPseudo() {
  const pseudoInput = document.getElementById('pseudo-input');
  const errorDiv = document.getElementById('create-error');
  
  // V√©rifier que les √©l√©ments existent (protection)
  if (!pseudoInput) {
    console.warn('‚ö†Ô∏è Champ pseudo non trouv√©');
    return;
  }
  
  if (errorDiv) {
    errorDiv.style.display = 'none';
  }
  
  // Si cache vide ou √©puis√©, r√©g√©n√©rer un batch
  if (currentPseudoIndex >= pseudoCache.length) {
    pseudoCache = generatePseudoBatch();
    currentPseudoIndex = 0;
    
    if (pseudoCache.length === 0) {
      if (errorDiv) {
        errorDiv.textContent = 'Erreur : listes de mots non charg√©es';
        errorDiv.style.display = 'block';
      }
      pseudoInput.value = '';
      return;
    }
  }
  
  // Proposer le prochain pseudo du cache
  currentPseudoProposal = pseudoCache[currentPseudoIndex];
  currentPseudoIndex++;
  
  pseudoInput.value = currentPseudoProposal.pseudo;
  
  console.log(`üéØ Pseudo propos√©: ${currentPseudoProposal.pseudo} (${currentPseudoIndex}/${pseudoCache.length} du cache)`);
}

// ========================================
// CONNEXION (changement d'appareil)
// ========================================
async function loginUser() {
  const pseudo = document.getElementById('login-pseudo').value.trim();
  const day = document.getElementById('login-birth-day').value;
  const month = document.getElementById('login-birth-month').value;
  const errorDiv = document.getElementById('login-error');
  const successDiv = document.getElementById('login-success');
  
  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';
  
  // Validation
if (!pseudo) {
  errorDiv.textContent = t('error_enter_pseudo');
  errorDiv.style.display = 'block';
  return;
}

if (!day || !month) {
  errorDiv.textContent = t('error_select_birthdate');
  errorDiv.style.display = 'block';
  return;
}
  
  const pin = day + month;
  
  try {
    console.log('üîê Tentative de connexion:', pseudo);
    
    // ‚úÖ AJOUT√â : Afficher le loader
    document.getElementById('login').classList.remove('active');
    document.getElementById('login-loader').style.display = 'flex';
    
    const authResult = await callAPI('authenticateUser', { pseudo, pin });
    
if (!authResult.success) {
  document.getElementById('login-loader').style.display = 'none';
  document.getElementById('login').classList.add('active');
  
  errorDiv.textContent = authResult.error || t('error_wrong_credentials');
  errorDiv.style.display = 'block';
  return;
}
    
    const newToken = crypto.randomUUID();
    
    const updateResult = await callAPI('updateUserToken', {
      pseudo,
      pin,
      newToken
    });
    
    if (updateResult.success) {
      // ‚úÖ Sauvegarder le token
      userToken = newToken;
      localStorage.setItem('userToken', newToken);
      currentUser = authResult.user;
      
      console.log('‚úÖ Token mis √† jour, rechargement des donn√©es...');
      
      // ‚úÖ R√©initialiser le contexte du jeu
      resetGameContext();
      
      // ‚úÖ Recharger les stats
      await loadUserProgress();
      
      currentUser.token = newToken;
      
      console.log('‚úÖ Connexion r√©ussie:', currentUser.pseudo);
      console.log(`üìä Niveau actif: ${niveauActif}, Niveau atteint: ${currentUser.niveau_atteint}`);
      
      // ‚úÖ MODIFI√â : Masquer le loader
      document.getElementById('login-loader').style.display = 'none';
      
      // ‚úÖ AJOUT√â : Afficher le message de bienvenue returning user
      showReturningUserWelcome(currentUser.pseudo);
      
} else {
  document.getElementById('login-loader').style.display = 'none';
  document.getElementById('login').classList.add('active');
  
  errorDiv.textContent = t('error_token_update');
  errorDiv.style.display = 'block';
}
    
} catch (error) {
  document.getElementById('login-loader').style.display = 'none';
  document.getElementById('login').classList.add('active');
  
  errorDiv.textContent = t('error_connection');
  errorDiv.style.display = 'block';
  console.error('‚ùå Erreur connexion:', error);
}
}
// ========================================
// AFFICHER LA PAGE DE CONNEXION
// ========================================
function showChangeDevice() {
  showSection('login');
  
  // ‚úÖ AJOUT√â : Initialiser les s√©lecteurs de date
  setTimeout(() => {
    initLoginBirthdateSelectors();
  }, 100);
}

// ========================================
// METTRE √Ä JOUR L'AFFICHAGE DU COMPTE
// ========================================
function updateAccountDisplay() {
  if (currentUser) {
    document.getElementById('account-pseudo').textContent = currentUser.pseudo;
    
    const niveauAffiche = currentUser.niveau_actif || niveauActif;
    document.getElementById('account-level').textContent = `${niveauAffiche} ${t('account_level_in_progress')}`;
    
    console.log(`üë§ Affichage compte: pseudo=${currentUser.pseudo}, niveau=${niveauAffiche}`);
  }
}
// ‚úÖ NOUVELLE FONCTION √† ajouter apr√®s updateAllTexts()
function updatePlaceholders() {
  // Mettre √† jour les placeholders avec data-i18n-placeholder
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    element.placeholder = t(key);
  });
}    
function resetGameContext() {
  // ‚úÖ R√©initialiser les variables de contexte
  current = {};
  selections = { first: null, second: null };
  isAnswered = false;
  previousCharacter = null;
  
  // ‚úÖ Vider les choix affich√©s
  const choices1 = document.getElementById("choices1");
  const choices2 = document.getElementById("choices2");
  if (choices1) choices1.innerHTML = "";
  if (choices2) choices2.innerHTML = "";
  
  // ‚úÖ Vider le r√©sultat
  const result = document.getElementById("result");
  if (result) result.innerText = "";
  
  // ‚úÖ Masquer le bouton continuer
  const continueBtn = document.getElementById("continueBtn");
  if (continueBtn) continueBtn.style.visibility = "hidden";
  
  console.log('üîÑ Contexte du jeu r√©initialis√©');
}    
// ========================================
// VALIDATION ET FORMATAGE DATE DE NAISSANCE
// ========================================
function formatPinToDate(pin) {
  if (!pin || pin.length !== 4) return null;
  const day = pin.substring(0, 2);
  const month = pin.substring(2, 4);
  
  // ‚úÖ Utiliser les traductions selon la langue
  const monthsKeys = ['month_01', 'month_02', 'month_03', 'month_04', 'month_05', 'month_06',
                      'month_07', 'month_08', 'month_09', 'month_10', 'month_11', 'month_12'];
  const monthName = t(monthsKeys[parseInt(month) - 1]);
  
  return { day, month, monthName, formatted: `${day}/${month}` };
}
// ‚úÖ NOUVELLE FONCTION : Formate la date selon la langue
function formatDateForDisplay(day, month) {
  const monthsKeys = ['month_01', 'month_02', 'month_03', 'month_04', 'month_05', 'month_06',
                      'month_07', 'month_08', 'month_09', 'month_10', 'month_11', 'month_12'];
  const monthName = t(monthsKeys[parseInt(month) - 1]);
  const dayNum = parseInt(day);
  
  if (currentLanguage === 'en') {
    // Format anglais : "March 3rd"
    const suffix = getOrdinalSuffix(dayNum);
    return `${monthName} ${dayNum}${suffix}`;
  } else if (currentLanguage === 'es') {
    // Format espagnol : "3 de marzo"
    return `${dayNum} de ${monthName}`;
  } else {
    // Format fran√ßais (par d√©faut) : "3 mars"
    return `${dayNum} ${monthName}`;
  }
}

// ‚úÖ FONCTION HELPER : Retourne le suffixe ordinal anglais (1st, 2nd, 3rd, 4th...)
function getOrdinalSuffix(day) {
  if (day >= 11 && day <= 13) {
    return 'th';
  }
  switch (day % 10) {
    case 1: return 'st';
    case 2: return 'nd';
    case 3: return 'rd';
    default: return 'th';
  }
}
function validatePin(pin) {
  if (!pin || pin.length !== 4) {
    return { valid: false, error: 'Le PIN doit contenir exactement 4 chiffres' };
  }
  
  if (!/^\d{4}$/.test(pin)) {
    return { valid: false, error: 'Le PIN doit contenir uniquement des chiffres' };
  }
  
  const day = parseInt(pin.substring(0, 2));
  const month = parseInt(pin.substring(2, 4));
  
  if (day < 1 || day > 31) {
    return { valid: false, error: 'Le jour doit √™tre entre 01 et 31' };
  }
  
  if (month < 1 || month > 12) {
    return { valid: false, error: 'Le mois doit √™tre entre 01 et 12' };
  }
  
  return { valid: true };
}
// ========================================
// RETOUR AU MENU
// ========================================
function backToMenu() {
  showSection('menu-section');
  toggleMenu();
}
// Nouvelle fonction : Charger progr√®s per-user et merger
// Am√©lioration de loadUserProgress() : Ajoute logs et defaults
async function loadUserProgress() {
  if (!userToken) {
    console.warn('‚ö†Ô∏è Pas de token - Stats non charg√©es');
    return;
  }
  
  const userStats = await callAPI('getUserStats', { token: userToken });
  if (userStats.success) {
    const stats = userStats.stats || {};
    let mergedCount = 0;
    
    // ‚úÖ Merger les stats dans HiraganaList
    HiraganaList.forEach(item => {
      const itemId = item.ID.toString();
      const itemStats = stats[itemId] || { validation: 0, tentatives: 0, reussites: 0 };
      
      item.Validation = itemStats.validation;
      item.Tentatives = itemStats.tentatives;
      item['R√©ussites'] = itemStats.reussites;
      mergedCount++;
      
      const id = parseInt(item.ID);
      validationCache[id] = parseInt(itemStats.validation);
      
      const tentatives = parseInt(itemStats.tentatives || 0);
      const reussites = parseFloat(itemStats.reussites || 0);
      const pourcentage = tentatives > 0 ? (reussites / tentatives * 100) : 0;
      
      statsCache.items[id] = {
        tentatives: tentatives,
        reussites: reussites,
        pourcentage: pourcentage
      };
    });

    const totalTentatives = Object.values(statsCache.items).reduce((sum, item) => sum + item.tentatives, 0);
    const totalReussites = Object.values(statsCache.items).reduce((sum, item) => sum + item.reussites, 0);
    statsCache.globalPourcentage = totalTentatives > 0 ? (totalReussites / totalTentatives * 100) : 0;

    console.log(`üìä Progr√®s user charg√©: ${mergedCount} items merg√©s`);
    
    // ‚úÖ Calculer le niveau MAX ATTEINT (niveaux 100% compl√©t√©s)
    let niveauMaxAtteint = 0;
    const maxLevel = getMaxLevel(HiraganaList);
    
    for (let n = 1; n <= maxLevel; n++) {
      const itemsNiveau = HiraganaList.filter(h => parseInt(h.Niveau) === n);
      const itemsValides = itemsNiveau.filter(h => parseInt(h.Validation || 0) >= 5);
      
      if (itemsValides.length === itemsNiveau.length && itemsNiveau.length > 0) {
        niveauMaxAtteint = n;
      } else {
        break;
      }
    }
    
    // ‚úÖ Calculer le niveau ACTIF (utilise la fonction corrig√©e)
    niveauActif = determineNiveauActif(HiraganaList);
    
    console.log(`üèÜ Niveau MAX ATTEINT: ${niveauMaxAtteint} (tous les items √† >=5)`);
    console.log(`üéÆ Niveau ACTIF: ${niveauActif} (premier niveau incomplet)`);
    console.log(`üö´ Mode apprentissage bloqu√©: ${isApprentissageBloque()}`);
    
    // ‚úÖ Mettre √† jour currentUser
    if (currentUser) {
      currentUser.niveau_atteint = niveauMaxAtteint;
      currentUser.niveau_actif = niveauActif;
    }
    
    // ‚úÖ R√©g√©n√©rer les tables
    revisionRomajiTable = generateRevisionRomajiTable(HiraganaList);
    revisionKatakanaTable = generateRevisionKatakanaTable(HiraganaList);
    
    // ‚úÖ Rafra√Æchir l'UI
    document.getElementById("levelDisplay").innerText = `${t('quiz_level')} ${niveauActif}`;
    updateLevelProgress(HiraganaList, niveauActif);
    renderProgressBar(niveauActif, maxLevel);
    renderHiraganaCards(HiraganaList, niveauActif);
    updateMenuButtonStates();
    updateAccountDisplay();
    
    console.log('‚úÖ loadUserProgress termin√©');
    
  } else {
    console.error('‚ö†Ô∏è Erreur chargement stats user:', userStats.error);
    niveauActif = 1;
    if (currentUser) {
      currentUser.niveau_atteint = 0;
      currentUser.niveau_actif = 1;
    }
    document.getElementById("levelDisplay").innerText = `${t('quiz_level')} 1`;
    updateAccountDisplay();
  }
}


function showAccountCreationLoader() {
  const messages = [
    t('loader_meditation'),
    t('loader_tea'),
    t('loader_cherry'),
    t('loader_garden'),
    t('loader_ceremony')
  ];
  
  const loaderScreen = document.getElementById('account-creation-loader');
  const textElement = loaderScreen.querySelector('.zen-loader-text');
  
  textElement.textContent = messages[Math.floor(Math.random() * messages.length)];
  
  loaderScreen.style.display = 'flex';
}

// ‚úÖ Ajouter animation sakura adapt√©e √† votre fonction existante
function showWelcomeAnimation(pseudo) {
  hideAccountCreationLoader();
  
  const welcomeScreen = document.getElementById('welcome-screen');
  const titleElement = document.querySelector('.welcome-user-title');
  
  titleElement.textContent = `${t('welcome_user')} ${pseudo} üéå`;
  welcomeScreen.style.display = 'flex';
  
  triggerSakuraFall(welcomeScreen);
  
  playLevelUp();
}
function hideAccountCreationLoader() {
  document.getElementById('account-creation-loader').style.display = 'none';
}



function showLoginFromCreate() {
  // Masquer la section create-account
  document.getElementById('create-account').classList.remove('active');
  
  // Afficher la section login
  document.getElementById('login').classList.add('active');
  
  // Vider les champs par s√©curit√©
  document.getElementById('login-pseudo').value = '';
  document.getElementById('login-pin').value = '';
  
  // Masquer les messages d'erreur/succ√®s
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-success').style.display = 'none';
  
  console.log('üîÑ Navigation vers connexion depuis cr√©ation de compte');
}    
function toggleMenu() {
  const menu = document.getElementById('menu');
  const hamburger = document.querySelector('.hamburger');
  
  menu.classList.toggle('active');
  
  // ‚úÖ CORRECTION : Utiliser une classe au lieu de style.display
  if (hamburger) {
    if (menu.classList.contains('active')) {
      hamburger.classList.add('hidden');
    } else {
      hamburger.classList.remove('hidden');
    }
  }
  
  // V√©rifier l'√©tat des boutons √† chaque ouverture du menu
  if (menu.classList.contains('active')) {
    updateMenuButtonStates();
  }
}
function loadDifficulty() {
  const saved = localStorage.getItem("difficulty");
  if (saved) {
    seuilValidation = parseInt(saved, 10);
    console.log("Difficult√© restaur√©e :", seuilValidation);
  } else {
    // valeur par d√©faut si rien n'est encore enregistr√©
    seuilValidation = 6; // Moyen par d√©faut
  }
}
function showSubOptions(section) {
  // Masquer le menu principal
  document.querySelector(".options-menu").classList.add("hidden");

  // Masquer toutes les sous-rubriques
  document.querySelectorAll('.options-sub').forEach(div => {
    div.classList.remove("active");
    div.classList.add("hidden");
  });

  // Afficher la sous-rubrique choisie avec animation
  const sub = document.getElementById('options-' + section);
  sub.classList.remove("hidden");
  setTimeout(() => sub.classList.add("active"), 10);
}

function backToOptions() {
  // Masquer toutes les sous-rubriques
  document.querySelectorAll('.options-sub').forEach(div => {
    div.classList.remove("active");
    div.classList.add("hidden");
  });

  // R√©afficher le menu principal Options
  const menu = document.querySelector(".options-menu");
  menu.classList.remove("hidden");
}

function setDifficulty(value) {
  seuilValidation = value; 
  localStorage.setItem("difficulty", value);

  // Mise en surbrillance du bouton choisi
  document.querySelectorAll("#options-difficulty .arcade-button").forEach(btn => {
    btn.classList.remove("clicked-glow");
  });
  event.target.classList.add("clicked-glow");

  // ‚úÖ Mettre √† jour le bouton Apprendre
  updateApprendreButtonState();

alert(`${t('difficulty_set')} ${value}`);

 niveauActif = determineNiveauActif(HiraganaList);
  document.getElementById("levelDisplay").innerText = `Niveau actuel : ${niveauActif}`;
  updateLevelProgress(HiraganaList, niveauActif);
  renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
  nextQuestion();      


}
function showSection(sectionId) {
  // ‚úÖ CORRECTION : Gestion de l'affichage du hamburger avec classe
  const hamburger = document.querySelector('.hamburger');
 const sectionsWithHamburger = ['quiz', 'mode2', 'account', 'stats', 'options', 
                                'options-difficulty', 'options-sound', 'options-language', 'login'];
  
  if (hamburger) {
    if (sectionsWithHamburger.includes(sectionId)) {
      hamburger.classList.remove('hidden');
    } else {
      hamburger.classList.add('hidden');
    }
  }
  // NOUVEAU : V√©rifier le blocage seulement lors du retour au menu depuis le mode r√©vision
  if (sectionId === 'menu-section' && revisionMode.isActive) {
    const wasBlocked = hasShownBlockedMenu; // √âtat pr√©c√©dent
    const isNowBlocked = isApprentissageBloque();
    
    // Mettre √† jour l'√©tat des boutons
    updateApprendreButtonState();
    
    // Afficher message appropri√©
    if (isNowBlocked && !wasBlocked) {
      // Passage de d√©bloqu√© √† bloqu√©
      setTimeout(() => {
        const menu = document.getElementById('menu');
        const menuMessage = document.getElementById('menu-message');
        menu.classList.add('active');
        menuMessage.innerText = t('menu_msg_blocked'); // ‚úÖ MODIFI√â
        hasShownBlockedMenu = true;
      }, 500);
    } else if (!isNowBlocked && wasBlocked) {
      // Passage de bloqu√© √† d√©bloqu√©
      setTimeout(() => {
        const menu = document.getElementById('menu');
        const menuMessage = document.getElementById('menu-message');
        menu.classList.add('active');
        menuMessage.innerText = t('menu_msg_unblocked'); // ‚úÖ MODIFI√â
        hasShownBlockedMenu = false;
        hasShownUnblockedMenu = true;
      }, 500);
    } else if (isNowBlocked) {
      // Toujours bloqu√©
      setTimeout(() => {
        const menuMessage = document.getElementById('menu-message');
        if (menuMessage) {
          menuMessage.innerText = t('menu_msg_still_blocked'); // ‚úÖ MODIFI√â
        }
      }, 500);
    }
    // Si on quitte le mode r√©vision
  if (sectionId !== 'mode2') { // 'mode2' est l'ID de la section r√©vision
    revisionMode.isActive = false;
    hasUnlockedInRevision = false; // R√©initialiser pour la prochaine session
  }
  }

  // NOUVEAU : V√©rifier syst√©matiquement l'√©tat du bouton Apprendre √† chaque passage par le menu
  if (sectionId === 'menu-section') {
    updateApprendreButtonState();
    updateMenuSectionMessage();
  }

  // V√©rifier si on essaie d'acc√©der au mode r√©vision
  if (sectionId === 'mode2' && !isRevisionModeAvailable()) {
    console.log('Mode r√©vision non disponible');
    return;
  }

  // SUPPRIMER la redirection automatique vers le mode r√©vision
  // Le bouton bloqu√© ne doit plus rediriger, il doit juste √™tre inop√©rant
  
document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(sectionId).classList.add('active');
  
  if (sectionId === 'create-account') {
    initPseudoCache();
    generateNewPseudo();
  }
  
  // D√©marrer le mode r√©visions si c'est le mode s√©lectionn√©
  if (sectionId === 'mode2') {
    wasBlockedWhenEnteringRevision = isApprentissageBloque();
    if (wasBlockedWhenEnteringRevision) {
      deficitInitialRevision = calculerDeficitValidation();
      pointsGagnesEnRevision = 0;
      console.log(`üéØ D√©ficit initial captur√©: ${deficitInitialRevision} points`);
    }
    hasUnlockedInRevision = false;
    revisionMode.isActive = true;
    setTimeout(() => {
      initRevisionKeyboard();
      startRevisionQuestion();
    }, 100);
  } else {
    revisionMode.isActive = false;
    wasBlockedWhenEnteringRevision = false;
  }
  
  // ‚úÖ NOUVEAU : G√©n√©rer une question quand on ouvre le mode Apprendre
  if (sectionId === 'quiz') {
    console.log('üéÆ Ouverture mode Apprendre, g√©n√©ration d\'une question...');
    setTimeout(() => {
      nextQuestion();
    }, 100);
  }
    // ‚úÖ NOUVEAU : G√©n√©rer les stats quand on ouvre la page stats
if (sectionId === 'stats') {
    setTimeout(generateGarden, 100);
  }
  // ‚úÖ CORRECTION : Ne fermer le menu que s'il est ouvert
  if (sectionId !== 'create-account') {
    const menu = document.getElementById('menu');
    
    // Ne toggle que si le menu est actuellement ouvert
    if (menu && menu.classList.contains('active')) {
      toggleMenu();
    }
    
    // R√©afficher le hamburger
    setTimeout(() => {
      const hamburger = document.querySelector('.hamburger');
      if (hamburger && sectionsWithHamburger.includes(sectionId)) {
        hamburger.classList.remove('hidden'); // ‚úÖ Chang√©
      }
    }, 100);
  }


}
// ========================================
// ONBOARDING - NAVIGATION ENTRE √âTAPES
// ========================================

function goToStep(stepNumber) {
  const currentStep = document.querySelector('.onboarding-step.active');
  const nextStep = document.getElementById(`onboarding-step-${stepNumber}`);
  
  if (!currentStep || !nextStep) return;
  
  // Enregistrer timestamp de l'√©tape
  stepTimestamps[stepNumber] = Date.now();
  
  // Masquer tous les messages d'erreur
  document.getElementById('create-error')?.style.setProperty('display', 'none');
  document.getElementById('pin-error')?.style.setProperty('display', 'none');
  
  // Animation de sortie
  currentStep.classList.add('slide-out-left');
  
  setTimeout(() => {
    currentStep.classList.remove('active', 'slide-out-left');
    nextStep.classList.add('active', 'slide-in-right');
    
    // Focus sur le champ appropri√©
    if (stepNumber === 2) {
      document.getElementById('pseudo-input')?.focus();
    } else if (stepNumber === 3) {
      // ‚úÖ AJOUT√â : Initialiser les s√©lecteurs de date
      initBirthdateSelectors();
      document.getElementById('birth-day')?.focus();
    }
    
    setTimeout(() => {
      nextStep.classList.remove('slide-in-right');
    }, 400);
  }, 400);
  
  console.log(`üéã Navigation vers √©tape ${stepNumber}`);
}
function showLoginFromOnboarding() {
  document.getElementById('create-account').classList.remove('active');
  document.getElementById('login').classList.add('active');
  
  document.getElementById('login-pseudo').value = '';
  
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-success').style.display = 'none';
    // ‚úÖ AJOUT√â : Initialiser les s√©lecteurs de date
  setTimeout(() => {
    initLoginBirthdateSelectors();
  }, 100);
  console.log('üîÑ Navigation vers connexion depuis onboarding');
}

function validatePseudoAndContinue() {
  const pseudoInput = document.getElementById('pseudo-input');
  const pseudo = pseudoInput.value.trim();
  const errorDiv = document.getElementById('create-error');
  
  // V√©rification d√©lai minimum
  const timeOnStep = Date.now() - (stepTimestamps[2] || Date.now());
  const requiredTime = 3000;
  
if (timeOnStep < requiredTime) {
  const remainingTime = Math.ceil((requiredTime - timeOnStep) / 1000);
  console.warn('ü§ñ Navigation trop rapide - bot suspect√©');
  if (errorDiv) {
    const secondText = remainingTime > 1 ? t('error_seconds') : t('error_second');
    errorDiv.textContent = `${t('error_please_wait')} ${remainingTime} ${secondText}...`;
    errorDiv.style.display = 'block';
    errorDiv.style.color = '#f39c12';
  }
  
  setTimeout(() => {
    if (errorDiv) {
      errorDiv.style.display = 'none';
      errorDiv.style.color = '#dc3545';
    }
  }, remainingTime * 1000);
  
  return;
}
  
  // Validation du pseudo
if (!pseudo || pseudo.length < 2) {
  errorDiv.textContent = t('error_pseudo_too_short');
  errorDiv.style.display = 'block';
  errorDiv.style.color = '#dc3545';
  pseudoInput.focus();
  return;
}

if (pseudo.length > 20) {
  errorDiv.textContent = t('error_pseudo_too_long');
  errorDiv.style.display = 'block';
  errorDiv.style.color = '#dc3545';
  pseudoInput.focus();
  return;
}

const validPattern = /^[a-zA-Z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ø√ß√±√Ä√Ç√Ñ√â√à√ä√ã√è√é√î√ô√õ√ú≈∏√á√ë]+$/;
if (!validPattern.test(pseudo)) {
  errorDiv.textContent = t('error_pseudo_invalid_chars');
  errorDiv.style.display = 'block';
  errorDiv.style.color = '#dc3545';
  pseudoInput.focus();
  return;
}
  
  // Mettre √† jour currentPseudoProposal
  currentPseudoProposal = {
    pseudo: pseudo,
    jpnWord: currentPseudoProposal?.jpnWord || '',
    engWord: currentPseudoProposal?.engWord || ''
  };
  
  errorDiv.style.display = 'none';
  
  console.log(`‚úÖ Pseudo valid√©: ${pseudo}`);
  goToStep(3);
}

// ‚úÖ AJOUT√â : Initialiser les s√©lecteurs de date
function initBirthdateSelectors() {
  const daySelect = document.getElementById('birth-day');
  const monthSelect = document.getElementById('birth-month');
  
  if (!daySelect || !monthSelect) return;
  
  // G√©n√©rer les jours (01-31)
  daySelect.innerHTML = '<option value="">--</option>';
  for (let i = 1; i <= 31; i++) {
    const day = String(i).padStart(2, '0');
    daySelect.innerHTML += `<option value="${day}">${day}</option>`;
  }
  
  // G√©n√©rer les mois avec la langue actuelle
  const months = {
    fr: ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'],
    en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    es: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
  };
  
  // ‚úÖ MODIFI√â : Utiliser currentLanguage au lieu de le red√©finir
  const monthNames = months[currentLanguage] || months.en;
  monthSelect.innerHTML = '<option value="">--</option>';
  
  for (let i = 1; i <= 12; i++) {
    const month = String(i).padStart(2, '0');
    monthSelect.innerHTML += `<option value="${month}">${monthNames[i-1]}</option>`;
  }
  
  console.log(`üìÖ S√©lecteurs de date initialis√©s en ${currentLanguage}`);
}
// ‚úÖ AJOUT√â : Initialiser les s√©lecteurs de date pour le login
function initLoginBirthdateSelectors() {
  const daySelect = document.getElementById('login-birth-day');
  const monthSelect = document.getElementById('login-birth-month');
  
  if (!daySelect || !monthSelect) return;
  
  // G√©n√©rer les jours (01-31)
  daySelect.innerHTML = '<option value="">--</option>';
  for (let i = 1; i <= 31; i++) {
    const day = String(i).padStart(2, '0');
    daySelect.innerHTML += `<option value="${day}">${day}</option>`;
  }
  
  // G√©n√©rer les mois avec la langue actuelle
  const months = {
    fr: ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'],
    en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    es: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
  };
  
  const monthNames = months[currentLanguage] || months.en;
  monthSelect.innerHTML = '<option value="">--</option>';
  
  for (let i = 1; i <= 12; i++) {
    const month = String(i).padStart(2, '0');
    monthSelect.innerHTML += `<option value="${month}">${monthNames[i-1]}</option>`;
  }
  
  console.log(`üìÖ S√©lecteurs de date login initialis√©s en ${currentLanguage}`);
}
function validateBirthdateAndContinue() {
  const daySelect = document.getElementById('birth-day');
  const monthSelect = document.getElementById('birth-month');
  const errorDiv = document.getElementById('pin-error');
  
  const day = daySelect.value;
  const month = monthSelect.value;
  
  // V√©rification d√©lai minimum
  const timeOnStep = Date.now() - (stepTimestamps[3] || Date.now());
  const requiredTime = 2000;
  
  if (timeOnStep < requiredTime) {
    const remainingTime = Math.ceil((requiredTime - timeOnStep) / 1000);
    console.warn('ü§ñ Navigation trop rapide - bot suspect√©');
    if (errorDiv) {
      const secondText = remainingTime > 1 ? t('error_seconds') : t('error_second');
      errorDiv.textContent = `${t('error_please_wait')} ${remainingTime} ${secondText}...`;
      errorDiv.style.display = 'block';
      errorDiv.style.color = '#f39c12';
    }
    
    setTimeout(() => {
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.style.color = '#dc3545';
      }
    }, remainingTime * 1000);
    
    return;
  }
  
  // Validation de la s√©lection
  if (!day || !month) {
    if (errorDiv) {
      errorDiv.textContent = t('error_select_date');
      errorDiv.style.display = 'block';
      errorDiv.style.color = '#dc3545';
    }
    return;
  }
  
  // ‚úÖ AJOUT√â : D√©finition de daysInMonth
  const daysInMonth = {
    '01': 31, '02': 29, '03': 31, '04': 30, '05': 31, '06': 30,
    '07': 31, '08': 31, '09': 30, '10': 31, '11': 30, '12': 31
  };
  
  const maxDay = daysInMonth[month];
  if (parseInt(day) > maxDay) {
    if (errorDiv) {
      errorDiv.textContent = `${t('error_invalid_day')} ${day} ${t('error_invalid_day_suffix')}`;
      errorDiv.style.display = 'block';
      errorDiv.style.color = '#dc3545';
    }
    return;
  }
  
  if (errorDiv) {
    errorDiv.style.display = 'none';
  }
  
 // Cr√©er le PIN au format JJMM
const pin = day + month;
window.tempPin = pin;

// ‚úÖ Afficher la date format√©e selon la langue
const formattedDate = formatDateForDisplay(day, month);
document.getElementById('confirm-date-display').textContent = formattedDate;

console.log(`‚úÖ Date valid√©e: ${pin}`);
goToStep(4);
}
async function finalizeAccount() {
  const pin = window.tempPin;
  
  if (!pin || !currentPseudoProposal) {
    console.error('‚ùå Donn√©es manquantes pour finaliser le compte');
    return;
  }
  
  // ‚úÖ AJOUT√â : V√âRIFICATIONS ANTI-BOT
  
  // 1. V√©rifier honeypot
  const honeypot = document.getElementById('website');
  if (honeypot && honeypot.value !== '') {
    console.warn('ü§ñ Bot d√©tect√© via honeypot');
    showAccountCreationLoader();
    setTimeout(() => {
      hideAccountCreationLoader();
      goToStep(1);
    }, 2000);
    return;
  }
  
// 2. V√©rifier temps total minimum (15 secondes)
const totalTime = Date.now() - (sessionStartTime || Date.now());
const requiredTotalTime = 5000; // 15 secondes

if (totalTime < requiredTotalTime) {
  const remainingTime = Math.ceil((requiredTotalTime - totalTime) / 1000);
  console.warn('ü§ñ Cr√©ation trop rapide:', totalTime, 'ms');
  
  goToStep(4);
  
  const errorDiv = document.getElementById('create-error');
  if (errorDiv) {
    const secondText = remainingTime > 1 ? t('error_seconds') : t('error_second');
    errorDiv.textContent = `${t('error_please_wait')} ${remainingTime} ${secondText} ${t('error_before_validate')}`;
    errorDiv.style.display = 'block';
    errorDiv.style.color = '#f39c12';
  }
  
  setTimeout(() => {
    if (errorDiv) {
      errorDiv.style.display = 'none';
      errorDiv.style.color = '#dc3545';
    }
  }, remainingTime * 1000);
  
  return;
}

if (userInteractions.clicks < 3 || userInteractions.keystrokes < 0) {
  console.warn('ü§ñ Interactions insuffisantes:', userInteractions);
  const errorDiv = document.getElementById('create-error');
  if (errorDiv) {
    errorDiv.textContent = t('error_suspicious_activity');
    errorDiv.style.display = 'block';
  }
  return;
}
  
  // 4. V√©rifier que le pseudo a des mots source (protection suppl√©mentaire)
  if (!currentPseudoProposal.jpnWord && !currentPseudoProposal.engWord) {
    console.warn('ü§ñ Pseudo sans origine - suspect√©');
    return;
  }
  
  console.log('‚úÖ V√©rifications anti-bot pass√©es:', {
    totalTime: totalTime + 'ms',
    clicks: userInteractions.clicks,
    keystrokes: userInteractions.keystrokes,
    mouseMovements: userInteractions.mouseMovements
  });
  
  // Masquer l'√©tape 4 et afficher loader
  document.getElementById('onboarding-step-4').classList.remove('active');
  showAccountCreationLoader();
  
  userToken = crypto.randomUUID();
  
  try {
    const result = await callAPI('assignPseudo', {
      token: userToken,
      pseudo: currentPseudoProposal.pseudo,
      jpnWord: currentPseudoProposal.jpnWord,
      engWord: currentPseudoProposal.engWord,
      pin: pin
    });
    
    if (result.success) {
      localStorage.setItem('userToken', userToken);
      currentUser = result.user;
      await loadUserProgress();
      
      console.log('‚úÖ Compte cr√©√© avec succ√®s:', currentUser.pseudo);
      
      showWelcomeAnimation(currentUser.pseudo);
      
      setTimeout(() => {
        document.getElementById('welcome-screen').style.display = 'none';
        
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('welcome').classList.add('active');
        
        document.querySelector('.panda-logo').style.display = 'none';
        document.getElementById('loadingText').style.display = 'none';
        
        document.querySelector('.hamburger').classList.remove('hidden');
        
        if (isApprentissageBloque()) {
          console.log('üö´ Mode Apprendre bloqu√© ‚Üí Redirection vers Mode R√©vision');
          forceRevisionMode();
        } else {
          console.log('‚úÖ Mode Apprendre d√©bloqu√© ‚Üí Redirection vers Mode Apprendre');
          showSection('quiz');
        }
        
        updateAccountDisplay();
      }, 3500);
      
    } else {
  hideAccountCreationLoader();
  goToStep(4);
  const errorDiv = document.getElementById('create-error');
  
 
}
} catch (error) {
  hideAccountCreationLoader();
  goToStep(4);
  const errorDiv = document.getElementById('create-error');
  errorDiv.textContent = t('error_connection');
  errorDiv.style.display = 'block';
  console.error('‚ùå Erreur:', error);
}
  
  delete window.tempPin;
}
// ========================================
// MON PARCOURS - FUNCTIONS
// ========================================
function generateGarden() {
  const ground = document.getElementById('garden-ground');
  if (!ground) return;
  ground.innerHTML = '';

  const currentLevel = niveauActif;
  const visibleItems = HiraganaList.filter(item => parseInt(item.Niveau) <= currentLevel);

  const levels = {};
  visibleItems.forEach(item => {
    const lvl = parseInt(item.Niveau);
    if (!levels[lvl]) levels[lvl] = [];
    levels[lvl].push(item);
  });

  const itemsPerRow = 5;
  let currentRow = null;
  let itemsInRow = 0;

  // On parcourt tous les niveaux de 1 √† currentLevel
  for (let lvl = 1; lvl <= currentLevel; lvl++) {
    // Quand on change de niveau (sauf le premier), on ajoute un bug
    if (lvl > 1) {
      // Si la ligne est pleine, on cr√©e une nouvelle ligne
      if (!currentRow || itemsInRow === itemsPerRow) {
        currentRow = createNewRow();
        itemsInRow = 0;
      }
      // Ajouter le bug
      addBugToRow(currentRow);
      itemsInRow++;
    }

    // Ajouter tous les items de ce niveau
    if (levels[lvl]) {
      levels[lvl].forEach(item => {
        // Si la ligne est pleine, on cr√©e une nouvelle ligne
        if (!currentRow || itemsInRow === itemsPerRow) {
          currentRow = createNewRow();
          itemsInRow = 0;
        }

        const validation = validationCache[parseInt(item.ID)] || 0;
        let plant = getPlantEmoji(validation);

        const itemDiv = document.createElement('div');
        itemDiv.className = 'garden-item';
        itemDiv.onclick = () => openGardenModal(item, plant);
        itemDiv.innerHTML = `
          <div class="garden-plant">${plant}</div>
          <div class="garden-hiragana">${item.Hiragana}</div>
        `;

        currentRow.appendChild(itemDiv);
        itemsInRow++;
      });
    }
  }

  // Compl√©ter la derni√®re ligne si elle n'est pas pleine
  if (currentRow && itemsInRow < itemsPerRow) {
    addEmptySlots(currentRow, itemsPerRow - itemsInRow);
  }

  // === Fonctions utilitaires ===
  function createNewRow() {
    const row = document.createElement('div');
    row.className = 'garden-level';
    ground.appendChild(row);
    return row;
  }

  function addBugToRow(row) {
    const bugs = ['üêõ', 'ü¶ã', 'üêù', 'üêû', 'ü¶ó', 'ü¶ü', 'üçÇ'];
    const bugDiv = document.createElement('div');
    bugDiv.className = 'garden-item garden-bug';
    bugDiv.innerHTML = `<div style="font-size:2.8em;">${bugs[Math.floor(Math.random() * bugs.length)]}</div>`;
    row.appendChild(bugDiv);
  }

  function addEmptySlots(row, count) {
    for (let i = 0; i < count; i++) {
      const empty = document.createElement('div');
      empty.className = 'garden-item';
      empty.style.visibility = 'hidden';
      row.appendChild(empty);
    }
  }

  function getPlantEmoji(validation) {
    if (validation >= seuilValidation) {
      return ['üå∏', 'üå∏', 'üå∏', 'üå∏'][Math.floor(Math.random() * 4)];
    } else if (validation >= 5) {
      return ['üåø', 'üåø', 'üåø', 'üåø'][Math.floor(Math.random() * 4)];
    } else {
      return ['üå±', 'üå±'][Math.floor(Math.random() * 2)];
    }
  }

  // === L√©gende au scroll ===
  const container = document.querySelector('.garden-container');
  const legend = document.getElementById('garden-legend');
  if (legend) {
    legend.style.display = 'flex';
    legend.classList.add('visible');
    container.addEventListener('scroll', () => {
      legend.classList.toggle('visible', container.scrollTop > 80);
    });
  }
}
// Ouvre la flashcard
function openGardenModal(item, emoji) {
  document.getElementById('modal-plant').textContent = emoji;
  document.getElementById('modal-hiragana').textContent = item.Hiragana;
  document.getElementById('modal-katakana').textContent = getLocalizedKatakana(item) || '-';
  document.getElementById('modal-romaji').textContent = item.Romaji;
  document.getElementById('modal-level').textContent = item.Niveau;
  document.getElementById('modal-validation').textContent = validationCache[parseInt(item.ID)] || 0;

  document.getElementById('garden-modal').classList.add('visible');
  
  // Ferme automatiquement apr√®s 2,2 secondes
  setTimeout(closeGardenModal, 2200);

  // Son du hiragana
  const audio = new Audio(`https://emmanuel971-source.github.io/hirakataquizz/${encodeURIComponent(item.Hiragana)}.mp3`);
  audio.play().catch(() => {});
}

// Ferme la flashcard
function closeGardenModal() {
  document.getElementById('garden-modal').classList.remove('visible');
}    
function updateFilterCounts(data) {
  const counts = {
    all: data.length,
    acquired: data.filter(item => item.statutClass === 'acquired').length,
    review: data.filter(item => item.statutClass === 'review').length,
    progress: data.filter(item => item.statutClass === 'progress').length // ‚úÖ 'progress' au lieu de 'in-progress'
  };
  
  document.getElementById('count-all').textContent = `(${counts.all})`;
  document.getElementById('count-acquired').textContent = `(${counts.acquired})`;
  document.getElementById('count-review').textContent = `(${counts.review})`;
  document.getElementById('count-progress').textContent = `(${counts.progress})`;
}

/**
 * Filtre les donn√©es du parcours
 */
function filterStats(filter) {
  console.log('üîç Filtrage:', filter);
  
  // Mettre √† jour l'√©tat actif des boutons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
  
  // Afficher le tableau filtr√©
  renderStatsTable(currentStatsData, filter);
}

/**
 * Affiche le tableau du parcours
 */
function renderStatsTable(data, filter) {
  const tbody = document.getElementById('stats-table-body');
  
  // Filtrer les donn√©es
  let filtered = data;
  if (filter !== 'all') {
    filtered = data.filter(item => {
      if (filter === 'acquired') return item.statutClass === 'acquired';
      if (filter === 'review') return item.statutClass === 'review';
      if (filter === 'progress') return item.statutClass === 'progress';
      return true;
    });
  }
  
  // Trier par niveau puis par ID
filtered.sort((a, b) => {
  const nivA = parseInt(a.niveau);
  const nivB = parseInt(b.niveau);

  if (nivA !== nivB) return nivB - nivA;  // Dernier niveau en haut
  return b.id - a.id;                    // Et dernier item en haut
});
  
  // G√©n√©rer le HTML
// G√©n√©rer le HTML
if (filtered.length === 0) {
  tbody.innerHTML = `
    <tr>
      <td colspan="4" style="text-align: center; opacity: 0.5; padding: 2em;">
        üå∏ ${t('stats_no_items')}
      </td>
    </tr>
  `;
  return;
}
  
  tbody.innerHTML = filtered.map(item => `
    <tr class="${item.statutClass}">
      <td><strong>${item.hiragana}</strong></td>
      <td>${item.katakana}</td>
      <td><em>${item.romaji}</em></td>
      <td><span class="status-emoji">${item.statutEmoji}</span></td>
    </tr>
  `).join('');
  
  console.log(`üìã Tableau affich√©: ${filtered.length} items`);
}
   
function forceRevisionMode() {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById('mode2').classList.add('active');
  
  revisionMode.isActive = true;
  setTimeout(() => {
    initRevisionKeyboard();
    startRevisionQuestion();
    updateUnlockProgress(); // Ajouter cette ligne
  }, 100);
}    
function updateMenuMessage() {
  const menuMessage = document.getElementById('menu-message');
  if (menuMessage && menuMessage.innerText === '') {
    // Messages neutres multilingues (les emojis sont universels)
    const messages = [
      '‚õ©Ô∏è Kanas-Zen-Garden ‚õ©Ô∏è',
      'üéå Kanas-Zen-Garden üéå',
      'üçÉ Kanas-Zen-Garden üçµ',
    ];
    menuMessage.innerText = messages[Math.floor(Math.random() * messages.length)];
  }
}
// ========================================
// BIENVENUE RETURNING USER
// ========================================
function showReturningUserWelcome(pseudo) {
  const messages = [
    t('proverb_1'),
    t('proverb_2'),
    t('proverb_3'),
    t('proverb_4'),
    t('proverb_5'),
    t('proverb_6'),
    t('proverb_7'),
    t('proverb_8'),
    t('proverb_9'),
    t('proverb_10'),
    t('proverb_11'),
    t('proverb_12'),
    t('proverb_13'),
    t('proverb_14'),
    t('proverb_15'),
    t('proverb_16'),
    t('proverb_17'),
    t('proverb_18'),
    t('proverb_19'),
    t('proverb_20'),
    t('proverb_21'),
    t('proverb_22'),
    t('proverb_23'),
    t('proverb_24'),
    t('proverb_25')
  ];
  
  // ‚úÖ CR√âER UN OVERLAY TEMPORAIRE au lieu d'utiliser #welcome-screen
  const overlay = document.createElement('div');
  overlay.id = 'returning-user-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #F8F1E9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    overflow: hidden;
  `;
  
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  
  // Cr√©er le titre
  const title = document.createElement('h1');
  title.style.cssText = `
   
    color: #8B6F47;
    text-shadow: 0 0 20px rgba(253, 193, 197, 0.5);
    animation: welcome-fade-in 1s ease-out;
    text-align: center;
    padding: 0 20px;
    margin: 0 0 20px 0;
  `;
  title.textContent = `${t('welcome_back')} ${pseudo} ! üéå`;
  
  // Cr√©er le sous-titre
  const subtitle = document.createElement('p');
  subtitle.style.cssText = `
  
    color: #8B6F47;
    opacity: 0.8;
    animation: welcome-fade-in 1s ease-out 0.5s both;
    text-align: center;
    padding: 0 20px;
    margin: 0;
  `;
  subtitle.textContent = randomMessage;
  
  overlay.appendChild(title);
  overlay.appendChild(subtitle);
  
  // Ajouter au body
  document.body.appendChild(overlay);
  
  console.log('‚úÖ Overlay cr√©√© et ajout√© au DOM');
  
  // Petite chute de sakura
  for (let i = 0; i < 15; i++) {
    const sakura = document.createElement("div");
    sakura.className = "sakura";
    sakura.style.cssText = `
      position: absolute;
      width: 12px;
      height: 12px;
      background: #FDC1C5;
      border-radius: 50%;
      pointer-events: none;
      animation: sakuraFall ${2.5 + Math.random() * 1.5}s linear forwards;
      animation-delay: ${Math.random() * 1.5}s;
      left: ${Math.random() * 100}vw;
      top: -10px;
      z-index: 10;
    `;
    overlay.appendChild(sakura);
    setTimeout(() => sakura.remove(), 6000);
  }
  
  playZenBell();
  
setTimeout(() => {
  console.log('‚è∞ Timeout atteint, fermeture overlay');
  
  // Supprimer l'overlay
  overlay.remove();
  
  // Retourner √† la section welcome (fond zen)
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const welcomeSection = document.getElementById('welcome');
  welcomeSection.classList.add('active');
  
  // Masquer le panda et le texte de chargement
  const panda = document.querySelector('.panda-logo');
  const loadingText = document.getElementById('loadingText');
  if (panda) panda.style.display = 'none';
  if (loadingText) loadingText.style.display = 'none';
  
  // ‚úÖ NOUVEAU : Redirection intelligente
  if (isApprentissageBloque()) {
    console.log('üö´ Mode Apprendre bloqu√© ‚Üí Redirection vers Mode R√©vision');
    forceRevisionMode();
  } else {
    console.log('‚úÖ Mode Apprendre d√©bloqu√© ‚Üí Redirection vers Mode Apprendre');
    showSection('quiz');
  }
  
  // Afficher le hamburger
  const hamburger = document.querySelector('.hamburger');
  if (hamburger) hamburger.classList.remove('hidden');
  
  updateAccountDisplay();
}, 2500);
}
  </script>
<script>
let pointsGagnesEnRevision = 0; // ‚úÖ NOUVEAU : compteur de progression  
let wasBlockedWhenEnteringRevision = false;
let deficitInitialRevision = 0;  
let hasUnlockedInRevision = false; // Nouvelle variable pour suivre le d√©blocage  
let gameDataLoaded = false; // Nouvelle variable globale  
let HiraganaList = [];
let current = {};
let selections = { first: null, second: null };
let targetFields = [];
let isAnswered = false;
let niveauActif = 1;
let previousValidationStates = new Map();
let activeSparks = []; // Variable globale pour les particules
let globalParticleCount = 0; // Compteur global
let previousCharacter = null;
let hasShownLevel4Menu = false; // Variable pour suivre si le menu a √©t√© affich√© au niveau 4  
let validationCache = {}; // Ajouter cette ligne pr√®s des autres variables globales
let statsCache = {
  items: {}, // { [hiragana/katakana]: { tentatives, reussites, pourcentage } }
  globalPourcentage: 0
};
let seuilValidation = parseInt(localStorage.getItem('seuilValidation')) || 10;  
// Variables pour le mode r√©visions
let revisionMode = {
  currentQuestion: "",
  input: "",
  romajiSegments: [],
  charCounts: [],
  fullCorrect: "",
  cumulativeRomaji: [],
  cumulativeChars: [],
  isActive: false
};
const GROUPES = {
  1: { niveaux: [1, 2, 3], nom: "Groupe 1" },
  2: { niveaux: [4, 5], nom: "Groupe 2" },
  3: { niveaux: [6, 7, 8], nom: "Groupe 3" },
  4: { niveaux: [9, 10, 11, 12], nom: "Groupe 4" },
  5: { niveaux: [13, 14, 15, 16, 17], nom: "Groupe 5" },
  6: { niveaux: [18, 19, 20, 21, 22], nom: "Groupe 6" },
  7: { niveaux: [23, 24, 25, 26, 27], nom: "Groupe 7" },
  8: { niveaux: [28, 29, 30, 31, 32, 33], nom: "Groupe 8" },
  9: { niveaux: [34, 35, 36, 37, 38, 39], nom: "Groupe 9" },
  10: { niveaux: [40, 41, 42, 43, 44, 45, 46], nom: "Groupe 10" }
};

let hasShownBlockedMenu = false;
let hasShownUnblockedMenu = false;
function startApp() {
  if (!gameDataLoaded) {
    document.getElementById("loadingText").textContent = t('welcome_loading'); // ‚úÖ MODIFI√â
    return;
  }
  
  updateMenuMessage();
}
function updateMenuSectionMessage() {
  const messages = [
    'Continues √† apprendre ! üå∏',
    'Explores les options ! ‚öôÔ∏è',
    'Progresses chaque jour ! üêº',
    'Un pas apr√®s l\'autre üå∏',
    'Bravo, tu progresses üéå'
  ];
  const menuMessage = document.getElementById('menu-message');
  if (menuMessage) {
    menuMessage.innerText = messages[Math.floor(Math.random() * messages.length)];
  }
}  
function getNiveauGroupe(niveau) {
  for (const [groupeId, groupe] of Object.entries(GROUPES)) {
    if (groupe.niveaux.includes(niveau)) {
      return parseInt(groupeId);
    }
  }
  return 1;
}
function getItemCountForLevel(level) {
 return HiraganaList.filter(h => parseInt(h.Niveau) === level && parseInt(h.Niveau) >= level).length;
  
}
function calculerDeficitValidation() {
  const groupeActuel = getNiveauGroupe(niveauActif);
  if (groupeActuel < 3) return 0; // Pas de blocage avant le groupe 3
  
  let deficitTotal = 0;
  
  // Parcourir TOUS les groupes pr√©c√©dents (1 √† groupeActuel-1)
  for (let g = 1; g < groupeActuel; g++) {
    const niveauxGroupe = GROUPES[g].niveaux;
    
    for (const niveau of niveauxGroupe) {
      const itemsNiveau = HiraganaList.filter(h => parseInt(h.Niveau) === niveau);
      for (const item of itemsNiveau) {
        const validation = parseInt(item.Validation || 0);
        if (validation < seuilValidation) {
  deficitTotal += (seuilValidation - validation);
        }
      }
    }
  }
  
  return deficitTotal;
}
function calculerDeficitMaximum() {
  const groupeActuel = getNiveauGroupe(niveauActif);
  if (groupeActuel < 3) return 0;
  
  let totalItems = 0;
  
  // Parcourir TOUS les groupes pr√©c√©dents (1 √† groupeActuel-1)
  for (let g = 1; g < groupeActuel; g++) {
    const niveauxGroupe = GROUPES[g].niveaux;
    
    for (const niveau of niveauxGroupe) {
      const itemsNiveau = HiraganaList.filter(h => parseInt(h.Niveau) === niveau);
      totalItems += itemsNiveau.length;
    }
  }
  
  return totalItems * (seuilValidation - 5); // D√©ficit max = passage de 5 au seuil
}
function updateUnlockProgress() {
  const container = document.getElementById('unlock-progress-container');
  const fill = document.getElementById('unlock-progress-fill');

  if (!container || !fill) return;

  if (!revisionMode.isActive || !wasBlockedWhenEnteringRevision || hasUnlockedInRevision) {
    container.style.display = 'none';
    return;
  }

  container.style.display = 'block';

  const deficitRestant = Math.max(0, deficitInitialRevision - pointsGagnesEnRevision);
  const pourcentage = deficitInitialRevision > 0 ? (deficitRestant / deficitInitialRevision * 100) : 0;

  fill.style.width = `${pourcentage}%`;

  console.log(`üìä Progress: ${deficitRestant}/${deficitInitialRevision} (${pourcentage.toFixed(1)}%) | Points: ${pointsGagnesEnRevision}`);

  if (pointsGagnesEnRevision >= deficitInitialRevision) {
    container.style.display = 'none';
    hasUnlockedInRevision = true;
    localStorage.setItem('apprentissageBloque', 'false');
    updateApprendreButtonState();
    console.log('üéâ D√©blocage atteint');
  }

  if (pourcentage < 10 && pourcentage > 0) {
    fill.classList.add('proche-deblocage');
  } else {
    fill.classList.remove('proche-deblocage');
  }
}
function isGroupeDebloque(groupeId) {
  if (groupeId <= 2) return true; // Groupes 1 et 2 toujours d√©bloqu√©s
  
  // V√©rifier TOUS les groupes pr√©c√©dents (1 √† groupeId-1)
  for (let g = 1; g < groupeId; g++) {
    const niveauxGroupe = GROUPES[g].niveaux;
    
    for (const niveau of niveauxGroupe) {
      const itemsNiveau = HiraganaList.filter(h => parseInt(h.Niveau) === niveau);
      const itemsValides = itemsNiveau.filter(h => parseInt(h.Validation || 0) >= seuilValidation);
      
      if (itemsValides.length < itemsNiveau.length) {
        return false;
      }
    }
  }
  return true;
}
function isApprentissageBloque() {
  const groupeActuel = getNiveauGroupe(niveauActif);
  // Pour les niveaux ‚â§ 5 : logique actuelle
  if (niveauActif <= 5) {
    return groupeActuel >= 3 && !isGroupeDebloque(groupeActuel);
  }
  // Pour les niveaux > 5 : bloquer si d√©ficit > 2, d√©bloquer SEULEMENT si d√©ficit = 0
  else {
    const deficit = calculerDeficitValidation();
    // Si actuellement bloqu√©, ne d√©bloquer que si d√©ficit = 0
    const wasBlocked = localStorage.getItem('apprentissageBloque') === 'true';
    
    if (wasBlocked) {
      // D√©j√† bloqu√© : on ne d√©bloque QUE si d√©ficit = 0
      const shouldUnblock = deficit === 0;
      if (shouldUnblock) {
        localStorage.setItem('apprentissageBloque', 'false');
      }
      return !shouldUnblock;
    } else {
      // Pas encore bloqu√© : on bloque si d√©ficit > 2
      const shouldBlock = deficit > 2;
      if (shouldBlock) {
        localStorage.setItem('apprentissageBloque', 'true');
      }
      return shouldBlock;
    }
  }
}
  
// Initialisation du contexte audio (√† placer au d√©but du script, une seule fois)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  
// Fonction pour g√©n√©rer la table romaji √† partir des donn√©es  Sheet (VERSION CORRIG√âE)
function generateRevisionRomajiTable(hiraganaList) {
  const table = {};
  let validItems = 0;
  let invalidItems = 0;
  
  hiraganaList.forEach((item, index) => {
    const hiragana = item.Hiragana;
    const romaji = item.Romaji;
    
    // ‚úÖ V√âRIFICATIONS ROBUSTES
    if (!hiragana || !romaji) {
      console.warn(`‚ö†Ô∏è Item ${index} ignor√© - donn√©es manquantes:`, {hiragana, romaji});
      invalidItems++;
      return;
    }
    
    // Convertir en string si ce n'est pas d√©j√† le cas
    const hiraganaStr = String(hiragana).trim();
    const romajiStr = String(romaji).trim();
    
    if (hiraganaStr === '' || romajiStr === '' || romajiStr === 'undefined' || romajiStr === 'null') {
      console.warn(`‚ö†Ô∏è Item ${index} ignor√© - donn√©es vides:`, {hiragana: hiraganaStr, romaji: romajiStr});
      invalidItems++;
      return;
    }
    
    try {
      // Analyser le romaji pour cr√©er les segments
      const segments = analyzeRomajiSegments(romajiStr);
      table[hiraganaStr] = {
        romaji: segments.segments,
        charCounts: segments.charCounts,
        originalRomaji: romajiStr,
        niveau: item.Niveau,
        validation: item.Validation
      };
      validItems++;
    } catch (error) {
      console.error(`‚ùå Erreur lors de l'analyse de l'item ${index}:`, {hiragana: hiraganaStr, romaji: romajiStr}, error);
      invalidItems++;
    }
  });
  
  console.log(`üìä G√©n√©ration table romaji: ${validItems} items valides, ${invalidItems} items ignor√©s`);
  return table;
}
function generateRevisionKatakanaTable(hiraganaList) {
  const table = {};
  let validItems = 0;
  let invalidItems = 0;
  
  hiraganaList.forEach((item, index) => {
    const katakana = getLocalizedKatakana(item); // ‚úÖ NOUVEAU
    const romaji = item.Romaji;
    
    if (!katakana || !romaji) {
      console.warn(`‚ö†Ô∏è Item ${index} ignor√© pour Katakana - donn√©es manquantes:`, {katakana, romaji});
      invalidItems++;
      return;
    }
    
    const katakanaStr = String(katakana).trim();
    const romajiStr = String(romaji).trim();
    
    if (katakanaStr === '' || romajiStr === '' || romajiStr === 'undefined' || romajiStr === 'null') {
      invalidItems++;
      return;
    }
    
    try {
      const segments = analyzeRomajiSegments(romajiStr);
      table[katakanaStr] = {
        romaji: segments.segments,
        charCounts: segments.charCounts,
        originalRomaji: romajiStr,
        niveau: item.Niveau,
        validation: item.Validation
      };
      validItems++;
    } catch (error) {
      invalidItems++;
    }
  });
  
  console.log(`üìä G√©n√©ration table katakana: ${validItems} items valides, ${invalidItems} items ignor√©s`);
  return table;
}
// Fonction pour analyser et segmenter le romaji (VERSION CORRIG√âE)
function analyzeRomajiSegments(romajiInput) {
  if (!romajiInput) {
    throw new Error("Romaji vide ou null");
  }
  
  let romajiString = String(romajiInput).toLowerCase().trim();
  romajiString = romajiString.replace(/[^a-z]/g, '');

  if (romajiString === '') {
    throw new Error(`Romaji vide apr√®s nettoyage des caract√®res sp√©ciaux`);
  }

  // Segmenter intelligemment
  const segments = smartSegmentRomaji(romajiString);
  
  return {
    segments: segments,
    charCounts: segments.map(() => 1) // Chaque segment = 1 caract√®re visuel
  };
}
  
// Fonction pour segmenter intelligemment le romaji (INCHANG√âE mais ajout de v√©rifications)
function smartSegmentRomaji(romaji) {
  if (!romaji || typeof romaji !== 'string') {
    console.warn("smartSegmentRomaji: romaji invalide", romaji);
    return [romaji || ''];
  }
  
  const specialSyllables = [
    'tsu', 'shi', 'chi', 'sha', 'sho', 'shu', 'cha', 'cho', 'chu',
    'nya', 'nyo', 'nyu', 'hya', 'hyo', 'hyu', 'mya', 'myo', 'myu',
    'rya', 'ryo', 'ryu', 'gya', 'gyo', 'gyu', 'bya', 'byo', 'byu',
    'pya', 'pyo', 'pyu', 'kya', 'kyo', 'kyu', 'ja', 'ji', 'ju', 'jo'
  ];

  const basicSyllables = [
    'ka', 'ki', 'ku', 'ke', 'ko', 'ga', 'gi', 'gu', 'ge', 'go',
    'sa', 'shi', 'su', 'se', 'so', 'za', 'ji', 'zu', 'ze', 'zo',
    'ta', 'chi', 'tsu', 'te', 'to', 'da', 'ji', 'zu', 'de', 'do',
    'na', 'ni', 'nu', 'ne', 'no',
    'ha', 'hi', 'fu', 'he', 'ho', 'ba', 'bi', 'bu', 'be', 'bo', 'pa', 'pi', 'pu', 'pe', 'po',
    'ma', 'mi', 'mu', 'me', 'mo',
    'ya', 'yu', 'yo',
    'ra', 'ri', 'ru', 're', 'ro',
    'wa', 'wi', 'we', 'wo', 'n'
  ];

  const vowels = ['a', 'i', 'u', 'e', 'o'];

  const allSyllables = [...specialSyllables, ...basicSyllables, ...vowels];

  const segments = [];
  let remaining = romaji.toLowerCase();
  
  while (remaining.length > 0) {
    let found = false;
    
    // Essayer les syllabes les plus longues d'abord
    for (const syllable of allSyllables.sort((a, b) => b.length - a.length)) {
      if (remaining.startsWith(syllable)) {
        segments.push(syllable);
        remaining = remaining.slice(syllable.length);
        found = true;
        break;
      }
    }
    
    // Fallback : prendre 2 caract√®res si possible (consonne + voyelle), sinon 1
    if (!found) {
      if (remaining.length >= 2 && !vowels.includes(remaining[0])) { // Si commence par consonne
        segments.push(remaining.slice(0, 2));
        remaining = remaining.slice(2);
      } else {
        segments.push(remaining[0]);
        remaining = remaining.slice(1);
      }
    }
  }
  
  return segments.length > 0 ? segments : [romaji];
}
  
  
  
function logError(msg) {
console.warn(msg);
}
function updateRevisionButtonState() {
  const revisionButton = document.getElementById('revision-button');
  if (!revisionButton) return;
  
  if (isRevisionModeAvailable()) {
    revisionButton.classList.remove('disabled');
    revisionButton.onclick = () => showSection('mode2');
    revisionButton.title = '';
  } else {
    revisionButton.classList.add('disabled');
    revisionButton.onclick = (e) => {
      e.preventDefault();
      // Optionnel : afficher un message
      console.log('Mode r√©vision disponible √† partir du niveau 4');
    };
    revisionButton.title = 'Disponible √† partir du niveau 4';
  }
}

function testFeu() {
const container = document.querySelector('.quiz-container');
if (isMobile) {
triggerLightFirework(container);
} else {
triggerAdvancedFirework(container);
}
}

function triggerSakuraFall(container) {
for (let i = 0; i < 30; i++) {
const sakura = document.createElement("div");
sakura.className = "sakura";
sakura.style.left = Math.random() * 100 + "vw";
sakura.style.top = "-10px";
sakura.style.animationDelay = Math.random() * 1.5 + "s";
sakura.style.animationDuration = 2.5 + Math.random() * 1.5 + "s";
document.body.appendChild(sakura);
setTimeout(() => sakura.remove(), 4000);
}


}


// üéØ GESTIONNAIRE DE PARTICULES OPTIMIS√â
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
const MAX_ACTIVE_PARTICLES = isMobile ? 15 : 30; // Limite stricte

// Fonction de nettoyage des particules
function cleanupOldParticles() {
// Supprimer les particules les plus anciennes si on d√©passe la limite
while (activeSparks.length > MAX_ACTIVE_PARTICLES) {
const oldSpark = activeSparks.shift();
if (oldSpark && oldSpark.canvas && oldSpark.canvas.parentNode) {
oldSpark.canvas.remove();
globalParticleCount--;
}
}
// Nettoyer les particules orphelines
activeSparks = activeSparks.filter(spark => {
if (!spark.canvas || !spark.canvas.parentNode) {
globalParticleCount--;
return false;
}
return true;
});
console.log(`üßπ Nettoyage: ${activeSparks.length} particules actives, ${globalParticleCount} compteur global`);
}

// Nettoyage automatique toutes les 3 secondes
setInterval(cleanupOldParticles, 3000);

// Audio
let audioContext;
let audioInitialized = false;

function initAudio() {
try {
if (!audioInitialized) {
audioContext = new (window.AudioContext || window.webkitAudioContext)();
audioInitialized = true;
}
} catch (error) {
console.error("Erreur lors de l'initialisation audio:", error.message);
}
}

function getValidatedCountForLevel(level) {
return HiraganaList.filter(h => parseInt(h.Niveau) === level && parseInt(h.Validation) >= 5).length;
}
function playPopSound() {
  initAudio();
  try {
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    osc.connect(gain);
    gain.connect(audioContext.destination);
    osc.type = 'sine';
    osc.frequency.value = 1000; // Son aigu pour "pop"
    gain.gain.setValueAtTime(0.05, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    osc.start();
    osc.stop(audioContext.currentTime + 0.1);
  } catch (error) {
    logError('Erreur son pop: ' + error.message);
  }
}
function playMarioCoin() {
initAudio();
const notes = [659.25, 1046.50];
const durations = [0.1, 0.2];
notes.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.05, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + durations[i]);
osc.start();
osc.stop(audioContext.currentTime + durations[i]);
}, i * 100);
});
}

function playSuccess90s() {
initAudio();
const baseFreq = 587.33;
const osc1 = audioContext.createOscillator();
const gain1 = audioContext.createGain();
const osc2 = audioContext.createOscillator();
const gain2 = audioContext.createGain();
osc1.connect(gain1);
osc2.connect(gain2);
gain1.connect(audioContext.destination);
gain2.connect(audioContext.destination);
osc1.type = 'sine';
osc2.type = 'sine';
osc1.frequency.value = baseFreq;
osc2.frequency.setValueAtTime(baseFreq * 1.5, audioContext.currentTime);
osc2.frequency.exponentialRampToValueAtTime(baseFreq * 3, audioContext.currentTime + 0.3);
gain1.gain.setValueAtTime(0.03, audioContext.currentTime);
gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
gain2.gain.setValueAtTime(0.01, audioContext.currentTime);
gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
osc1.start();
osc2.start();
osc1.stop(audioContext.currentTime + 0.4);
osc2.stop(audioContext.currentTime + 0.3);
}

function playFail() {
initAudio();
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
oscillator.type = 'sine';
gainNode.gain.setValueAtTime(0.04, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.4);
oscillator.start(audioContext.currentTime);
oscillator.stop(audioContext.currentTime + 0.4);
}

function playFireworkSound() {
initAudio();
try {
const frequencies = [329.63, 415.30, 523.25, 659.25];
frequencies.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
const filter = audioContext.createBiquadFilter();
osc.connect(filter);
filter.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'triangle';
osc.frequency.value = freq;
filter.type = 'lowpass';
filter.frequency.value = freq * 2;
gain.gain.setValueAtTime(0.03, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
osc.start();
osc.stop(audioContext.currentTime + 0.4);
}, i * 150);
});
} catch (error) {
logError('Erreur Firework: ' + error.message);
}
}

function playfireworksound2() {
initAudio();
try {
const sequence = [554.37, 659.25, 830.61, 987.77];
sequence.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.035, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
osc.start();
osc.stop(audioContext.currentTime + 0.2);
}, i * 100);
});
} catch (error) {
logError('Erreur fireworksound 2: ' + error.message);
}
}

function playfireworksound3() {
initAudio();
try {
const sequence = [659.25, 783.99, 987.77, 1174.66];
sequence.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.035, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
osc.start();
osc.stop(audioContext.currentTime + 0.2);
}, i * 100);
});
} catch (error) {
logError('Erreur fireworksound 3: ' + error.message);
}
}

function playfireworksound4() {
initAudio();
try {
const sequence = [783.99, 987.77, 1174.66, 1396.91];
sequence.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.035, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
osc.start();
osc.stop(audioContext.currentTime + 0.2);
}, i * 100);
});
} catch (error) {
logError('Erreur fireworksound 4: ' + error.message);
}
}

function playLevelUp() {
initAudio();
try {
const sequence = [523.25, 659.25, 783.99, 1046.50];
const flourish = [783.99, 1046.50, 1318.51];
sequence.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.04, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
osc.start();
osc.stop(audioContext.currentTime + 0.12);
}, i * 120);
});
flourish.forEach((freq, i) => {
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
osc.frequency.value = freq;
gain.gain.setValueAtTime(0.04, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
osc.start();
osc.stop(audioContext.currentTime + 0.1);
}, 480 + i * 100);
});
setTimeout(() => {
const osc = audioContext.createOscillator();
const gain = audioContext.createGain();
const mod = audioContext.createOscillator();
const modGain = audioContext.createGain();
mod.connect(modGain);
modGain.connect(osc.frequency);
osc.connect(gain);
gain.connect(audioContext.destination);
osc.type = 'sine';
mod.type = 'sine';
osc.frequency.value = 1318.51;
mod.frequency.value = 5;
modGain.gain.value = 10;
gain.gain.setValueAtTime(0.04, audioContext.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2.0);
osc.start();
mod.start();
osc.stop(audioContext.currentTime + 2.0);
mod.stop(audioContext.currentTime + 2.0);
}, 780);
} catch (error) {
logError('Erreur Level Up: ' + error.message);
}
}

// Son pour r√©ponses correctes : Clochette zen
function playZenBell() {
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  
  // Fr√©quences cristallines
  const frequencies = [1047, 1319, 1568, 1760]; // C6, E6, G6, A6
  oscillator.frequency.setValueAtTime(
    frequencies[Math.floor(Math.random() * frequencies.length)], 
    audioCtx.currentTime
  );
  oscillator.type = 'sine';
  
  // Enveloppe rapide comme une goutte
  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
  gainNode.gain.linearRampToValueAtTime((typeof globalVolume !== 'undefined' ? globalVolume : 1) * 0.3, audioCtx.currentTime + 0.01);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
  
  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.3);
  console.log('üé∂ Son jou√© : Goutte cristalline (fr√©quence al√©atoire, 0.3s)');
}
// Son pour r√©ponses incorrectes : Bip att√©nu√©
function playSoftError() {
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'triangle';
  oscillator.frequency.setValueAtTime(220, audioCtx.currentTime);
  gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.4);
}
  
function drawStar(ctx, x, y, radius, rotation = 0) {
const points = 5;
const outerRadius = radius;
const innerRadius = radius / 2;
ctx.beginPath();
for (let i = 0; i < points * 2; i++) {
const r = i % 2 === 0 ? outerRadius : innerRadius;
const angle = (i * Math.PI / points) + rotation - Math.PI / 2;
ctx.lineTo(
x + r * Math.cos(angle),
y + r * Math.sin(angle)
);
}
ctx.closePath();
ctx.fill();
}

function triggerAdvancedFirework(container) {
initAudio();
const validatedCount = getValidatedCountForLevel(niveauActif);
const canvas = document.createElement('canvas');
canvas.style.position = 'absolute';
canvas.style.left = '50%';
canvas.style.top = '50%';
canvas.style.transform = 'translate(-50%, -50%)';
canvas.style.pointerEvents = 'none';
canvas.style.zIndex = '20';
canvas.width = 400;
canvas.height = 400;
container.appendChild(canvas);
const ctx = canvas.getContext('2d');

const colorPalettes = [
['#6B8E23', '#9ACD32', '#32CD32', '#228B22', '#008000', '#006400'], // Palette verte
['#A8D5BA', '#76FF03', '#64DD17', '#00C853', '#AEEA00', '#00E676'],
['#FDC1C5', '#F48FB1', '#EC407A', '#D81B60', '#AD1457', '#FF80AB'],
];
const colors = colorPalettes[Math.floor(Math.random() * colorPalettes.length)];

const maxLifeBase = isMobile ? 30 : 50;
const numParticles = isMobile ? 9 : 12;
const numSalvos = isMobile ? 3 : 3;
const gravity = 0.1;
const salvoDelay = 150;
const dispersionBase = 3;
const itemCount = getItemCountForLevel(niveauActif);
const particles = [];
const trails = [];

const halo = document.createElement('div');
halo.style.position = 'absolute';
halo.style.left = '50%';
halo.style.top = '50%';
halo.style.width = '20px';
halo.style.height = '20px';
halo.style.borderRadius = '50%';
halo.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0.05))';
halo.style.transform = 'translate(-50%, -50%) scale(1)';
halo.style.opacity = '1';
halo.style.zIndex = '0';
halo.style.pointerEvents = 'none';
container.appendChild(halo);
halo.animate([
{ transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
{ transform: 'translate(-50%, -50%) scale(6)', opacity: 0 }
], {
duration: 700,
easing: 'ease-out'
}).onfinish = () => halo.remove();

console.log("üéØ nbre d'items dans le niveau =", itemCount, "niveau =", niveauActif);
console.log("üéØ nbre d'items valid√©s =", validatedCount, "niveau =", niveauActif);  
if (validatedCount === itemCount-1) {
  playLevelUp();
  triggerLevelUpAnimation(document.body);
} else if (validatedCount === 3) {
playfireworksound4();
} else if (validatedCount === 2) {
playfireworksound3();
} else if (validatedCount === 1) {
playfireworksound2();
} else if (validatedCount === 0) {
playFireworkSound();
}

for (let salvo = 0; salvo < numSalvos; salvo++) {
setTimeout(() => {
if (activeSparks.length >= MAX_ACTIVE_PARTICLES) {
console.warn(`‚ö†Ô∏è Salvo ${salvo} annul√©e - limite atteinte`);
return;
}

const biasDirection = Math.random() < 0.5 ? -1 : 1;
const biasMagnitude = (Math.random() * 0.2 - 0.1) * biasDirection;

for (let i = 0; i < numParticles; i++) {
if (activeSparks.length >= MAX_ACTIVE_PARTICLES) {
console.warn(`üõë Particule ${i} du salvo ${salvo} ignor√©e - limite atteinte`);
break;
}

const angleOffset = (Math.random() * 10 - 5) * (Math.PI / 180);
const angle = angleOffset + (i * (360 / numParticles)) * (Math.PI / 180);
const isUpward = (angle >= 3 * Math.PI / 2 || angle <= Math.PI / 2);
let speed = dispersionBase + Math.random() * 3;
if (isUpward) {
speed = Math.max(7, speed);
if ((angle >= 3 * Math.PI / 2 && biasDirection === -1) || (angle <= Math.PI / 2 && biasDirection === 1)) {
speed *= (1 + biasMagnitude);
}
}

const v0x = speed * Math.cos(angle);
const v0y = speed * Math.sin(angle) * -1;
const color = colors[Math.floor(Math.random() * colors.length)];

particles.push({
x: canvas.width / 2,
y: canvas.height / 2,
vx: v0x,
vy: v0y,
life: maxLifeBase + Math.random() * 20,
maxLife: maxLifeBase + Math.random() * 20,
color: color,
rotation: Math.random() * Math.PI * 2
});
activeSparks.push({ canvas });
globalParticleCount++;
console.log(`Particule ajout√©e: ${particles.length} particules, ${activeSparks.length} sparks`);
}
}, salvo * salvoDelay);
}

function animate() {
ctx.clearRect(0, 0, canvas.width, canvas.height);

if (!isMobile) {
particles.forEach(p => {
if (Math.random() < 0.2) {
trails.push({
x: p.x,
y: p.y,
color: p.color,
life: 10
});
}
});
}

trails.forEach((t, i) => {
t.life--;
if (t.life <= 0) {
trails.splice(i, 1);
return;
}
ctx.fillStyle = t.color;
ctx.globalAlpha = t.life / 10 * 0.3;
ctx.beginPath();
ctx.arc(t.x, t.y, isMobile ? 2 : 3, 0, 2 * Math.PI);
ctx.fill();
});

particles.forEach((p, i) => {
p.x += p.vx;
p.y += p.vy;
p.vy += gravity;
p.life--;
p.rotation += 0.05;
if (p.life <= 0) {
particles.splice(i, 1);
activeSparks.splice(i, 1);
globalParticleCount--;
return;
}
ctx.fillStyle = p.color;
ctx.globalAlpha = Math.max(0, p.life / p.maxLife);
ctx.save();
ctx.translate(p.x, p.y);
drawStar(ctx, 0, 0, isMobile ? 4 : 6, p.rotation);
ctx.restore();
});

if (particles.length > 0 || Date.now() < Date.now() + numSalvos * salvoDelay) {
requestAnimationFrame(animate);
} else {
canvas.remove();
activeSparks = activeSparks.filter(spark => spark.canvas !== canvas);
globalParticleCount = Math.max(0, globalParticleCount - particles.length);
console.log('Animation termin√©e');
}
}
requestAnimationFrame(animate);
}
/*
function cleanupOldParticles() {
while (activeSparks.length > MAX_ACTIVE_PARTICLES) {
const oldSpark = activeSparks.shift();
if (oldSpark && oldSpark.canvas && oldSpark.canvas.parentNode) {
oldSpark.canvas.remove();
globalParticleCount--;
}
}
activeSparks = activeSparks.filter(spark => {
if (!spark.canvas || !spark.canvas.parentNode) {
globalParticleCount--;
return false;
}
return true;
});
console.log(`üßπ Nettoyage: ${activeSparks.length} particules actives, ${globalParticleCount} compteur global`);
}

setInterval(cleanupOldParticles, 3000);

const MAX_ACTIVE_PARTICLES = isMobile ? 15 : 30;
*/
function getMaxLevel(list) {
if (!list || list.length === 0) return 1;
return Math.max(...list.map(k => parseInt(k.Niveau) || 1));
}

function updateStarsForHiragana(hiraganaId, newValidation) {
const cards = document.querySelectorAll('.hiragana-card');
cards.forEach(card => {
const hiraganaChar = card.querySelector('.hiragana-char').textContent;
const hiragana = HiraganaList.find(h => h.Hiragana === hiraganaChar && h.ID == hiraganaId);
if (hiragana) {
const stars = card.querySelectorAll('.star');
const previousValidation = previousValidationStates.get(hiraganaId) || 0;

stars.forEach((star, index) => {
if (index < newValidation && !star.classList.contains('filled')) {
star.classList.add('filled', 'new-star');
setTimeout(() => star.classList.remove('new-star'), 500);
} else if (index < newValidation) {
star.classList.add('filled');
} else {
star.classList.remove('filled', 'new-star');
}
});

if (newValidation >= 5 && previousValidation < 5) {
if (isMobile) {
triggerLightFirework(card);
} else {
triggerAdvancedFirework(card);
}
}

if (newValidation >= 5) {
card.classList.add('completed');
} else {
card.classList.remove('completed');
}

previousValidationStates.set(hiraganaId, newValidation);
}
});
}

function renderHiraganaCards(list, niveau) {
const container = document.getElementById("hiraganaCards");
if (!container) return;
const hiraganas = list.filter(h => parseInt(h.Niveau) === niveau);
container.innerHTML = "";
hiraganas.forEach(hiragana => {
const validation = parseInt(hiragana.Validation || 0);
const isCompleted = validation >= 5;
const card = document.createElement("div");
card.className = `hiragana-card ${isCompleted ? 'completed' : ''}`;
card.innerHTML = `
<div class="hiragana-char">${hiragana.Hiragana}</div>
<div class="stars-container">
${Array.from({length: 5}, (_, i) =>
`<div class="star ${i < validation ? 'filled' : ''}"></div>`
).join('')}
</div>
`;
container.appendChild(card);
previousValidationStates.set(parseInt(hiragana.ID), validation);
});
}

function renderProgressBar(currentLevel, maxLevel) {
const container = document.getElementById("progressBarContainer");
if (!container) return;

container.innerHTML = "";

const leftEmoji = document.createElement("span");
leftEmoji.textContent = "üå±";
leftEmoji.className = "side-emoji";

const rightEmoji = document.createElement("span");
rightEmoji.textContent = "üå≥";
rightEmoji.className = "side-emoji";

const barTrack = document.createElement("div");
barTrack.className = "progress-bar-track";

const marker = document.createElement("div");
marker.className = "progress-marker";
marker.innerText = "üêº";  /*  üêº üê±üí©ü§°üê∂üêØüê± */

const pct = maxLevel > 1 ? ((currentLevel - 1) / (maxLevel - 1)) * 100 : 0;
marker.style.left = `${Math.min(100, Math.max(0, pct))}%`;

barTrack.appendChild(marker);
container.appendChild(leftEmoji);
container.appendChild(barTrack);
container.appendChild(rightEmoji);
}

function determineNiveauActif(list) {
  if (!list || list.length === 0) return 1;
  let maxNiveau = Math.max(...list.map(k => parseInt(k.Niveau) || 1));

  // ‚úÖ NOUVEAU : Calculer le niveau actif SANS tenir compte du blocage
  for (let n = 1; n <= maxNiveau; n++) {
    const kanjisNiveau = list.filter(k => parseInt(k.Niveau) === n);
    const kanjisValides = kanjisNiveau.filter(k => parseInt(k.Validation) >= 5); // ‚úÖ Seuil fixe √† 5
    
    if (kanjisValides.length < kanjisNiveau.length) {
      console.log(`üìç Niveau actif d√©termin√©: ${n} (${kanjisValides.length}/${kanjisNiveau.length} items valid√©s √† >=5)`);
      return n;
    }
  }
  
  console.log(`üìç Tous les niveaux sont compl√©t√©s, niveau actif = ${maxNiveau}`);
  return maxNiveau;
}
function updateApprendreButtonState() {
  const apprendreButton = document.querySelector('button[onclick="showSection(\'quiz\')"]');
  if (!apprendreButton) return;
  
  if (isApprentissageBloque()) {
    apprendreButton.classList.add('disabled');
    // Compl√®tement bloquer le clic
    apprendreButton.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      // Optionnel : feedback visuel ou sonore pour indiquer que c'est bloqu√©
      console.log('Mode apprentissage bloqu√© - utilisez le mode r√©vision');
      return false;
    };
    apprendreButton.title = 'Mode bloqu√© - Pratiquez le mode r√©vision pour d√©bloquer';
    apprendreButton.style.opacity = '0.5';
    apprendreButton.style.cursor = 'not-allowed';
  } else {
    apprendreButton.classList.remove('disabled');
    apprendreButton.onclick = () => showSection('quiz');
    apprendreButton.title = '';
    apprendreButton.style.opacity = '1';
    apprendreButton.style.cursor = 'pointer';
  }
}
function updateMenuButtonStates() {
  updateApprendreButtonState();
  updateRevisionButtonState();
}  
function updateLevelProgress(list, niveau) {
renderHiraganaCards(list, niveau);
}

// Initialisation avec  Apps Script
// *** NOUVELLE URL DE VOTRE WEB APP  ***
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbylWVyaAxXK7CYwyRCHz7uW2L8Twb5X34PLUI1oP7oFLqIvwyNbQ8JTDdNP7mrSSUaeNQ/exec';


// Fonction pour appeler l'API
async function callAPI(action, data = null) {
  try {
    let params = new URLSearchParams({ action });

    if (data) {
      Object.entries(data).forEach(([key, value]) => {
        params.append(key, value);
      });
    }

    const url = `${WEB_APP_URL}?${params.toString()}`;
    console.log(`üîç Appel API: ${action} -> ${url}`);

    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const result = await response.json();
    console.log(`üîç R√©ponse brute de ${action}:`, JSON.stringify(result, null, 2));
    return result;
  } catch (error) {
    logError(`Erreur API (${action}): ${error.message}`);
    console.error(`‚ö†Ô∏è D√©tails erreur:`, error);
    return { error: error.message };
  }
}
// Variable globale pour la table romaji
let revisionRomajiTable = {};

// Modifier votre fonction initGame existante
// Variable globale pour le chargement background
let backgroundLoadingInProgress = false;

async function initGame() {
  try {
    gameDataLoaded = false;
    console.log('üõ†Ô∏è Initialisation du jeu avec chunking...');
// R√©cup√©ration du token (d√©j√† existant dans ton code, on le garde ici)
    const userTokenFromStorage = localStorage.getItem('userToken'); // ‚Üê renomm√© pour √©viter conflit

    // ==================================================================
    // D√âTECTION DE LA LANGUE SELON NEW / RETURNING USER
    // ==================================================================
    let finalLanguage;

    if (!userTokenFromStorage) {
      // NEW USER ‚Üí on force la langue du navigateur
      const browserLang = (navigator.language || navigator.userLanguage || "en")
        .toLowerCase().split('-')[0];

      if (browserLang.startsWith("fr")) finalLanguage = "fr";
      else if (browserLang.startsWith("es")) finalLanguage = "es";
      else finalLanguage = "en";

      console.log("NEW USER ‚Üí Langue forc√©e par navigateur :", finalLanguage);

      // On sauvegarde pour coh√©rence (m√™me si c'est un new user)
      localStorage.setItem('appLanguage', finalLanguage);

    } else {
      // RETURNING USER ‚Üí on prend la langue qu'il a choisie dans les Options
      const savedLang = localStorage.getItem('appLanguage');
      finalLanguage = savedLang || "en"; // fallback au cas o√π

      console.log("RETURNING USER ‚Üí Langue restaur√©e depuis localStorage :", finalLanguage);
    }

    // Application finale de la langue
    currentLanguage = finalLanguage;

    // Mise √† jour IMM√âDIATE de tous les textes (avant tout affichage !)
    updateAllTexts();
    console.log("Langue appliqu√©e au d√©marrage :", currentLanguage);

    // ==================================================================
    // Suite de ton initGame() existant (ne touche √† rien en dessous)
    // ==================================================================
    // Masquer le texte "Chargement..." classique
    document.getElementById("loadingText").style.display = "none";
    
    // Afficher la barre de progression
    const progressContainer = document.getElementById('loading-progress-container');
    progressContainer.style.display = 'block';
    
    // ==========================================
    // PHASE 1 : D√âTECTION PROFIL (0-15%)
    // ==========================================
    updateLoadingProgress(5, "Connexion au serveur...");
    
    const token = localStorage.getItem('userToken');
    const profileResult = await callAPI('getProfile', { token: token || '' });
    
    if (!profileResult.success) {
      throw new Error('Erreur d√©tection profil');
    }
    
    const profile = profileResult.profile;
    console.log('üë§ Profil d√©tect√©:', profile);
    updateLoadingProgress(15, "Profil d√©tect√© !");
    
    // ==========================================
    // PHASE 2 : CHARGEMENT PRIORITAIRE (15-60%)
    // ==========================================
    
    if (profile.isNew) {
      // üÜï NEW USER : WordLists + Niveaux 1-3
      updateLoadingProgress(20, "Chargement des listes de mots...");
      const wordListsResult = await callAPI('getWordLists');
      if (wordListsResult.success) {
        // Stocker pour generatePseudo c√¥t√© client si besoin
        localStorage.setItem('wordLists', JSON.stringify(wordListsResult.words));
        console.log(`üìö ${wordListsResult.count} mots charg√©s`);
      }
      
      updateLoadingProgress(35, "Chargement niveaux 1-3...");
      const chunk1Result = await callAPI('getHiraganaChunk', { startLevel: 1, endLevel: 3 });
      
      if (chunk1Result.success) {
        HiraganaList = chunk1Result.data.map(item => ({
          ...item,
          Validation: 0,
          Tentatives: 0,
          R√©ussites: 0
        }));
        console.log(`üìä Chunk 1: ${chunk1Result.count} items charg√©s (niveaux ${chunk1Result.startLevel}-${chunk1Result.endLevel})`);
      }
      
      updateLoadingProgress(60, "Pr√™t √† jouer !");
      

 } else {
  // üîÅ RETURNING USER : Niveaux 1 √† (niveau+2)
  const maxLevel = Math.min(profile.niveau + 2, profile.totalLevels);
  
  updateLoadingProgress(25, `Chargement niveaux 1-${maxLevel}...`);
  const chunkResult = await callAPI('getHiraganaChunk', { startLevel: 1, endLevel: maxLevel });
  
  if (chunkResult.success) {
    HiraganaList = chunkResult.data.map(item => ({
      ...item,
      Validation: 0,
      Tentatives: 0,
      R√©ussites: 0
    }));
    console.log(`üìä Chunk returning user: ${chunkResult.count} items charg√©s (niveaux ${chunkResult.startLevel}-${chunkResult.endLevel})`);
  }
  
  // ‚úÖ CORRECTION : Initialiser userToken et currentUser AVANT loadUserProgress
  updateLoadingProgress(40, "R√©cup√©ration de votre profil...");
  userToken = token;
  const userResult = await callAPI('getUserByToken', { token: token });
  if (userResult.success) {
    currentUser = userResult.user;
    console.log('üë§ Utilisateur r√©cup√©r√©:', currentUser.pseudo);
  }
  
  // ‚úÖ MAINTENANT loadUserProgress peut merger les stats
  updateLoadingProgress(50, "Chargement de vos statistiques...");
  await loadUserProgress(); // Merge stats_json dans HiraganaList
  
  updateLoadingProgress(60, "Profil charg√© !");
}
    
    // ==========================================
    // PHASE 3 : INTERFACE JOUABLE (60-80%)
    // ==========================================
    updateLoadingProgress(70, "Initialisation de l'interface...");
    
    // Initialiser le syst√®me utilisateur
// ‚úÖ Mettre √† jour l'affichage du compte (pour new + returning)
if (currentUser) {
  updateAccountDisplay();
}
    
    // D√©terminer niveau actif
    niveauActif = determineNiveauActif(HiraganaList);
    console.log(`üéÆ Niveau actif calcul√©: ${niveauActif}`);
    
    // Initialiser l'UI
    document.getElementById("levelDisplay").innerText = `${t('quiz_level')} ${niveauActif}`;
    updateLevelProgress(HiraganaList, niveauActif);
    renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
    renderHiraganaCards(HiraganaList, niveauActif);
    updateMenuButtonStates();
    
    updateLoadingProgress(80, "Presque pr√™t...");
    
    // ==========================================
    // PHASE 4 : CHARGEMENT BACKGROUND (80-100%)
    // ==========================================
    gameDataLoaded = true;
    updateLoadingProgress(90, "Finalisation...");
    
    // Afficher le panda et masquer la barre
    const panda = document.querySelector(".panda-logo");
    const loadingText = document.getElementById("loadingText");
    if (panda && loadingText) {
      panda.style.opacity = "1";
      panda.style.pointerEvents = "auto";
      loadingText.textContent = t('welcome_touch');
      loadingText.style.display = "block";
    }
    
    updateLoadingProgress(100, "Chargement termin√© !");
    
    // Masquer la barre apr√®s 500ms
    setTimeout(() => {
      progressContainer.style.display = 'none';
    }, 500);
    
    console.log('‚úÖ initGame termin√© avec succ√®s');
    
    // ==========================================
    // PHASE 5 : CHARGEMENT EN ARRI√àRE-PLAN
    // ==========================================
    loadRemainingDataInBackground(profile);
    
  } catch (error) {
    console.error('‚ùå Erreur dans initGame:', error.message);
    document.getElementById('loading-message').textContent = 'Erreur : ' + error.message;
    document.getElementById('loading-message').style.color = '#dc3545';
    gameDataLoaded = false;
  }
}


// Fonction helper pour mettre √† jour la barre
function updateLoadingProgress(percent, message) {
  const fill = document.getElementById('loading-progress-fill');
  const msg = document.getElementById('loading-message');
  
  if (fill) fill.style.width = percent + '%';
  if (msg) msg.textContent = message;
  
  console.log(`üìä ${percent}% - ${message}`);
}

// Chargement en arri√®re-plan des donn√©es restantes
async function loadRemainingDataInBackground(profile) {
  if (backgroundLoadingInProgress) return;
  backgroundLoadingInProgress = true;
  
  console.log('üîÑ D√©marrage chargement background...');
  
  try {
    if (profile.isNew) {
      // Charger niveaux 4-46 par paquets de 10
      for (let start = 4; start <= profile.totalLevels; start += 10) {
        const end = Math.min(start + 9, profile.totalLevels);
        console.log(`üì• Background: chargement niveaux ${start}-${end}...`);
        
        const chunkResult = await callAPI('getHiraganaChunk', { startLevel: start, endLevel: end });
        
        if (chunkResult.success) {
          // Merger avec HiraganaList existante
          const newItems = chunkResult.data.map(item => ({
            ...item,
            Validation: 0,
            Tentatives: 0,
            R√©ussites: 0
          }));
          
          HiraganaList.push(...newItems);
          newItems.forEach(item => {
  const id = parseInt(item.ID);
  validationCache[id] = parseInt(item.Validation || 0);
  
  const tentatives = parseInt(item.Tentatives || 0);
  const reussites = parseInt(item['R√©ussites'] || 0);
  const pourcentage = tentatives > 0 ? (reussites / tentatives * 100) : 0;
  
  statsCache.items[id] = { tentatives, reussites, pourcentage };
});
// Recalcul global (rapide)
const totalTentatives = Object.values(statsCache.items).reduce((sum, item) => sum + item.tentatives, 0);
const totalReussites = Object.values(statsCache.items).reduce((sum, item) => sum + item.reussites, 0);
statsCache.globalPourcentage = totalTentatives > 0 ? (totalReussites / totalTentatives * 100) : 0;
          console.log(`‚úÖ Background: ${newItems.length} items ajout√©s (total: ${HiraganaList.length})`);
        }
        
        // Petit d√©lai pour ne pas surcharger
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
    } else {
      // Charger le reste des niveaux + WordLists (cas changement appareil)
      const currentMax = Math.min(profile.niveau + 2, profile.totalLevels);
      
      if (currentMax < profile.totalLevels) {
        console.log(`üì• Background: chargement niveaux ${currentMax + 1}-${profile.totalLevels}...`);
        
        const chunkResult = await callAPI('getHiraganaChunk', { 
          startLevel: currentMax + 1, 
          endLevel: profile.totalLevels 
        });
        
        if (chunkResult.success) {
          const newItems = chunkResult.data.map(item => ({
            ...item,
            Validation: 0,
            Tentatives: 0,
            R√©ussites: 0
          }));
          
          HiraganaList.push(...newItems);
          console.log(`‚úÖ Background: ${newItems.length} items ajout√©s (total: ${HiraganaList.length})`);
        }
      }
      
      // Charger WordLists pour futur changement d'appareil
      console.log('üì• Background: chargement WordLists...');
      const wordListsResult = await callAPI('getWordLists');
      if (wordListsResult.success) {
        localStorage.setItem('wordLists', JSON.stringify(wordListsResult.words));
        console.log(`‚úÖ Background: ${wordListsResult.count} mots stock√©s`);
      }
    }
    
    // R√©g√©n√©rer les tables de r√©vision avec toutes les donn√©es
    revisionRomajiTable = generateRevisionRomajiTable(HiraganaList);
    revisionKatakanaTable = generateRevisionKatakanaTable(HiraganaList);
    console.log(`üìö Tables r√©g√©n√©r√©es: Romaji=${Object.keys(revisionRomajiTable).length}, Katakana=${Object.keys(revisionKatakanaTable).length}`);
    
    console.log('‚úÖ Chargement background termin√© !');
    
  } catch (error) {
    console.error('‚ùå Erreur chargement background:', error.message);
  } finally {
    backgroundLoadingInProgress = false;
  }
}
function nextQuestion() {
document.getElementById("result").innerText = "";
document.getElementById("continueBtn").style.visibility = "hidden";
selections = { first: null, second: null };
isAnswered = false;

const kanas = HiraganaList.filter(k =>
parseInt(k.Niveau) === niveauActif && parseInt(k.Validation || 0) < 5
);

if (kanas.length === 0) {
const nouveauNiveau = determineNiveauActif(HiraganaList);
if (nouveauNiveau !== niveauActif) {

const ancienGroupe = getNiveauGroupe(niveauActif);
const nouveauGroupe = getNiveauGroupe(nouveauNiveau);  
niveauActif = nouveauNiveau;  
localStorage.setItem('unlockedLevel', currentLevel + 1);  
document.getElementById("levelDisplay").innerText = `Niveau actuel : ${niveauActif}`;
renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
updateLevelProgress(HiraganaList, niveauActif);
updateRevisionButtonState();  
updateApprendreButtonState(); // Nouvelle ligne  
// Ajouter ici
if (niveauActif === 4 && !hasShownLevel4Menu) {
    const menu = document.getElementById('menu');
    const menuMessage = document.getElementById('menu-message');
    menu.classList.add('active');
    menuMessage.innerText = 'üéÆ Mode r√©visions d√©bloqu√© üéÆ';
    hasShownLevel4Menu = true;
}
if (nouveauGroupe > ancienGroupe && nouveauGroupe >= 3 && isApprentissageBloque() && !hasShownBlockedMenu) {
  // Passer automatiquement en mode r√©vision AVANT d'afficher le menu
  setTimeout(() => {
    forceRevisionMode();
    // Puis afficher le menu apr√®s un court d√©lai
    setTimeout(() => {
      const menu = document.getElementById('menu');
      const menuMessage = document.getElementById('menu-message');
      menu.classList.add('active');
      menuMessage.innerText = 'Mode Apprendre bloqu√©';
      hasShownBlockedMenu = true;
    }, 500);
  }, 3000);
} 
nextQuestion();
return;
}
}

const finalKanas = kanas.length > 0 ? kanas : HiraganaList.filter(k => parseInt(k.Niveau) === niveauActif);

const currentWeights = finalKanas.map(k => {
const validation = parseInt(k.Validation || 0);
return Math.max(0.1, 5 - validation + 0.5);
});

let selected;
do {
const sum = currentWeights.reduce((a, b) => a + b, 0);
const rand = Math.random() * sum;
let acc = 0;
for (let i = 0; i < finalKanas.length; i++) {
acc += currentWeights[i];
if (rand < acc) {
selected = finalKanas[i];
break;
}
}
} while (selected === previousCharacter && finalKanas.length > 1); // Repeat if same as previous and more than one option exists

current = selected;
previousCharacter = current; // Update previous character

const modes = [
{ question: "Hiragana", options1: "Katakana", options2: "Romaji" },
{ question: "Katakana", options1: "Hiragana", options2: "Romaji" },
{ question: "Romaji", options1: "Hiragana", options2: "Katakana" }
];
const mode = modes[Math.floor(Math.random() * modes.length)];
targetFields = [mode.options1, mode.options2];

document.getElementById("question").innerText = (mode.question === 'Katakana') 
  ? getLocalizedKatakana(current) 
  : current[mode.question];
renderChoices("choices1", generateChoices(mode.options1), "first");
renderChoices("choices2", generateChoices(mode.options2), "second");
previousCharacter = current; // Met √† jour apr√®s avoir d√©fini current  
}

function generateChoices(field) {
const others = HiraganaList.filter(k => k !== current && parseInt(k.Niveau) === niveauActif);
    // ‚úÖ NOUVEAU : G√©rer les Katakana localis√©s
  const getValue = (item, fieldName) => {
    if (fieldName === 'Katakana') {
      return getLocalizedKatakana(item);
    }
    return item[fieldName];
  };
const values = [
  getValue(current, field), 
  ...others.sort(() => 0.5 - Math.random()).slice(0, 3).map(k => getValue(k, field))
];
return values.sort(() => 0.5 - Math.random());
}

function renderChoices(id, options, slot) {
const container = document.getElementById(id);
container.innerHTML = "";
options.forEach(text => {
const btn = document.createElement("button");
btn.innerText = text;
btn.className = "arcade-button";
btn.onclick = () => {
if (selections[slot] !== null || isAnswered) return;
selections[slot] = text;

// Ajouter l'effet de halo sans le retirer imm√©diatement
btn.classList.add("clicked-glow");

// Garder l'effet d'opacit√© pour les autres boutons
container.querySelectorAll("button").forEach(b => {
b.disabled = true;
if (b === btn) {
b.classList.add("clicked");
}
});
checkAnswer();
};
container.appendChild(btn);
});
}

// Variables globales (assure-toi qu'elles sont bien d√©finies ailleurs)
let pendingUpdates = [];
// Autres variables n√©cessaires : HiraganaList, validationCache, statsCache, niveauActuel, etc.

async function queueUpdateStats(params) {
  // 1. Ajouter √† la file
  pendingUpdates.push(params);

  // 2. Traiter la file si c'est le premier √©l√©ment
  if (pendingUpdates.length === 1) {
    while (pendingUpdates.length > 0) {
      const update = pendingUpdates[0]; // On garde une r√©f√©rence
      const id = update.id; // On extrait id une fois pour √©viter les bugs

      try {
        // Construire les param√®tres API
        const apiParams = {
          token: update.token,
          id: id,
          scorePoints: update.scorePoints,
          isRevisionMode: update.isRevisionMode || false
        };

        const result = await callAPI('updateStats', apiParams);

        if (result.success) {
          console.log(`File: Stats synchronis√©es pour item ${id}: Validation=${result.newValidation}, NewLevel=${result.newLevel}`);

          // Mise √† jour locale de HiraganaList
          const hiraganaIndex = HiraganaList.findIndex(h => h.ID == id);
          if (hiraganaIndex !== -1) {
            HiraganaList[hiraganaIndex].Validation = result.newValidation;
            HiraganaList[hiraganaIndex].Tentatives = (HiraganaList[hiraganaIndex].Tentatives || 0) + 1;
            HiraganaList[hiraganaIndex]['R√©ussites'] = (HiraganaList[hiraganaIndex]['R√©ussites'] || 0) + update.scorePoints;

            // Mise √† jour du cache de validation
            validationCache[id] = result.newValidation;

            // Mise √† jour statsCache
            const itemStats = statsCache.items[id] || { tentatives: 0, reussites: 0, pourcentage: 0 };
            itemStats.tentatives += 1;
            itemStats.reussites += update.scorePoints;
            itemStats.pourcentage = itemStats.tentatives > 0 
              ? Math.round((itemStats.reussites / itemStats.tentatives) * 100) 
              : 0;
            statsCache.items[id] = itemStats;

            console.log(`HiraganaList[${hiraganaIndex}] synchronis√© avec serveur:`, HiraganaList[hiraganaIndex]);
          }

          // Gestion du level up
          if (result.newLevel && result.newLevel > niveauActif) {
            niveauActif = result.newLevel;
            console.log(`Level up d√©tect√© (serveur): Niveau ${niveauActif}`);
            document.getElementById("levelDisplay").innerText = `${t('quiz_level')} ${niveauActif}`;
            updateLevelProgress(HiraganaList, niveauActif);
            renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
            renderHiraganaCards(HiraganaList, niveauActif);
            updateMenuButtonStates();
            triggerLevelUpAnimation(document.body);
          }
        } else {
          console.error(`File: Erreur API updateStats pour item ${id}: ${result.error || 'Erreur inconnue'}`);
        }
      } catch (error) {
        // ERREUR CRITIQUE ICI : on utilise `id` qui est bien d√©fini
        console.error(`File: Erreur r√©seau updateStats pour item ${id}: ${error.message}`);
      } finally {
        // Toujours retirer l'√©l√©ment, m√™me en cas d'erreur
        pendingUpdates.shift();
      }
    }
  }
}
async function checkAnswer() {
  if (selections.first && selections.second && !isAnswered) {
    isAnswered = true;

    const getValue = (fieldName) => {
      if (fieldName === 'Katakana') {
        return getLocalizedKatakana(current);
      }
      return current[fieldName];
    };

    const correct1 = getValue(targetFields[0]);
    const correct2 = getValue(targetFields[1]);
    let score = 0;
    const containers = [document.getElementById("choices1"), document.getElementById("choices2")];
    const correctAnswers = [correct1, correct2];
    const userSelections = [selections.first, selections.second];

    containers.forEach(container => {
      container.querySelectorAll("button").forEach(btn => {
        btn.classList.remove("clicked-glow", "correct", "incorrect");
      });
    });

    containers.forEach((container, index) => {
      const buttons = container.querySelectorAll("button");
      buttons.forEach(btn => {
        if (btn.innerText === correctAnswers[index]) {
          btn.classList.add("correct");
          btn.disabled = true;
          if (btn.innerText === userSelections[index]) {
            score += 0.5;
            btn.classList.add("clicked");
          }
        } else if (btn.innerText === userSelections[index]) {
          btn.classList.add("incorrect");
          btn.disabled = true;
        } else {
          btn.disabled = true;
        }
      });
    });

    const currentValidation = parseInt(current.Validation || 0);
    let newValidation = currentValidation;
    if (score === 1) {
      newValidation = Math.min(5, currentValidation + 1);
    } else if (score === 0.5) {
      newValidation = Math.max(0, currentValidation - 1);
    } else {
      newValidation = Math.max(0, currentValidation - 2);
    }
    const isFinalValidation = score === 1 && currentValidation < 5 && newValidation >= 5;

    const currentItemId = parseInt(current.ID);
    console.log(`üìù R√©ponse pour item ${currentItemId} (score: ${score})`);

    updateStarsForHiragana(currentItemId, newValidation);
    const hiraganaIndex = HiraganaList.findIndex(h => h.ID == currentItemId);
    if (hiraganaIndex !== -1) {
      HiraganaList[hiraganaIndex].Validation = newValidation.toString();
      HiraganaList[hiraganaIndex].Tentatives = (HiraganaList[hiraganaIndex].Tentatives || 0) + 1;
      HiraganaList[hiraganaIndex]['R√©ussites'] = (HiraganaList[hiraganaIndex]['R√©ussites'] || 0) + score;
      validationCache[currentItemId] = newValidation;
      console.log(`üîÑ HiraganaList[${hiraganaIndex}] mis √† jour localement:`, HiraganaList[hiraganaIndex]);
    }

    let emoji = "", resultText = "";
    if (score === 1) {
      const emojisOK = ["üå∏", "üéç", "üçµ", "ü™¥", "üíÆ", "üå∫", "üåº", "ü™∑"];
      emoji = emojisOK[Math.floor(Math.random() * emojisOK.length)];
      resultText = isFinalValidation ? t('msg_validated') : t('msg_perfect');
      if (!isFinalValidation) {
        playMarioCoin();
      }
    } else if (score === 0.5) {
      const emojisMid = ["ü™®", "üåø", "ü™µ", "üçÉ", "üå≥", "üéã"];
      emoji = emojisMid[Math.floor(Math.random() * emojisMid.length)];
      resultText = t('msg_almost');
      playSuccess90s();
    } else {
      const emojisBad = ["üôà", "üôä", "ü™®", "üåä", "üçÇ", "üçÅ"];
      emoji = emojisBad[Math.floor(Math.random() * emojisBad.length)];
      resultText = t('msg_notquite');
      playFail();
    }

document.getElementById("result").innerHTML = `
  <div class="result-line">${emoji} ${resultText} ${emoji}</div>
  <div class="result-line highlight">
    ${t('quiz_correct_answer')} <strong>${correct1}</strong> ${t('quiz_answer_separator')} <strong>${correct2}</strong>
  </div>`;

    if (current && current.Hiragana) {
      const audioFile = `${encodeURIComponent(current.Hiragana)}.mp3`;
      const audioUrl = `https://emmanuel971-source.github.io/hirakataquizz/${audioFile}`;
      console.log("üéß Lecture du son :", audioUrl);
      const audio = new Audio(audioUrl);
      audio.play().catch(e => console.warn("Erreur audio :", e));
    } else {
      console.warn("‚ùó Aucun Hiragana √† prononcer.");
    }

    const previousNiveau = niveauActif;
    niveauActif = determineNiveauActif(HiraganaList);
    document.getElementById("levelDisplay").innerText = `${t('quiz_level')} ${niveauActif}`;
    updateLevelProgress(HiraganaList, niveauActif);
    renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
    renderHiraganaCards(HiraganaList, niveauActif);
    updateMenuButtonStates();

    // Si level up local, d√©clencher l'animation
    if (niveauActif > previousNiveau) {
      triggerLevelUpAnimation(document.body);
    }

    queueUpdateStats({
      token: userToken,
      id: currentItemId,
      scorePoints: score,
      isRevisionMode: revisionMode.isActive
    });
  // ‚úÖ NOUVEAU : Rafra√Æchir les stats si la page est ouverte
  if (document.getElementById('stats').classList.contains('active')) {
    setTimeout(() => {
      generateStatsPage();
    }, 100);
  }
    if (!revisionMode.isActive) {
      if (score === 1) {
        setTimeout(() => {
          nextQuestion();
        }, niveauActif > previousNiveau ? 4000 : 1500); // Attendre plus longtemps si level up
      } else {
        document.getElementById("continueBtn").style.visibility = "visible";
      }
    } else {
      document.getElementById("continueBtn").style.visibility = "visible";
    }
  }
}
function triggerLightFirework(card) {
const halo = document.createElement("div");
halo.style.position = "absolute";
halo.style.width = "30px";
halo.style.height = "30px";
halo.style.borderRadius = "50%";
halo.style.background = "radial-gradient(circle, rgba(253,193,197,0.9), rgba(253,193,197,0.1))";
halo.style.transform = "translate(-50%, -50%) scale(1)";
halo.style.opacity = "1";
halo.style.pointerEvents = "none";
halo.style.zIndex = "10";

const rect = card.getBoundingClientRect();
const cx = rect.left + rect.width / 2;
const cy = rect.top + rect.height / 2;

halo.style.left = `${cx}px`;
halo.style.top = `${cy}px`;
document.body.appendChild(halo);

halo.animate([
{ transform: "translate(-50%, -50%) scale(1)", opacity: 1 },
{ transform: "translate(-50%, -50%) scale(4)", opacity: 0 }
], {
duration: 800,
easing: "ease-out"
}).onfinish = () => halo.remove();

// Utiliser l'effet de chute de sakura depuis le haut de l'√©cran
for (let i = 0; i < 30; i++) {
const sakura = document.createElement("div");
sakura.className = "sakura";
sakura.style.left = Math.random() * 100 + "vw";
sakura.style.top = "-10px";
sakura.style.animationDelay = Math.random() * 1.5 + "s";
sakura.style.animationDuration = 2.5 + Math.random() * 1.5 + "s";
document.body.appendChild(sakura);
setTimeout(() => sakura.remove(), 4000);
}
const validatedCount = getValidatedCountForLevel(niveauActif);
const itemCount = getItemCountForLevel(niveauActif);
console.log("üéØ nbre d'items dans le niveau =", itemCount, "niveau =", niveauActif);
console.log("üéØ nbre d'items valid√©s =", validatedCount, "niveau =", niveauActif);  


if (validatedCount === itemCount-1) {
  playLevelUp();
  triggerLevelUpAnimation(document.body);
} else if (validatedCount === 3) {
playfireworksound4();
} else if (validatedCount === 2) {
playfireworksound3();
} else if (validatedCount === 1) {
playfireworksound2();
} else if (validatedCount === 0) {
playFireworkSound();
}
 
}

function triggerLevelUpAnimation(container) {
const toHide = ['#question', '#choices1', '#choices2'];
toHide.forEach(id => {
const el = document.querySelector(id);
if (el) el.style.visibility = 'hidden';
});

triggerSakuraFall(container);

setTimeout(() => {
toHide.forEach(id => {
const el = document.querySelector(id);
if (el) {
el.style.visibility = 'visible';
el.style.opacity = 0;
el.animate([
{ opacity: 0 },
{ opacity: 1 }
], {
duration: 600,
fill: 'forwards'
});
}
});
}, 3000);

const msgWrapper = document.createElement("div");
msgWrapper.style.position = "fixed";
msgWrapper.style.top = "40%";
msgWrapper.style.left = "0";
msgWrapper.style.width = "100vw";
msgWrapper.style.textAlign = "center";
msgWrapper.style.zIndex = 9999;
msgWrapper.style.pointerEvents = "none";
document.body.appendChild(msgWrapper);

  const msg = document.createElement("div");
  msg.innerText = t('msg_level_up'); // ‚úÖ MODIFI√â
  msg.style.display = "inline-block";
msg.style.fontSize = "3em";
msg.style.fontWeight = "bold";
msg.style.color = "#8B6F47";
msg.style.textShadow = "0 0 20px #A8D5BA, 0 0 40px #FDC1C5";
msg.style.writingMode = "horizontal-tb";
msg.style.whiteSpace = "nowrap";
msgWrapper.appendChild(msg);

msg.animate([
{ transform: "translateY(0)", opacity: 1 },
{ transform: "translateY(-40px)", opacity: 0 }
], {
duration: 3000,
easing: "ease-out"
}).onfinish = () => msgWrapper.remove();

const marker = document.querySelector(".progress-marker");
if (marker) {
marker.animate([
{ transform: "translate(-50%, -50%) rotate(0deg) scale(1)" },
{ transform: "translate(-50%, -50%) rotate(180deg) scale(4)" },
{ transform: "translate(-50%, -50%) rotate(360deg) scale(1)" }
], {
duration: 1000,
easing: "ease-in-out"
});
}
}
/**
 * Affiche temporairement une bulle de validation √† c√¥t√© de la carte active.
 * @param {HTMLElement} charCard - √âl√©ment .char-card √† c√¥t√© duquel afficher la bulle.
 * @param {number} validation - Score de validation actuel.
 * @param {number} seuil - Seuil de blocage du mode apprendre.
 */
function showValidationBubble(charCard, validation, seuil) {
  const diff = validation - seuil;
  const bubble = document.createElement("div");
  bubble.classList.add("validation-bubble");

  // üåà Couleur subtile selon le niveau de ma√Ætrise
  const absDiff = Math.abs(diff);
  if (diff >= 4) bubble.classList.add("green-4");
  else if (diff >= 2) bubble.classList.add("green-3");
  else if (diff >= 0) bubble.classList.add("green-2");
  else if (diff <= -4) bubble.classList.add("red-4");
  else if (diff <= -2) bubble.classList.add("red-3");
  else bubble.classList.add("red-2");

  // Texte avec signe clair
  bubble.textContent = diff > 0 ? `+${diff}` : diff;

  charCard.style.position = "relative";
  charCard.appendChild(bubble);

  // Apparition
  requestAnimationFrame(() => bubble.classList.add("show"));

  // Disparition progressive
  setTimeout(() => {
    bubble.classList.remove("show");
    bubble.classList.add("fade-out");
    setTimeout(() => bubble.remove(), 600);
  }, 1600);
}


function startRevisionQuestion() {


  const niveauActif = determineNiveauActif(HiraganaList);
  const excludedKatakanaLevels = [3, 5, 7, 10, 11, 12, 14, 16, 17, 21, 22, 24, 25, 27, 28, 30, 31, 32, 34, 35, 36, 37, 38];
  const hiraganaItems = HiraganaList.filter(h => 
    parseInt(h.Niveau || 1) < niveauActif && 
    revisionRomajiTable[h.Hiragana] &&
    h.Hiragana && h.Romaji
  );
  const katakanaItems = HiraganaList.filter(h => 
    parseInt(h.Niveau || 1) < niveauActif && 
    !excludedKatakanaLevels.includes(parseInt(h.Niveau || 1)) && 
    revisionKatakanaTable[h.Katakana] &&
    h.Katakana && h.Romaji
  );
  const availableItems = [
    ...hiraganaItems.map(item => ({ ...item, type: 'hiragana', key: item.Hiragana })), 
    ...katakanaItems.map(item => ({ ...item, type: 'katakana', key: getLocalizedKatakana(item) }))
  ];

  console.log(`üéØ Items disponibles pour r√©vision: Hiragana=${hiraganaItems.length}, Katakana=${katakanaItems.length}`);

 if (availableItems.length === 0) {
    document.getElementById("revision-message").textContent = 
      niveauActif < 4 ? 
      t('revision_available_level4') :  // ‚úÖ MODIFI√â
      t('revision_no_items');            // ‚úÖ MODIFI√â
    document.getElementById("revision-message").style.color = "#dc3545";
    return;
  }

  // Tampon des 3 derniers tirages - convertir en numbers
  const recentItems = JSON.parse(localStorage.getItem('recentRevisionItems') || '[]').map(id => parseInt(id));

  let selectedItem;
  const apprendreBloque = isApprentissageBloque();
  if (!apprendreBloque) {
    // üé≤ TIRAGE AL√âATOIRE PUR (20%) - Filtr√© seulement par le tampon
    const randomItems = availableItems.filter(item => !recentItems.includes(parseInt(item.ID)));
    const finalRandomItems = randomItems.length >= 4 ? randomItems : availableItems;
    
    selectedItem = finalRandomItems[Math.floor(Math.random() * finalRandomItems.length)];
    
    console.log(`üé≤ TIRAGE AL√âATOIRE (20%)`);
    console.log(`üìã Items disponibles pour tirage al√©atoire: ${finalRandomItems.length}/${availableItems.length}`);
    console.log(`üîç Items filtr√©s par tampon:`, finalRandomItems.map(item => `${item.key}(ID:${item.ID})`).join(', '));
    
  } else {
    // ‚öñÔ∏è TIRAGE POND√âR√â (80%) - Filtr√© par Validation ‚â§ 10 + tampon
    const validationFilteredItems = availableItems.filter(item => (validationCache[parseInt(item.ID)] || 0) < seuilValidation);
    const weightedItems = validationFilteredItems.filter(item => !recentItems.includes(parseInt(item.ID)));
    
    let finalWeightedItems;
    
    if (weightedItems.length >= 4) {
      // Cas id√©al : assez d'items respectant validation ‚â§ 10 ET hors tampon
      finalWeightedItems = weightedItems;
    } else if (weightedItems.length > 0) {
      // Peu d'items mais au moins quelques-uns : on les garde
      finalWeightedItems = weightedItems;
    } else {
      // Aucun item respectant les deux contraintes
      // PRIORIT√â : √©viter le tampon (lib√©rer contrainte validation ‚â§ 10)
      const itemsHorsTampon = availableItems.filter(item => !recentItems.includes(parseInt(item.ID)));
      if (itemsHorsTampon.length > 0) {
        finalWeightedItems = itemsHorsTampon;
        console.log(`‚ö†Ô∏è FALLBACK 1 - Lib√©ration contrainte Validation ‚â§ 10 pour √©viter tampon`);
      } else {
        // Dernier recours : prendre tous les items (m√™me dans le tampon)
        finalWeightedItems = availableItems;
        console.log(`‚ö†Ô∏è FALLBACK 2 - Tous les items utilis√©s (tampon ignor√©)`);
      }
    }

    // Tirage pond√©r√© sur les items finaux
    const weights = finalWeightedItems.map(item => {
      const stats = statsCache.items[parseInt(item.ID)] || { pourcentage: 0 };
      const pourcentage = stats.pourcentage;
      return pourcentage === 0 ? 50 : Math.min(50, Math.pow(100 / (pourcentage + 10), 2));
    });
    const totalWeight = weights.reduce((a, b) => a + b, 0);
    let random = Math.random() * totalWeight;
    for (let i = 0; i < finalWeightedItems.length; i++) {
      random -= weights[i];
      if (random <= 0) {
        selectedItem = finalWeightedItems[i];
        break;
      }
    }
    
    console.log(`‚öñÔ∏è TIRAGE POND√âR√â (80%)`);
    console.log(`üìã Items disponibles (Validation ‚â§ 10 + tampon): ${finalWeightedItems.length}/${availableItems.length}`);
    console.log(`üîç Items respectant Validation ‚â§ 10:`, 
      validationFilteredItems.map(item => `${item.key}(ID:${item.ID},Val:${validationCache[parseInt(item.ID)] || 0})`)
        .join(', '));
    console.log(`üö´ Items exclus par tampon:`, recentItems.join(', '));
    console.log(`‚úÖ Items finaux pour pond√©ration:`, 
      finalWeightedItems.map(item => `${item.key}(ID:${item.ID},Val:${validationCache[parseInt(item.ID)] || 0},${(statsCache.items[parseInt(item.ID)]?.pourcentage || 0).toFixed(1)}%)`)
        .join(', '));
  }

  // Mettre √† jour le tampon - s'assurer que c'est un number
  recentItems.push(parseInt(selectedItem.ID));
  if (recentItems.length > 3) recentItems.shift(); // Garder seulement les 3 derniers
  localStorage.setItem('recentRevisionItems', JSON.stringify(recentItems));

  // Log pour v√©rification
  console.log(`üéØ Question s√©lectionn√©e: "${selectedItem.key}" (ID: ${selectedItem.ID}, Type: ${selectedItem.type})`);
  console.log(`üîç Tampon r√©cent:`, recentItems);

  // Configurer la question
  revisionMode.currentQuestion = selectedItem.key;
  const table = selectedItem.type === 'hiragana' ? revisionRomajiTable : revisionKatakanaTable;
  const tableEntry = table[selectedItem.key];
  revisionMode.romajiSegments = tableEntry.romaji;
  revisionMode.charCounts = tableEntry.charCounts;
  revisionMode.fullCorrect = revisionMode.romajiSegments.join("");
  revisionMode.currentItem = selectedItem;

  let cumRom = 0;
  revisionMode.cumulativeRomaji = revisionMode.romajiSegments.map(segment => {
    cumRom += segment.length;
    return cumRom;
  });
  let cumChar = 0;
  revisionMode.cumulativeChars = revisionMode.charCounts.map(count => {
    cumChar += count;
    return cumChar;
  });

  revisionMode.input = "";
  document.getElementById("revision-question").innerHTML = 
    revisionMode.currentQuestion.split("").map((char, index) => 
      `<div class="char-card" id="revision-card-${index}">
        <span id="revision-char-${index}">${char}</span>
      </div>`
    ).join("");
  document.getElementById("revision-input-display").textContent = "";
  document.getElementById("revision-message").textContent = "";

  // üí¨ Affiche l‚Äôinfobulle du d√©ficit/avance de Validation sur la premi√®re carte
const firstCard = document.getElementById(`revision-card-0`);
if (firstCard && revisionMode.currentItem) {
  const currentValidation = parseInt(revisionMode.currentItem.Validation || validationCache[revisionMode.currentItem.ID] || 0);
  showValidationBubble(firstCard, currentValidation, seuilValidation);
}


  

  if (firstCard) firstCard.classList.add("pulsing");

  console.log(`üìù Question: "${revisionMode.currentQuestion}" (${selectedItem.Romaji}) -> Attendu: "${revisionMode.fullCorrect}"`);
  console.log(`üìä Pourcentage item (ID ${selectedItem.ID}): ${(statsCache.items[parseInt(selectedItem.ID)]?.pourcentage || 0).toFixed(2)}% | Pourcentage global: ${statsCache.globalPourcentage.toFixed(2)}%`);
 // ‚úÖ Afficher la barre √† chaque nouvelle question (sans la recalculer)
  updateUnlockProgress();
}  
function isRevisionModeAvailable() {
  return niveauActif >= 4;
}  
function updateRevisionFeedback() {
  // Reset toutes les classes
  for (let i = 0; i < revisionMode.currentQuestion.length; i++) {
    const cardElement = document.getElementById(`revision-card-${i}`);
    const charElement = document.getElementById(`revision-char-${i}`);
    if (cardElement) {
      cardElement.classList.remove(
        "char-correct-1", "char-correct-2", "char-correct-3", "char-correct-4",
        "char-incorrect-1", "char-incorrect-2", "char-incorrect-3", "char-incorrect-4",
        "pulsing", "pop-animation"
      );
    }
    if (charElement) {
      charElement.classList.remove("pulsing");
    }
  }

  let currentSegment = -1;
  const inputLength = revisionMode.input.length;

  // Parcourir chaque segment
  for (let seg = 0; seg < revisionMode.romajiSegments.length; seg++) {
    const romStart = seg > 0 ? revisionMode.cumulativeRomaji[seg - 1] : 0;
    const romEnd = revisionMode.cumulativeRomaji[seg];
    const charStart = seg > 0 ? revisionMode.cumulativeChars[seg - 1] : 0;
    const charEnd = revisionMode.cumulativeChars[seg];
    const segmentLength = romEnd - romStart;
    const typedLen = Math.max(0, Math.min(inputLength - romStart, segmentLength));
    const typedSegment = revisionMode.input.substring(romStart, romStart + typedLen);
    const expected = revisionMode.romajiSegments[seg];
    let className = "";

    console.log(`Segment ${seg}: romStart=${romStart}, romEnd=${romEnd}, typedLen=${typedLen}, typedSegment="${typedSegment}", expected="${expected}"`);

    // Gradation bas√©e sur la progression dans le segment
    if (typedLen > 0) {
      if (expected.startsWith(typedSegment)) {
        const level = Math.min(4, typedLen);
        className = `char-correct-${level}`;
      } else {
        const level = Math.min(4, typedLen);
        className = `char-incorrect-${level}`;
      }
    }

    // Appliquer la gradation aux cartes du segment
    for (let c = charStart; c < charEnd; c++) {
      const card = document.getElementById(`revision-card-${c}`);
      const span = document.getElementById(`revision-char-${c}`);
      if (card) {
        card.className = `char-card ${className || ""}`; // Appliquer la gradation
        // Ajouter animation "pop" et son si on valide un nouveau caract√®re
        if (inputLength > romStart && c === charStart && !card.classList.contains("pop-animation")) {
          card.classList.add("pop-animation");
          playPopSound();
          setTimeout(() => card.classList.remove("pop-animation"), 300);
        }
      }
    }

    // Validation finale uniquement pour le segment courant si enti√®rement saisi
    if (inputLength >= romEnd) {
      const fullSegment = revisionMode.input.substring(romStart, romEnd);
      if (fullSegment === expected) {
        for (let c = charStart; c < charEnd; c++) {
          const card = document.getElementById(`revision-card-${c}`);
          if (card) {
            card.classList.remove("pulsing");
            card.className = `char-card char-correct-4`;
          }
        }
      } else if (romStart < inputLength) { // Saisie incorrecte partielle
        for (let c = charStart; c < charEnd; c++) {
          const card = document.getElementById(`revision-card-${c}`);
          if (card) {
            card.classList.remove("pulsing");
            card.className = `char-card char-incorrect-4`;
          }
        }
      }
    }

    // D√©terminer le segment en cours pour la pulsation
    if (romStart <= inputLength && inputLength < romEnd) {
      currentSegment = seg;
    }
  }

  // Ajouter la pulsation √† la carte en cours
  if (currentSegment >= 0) {
    const charStart = currentSegment > 0 ? revisionMode.cumulativeChars[currentSegment - 1] : 0;
    const charEnd = revisionMode.cumulativeChars[currentSegment];
    for (let c = charStart; c < charEnd; c++) {
      const cardElement = document.getElementById(`revision-card-${c}`);
      if (cardElement) {
        cardElement.classList.add("pulsing");
      }
    }
  }

}
  
      
  
  
// Initialiser les √©v√©nements du clavier de r√©vision
// Initialiser les √©v√©nements du clavier de r√©vision
function initRevisionKeyboard() {
  const revisionKeys = document.querySelectorAll('.revision-key');
  revisionKeys.forEach(key => key.replaceWith(key.cloneNode(true)));
  const newRevisionKeys = document.querySelectorAll('.revision-key');

  newRevisionKeys.forEach(key => {
    key.addEventListener("click", async () => {  // ‚úÖ ASYNC ajout√©
      if (!revisionMode.isActive) return;

      if (key.id === "revision-back") {
        revisionMode.input = revisionMode.input.slice(0, -1);
      } else {
        revisionMode.input += key.textContent;
      }

      document.getElementById("revision-input-display").textContent = revisionMode.input;
      updateRevisionFeedback();

      const totalLength = revisionMode.cumulativeRomaji[revisionMode.cumulativeRomaji.length - 1] || 1;
      const hiraganaItem = HiraganaList.find(h => h.ID == revisionMode.currentItem.ID);
      const hiraganaChar = hiraganaItem ? hiraganaItem.Hiragana : revisionMode.currentQuestion;
      const niveau = parseInt(revisionMode.currentItem.Niveau || 1);
      const isHighLevel = niveau > 38;
      const isMultiChar = revisionMode.romajiSegments.length >= 2;
      const katakanaDisplay = (!isHighLevel && isMultiChar) ? ` (${getLocalizedKatakana(revisionMode.currentItem)})` : '';

    if (revisionMode.input.length >= totalLength) {
  const isCorrect = revisionMode.input === revisionMode.fullCorrect;
  const key = revisionMode.currentItem.ID;

  // Mettre √† jour statsCache
  statsCache.items[key] = statsCache.items[key] || { tentatives: 0, reussites: 0, pourcentage: 0 };
  statsCache.items[key].tentatives += 1;
  statsCache.items[key].reussites += isCorrect ? 1 : 0;
  statsCache.items[key].pourcentage = statsCache.items[key].tentatives > 0 
    ? (statsCache.items[key].reussites / statsCache.items[key].tentatives * 100) : 0;

  // Mettre √† jour pourcentage global
  const totalTentatives = Object.values(statsCache.items).reduce((sum, item) => sum + item.tentatives, 0);
  const totalReussites = Object.values(statsCache.items).reduce((sum, item) => sum + item.reussites, 0);
  statsCache.globalPourcentage = totalTentatives > 0 ? (totalReussites / totalTentatives * 100) : 0;

  console.log(`üìä Mise √† jour pour "${revisionMode.currentQuestion}" (ID ${key}): Tentatives=${statsCache.items[key].tentatives}, R√©ussites=${statsCache.items[key].reussites}, Pourcentage=${statsCache.items[key].pourcentage.toFixed(2)}%`);
  console.log('üìà Pourcentage global:', statsCache.globalPourcentage.toFixed(2) + '%');

  // Modification de la validation en mode r√©vision
  const hiraganaIndex = HiraganaList.findIndex(h => h.ID == revisionMode.currentItem.ID);
  if (hiraganaIndex !== -1) {
    const currentValidation = parseInt(HiraganaList[hiraganaIndex].Validation || 0);
    
    let newValidation;
    let pointsGagnes = 0;

    if (isCorrect) {
      newValidation = currentValidation + 1;
      if (currentValidation < seuilValidation) {
        pointsGagnes = 1;
      }
    } else {
      newValidation = Math.max(5, currentValidation - 2);
      const oldDeficit = Math.max(0, seuilValidation - currentValidation);
      const newDeficit = Math.max(0, seuilValidation - newValidation);
      pointsGagnes = oldDeficit - newDeficit;
    }

    HiraganaList[hiraganaIndex].Validation = newValidation.toString();
    validationCache[revisionMode.currentItem.ID] = newValidation;

    if (wasBlockedWhenEnteringRevision) {
      pointsGagnesEnRevision += pointsGagnes;
      console.log(`üìä Validation: ${currentValidation}‚Üí${newValidation} | Points cette question: ${pointsGagnes} | Total gagn√©: ${pointsGagnesEnRevision}/${deficitInitialRevision}`);
      updateUnlockProgress();
    }
    
    console.log(`üîí Mode r√©vision - Validation: ${newValidation} (√©tait: ${currentValidation})`);
  }

  // ‚úÖ Mettre en file d'attente l'appel API (en background, sans attendre)
  queueUpdateStats({
    token: userToken,
    id: parseInt(revisionMode.currentItem.ID),
    scorePoints: isCorrect ? 1 : 0,
    isRevisionMode: true
  });
// ‚úÖ Rafra√Æchir les stats si la page est ouverte
if (document.getElementById('stats').classList.contains('active')) {
  setTimeout(() => {
    generateStatsPage();
  }, 100);
}
  // Mettre √† jour la barre de d√©blocage
  if (wasBlockedWhenEnteringRevision) {
    updateUnlockProgress();
  }

  // Afficher feedback
if (isCorrect) {
  document.getElementById("revision-message").textContent = isHighLevel ? t('revision_ok') : `${katakanaDisplay}`;
  document.getElementById("revision-message").style.color = "#8B6F47";
  playZenBell();
} else {
  document.getElementById("revision-message").textContent = isHighLevel 
    ? t('revision_wrong')
    : `${t('revision_correct_answer')} ${revisionMode.fullCorrect}${katakanaDisplay}`;
  document.getElementById("revision-message").style.color = "#8B6F47";
  playSoftError();
}

  // Jouer son MP3
  const audioFile = `${encodeURIComponent(hiraganaChar)}.mp3`;
  const audioUrl = `https://emmanuel971-source.github.io/hirakataquizz/${audioFile}`;
  const audio = new Audio(audioUrl);
  audio.play().catch(e => console.warn('Erreur audio:', e));

// üí¨ Affiche mise √† jour du score apr√®s la r√©ponse
const currentCard = document.querySelector('.char-card.pulsing') || document.getElementById('revision-card-0');
if (currentCard) {
  const newVal = parseInt(HiraganaList[hiraganaIndex].Validation || 0);
  showValidationBubble(currentCard, newVal, seuilValidation);
}

      
  setTimeout(() => {
    startRevisionQuestion();
  }, isCorrect ? 2000 : 3000);
}
    });
  });
}
  
// Appeler l'initialisation au chargement de la page
window.addEventListener('load', () => {
  initRevisionKeyboard();
});

  
  
  // D√©marrage du jeu
window.onload = () => {
  // ‚úÖ AJOUT√â : S'assurer que la langue est correcte d√®s le chargement
  if (!localStorage.getItem('appLanguage')) {
    const detectedLang = detectBrowserLanguage();
    currentLanguage = detectedLang;
    localStorage.setItem('appLanguage', detectedLang);
  } else {
    currentLanguage = localStorage.getItem('appLanguage');
  }
  
  // ‚úÖ AJOUT√â : Mettre √† jour les textes avant initGame
  updateAllTexts();
  
  initGame();
};
// ‚úÖ AJOUT√â : Tracking des interactions utilisateur (anti-bot)
document.addEventListener('click', () => userInteractions.clicks++);
document.addEventListener('keydown', () => userInteractions.keystrokes++);
document.addEventListener('mousemove', () => {
  if (userInteractions.mouseMovements < 50) { // Limiter pour ne pas surcharger
    userInteractions.mouseMovements++;
  }
});  
// S'assurer que les voix sont bien charg√©es
speechSynthesis.onvoiceschanged = () => {
console.log("üì¢ Voix disponibles :", speechSynthesis.getVoices());
};

</script>
<script>
function adjustStatsTableOffset() {
  const menu = document.getElementById('thead');
  const container = document.querySelector('.stats-table-container');

  if (!menu || !container) return;

  // Hauteur r√©elle du menu
  const menuHeight = menu.offsetHeight;

  // Appliquer un padding √©quivalent
  container.style.paddingTop = menuHeight + 'px';
}

// Lancer quand la page est charg√©e
window.addEventListener('load', adjustStatsTableOffset);

// Lancer lors d‚Äôun changement de taille (mobile -> landscape)
window.addEventListener('resize', adjustStatsTableOffset);

// Lancer aussi quand la section "stats" s‚Äôouvre
const originalShowSection = showSection;
showSection = function(sectionId) {
  originalShowSection(sectionId);
if (sectionId === 'stats') {
  setTimeout(generateGarden, 100);
}
}
</script>
  
</body>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const panda = document.querySelector(".panda-logo");
  if (panda) {
   panda.addEventListener("click", () => {
  document.getElementById("welcome").classList.add("hidden");
  loadDifficulty();
  updateMenuMessage();
  updateApprendreButtonState();
  
  const menuBtn = document.querySelector(".hamburger");
  if (menuBtn) menuBtn.classList.remove("hidden");
  
  // ‚úÖ NOUVEAU : Diff√©rencier new user vs returning user
  if (!userToken || !currentUser) {
    // üÜï NEW USER : Cr√©ation de compte
    showSection('create-account');
    generateNewPseudo();
  } else {
    // üîÅ RETURNING USER : Message de bienvenue + menu
    showReturningUserWelcome(currentUser.pseudo);
  }
  
  niveauActif = determineNiveauActif(HiraganaList);
  document.getElementById("levelDisplay").innerText = `Niveau actuel : ${niveauActif}`;
  updateLevelProgress(HiraganaList, niveauActif);
  renderProgressBar(niveauActif, getMaxLevel(HiraganaList));
  nextQuestion();      
  updateRevisionButtonState();
  updateApprendreButtonState();
});
  }
  
  updateAllTexts();
});
  document.addEventListener("DOMContentLoaded", () => {
  const panda = document.querySelector(".panda-logo");
  const menuBtn = document.querySelector(".hamburger");

  // Masquer le menu tant qu'on est sur l'accueil
  if (menuBtn) menuBtn.classList.add("hidden");

  // D√©sactiver le clic sur le panda tant que les donn√©es ne sont pas charg√©es
  panda.style.pointerEvents = "none"; 
  panda.style.opacity = "0.2"; // optionnel, pour indiquer que c'est inactif
});
</script>  
</html>
