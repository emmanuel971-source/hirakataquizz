<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Kana - D√©tection Sons Courts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 2rem;
      max-width: 700px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
    }
    .info {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      border: none;
      border-radius: 12px;
      background: #4CAF50;
      color: white;
      font-weight: bold;
      margin: 1rem;
      transition: all 0.3s;
    }
    button:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
    }
    button.listening {
      background: #f44336;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    #kana {
      font-size: 10rem;
      margin: 2rem 0;
      color: #333;
      min-height: 12rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #kana.match {
      color: #4CAF50;
      animation: pop 0.3s;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    #status {
      font-size: 1.1rem;
      color: #666;
      margin: 1rem 0;
      min-height: 2rem;
    }
    .heard-box {
      margin: 1rem 0;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 80px;
    }
    .heard-item {
      font-size: 0.9rem;
      color: #555;
      margin: 0.3rem 0;
    }
    .heard-item.match {
      color: #4CAF50;
      font-weight: bold;
    }
    .heard-item.rejected {
      color: #999;
      text-decoration: line-through;
    }
    #debug {
      margin-top: 1rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.75rem;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ Reconnaissance Kana</h1>
    <div class="info">
      Prononce clairement un kana (ka, shi, tsu, a, n...)<br>
      Le syst√®me d√©tecte les sons courts et filtre les mots longs
    </div>
    
    <button id="toggleBtn">D√©marrer l'√©coute</button>
    
    <div id="kana">‚Äî</div>
    <div id="status"></div>
    
    <div class="heard-box">
      <strong>Derniers sons d√©tect√©s:</strong>
      <div id="heardList"></div>
    </div>
    
    <div id="debug"></div>
  </div>

<script>
  const toggleBtn = document.getElementById("toggleBtn");
  const kanaDiv = document.getElementById("kana");
  const statusDiv = document.getElementById("status");
  const heardListDiv = document.getElementById("heardList");
  const debugDiv = document.getElementById("debug");

  let isListening = false;
  let recognition = null;
  let lastDetectionTime = 0;

  // Mapping tr√®s √©tendu romaji -> kana
  const romajiToKana = {
    // Voyelles
    "a": "„ÅÇ", "ah": "„ÅÇ", "ha": "„ÅÇ",
    "i": "„ÅÑ", "ii": "„ÅÑ", "ee": "„ÅÑ",
    "u": "„ÅÜ", "uu": "„ÅÜ", "ou": "„ÅÜ", "hou": "„ÅÜ",
    "e": "„Åà", "eh": "„Åà", "ay": "„Åà",
    "o": "„Åä", "oh": "„Åä", "oo": "„Åä",
    
    // K
    "ka": "„Åã", "ca": "„Åã", "kah": "„Åã",
    "ki": "„Åç", "key": "„Åç", "kee": "„Åç",
    "ku": "„Åè", "cou": "„Åè", "koo": "„Åè",
    "ke": "„Åë", "keh": "„Åë", "kay": "„Åë",
    "ko": "„Åì", "koh": "„Åì", "coh": "„Åì",
    
    // S
    "sa": "„Åï", "sah": "„Åï",
    "shi": "„Åó", "si": "„Åó", "she": "„Åó", "chi": "„Åó", "shee": "„Åó",
    "su": "„Åô", "sou": "„Åô", "sue": "„Åô",
    "se": "„Åõ", "seh": "„Åõ", "say": "„Åõ",
    "so": "„Åù", "soh": "„Åù",
    
    // T
    "ta": "„Åü", "tah": "„Åü",
    "chi": "„Å°", "ti": "„Å°", "tchi": "„Å°", "chee": "„Å°",
    "tsu": "„Å§", "tu": "„Å§", "tsou": "„Å§", "tsue": "„Å§", "sue": "„Å§",
    "te": "„Å¶", "teh": "„Å¶", "tay": "„Å¶",
    "to": "„Å®", "toh": "„Å®",
    
    // N
    "na": "„Å™", "nah": "„Å™",
    "ni": "„Å´", "nee": "„Å´",
    "nu": "„Å¨", "nou": "„Å¨",
    "ne": "„Å≠", "neh": "„Å≠", "nay": "„Å≠",
    "no": "„ÅÆ", "noh": "„ÅÆ",
    
    // H
    "ha": "„ÅØ", "hah": "„ÅØ",
    "hi": "„Å≤", "hee": "„Å≤",
    "fu": "„Åµ", "hu": "„Åµ", "fou": "„Åµ", "who": "„Åµ",
    "he": "„Å∏", "heh": "„Å∏", "hay": "„Å∏",
    "ho": "„Åª", "hoh": "„Åª",
    
    // M
    "ma": "„Åæ", "mah": "„Åæ",
    "mi": "„Åø", "mee": "„Åø",
    "mu": "„ÇÄ", "mou": "„ÇÄ",
    "me": "„ÇÅ", "meh": "„ÇÅ", "may": "„ÇÅ",
    "mo": "„ÇÇ", "moh": "„ÇÇ",
    
    // Y
    "ya": "„ÇÑ", "yah": "„ÇÑ",
    "yu": "„ÇÜ", "you": "„ÇÜ", "yoo": "„ÇÜ",
    "yo": "„Çà", "yoh": "„Çà",
    
    // R
    "ra": "„Çâ", "la": "„Çâ", "rah": "„Çâ", "lah": "„Çâ",
    "ri": "„Çä", "li": "„Çä", "ree": "„Çä", "lee": "„Çä",
    "ru": "„Çã", "lou": "„Çã", "rou": "„Çã",
    "re": "„Çå", "leh": "„Çå", "reh": "„Çå", "ray": "„Çå", "lay": "„Çå",
    "ro": "„Çç", "lo": "„Çç", "roh": "„Çç", "loh": "„Çç",
    
    // W
    "wa": "„Çè", "wah": "„Çè",
    "wo": "„Çí", "woh": "„Çí",
    "n": "„Çì", "nn": "„Çì", "m": "„Çì", "un": "„Çì",
    
    // G
    "ga": "„Åå", "gah": "„Åå",
    "gi": "„Åé", "gui": "„Åé", "gee": "„Åé",
    "gu": "„Åê", "gou": "„Åê",
    "ge": "„Åí", "geh": "„Åí", "gay": "„Åí",
    "go": "„Åî", "goh": "„Åî",
    
    // Z
    "za": "„Åñ", "zah": "„Åñ",
    "ji": "„Åò", "zi": "„Åò", "jee": "„Åò", "gee": "„Åò",
    "zu": "„Åö", "zou": "„Åö",
    "ze": "„Åú", "zeh": "„Åú",
    "zo": "„Åû", "zoh": "„Åû",
    
    // D
    "da": "„Å†", "dah": "„Å†",
    "di": "„Å¢", "dji": "„Å¢",
    "du": "„Å•", "dzu": "„Å•",
    "de": "„Åß", "deh": "„Åß", "day": "„Åß",
    "do": "„Å©", "doh": "„Å©",
    
    // B
    "ba": "„Å∞", "bah": "„Å∞",
    "bi": "„Å≥", "bee": "„Å≥",
    "bu": "„Å∂", "bou": "„Å∂",
    "be": "„Åπ", "beh": "„Åπ", "bay": "„Åπ",
    "bo": "„Åº", "boh": "„Åº",
    
    // P
    "pa": "„Å±", "pah": "„Å±",
    "pi": "„Å¥", "pee": "„Å¥",
    "pu": "„Å∑", "pou": "„Å∑",
    "pe": "„Å∫", "peh": "„Å∫", "pay": "„Å∫",
    "po": "„ÅΩ", "poh": "„ÅΩ"
  };

  // Inverser le mapping pour avoir kana -> romaji aussi
  const kanaToRomaji = {};
  for (const [romaji, kana] of Object.entries(romajiToKana)) {
    if (!kanaToRomaji[kana]) {
      kanaToRomaji[kana] = [];
    }
    kanaToRomaji[kana].push(romaji);
  }

  function addDebug(msg, isError = false) {
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div style="color: ${isError ? 'red' : '#333'}">[${time}] ${msg}</div>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
  }

  function addHeard(text, isMatch = false, isRejected = false) {
    const item = document.createElement('div');
    item.className = 'heard-item';
    if (isMatch) item.classList.add('match');
    if (isRejected) item.classList.add('rejected');
    item.textContent = text;
    heardListDiv.insertBefore(item, heardListDiv.firstChild);
    
    // Garder seulement les 10 derniers
    while (heardListDiv.children.length > 10) {
      heardListDiv.removeChild(heardListDiv.lastChild);
    }
  }

  addDebug("Script charg√©");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    statusDiv.innerHTML = '<span class="error">‚ùå Reconnaissance vocale non support√©e</span>';
    toggleBtn.disabled = true;
    addDebug("SpeechRecognition non disponible", true);
  } else {
    addDebug("SpeechRecognition disponible ‚úì");
    
    recognition = new SpeechRecognition();
    
    // üî• STRAT√âGIE: On essaie en FRAN√áAIS pour mieux capter les sons courts
    recognition.lang = "fr-FR";
    recognition.continuous = true;
    recognition.interimResults = false; // Seulement les r√©sultats finaux
    recognition.maxAlternatives = 10;

    function findKanaMatch(transcript) {
      const cleaned = transcript.toLowerCase().trim()
        .replace(/[.,!?;]/g, '')
        .replace(/c'est\s+/gi, '')
        .replace(/le\s+/gi, '')
        .replace(/la\s+/gi, '')
        .replace(/un\s+/gi, '')
        .replace(/une\s+/gi, '');
      
      // Longueur max pour un son de kana
      if (cleaned.length > 5) {
        addDebug(`‚ùå Trop long: "${cleaned}" (${cleaned.length} chars)`);
        return null;
      }
      
      // Chercher correspondance exacte
      if (romajiToKana[cleaned]) {
        return romajiToKana[cleaned];
      }
      
      // Chercher correspondance partielle
      for (const [romaji, kana] of Object.entries(romajiToKana)) {
        if (cleaned === romaji || 
            cleaned.endsWith(romaji) && cleaned.length - romaji.length <= 2) {
          return kana;
        }
      }
      
      return null;
    }

    toggleBtn.onclick = () => {
      if (!isListening) {
        try {
          recognition.start();
          isListening = true;
          toggleBtn.textContent = "Arr√™ter l'√©coute";
          toggleBtn.classList.add("listening");
          statusDiv.innerHTML = 'üéß En √©coute...';
          addDebug("√âcoute d√©marr√©e (fr-FR)");
        } catch (e) {
          addDebug(`Erreur: ${e.message}`, true);
        }
      } else {
        recognition.stop();
        isListening = false;
        toggleBtn.textContent = "D√©marrer l'√©coute";
        toggleBtn.classList.remove("listening");
        statusDiv.textContent = "√âcoute arr√™t√©e";
        addDebug("√âcoute arr√™t√©e");
      }
    };

    recognition.onresult = (event) => {
      const now = Date.now();
      
      // Anti-spam: ignorer si moins de 300ms depuis derni√®re d√©tection
      if (now - lastDetectionTime < 300) {
        return;
      }
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const result = event.results[i];
        if (!result.isFinal) continue;
        
        const transcript = result[0].transcript;
        addDebug(`Entendu: "${transcript}"`);
        
        // Essayer toutes les alternatives
        let foundKana = null;
        let matchedTranscript = null;
        
        for (let j = 0; j < Math.min(result.length, 10); j++) {
          const altTranscript = result[j].transcript;
          const altConfidence = result[j].confidence;
          
          addDebug(`  Alt ${j+1}: "${altTranscript}" (${(altConfidence * 100).toFixed(0)}%)`);
          
          if (!foundKana) {
            foundKana = findKanaMatch(altTranscript);
            if (foundKana) {
              matchedTranscript = altTranscript;
              addDebug(`  ‚úì Match trouv√© !`);
            }
          }
        }
        
        if (foundKana) {
          kanaDiv.textContent = foundKana;
          kanaDiv.classList.add("match");
          addHeard(`"${matchedTranscript}" ‚Üí ${foundKana}`, true, false);
          lastDetectionTime = now;
          
          setTimeout(() => {
            kanaDiv.classList.remove("match");
          }, 800);
        } else {
          addHeard(`"${transcript}" (pas de correspondance)`, false, true);
        }
      }
    };

    recognition.onerror = (event) => {
      if (event.error === "no-speech" || event.error === "aborted") return;
      addDebug(`Erreur: ${event.error}`, true);
    };

    recognition.onend = () => {
      addDebug("Reconnaissance termin√©e");
      if (isListening) {
        setTimeout(() => {
          try {
            recognition.start();
            addDebug("Red√©marrage auto");
          } catch (e) {
            addDebug(`Erreur red√©marrage: ${e.message}`, true);
          }
        }, 100);
      }
    };
  }
</script>
</body>
</html>
