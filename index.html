<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Reconnaissance Hiragana - Web Speech Optimis√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      border: 2px solid #333;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      border-color: #999;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.98);
    }
    #kana {
      font-size: 4rem;
      margin-top: 1.5rem;
      min-height: 5rem;
    }
    #raw {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    #error {
      margin-top: 1rem;
      color: red;
      font-size: 1rem;
      padding: 0.5rem;
    }
    #debug {
      margin-top: 2rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.85rem;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: green;
    }
    .hint {
      background: #e3f2fd;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    .recording {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üé§ Prononce un hiragana</h1>
  
  <div class="hint">
    üí° <strong>Conseils :</strong><br>
    ‚Ä¢ Prononce clairement le son japonais<br>
    ‚Ä¢ Exemples : "„ÅÇ" (a), "„Åã" (ka), "„Åó" (shi)<br>
    ‚Ä¢ Parle naturellement, pas besoin de crier
  </div>
  
  <button id="mic">üé§ Parler</button>
  <div id="kana">‚Äî</div>
  <div id="raw"></div>
  <div id="error"></div>
  <div id="debug"></div>

<script>
  const micBtn = document.getElementById("mic");
  const kanaDiv = document.getElementById("kana");
  const rawDiv = document.getElementById("raw");
  const errorDiv = document.getElementById("error");
  const debugDiv = document.getElementById("debug");

  function addDebug(msg, isError = false) {
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div style="color: ${isError ? 'red' : '#333'}">[${time}] ${msg}</div>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
  }

  addDebug("Script charg√©");

  // V√©rification HTTPS
  if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
    errorDiv.textContent = "‚ö†Ô∏è HTTPS requis pour la reconnaissance vocale";
    micBtn.disabled = true;
    addDebug("HTTPS non d√©tect√©", true);
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    errorDiv.textContent = "‚ùå Reconnaissance vocale non support√©e";
    micBtn.disabled = true;
    addDebug("SpeechRecognition non disponible", true);
  } else {
    addDebug("‚úÖ SpeechRecognition disponible");
    
    const recognition = new SpeechRecognition();
    
    // CONFIGURATION OPTIMIS√âE POUR JAPONAIS
    recognition.lang = "ja-JP";  // Japonais
    recognition.continuous = false;  // Un seul r√©sultat
    recognition.interimResults = true;  // R√©sultats en temps r√©el
    recognition.maxAlternatives = 5;  // Plus d'alternatives pour mieux matcher

    addDebug("Configuration: lang=ja-JP, maxAlternatives=5");

    // MAPPING COMPLET : Hiragana ‚Üí Romaji ET Hiragana direct
    const kanaMap = {
      // Hiragana direct (ce que Web Speech va reconna√Ætre)
      "„ÅÇ": "„ÅÇ", "„ÅÑ": "„ÅÑ", "„ÅÜ": "„ÅÜ", "„Åà": "„Åà", "„Åä": "„Åä",
      "„Åã": "„Åã", "„Åç": "„Åç", "„Åè": "„Åè", "„Åë": "„Åë", "„Åì": "„Åì",
      "„Åï": "„Åï", "„Åó": "„Åó", "„Åô": "„Åô", "„Åõ": "„Åõ", "„Åù": "„Åù",
      "„Åü": "„Åü", "„Å°": "„Å°", "„Å§": "„Å§", "„Å¶": "„Å¶", "„Å®": "„Å®",
      "„Å™": "„Å™", "„Å´": "„Å´", "„Å¨": "„Å¨", "„Å≠": "„Å≠", "„ÅÆ": "„ÅÆ",
      "„ÅØ": "„ÅØ", "„Å≤": "„Å≤", "„Åµ": "„Åµ", "„Å∏": "„Å∏", "„Åª": "„Åª",
      "„Åæ": "„Åæ", "„Åø": "„Åø", "„ÇÄ": "„ÇÄ", "„ÇÅ": "„ÇÅ", "„ÇÇ": "„ÇÇ",
      "„ÇÑ": "„ÇÑ", "„ÇÜ": "„ÇÜ", "„Çà": "„Çà",
      "„Çâ": "„Çâ", "„Çä": "„Çä", "„Çã": "„Çã", "„Çå": "„Çå", "„Çç": "„Çç",
      "„Çè": "„Çè", "„Çí": "„Çí", "„Çì": "„Çì",
      // Dakuten
      "„Åå": "„Åå", "„Åé": "„Åé", "„Åê": "„Åê", "„Åí": "„Åí", "„Åî": "„Åî",
      "„Åñ": "„Åñ", "„Åò": "„Åò", "„Åö": "„Åö", "„Åú": "„Åú", "„Åû": "„Åû",
      "„Å†": "„Å†", "„Å¢": "„Å¢", "„Å•": "„Å•", "„Åß": "„Åß", "„Å©": "„Å©",
      "„Å∞": "„Å∞", "„Å≥": "„Å≥", "„Å∂": "„Å∂", "„Åπ": "„Åπ", "„Åº": "„Åº",
      "„Å±": "„Å±", "„Å¥": "„Å¥", "„Å∑": "„Å∑", "„Å∫": "„Å∫", "„ÅΩ": "„ÅΩ",
      // Romaji en fallback
      "a": "„ÅÇ", "i": "„ÅÑ", "u": "„ÅÜ", "e": "„Åà", "o": "„Åä",
      "ka": "„Åã", "ki": "„Åç", "ku": "„Åè", "ke": "„Åë", "ko": "„Åì",
      "sa": "„Åï", "shi": "„Åó", "si": "„Åó", "su": "„Åô", "se": "„Åõ", "so": "„Åù",
      "ta": "„Åü", "chi": "„Å°", "ti": "„Å°", "tsu": "„Å§", "tu": "„Å§",
      "te": "„Å¶", "to": "„Å®",
      "na": "„Å™", "ni": "„Å´", "nu": "„Å¨", "ne": "„Å≠", "no": "„ÅÆ",
      "ha": "„ÅØ", "hi": "„Å≤", "fu": "„Åµ", "hu": "„Åµ", "he": "„Å∏", "ho": "„Åª",
      "ma": "„Åæ", "mi": "„Åø", "mu": "„ÇÄ", "me": "„ÇÅ", "mo": "„ÇÇ",
      "ya": "„ÇÑ", "yu": "„ÇÜ", "yo": "„Çà",
      "ra": "„Çâ", "ri": "„Çä", "ru": "„Çã", "re": "„Çå", "ro": "„Çç",
      "wa": "„Çè", "wo": "„Çí", "n": "„Çì",
      "ga": "„Åå", "gi": "„Åé", "gu": "„Åê", "ge": "„Åí", "go": "„Åî",
      "za": "„Åñ", "ji": "„Åò", "zi": "„Åò", "zu": "„Åö", "ze": "„Åú", "zo": "„Åû",
      "da": "„Å†", "de": "„Åß", "do": "„Å©",
      "ba": "„Å∞", "bi": "„Å≥", "bu": "„Å∂", "be": "„Åπ", "bo": "„Åº",
      "pa": "„Å±", "pi": "„Å¥", "pu": "„Å∑", "pe": "„Å∫", "po": "„ÅΩ"
    };

    micBtn.onclick = () => {
      addDebug("üé§ Bouton cliqu√© - d√©marrage");
      kanaDiv.innerHTML = '<span class="recording">üéß √âcoute...</span>';
      rawDiv.textContent = "";
      errorDiv.textContent = "";
      micBtn.disabled = true;
      micBtn.textContent = "√âcoute en cours...";
      
      try {
        recognition.start();
        addDebug("recognition.start() appel√©");
      } catch (e) {
        addDebug(`‚ùå Erreur au d√©marrage: ${e.message}`, true);
        errorDiv.textContent = `Erreur: ${e.message}`;
        micBtn.disabled = false;
        micBtn.textContent = "üé§ Parler";
      }
    };

    recognition.onstart = () => {
      addDebug("‚úÖ Reconnaissance d√©marr√©e");
    };

    // R√©sultats interm√©diaires (temps r√©el)
    recognition.onresult = (event) => {
      const results = event.results[event.results.length - 1];
      const isFinal = results.isFinal;
      
      addDebug(`üì• R√©sultat re√ßu (final: ${isFinal})`);
      
      // Afficher TOUTES les alternatives
      let allAlternatives = [];
      for (let i = 0; i < results.length; i++) {
        const transcript = results[i].transcript;
        const confidence = results[i].confidence;
        allAlternatives.push(`"${transcript}" (${(confidence * 100).toFixed(0)}%)`);
        addDebug(`  Alt ${i}: ${transcript} - confiance: ${(confidence * 100).toFixed(0)}%`);
      }
      
      const bestTranscript = results[0].transcript;
      const bestConfidence = results[0].confidence;
      
      rawDiv.innerHTML = `Reconnu : ${allAlternatives.join(' | ')}`;
      
      if (!isFinal) {
        kanaDiv.innerHTML = `<span style="color: #666">${bestTranscript}...</span>`;
        return;
      }
      
      // Traiter le r√©sultat final
      addDebug(`üéØ R√©sultat FINAL: "${bestTranscript}"`);
      
      // Essayer de matcher avec TOUTES les alternatives
      let found = false;
      for (let i = 0; i < results.length && !found; i++) {
        const transcript = results[i].transcript.trim();
        
        // Essai 1 : Match direct (hiragana)
        if (kanaMap[transcript]) {
          kanaDiv.textContent = kanaMap[transcript];
          found = true;
          addDebug(`‚úÖ Match direct: "${transcript}" ‚Üí ${kanaMap[transcript]}`);
          break;
        }
        
        // Essai 2 : Premi√®re lettre seulement
        const firstChar = transcript.charAt(0);
        if (kanaMap[firstChar]) {
          kanaDiv.textContent = kanaMap[firstChar];
          found = true;
          addDebug(`‚úÖ Match 1er caract√®re: "${firstChar}" ‚Üí ${kanaMap[firstChar]}`);
          break;
        }
        
        // Essai 3 : Romaji en minuscule
        const lowerTranscript = transcript.toLowerCase();
        if (kanaMap[lowerTranscript]) {
          kanaDiv.textContent = kanaMap[lowerTranscript];
          found = true;
          addDebug(`‚úÖ Match romaji: "${lowerTranscript}" ‚Üí ${kanaMap[lowerTranscript]}`);
          break;
        }
        
        // Essai 4 : Chercher dans le texte
        for (const [key, value] of Object.entries(kanaMap)) {
          if (transcript.includes(key)) {
            kanaDiv.textContent = value;
            found = true;
            addDebug(`‚úÖ Match contient: "${key}" dans "${transcript}" ‚Üí ${value}`);
            break;
          }
        }
      }
      
      if (!found) {
        kanaDiv.textContent = "‚ùì Pas reconnu";
        addDebug(`‚ùå Aucune correspondance trouv√©e`);
      }
    };

    recognition.onerror = (event) => {
      addDebug(`‚ùå Erreur: ${event.error}`, true);
      let message = "";
      switch (event.error) {
        case "no-speech":
          message = "Aucun son d√©tect√©. Parlez plus fort.";
          break;
        case "audio-capture":
          message = "Probl√®me avec le micro. V√©rifiez qu'il est autoris√©.";
          break;
        case "not-allowed":
          message = "Acc√®s au micro refus√©. Autorisez-le dans les param√®tres.";
          break;
        case "network":
          message = "Probl√®me de r√©seau.";
          break;
        case "aborted":
          message = "Reconnaissance interrompue.";
          break;
        default:
          message = `Erreur : ${event.error}`;
      }
      errorDiv.textContent = `‚ùå ${message}`;
      kanaDiv.textContent = "‚Äî";
    };

    recognition.onend = () => {
      addDebug("‚èπÔ∏è Reconnaissance termin√©e");
      micBtn.disabled = false;
      micBtn.textContent = "üé§ Parler";
    };
  }
</script>
</body>
</html>
