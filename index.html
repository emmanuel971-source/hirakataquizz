<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Vocal Hiragana</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        :root {
            --bg:       #0d1117;
            --surface:  #161b22;
            --border:   #30363d;
            --text:     #e6edf3;
            --muted:    #8b949e;
            --accent:   #58a6ff;
            --green:    #3fb950;
            --yellow:   #d29922;
            --red:      #f85149;
            --purple:   #bc8cff;
            --radius:   14px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 16px;
            min-height: 100vh;
        }

        .container { max-width: 480px; margin: 0 auto; }

        /* ‚îÄ‚îÄ CARTES G√âN√âRALES ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 14px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-sub {
            font-size: 0.82rem;
            color: var(--muted);
            margin-bottom: 20px;
        }

        /* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
        .field { margin-bottom: 18px; }
        .field label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; font-weight: 500; }

        input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: var(--accent); }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            margin-top: 8px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .gain-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--muted); }
        .gain-val { color: var(--accent); font-weight: 700; }

        /* ‚îÄ‚îÄ BOUTONS ‚îÄ‚îÄ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            padding: 12px 20px; font-size: 0.95rem; font-weight: 600;
            border-radius: 10px; border: none; cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            width: 100%;
        }
        .btn:active { transform: scale(0.97); opacity: 0.85; }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .btn-accent  { background: var(--accent);  color: #0d1117; }
        .btn-green   { background: var(--green);   color: #0d1117; }
        .btn-red     { background: var(--red);     color: white; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-sm { padding: 9px 16px; font-size: 0.85rem; width: auto; }

        #loading { color: var(--muted); font-size: 0.85rem; margin-top: 10px; text-align: center; }

        /* ‚îÄ‚îÄ QUIZ CARD ‚îÄ‚îÄ */
        #quiz-card {
            display: none;
            border: 2px solid var(--border);
            transition: border-color 0.3s, background 0.3s;
        }
        .quiz-active  { border-color: var(--accent) !important; }
        .quiz-success { border-color: var(--green)  !important; background: rgba(63,185,80,0.07) !important; }
        .quiz-fail    { border-color: var(--red)    !important; background: rgba(248,81,73,0.07) !important; }

        .quiz-meta {
            display: flex; justify-content: space-between;
            font-size: 0.78rem; color: var(--muted); margin-bottom: 18px;
        }
        .quiz-meta span { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; }
        .quiz-meta b { color: var(--text); }

        .hiragana-big {
            font-size: 7rem; font-weight: 700;
            color: var(--text); line-height: 1;
            margin: 8px 0 6px;
            text-align: center;
        }
        .romaji-hint {
            font-size: 1.6rem; color: var(--accent);
            text-transform: uppercase; font-weight: 700;
            letter-spacing: 4px; text-align: center;
            margin-bottom: 18px;
        }

        .timer-bar { width: 100%; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .timer-fill { height: 100%; width: 100%; background: var(--accent); transition: width linear; border-radius: 3px; }

        .feedback-zone {
            margin-top: 14px; font-size: 0.9rem;
            color: var(--muted); min-height: 22px; text-align: center;
        }

        /* ‚îÄ‚îÄ ACTION CARD ‚îÄ‚îÄ */
        #action-card { padding: 16px 24px; }
        .action-row { display: flex; gap: 10px; }
        .action-row .btn { flex: 1; }
        #log-count { text-align: center; margin-top: 10px; font-size: 0.75rem; color: var(--muted); }

        /* ‚îÄ‚îÄ R√âSULTATS ‚îÄ‚îÄ */
        .hidden { display: none !important; }

        .res-header {
            text-align: center;
            padding: 22px 24px 18px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 14px;
        }
        .res-header .big-score {
            font-size: 3.5rem; font-weight: 800; line-height: 1;
            margin: 8px 0 4px;
        }
        .res-header .score-label { font-size: 0.82rem; color: var(--muted); }
        .res-header .user-name { font-size: 0.85rem; color: var(--muted); margin-top: 8px; }

        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px; }
        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 8px;
            text-align: center;
        }
        .kpi-val { font-size: 1.6rem; font-weight: 700; }
        .kpi-lbl { font-size: 0.7rem; color: var(--muted); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.5px; }

        .section-label {
            font-size: 0.72rem; font-weight: 700; color: var(--muted);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin: 18px 0 10px;
        }

        /* Grille hiragana ‚Äî 5 colonnes, grande taille */
        .hira-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }
        .hira-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 4px 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hira-card::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 3px;
        }
        .hira-card.good::after  { background: var(--green); }
        .hira-card.mid::after   { background: var(--yellow); }
        .hira-card.poor::after  { background: var(--red); }

        .hira-char { font-size: 2.4rem; line-height: 1.1; }
        .hira-romaji { font-size: 0.7rem; color: var(--muted); margin: 2px 0; letter-spacing: 1px; text-transform: uppercase; }
        .hira-pct { font-size: 1.15rem; font-weight: 700; margin: 2px 0; }
        .hira-sub { font-size: 0.65rem; color: var(--muted); }

        /* Confusions */
        .conf-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 14px;
        }
        .conf-row {
            display: flex; align-items: center;
            padding: 13px 16px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .conf-row:last-child { border-bottom: none; }
        .conf-chars { font-size: 1.8rem; line-height: 1; min-width: 80px; }
        .conf-arrow { color: var(--muted); font-size: 1rem; }
        .conf-info { flex: 1; }
        .conf-info .conf-rom { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
        .conf-bar-wrap { flex: 2; background: var(--bg); border-radius: 4px; height: 6px; overflow: hidden; }
        .conf-bar { height: 100%; background: var(--red); border-radius: 4px; }
        .conf-count { font-size: 0.85rem; font-weight: 700; color: var(--red); min-width: 28px; text-align: right; }
        .conf-empty { padding: 18px; text-align: center; color: var(--green); font-size: 0.95rem; }

        /* Boutons r√©sultats */
        .res-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 6px; padding-bottom: 24px; }
        .res-btns .btn { padding: 15px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">

    <!-- ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ -->
    <div class="card" id="setup-card">
        <div class="card-title">üéôÔ∏è Quiz Vocal Hiragana</div>
        <div class="card-sub">Protocole de test v1.0</div>

        <div class="field">
            <label>Nom / Appareil</label>
            <input type="text" id="username" placeholder="ex: Pierre_Android" value="Testeur_01">
        </div>

        <div class="field">
            <div class="gain-row">
                <span>Sensibilit√© micro</span>
                <span class="gain-val" id="gain-val">1.0</span>√ó
            </div>
            <input type="range" id="gain-slider" min="0.5" max="5" step="0.1" value="1">
        </div>

        <button id="btn-start" class="btn btn-accent">üöÄ Initialiser &amp; D√©marrer</button>
        <div id="loading" class="hidden">‚è≥ Chargement du mod√®le‚Ä¶</div>
    </div>

    <!-- ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ -->
    <div class="card" id="quiz-card">
        <div class="quiz-meta">
            <span>Question <b id="q-count">0</b></span>
            <span>RMS <b id="rms-disp">0.0000</b></span>
        </div>

        <div class="hiragana-big" id="target-char">?</div>
        <div class="romaji-hint" id="target-romaji">PR√äT ?</div>

        <div class="timer-bar">
            <div class="timer-fill" id="timer-fill"></div>
        </div>

        <div class="feedback-zone" id="feedback-top1">En attente‚Ä¶</div>
    </div>

    <!-- ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ -->
    <div class="card hidden" id="action-card">
        <div class="action-row">
            <button class="btn btn-outline" onclick="nextQuestion()">‚è≠ Suivant</button>
            <button class="btn btn-red" onclick="stopQuiz()">‚èπ Finir</button>
        </div>
        <div id="log-count">0 r√©sultat enregistr√©</div>
    </div>

    <!-- ‚îÄ‚îÄ R√âSULTATS ‚îÄ‚îÄ -->
    <div id="results-page" class="hidden">

        <div class="res-header">
            <div class="score-label">Pr√©cision globale</div>
            <div class="big-score" id="res-accuracy">‚Äî</div>
            <div class="user-name" id="res-username-display"></div>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-val" style="color:var(--accent)" id="res-total">‚Äî</div>
                <div class="kpi-lbl">Questions</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-val" style="color:var(--green)" id="res-correct">‚Äî</div>
                <div class="kpi-lbl">Correctes</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-val" style="color:var(--yellow); font-size:1.1rem" id="res-rms">‚Äî</div>
                <div class="kpi-lbl">RMS moy.</div>
            </div>
        </div>

        <div class="section-label">R√©ussite par hiragana</div>
        <div class="hira-grid" id="res-hiragana-grid"></div>

        <div class="section-label">Confusions principales</div>
        <div class="conf-card" id="res-confusions"></div>

        <div class="res-btns">
            <button class="btn btn-outline" onclick="restartQuiz()">üîÑ Recommencer</button>
            <button class="btn btn-green" onclick="exportCSV()">üíæ Exporter CSV</button>
        </div>

    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const URL_MODEL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";

    const HIRAGANA_MAP = { 'a':'„ÅÇ','i':'„ÅÑ','u':'„ÅÜ','e':'„Åà','o':'„Åä' };
    const VOWELS = ['„ÅÇ','„ÅÑ','„ÅÜ','„Åà','„Åä'];

    // --- VARIABLES GLOBALES ---
    let recognizer, audioContext, gainNode, analyser, dataArray;
    let isListening  = false;
    let quizStopped  = false;
    let currentTarget = "";
    let logs = [];
    let questionCount = 0;

    let sessionBest   = { label:"", score:0, label2:"", score2:0 };
    let sessionMaxRMS = 0;
    let sessionAvgRMS = 0;
    let rmsSum = 0, rmsCount = 0;

    // --- INIT ---
    document.getElementById('btn-start').onclick = async () => {
        const btn  = document.getElementById('btn-start');
        const name = document.getElementById('username').value.trim();
        if (!name) { alert("Merci d'entrer un nom !"); return; }

        btn.disabled = true;
        document.getElementById('loading').classList.remove('hidden');

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(stream);

            gainNode = audioContext.createGain();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Float32Array(analyser.fftSize);

            source.connect(gainNode);
            gainNode.connect(analyser);

            recognizer = speechCommands.create("BROWSER_FFT", undefined, URL_MODEL + "model.json", URL_MODEL + "metadata.json");
            await recognizer.ensureModelLoaded();

            document.getElementById('setup-card').classList.add('hidden');
            document.getElementById('quiz-card').style.display = 'block';
            document.getElementById('action-card').classList.remove('hidden');

            updateRMSLoop();
            startContinuousRecognition();
            setTimeout(nextQuestion, 1000);

        } catch (e) {
            alert("Erreur micro ou mod√®le : " + e);
            console.error(e);
            btn.disabled = false;
        }
    };

    // --- RECONNAISSANCE ---
    function startContinuousRecognition() {
        recognizer.listen(result => {
            if (!isListening) return;

            const labels = recognizer.wordLabels();
            const scores = Array.from(result.scores).map((s, i) => ({ label: labels[i], score: s }));
            scores.sort((a, b) => b.score - a.score);

            const top1 = scores[0];
            const top2 = scores[1] || { label:"none", score:0 };

            const isBackground = top1.label.toLowerCase().includes("background") ||
                                  top1.label.toLowerCase().includes("bruit");
            if (isBackground) return;

            const isTarget = top1.label === currentTarget;

            if (isTarget && top1.score > 0.70) {
                if (top1.score > sessionBest.score || sessionBest.label !== currentTarget) {
                    updateSessionBest(top1, top2);
                }
            } else if (top1.score > sessionBest.score) {
                if (sessionBest.label !== currentTarget) {
                    updateSessionBest(top1, top2);
                }
            }

        }, { probabilityThreshold: 0.1, overlapFactor: 0.5 });
    }

    function updateSessionBest(s1, s2) {
        sessionBest.label  = s1.label;
        sessionBest.score  = s1.score;
        sessionBest.label2 = s2.label;
        sessionBest.score2 = s2.score;

        const isCorrect = sessionBest.label === currentTarget;
        const color = isCorrect ? "var(--green)" : "var(--red)";
        const icon  = isCorrect ? "‚úÖ" : "üëÇ";
        document.getElementById('feedback-top1').innerHTML =
            `<span style="color:${color};font-weight:700">${icon} ${sessionBest.label} ¬∑ ${(sessionBest.score*100).toFixed(0)}%</span>`;
    }

    // --- QUIZ FLOW ---
    function nextQuestion() {
        if (quizStopped) return;

        questionCount++;
        document.getElementById('q-count').innerText = questionCount;

        const randKey = VOWELS[Math.floor(Math.random() * VOWELS.length)];
        currentTarget = randKey;

        const card = document.getElementById('quiz-card');
        card.className = "card quiz-active";
        document.getElementById('target-char').innerText   = HIRAGANA_MAP[randKey] || randKey;
        document.getElementById('target-romaji').innerText = randKey;
        document.getElementById('feedback-top1').innerText = "√âcoute en cours‚Ä¶";

        sessionBest   = { label:"Silence", score:0, label2:"-", score2:0 };
        sessionMaxRMS = 0;
        rmsSum = 0; rmsCount = 0;

        const timer = document.getElementById('timer-fill');
        timer.style.transition = 'none';
        timer.style.width = '100%';
        setTimeout(() => {
            timer.style.transition = 'width 3s linear';
            timer.style.width = '0%';
            isListening = true;
        }, 50);

        setTimeout(finishQuestion, 3050);
    }

    function finishQuestion() {
        isListening = false;
        sessionAvgRMS = rmsCount > 0 ? (rmsSum / rmsCount) : 0;

        const timestamp   = new Date().toLocaleString('fr-FR');
        const username    = document.getElementById('username').value.replace(/[^a-zA-Z0-9_-]/g, "");
        const filenameMock = `LiveTest_${username}`;

        const logEntry = {
            timestamp, filename: filenameMock,
            expected: currentTarget,
            top1:  sessionBest.label,  score1: sessionBest.score.toFixed(4),
            top2:  sessionBest.label2, score2: sessionBest.score2.toFixed(4),
            rms:   sessionAvgRMS.toFixed(6),
            gain:  gainNode.gain.value.toFixed(2)
        };
        logs.push(logEntry);

        const n = logs.length;
        document.getElementById('log-count').innerText =
            `${n} r√©sultat${n > 1 ? 's' : ''} enregistr√©${n > 1 ? 's' : ''}`;

        const card      = document.getElementById('quiz-card');
        const isCorrect = sessionBest.label === currentTarget;

        card.className = "card " + (isCorrect ? "quiz-success" : "quiz-fail");
        document.getElementById('feedback-top1').innerHTML = isCorrect
            ? `<span style="color:var(--green);font-weight:700">‚úÖ Bravo ! (${(sessionBest.score*100).toFixed(0)}%)</span>`
            : `<span style="color:var(--red);font-weight:700">‚ùå Entendu : ${sessionBest.label}</span>`;

        if (!quizStopped) setTimeout(nextQuestion, 1500);
    }

    // --- STOP & R√âSULTATS ---
    function stopQuiz() {
        if (logs.length === 0) { alert("Aucune donn√©e √† exporter."); return; }

        isListening = false;
        quizStopped = true;

        document.getElementById('quiz-card').style.display = 'none';
        document.getElementById('action-card').classList.add('hidden');
        document.getElementById('results-page').classList.remove('hidden');

        buildResultsPage();
    }

    function buildResultsPage() {
        const r2h = { 'a':'„ÅÇ','i':'„ÅÑ','u':'„ÅÜ','e':'„Åà','o':'„Åä' };
        const total   = logs.length;
        const correct = logs.filter(l => l.top1 === l.expected).length;
        const accuracy = total > 0 ? (correct / total * 100) : 0;
        const avgRms  = logs.reduce((s, l) => s + parseFloat(l.rms), 0) / total;

        const user = document.getElementById('username').value;
        document.getElementById('res-username-display').innerText = user;

        // Score principal
        const accEl = document.getElementById('res-accuracy');
        accEl.innerText = accuracy.toFixed(1) + '%';
        accEl.style.color = accuracy >= 80 ? 'var(--green)' : accuracy >= 60 ? 'var(--yellow)' : 'var(--red)';

        document.getElementById('res-total').innerText   = total;
        document.getElementById('res-correct').innerText = correct;
        document.getElementById('res-rms').innerText     = avgRms.toFixed(4);

        // Grille hiragana
        const hiraganaStats = {};
        logs.forEach(l => {
            if (!hiraganaStats[l.expected]) hiraganaStats[l.expected] = { total:0, correct:0 };
            hiraganaStats[l.expected].total++;
            if (l.top1 === l.expected) hiraganaStats[l.expected].correct++;
        });

        const grid = document.getElementById('res-hiragana-grid');
        grid.innerHTML = '';
        Object.entries(hiraganaStats).sort().forEach(([key, val]) => {
            const pct   = val.correct / val.total * 100;
            const color = pct >= 80 ? 'var(--green)' : pct >= 60 ? 'var(--yellow)' : 'var(--red)';
            const cls   = pct >= 80 ? 'good' : pct >= 60 ? 'mid' : 'poor';
            const char  = r2h[key] || key;
            grid.innerHTML += `
                <div class="hira-card ${cls}">
                    <div class="hira-char">${char}</div>
                    <div class="hira-romaji">${key}</div>
                    <div class="hira-pct" style="color:${color}">${pct.toFixed(0)}%</div>
                    <div class="hira-sub">${val.correct}/${val.total}</div>
                </div>`;
        });

        // Confusions
        const confusions = {};
        const maxConf = logs.filter(l => l.top1 !== l.expected).length;

        logs.filter(l => l.top1 !== l.expected).forEach(l => {
            const key = `${l.expected}‚Üí${l.top1}`;
            confusions[key] = (confusions[key] || 0) + 1;
        });

        const sortedConf = Object.entries(confusions).sort((a,b) => b[1]-a[1]).slice(0, 4);
        const confEl = document.getElementById('res-confusions');
        confEl.innerHTML = '';

        if (sortedConf.length === 0) {
            confEl.innerHTML = `<div class="conf-empty">üéâ Aucune confusion !</div>`;
        } else {
            const topCount = sortedConf[0][1];
            sortedConf.forEach(([pair, count]) => {
                const [exp, got] = pair.split('‚Üí');
                const expH = r2h[exp] || exp;
                const gotH = r2h[got] || got;
                const barW = (count / topCount * 100).toFixed(0);
                confEl.innerHTML += `
                    <div class="conf-row">
                        <div class="conf-chars">${expH}<span style="color:var(--muted);font-size:1.2rem">‚Üí</span>${gotH}</div>
                        <div class="conf-info">
                            <div class="conf-rom">${exp} ‚Üí ${got}</div>
                        </div>
                        <div class="conf-bar-wrap">
                            <div class="conf-bar" style="width:${barW}%"></div>
                        </div>
                        <div class="conf-count">${count}√ó</div>
                    </div>`;
            });
        }
    }

    // --- EXPORT CSV ---
    function exportCSV() {
        let csv = "Horodatage,NomFichier,Attendu,Top1,Score1,Top2,Score2,RMS,Gain\n";
        logs.forEach(r => {
            csv += `${r.timestamp},${r.filename},${r.expected},${r.top1},${r.score1},${r.top2},${r.score2},${r.rms},${r.gain}\n`;
        });
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const dateStr = new Date().toISOString().slice(0,10);
        const user = document.getElementById('username').value;
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", `resultats_${user}_${dateStr}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- RESTART ---
    function restartQuiz() {
        logs = []; questionCount = 0;
        quizStopped = false; isListening = false;
        sessionBest = { label:"", score:0, label2:"", score2:0 };

        document.getElementById('results-page').classList.add('hidden');
        document.getElementById('quiz-card').style.display = 'block';
        document.getElementById('action-card').classList.remove('hidden');
        document.getElementById('log-count').innerText = '0 r√©sultat enregistr√©';

        setTimeout(nextQuestion, 500);
    }

    // --- RMS LOOP ---
    function updateRMSLoop() {
        if (analyser) {
            analyser.getFloatTimeDomainData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
            const rms = Math.sqrt(sum / dataArray.length);
            document.getElementById('rms-disp').innerText = rms.toFixed(4);
            if (isListening) { rmsSum += rms; rmsCount++; if (rms > sessionMaxRMS) sessionMaxRMS = rms; }
        }
        requestAnimationFrame(updateRMSLoop);
    }

    document.getElementById('gain-slider').oninput = (e) => {
        const val = e.target.value;
        document.getElementById('gain-val').innerText = val;
        if (gainNode) gainNode.gain.value = parseFloat(val);
    };
</script>
</body>
</html>
