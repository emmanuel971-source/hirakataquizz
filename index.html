<!DOCTYPE html>
<html>
<head>
    <title>Marathon Hiragana Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 10px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; }
        button { width: 100%; padding: 15px; margin: 5px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-start { background: #4CAF50; color: white; }
        .btn-calib { background: #2196F3; color: white; }
        .btn-stop { background: #f44336; color: white; }
        #log-container { height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #000; padding: 10px; border-radius: 5px; }
        .stat-badge { display: inline-block; padding: 5px; background: #333; margin: 2px; border-radius: 4px; font-size: 11px; }
        .progress-bg { background: #333; height: 10px; border-radius: 5px; margin: 10px 0; }
        #progress-bar { background: #4CAF50; width: 0%; height: 100%; border-radius: 5px; transition: 0.3s; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Dashboard Marathon</h2>
        <div id="stats-summary">Progression : <span id="count">0</span> / <input type="number" id="limit" value="50" style="width:50px"></div>
        <div class="progress-bg"><div id="progress-bar"></div></div>
        <div id="timer">Temps restant estimé : --:--</div>
        <div id="class-stats"></div>
    </div>

    <div class="card">
        <label>Gain Audio: <input type="range" id="gain" min="1" max="50" value="10"></label><br>
        <label>Seuil (Sensibilité): <input type="range" id="threshold" min="0" max="100" value="85"></label>
        <div id="audio-debug">Volume : 0 | Statut : Prêt</div>
    </div>

    <button class="btn-calib" onclick="toggleMode('calib')" id="btnCalib">MODE CALIBRAGE (Loop 5)</button>
    <button class="btn-start" onclick="toggleMode('marathon')" id="btnStart">LANCER LE MARATHON</button>
    <button class="btn-stop" onclick="stop()">STOP</button>

    <div id="log-container"></div>

    <script>
        const SERVER_URL = "https://VOTRE_LIEN_NGROK.ngrok-free.dev"; 
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/VOTRE_ID/";

        let recognizer;
        let isRunning = false;
        let mode = ""; // "marathon" ou "calib"
        let startTime;

        async function init() {
            const checkpointURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";
            recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
            await recognizer.ensureModelLoaded();
            log("Modèle chargé !");
        }

        async function toggleMode(m) {
            if(isRunning) return;
            mode = m;
            isRunning = true;
            startTime = Date.now();
            log("Démarrage : " + mode);
            runCycle();
        }

        async function runCycle() {
            if(!isRunning) return;

            try {
                // 1. Demander le prochain fichier
                const res = await fetch(`${SERVER_URL}/get_next`, { headers: {"ngrok-skip-browser-warning": "69"} });
                const test = await res.json();
                
                // 2. Jouer le son sur le PC
                await fetch(`${SERVER_URL}/play`, { method: 'POST' });

                // 3. Écouter sur Android
                const result = await listenOnce();

                // 4. Envoyer le log
                const logRes = await fetch(`${SERVER_URL}/log`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        expected: test.expected,
                        filename: test.filename,
                        top1: result.top1,
                        score1: result.score1,
                        top2: result.top2,
                        score2: result.score2,
                        rms: result.rms,
                        gain: document.getElementById('gain').value
                    })
                });

                const sessionData = await logRes.json();
                updateUI(sessionData);

                // Continuer ou Arrêter
                const limit = document.getElementById('limit').value;
                if(mode === "marathon" && sessionData.total >= limit) {
                    stop();
                    alert("Marathon terminé !");
                } else {
                    setTimeout(runCycle, 1500);
                }

            } catch (err) {
                log("Erreur : " + err.message);
                stop();
            }
        }

        async function listenOnce() {
            return new Promise(resolve => {
                const gain = document.getElementById('gain').value;
                const thresh = document.getElementById('threshold').value / 100;
                
                recognizer.listen(result => {
                    const scores = Array.from(result.scores);
                    const sorted = scores.map((s, i) => ({name: recognizer.wordLabels()[i], score: s}))
                                         .sort((a,b) => b.score - a.score);
                    
                    recognizer.stopListening();
                    
                    // Calcul simplifié du volume (RMS)
                    const rms = Math.max(...result.spectrogram.data); 
                    
                    resolve({
                        top1: sorted[0].score > thresh ? sorted[0].name : "---",
                        score1: Math.round(sorted[0].score * 100),
                        top2: sorted[1].name,
                        score2: Math.round(sorted[1].score * 100),
                        rms: rms.toFixed(4)
                    });
                }, { probabilityThreshold: 0.1, overlapFactor: 0, invokeCallbackOnNoiseAndUnknown: true });
            });
        }

        function updateUI(data) {
            document.getElementById('count').innerText = data.total;
            const limit = document.getElementById('limit').value;
            const percent = (data.total / limit) * 100;
            document.getElementById('progress-bar').style.width = percent + "%";

            // Estimation temps
            const elapsed = (Date.now() - startTime) / 1000;
            const secPerTest = elapsed / data.total;
            const remaining = Math.round(secPerTest * (limit - data.total));
            document.getElementById('timer').innerText = `Reste env. ${Math.floor(remaining/60)}m ${remaining%60}s`;

            // Stats par classe
            let html = "";
            for(let c in data.stats) {
                let s = data.stats[c];
                let pc = s.total > 0 ? Math.round((s.reussi/s.total)*100) : 0;
                html += `<span class="stat-badge">${c}: ${pc}% (${s.total})</span>`;
            }
            document.getElementById('class-stats').innerHTML = html;
            log(`Test ${data.total}: ${data.stats[Object.keys(data.stats)[0]].reussi} réussites`);
        }

        function log(m) {
            const c = document.getElementById('log-container');
            c.innerHTML = `> ${m}<br>` + c.innerHTML;
        }

        function stop() { isRunning = false; log("STOPPED"); }

        init();
    </script>
</body>
</html>
