
  <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labo Calibrage Gain & RMS</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #eceff1; color: #263238; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .metric { font-size: 1.2rem; margin: 10px 0; }
        .val { font-weight: bold; color: #1976d2; }
        input[type=range] { width: 80%; margin: 20px 0; cursor: pointer; }
        #vumeter { width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #vulevel { height: 100%; width: 0%; background: #4caf50; transition: width 0.1s; }
        button { padding: 15px 30px; font-size: 18px; border-radius: 10px; border: none; background: #1976d2; color: white; cursor: pointer; }
        button:disabled { background: #b0bec5; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üõ†Ô∏è Labo de Calibrage</h2>
        <p>Ajuste le gain pour que ton volume "normal" soit bien per√ßu par l'IA.</p>
        <button id="btn-start">üöÄ Initialiser le Micro & le Mod√®le</button>
    </div>

    <div class="card">
        <div class="metric">Gain Logiciel : <span id="gain-val" class="val">1.0</span>x</div>
        <input type="range" id="gain-slider" min="1" max="20" step="0.5" value="1">
        
        <div class="metric">Volume Per√ßu (RMS) : <span id="rms-val" class="val">0</span></div>
        <div id="vumeter"><div id="vulevel"></div></div>
    </div>

    <div class="card">
        <h3>R√©sultats IA (Top 2)</h3>
        <div id="result-1" class="metric" style="font-size: 1.5rem; color: #2e7d32;">1. ---</div>
        <div id="result-2" class="metric" style="color: #546e7a; font-size: 1rem;">2. ---</div>
    </div>

    <script>
        // --- REMPLACE PAR TON LIEN ---
          const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/"; 
        
        let recognizer;
        let audioContext, gainNode, source;

        async function setupAudio() {
            // Cr√©ation du contexte audio
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Acc√®s au micro
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            
            // Cr√©ation de la cha√Æne : Source -> Gain -> Destination interne
            source = audioContext.createMediaStreamSource(stream);
            gainNode = audioContext.createGain();
            gainNode.gain.value = 1.0; // Valeur par d√©faut
            
            source.connect(gainNode);
            // On ne connecte PAS gainNode aux enceintes pour √©viter l'effet Larsen (feedback)
            
            return stream;
        }

        document.getElementById('btn-start').onclick = async () => {
            const btn = document.getElementById('btn-start');
            btn.disabled = true;
            btn.innerText = "Chargement...";
            
            try {
                // 1. Setup Audio
                await setupAudio();
                if (audioContext.state === 'suspended') await audioContext.resume();

                // 2. Setup Teachable Machine
                recognizer = speechCommands.create("BROWSER_FFT", undefined, URL + "model.json", URL + "metadata.json");
                await recognizer.ensureModelLoaded();

                btn.innerText = "üî¥ Micro Actif";

                // 3. Boucle d'analyse
                const classLabels = recognizer.wordLabels();
                recognizer.listen(result => {
                    // Analyse des scores
                    const scores = Array.from(result.scores).map((s, i) => ({ label: classLabels[i], score: s }));
                    scores.sort((a, b) => b.score - a.score);

                    // Affichage des r√©sultats
                    document.getElementById('result-1').innerHTML = `1. <b>${scores[0].label}</b> (${(scores[0].score * 100).toFixed(1)}%)`;
                    document.getElementById('result-2').innerHTML = `2. ${scores[1].label} (${(scores[1].score * 100).toFixed(1)}%)`;

                    // Mesure du volume (RMS) via le spectrogramme fourni par le mod√®le
                    calculateRMS(result.spectrogram);

                }, { 
                    probabilityThreshold: 0.1, // On baisse le seuil pour voir les h√©sitations
                    includeSpectrogram: true, 
                    overlapFactor: 0.5 
                });

            } catch (err) {
                alert("Erreur : " + err.message);
                btn.disabled = false;
                btn.innerText = "R√©essayer";
            }
        };

        // Mise √† jour dynamique du gain via le slider
        document.getElementById('gain-slider').oninput = (e) => {
            const val = e.target.value;
            document.getElementById('gain-val').innerText = val;
            if (gainNode) {
                gainNode.gain.value = parseFloat(val);
            }
        };

        function calculateRMS(spectrogram) {
            const data = spectrogram.data;
            let sum = 0;
            for (let i = 0; i < data.length; i++) {
                sum += data[i] * data[i];
            }
            // Calcul de la moyenne quadratique (RMS)
            const rms = Math.sqrt(sum / data.length);
            
            // Affichage
            document.getElementById('rms-val').innerText = rms.toFixed(5);
            
            // Mise √† jour de la barre visuelle (normalis√©e pour l'affichage)
            const visualLevel = Math.min(100, rms * 200); 
            document.getElementById('vulevel').style.width = visualLevel + "%";
            
            // Couleur de la barre : change si √ßa sature
            document.getElementById('vulevel').style.background = visualLevel > 90 ? "#f44336" : "#4caf50";
        }
    </script>
</body>
</html>
