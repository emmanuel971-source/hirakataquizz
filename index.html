<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Hiragana - Chrono</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .score {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 1.5rem;
    }
    .game-area {
      background: #f5f5f5;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #kana {
      font-size: 8rem;
      margin: 1rem 0;
      color: #333;
      transition: all 0.3s;
    }
    #kana.correct {
      color: #4CAF50;
      transform: scale(1.2);
    }
    #kana.wrong {
      color: #f44336;
    }
    .timer {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 1rem 0;
    }
    .timer.warning {
      color: #ff9800;
      animation: pulse 0.5s infinite;
    }
    .timer.danger {
      color: #f44336;
      animation: pulse 0.3s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    .status {
      text-align: center;
      font-size: 1.2rem;
      color: #666;
      margin: 1rem 0;
      min-height: 2rem;
    }
    .status.listening {
      color: #4CAF50;
      font-weight: bold;
    }
    .status .indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #4CAF50;
      border-radius: 50%;
      margin-left: 8px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    button {
      width: 100%;
      font-size: 1.3rem;
      padding: 1.2rem;
      cursor: pointer;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      transition: all 0.3s;
      color: white;
    }
    #startBtn {
      background: #4CAF50;
    }
    #startBtn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }
    #startBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .feedback {
      text-align: center;
      font-size: 1.1rem;
      margin-top: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
    }
    .feedback.correct {
      background: #4CAF50;
      color: white;
    }
    .feedback.wrong {
      background: #f44336;
      color: white;
    }
    #error {
      color: #f44336;
      text-align: center;
      margin-top: 1rem;
      font-weight: bold;
    }
    #debug {
      margin-top: 1rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.75rem;
      text-align: left;
      max-height: 120px;
      overflow-y: auto;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéå Quiz Hiragana</h1>
    <div class="score">Score: <span id="score">0</span></div>
    
    <div class="game-area">
      <div id="kana">‚Äî</div>
      <div class="timer" id="timer"></div>
      <div class="status" id="status">Pr√™t √† commencer ?</div>
      <div class="feedback" id="feedback"></div>
    </div>
    
    <button id="startBtn">D√©marrer le Quiz</button>
    
    <div id="error"></div>
    <div id="debug"></div>
  </div>

<script>
  // üî• CONFIGURATION - Remplace par l'URL de ton repo GitHub
  const MP3_BASE_URL = "https://emmanuel971-source.github.io/hirakataquizz/";
  const ANSWER_TIME = 3; // Secondes pour r√©pondre

  // Elements DOM
  const startBtn = document.getElementById("startBtn");
  const kanaDiv = document.getElementById("kana");
  const timerDiv = document.getElementById("timer");
  const statusDiv = document.getElementById("status");
  const feedbackDiv = document.getElementById("feedback");
  const scoreDiv = document.getElementById("score");
  const errorDiv = document.getElementById("error");
  const debugDiv = document.getElementById("debug");

  // Variables de jeu
  let score = 0;
  let currentKana = null;
  let gameInterval = null;
  let timeLeft = 0;
  let recognition = null;
  let isListening = false;
  let hasAnswered = false;

  // Liste compl√®te des hiraganas
  const allKana = [
    // Voyelles
    "„ÅÇ", "„ÅÑ", "„ÅÜ", "„Åà", "„Åä",
    // K
    "„Åã", "„Åç", "„Åè", "„Åë", "„Åì",
    // S
    "„Åï", "„Åó", "„Åô", "„Åõ", "„Åù",
    // T
    "„Åü", "„Å°", "„Å§", "„Å¶", "„Å®",
    // N
    "„Å™", "„Å´", "„Å¨", "„Å≠", "„ÅÆ",
    // H
    "„ÅØ", "„Å≤", "„Åµ", "„Å∏", "„Åª",
    // M
    "„Åæ", "„Åø", "„ÇÄ", "„ÇÅ", "„ÇÇ",
    // Y
    "„ÇÑ", "„ÇÜ", "„Çà",
    // R
    "„Çâ", "„Çä", "„Çã", "„Çå", "„Çç",
    // W
    "„Çè", "„Çí", "„Çì",
    // G
    "„Åå", "„Åé", "„Åê", "„Åí", "„Åî",
    // Z
    "„Åñ", "„Åò", "„Åö", "„Åú", "„Åû",
    // D
    "„Å†", "„Å¢", "„Å•", "„Åß", "„Å©",
    // B
    "„Å∞", "„Å≥", "„Å∂", "„Åπ", "„Åº",
    // P
    "„Å±", "„Å¥", "„Å∑", "„Å∫", "„ÅΩ"
  ];

  // Mapping kana -> romaji possibles
  const kanaToRomaji = {
    "„ÅÇ": ["a", "ah"], "„ÅÑ": ["i", "ii"], "„ÅÜ": ["u", "uu"], "„Åà": ["e", "eh"], "„Åä": ["o", "oh"],
    "„Åã": ["ka"], "„Åç": ["ki"], "„Åè": ["ku"], "„Åë": ["ke"], "„Åì": ["ko"],
    "„Åï": ["sa"], "„Åó": ["shi", "si"], "„Åô": ["su"], "„Åõ": ["se"], "„Åù": ["so"],
    "„Åü": ["ta"], "„Å°": ["chi", "ti"], "„Å§": ["tsu", "tu"], "„Å¶": ["te"], "„Å®": ["to"],
    "„Å™": ["na"], "„Å´": ["ni"], "„Å¨": ["nu"], "„Å≠": ["ne"], "„ÅÆ": ["no"],
    "„ÅØ": ["ha"], "„Å≤": ["hi"], "„Åµ": ["fu", "hu"], "„Å∏": ["he"], "„Åª": ["ho"],
    "„Åæ": ["ma"], "„Åø": ["mi"], "„ÇÄ": ["mu"], "„ÇÅ": ["me"], "„ÇÇ": ["mo"],
    "„ÇÑ": ["ya"], "„ÇÜ": ["yu"], "„Çà": ["yo"],
    "„Çâ": ["ra", "la"], "„Çä": ["ri", "li"], "„Çã": ["ru"], "„Çå": ["re"], "„Çç": ["ro"],
    "„Çè": ["wa"], "„Çí": ["wo", "o"], "„Çì": ["n", "nn"],
    "„Åå": ["ga"], "„Åé": ["gi"], "„Åê": ["gu"], "„Åí": ["ge"], "„Åî": ["go"],
    "„Åñ": ["za"], "„Åò": ["ji", "zi"], "„Åö": ["zu"], "„Åú": ["ze"], "„Åû": ["zo"],
    "„Å†": ["da"], "„Å¢": ["di"], "„Å•": ["du"], "„Åß": ["de"], "„Å©": ["do"],
    "„Å∞": ["ba"], "„Å≥": ["bi"], "„Å∂": ["bu"], "„Åπ": ["be"], "„Åº": ["bo"],
    "„Å±": ["pa"], "„Å¥": ["pi"], "„Å∑": ["pu"], "„Å∫": ["pe"], "„ÅΩ": ["po"]
  };

  function addDebug(msg, isError = false) {
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div style="color: ${isError ? 'red' : '#333'}">[${time}] ${msg}</div>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
  }

  addDebug("Script charg√©");

  // V√©rification HTTPS
  if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
    errorDiv.textContent = "‚ö†Ô∏è HTTPS requis pour la reconnaissance vocale";
    startBtn.disabled = true;
    addDebug("HTTPS non d√©tect√©", true);
  }

  // Configuration reconnaissance vocale
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    errorDiv.textContent = "‚ùå Reconnaissance vocale non support√©e";
    startBtn.disabled = true;
    addDebug("SpeechRecognition non disponible", true);
  } else {
    addDebug("SpeechRecognition disponible ‚úì");
    
    recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.maxAlternatives = 5;

    recognition.onresult = (event) => {
      if (!currentKana || hasAnswered) return;

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const result = event.results[i];
        if (!result.isFinal) continue;

        const transcript = result[0].transcript.toLowerCase().trim();
        addDebug(`Reconnu: "${transcript}"`);

        // V√©rifier si c'est le bon kana
        if (checkAnswer(transcript)) {
          handleCorrectAnswer();
        }
      }
    };

    recognition.onerror = (event) => {
      if (event.error === "no-speech" || event.error === "aborted") return;
      addDebug(`Erreur: ${event.error}`, true);
    };

    recognition.onend = () => {
      addDebug("Reconnaissance arr√™t√©e");
      if (isListening && currentKana && !hasAnswered) {
        // Red√©marrer si le jeu est en cours
        setTimeout(() => {
          try {
            recognition.start();
            addDebug("Reconnaissance red√©marr√©e");
          } catch (e) {
            addDebug(`Erreur red√©marrage: ${e.message}`, true);
          }
        }, 100);
      }
    };
  }

  // V√©rifier la r√©ponse
  function checkAnswer(transcript) {
    if (!currentKana) return false;

    const validRomaji = kanaToRomaji[currentKana] || [];
    
    // V√©rifier correspondance directe
    for (const romaji of validRomaji) {
      if (transcript === romaji || 
          transcript === currentKana ||
          transcript.includes(romaji) ||
          transcript.includes(currentKana)) {
        return true;
      }
    }
    
    return false;
  }

  // R√©ponse correcte
  function handleCorrectAnswer() {
    if (hasAnswered) return;
    
    hasAnswered = true;
    score++;
    scoreDiv.textContent = score;
    
    kanaDiv.classList.add("correct");
    feedbackDiv.className = "feedback correct";
    feedbackDiv.textContent = "‚úì Correct !";
    
    addDebug(`Bonne r√©ponse ! Score: ${score}`);
    
    stopListening();
    
    // Continuer apr√®s 1 seconde
    setTimeout(() => {
      nextRound();
    }, 1000);
  }

  // Nouvelle manche
  function nextRound() {
    hasAnswered = false;
    feedbackDiv.className = "feedback";
    feedbackDiv.textContent = "";
    kanaDiv.classList.remove("correct", "wrong");
    
    // Choisir un kana al√©atoire
    currentKana = allKana[Math.floor(Math.random() * allKana.length)];
    kanaDiv.textContent = currentKana;
    
    addDebug(`Nouveau kana: ${currentKana}`);
    
    // D√©marrer le timer
    timeLeft = ANSWER_TIME;
    updateTimer();
    
    gameInterval = setInterval(() => {
      timeLeft--;
      updateTimer();
      
      if (timeLeft <= 0) {
        handleTimeout();
      }
    }, 1000);
    
    // D√©marrer l'√©coute
    startListening();
  }

  // Mise √† jour du timer
  function updateTimer() {
    timerDiv.textContent = `‚è±Ô∏è ${timeLeft}s`;
    
    timerDiv.className = "timer";
    if (timeLeft <= 1) {
      timerDiv.classList.add("danger");
    } else if (timeLeft <= 2) {
      timerDiv.classList.add("warning");
    }
  }

  // Timeout
  function handleTimeout() {
    clearInterval(gameInterval);
    
    if (hasAnswered) return;
    
    hasAnswered = true;
    
    kanaDiv.classList.add("wrong");
    feedbackDiv.className = "feedback wrong";
    feedbackDiv.textContent = "‚è∞ Temps √©coul√© !";
    
    addDebug("Temps √©coul√©");
    
    // Arr√™ter l'√©coute AVANT de jouer le son
    stopListening();
    
    // Jouer le MP3 de la r√©ponse
    playKanaAudio(currentKana);
    
    // Continuer apr√®s 2 secondes (le temps que l'audio se joue)
    setTimeout(() => {
      nextRound();
    }, 2000);
  }

  // Jouer l'audio d'un kana
  function playKanaAudio(kana) {
    const audioUrl = `${MP3_BASE_URL}${kana}.mp3`;
    addDebug(`Lecture audio: ${audioUrl}`);
    
    const audio = new Audio(audioUrl);
    audio.play().catch(err => {
      addDebug(`Erreur lecture: ${err.message}`, true);
    });
  }

  // D√©marrer l'√©coute
  function startListening() {
    if (!recognition || isListening) return;
    
    try {
      recognition.start();
      isListening = true;
      statusDiv.className = "status listening";
      statusDiv.innerHTML = 'üé§ En √©coute <span class="indicator"></span>';
      addDebug("√âcoute d√©marr√©e");
    } catch (e) {
      addDebug(`Erreur d√©marrage √©coute: ${e.message}`, true);
    }
  }

  // Arr√™ter l'√©coute
  function stopListening() {
    if (!recognition || !isListening) return;
    
    try {
      recognition.stop();
      isListening = false;
      statusDiv.className = "status";
      statusDiv.textContent = "";
      addDebug("√âcoute arr√™t√©e");
    } catch (e) {
      addDebug(`Erreur arr√™t √©coute: ${e.message}`, true);
    }
  }

  // D√©marrer le jeu
  startBtn.onclick = () => {
    if (currentKana) {
      // Reset du jeu
      score = 0;
      scoreDiv.textContent = score;
      clearInterval(gameInterval);
      stopListening();
    }
    
    startBtn.textContent = "Red√©marrer";
    errorDiv.textContent = "";
    
    nextRound();
  };
</script>
</body>
</html>
