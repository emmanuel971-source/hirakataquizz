   <script>
//        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
//        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";
   </script>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Hiragana - Dashboard Temps R√©el</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #1a1a2e; 
            color: #eee; 
            padding: 15px;
            font-size: 14px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .header h2 { 
            font-size: 1.5rem; 
            margin-bottom: 8px;
            color: white;
        }
        
        #status { 
            font-size: 1rem; 
            color: #fff; 
            font-weight: 600;
            margin-top: 5px;
        }
        
        .btn { 
            padding: 12px 20px; 
            font-size: 16px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            width: 100%; 
            margin: 8px 0;
            transition: transform 0.2s;
        }
        
        .btn:active { transform: scale(0.95); }
        .btn-start { background: #00e676; color: #1b5e20; }
        .btn-stop { background: #ff5252; color: white; }
        
        /* DASHBOARD STATISTIQUES PAR HIRAGANA */
        .stats-dashboard {
            background: #16213e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #0f3460;
        }
        
        .stats-dashboard h3 {
            color: #00d9ff;
            margin-bottom: 12px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 8px;
        }
        
        .hiragana-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        /* Compteur global */
        .global-counter {
            background: #0f3460;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
            border: 2px solid #1a5490;
        }
        
        .global-counter .total-tests {
            font-size: 2rem;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 5px;
        }
        
        .global-counter .total-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .global-counter .success-rate-global {
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .global-counter .success-rate-global.excellent { color: #00e676; }
        .global-counter .success-rate-global.good { color: #ffd700; }
        .global-counter .success-rate-global.poor { color: #ff5252; }
        
        .hiragana-card {
            background: #0f3460;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #1a5490;
        }
        
        .hiragana-card.excellent { border-color: #00e676; }
        .hiragana-card.good { border-color: #ffd700; }
        .hiragana-card.poor { border-color: #ff5252; }
        
        .hiragana-char {
            font-size: 2rem;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 5px;
        }
        
        .hiragana-success {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .hiragana-success.excellent { color: #00e676; }
        .hiragana-success.good { color: #ffd700; }
        .hiragana-success.poor { color: #ff5252; }
        
        .hiragana-rms {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .hiragana-tests {
            font-size: 0.8rem;
            color: #888;
            margin-top: 3px;
        }
        
        /* R√âSULTAT ACTUEL */
        .current-result {
            background: #16213e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #0f3460;
        }
        
        .current-result h3 {
            color: #ffeb3b;
            margin-bottom: 10px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .countdown { 
            font-size: 2.5rem; 
            color: #ffeb3b; 
            font-weight: bold; 
            text-align: center;
            margin: 10px 0;
        }
        
        .result-line {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #0f3460;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .result-label { color: #aaa; }
        .result-value { 
            font-weight: bold; 
            color: #fff;
        }
        
        .result-value.success { color: #00e676; }
        .result-value.warning { color: #ffd700; }
        
        /* MINI TABLEUR */
        .table-container {
            background: #16213e;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #0f3460;
        }
        
        .table-container h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 8px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #0f3460;
            z-index: 10;
        }
        
        th {
            padding: 10px 8px;
            text-align: left;
            color: #00d9ff;
            font-weight: bold;
            border-bottom: 2px solid #1a5490;
            font-size: 0.8rem;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #0f3460;
            color: #ddd;
        }
        
        tr:hover {
            background: #0f3460;
        }
        
        .row-new {
            background: #1a5490 !important;
            animation: highlight 1s ease-in-out;
        }
        
        @keyframes highlight {
            0% { background: #00e676; }
            100% { background: #1a5490; }
        }
        
        .match-success { color: #00e676; font-weight: bold; }
        .match-fail { color: #ff5252; font-weight: bold; }
        
        .score-high { color: #00e676; }
        .score-medium { color: #ffd700; }
        .score-low { color: #ff5252; }
    </style>
</head>
<body>

    <!-- HEADER AVEC CONTR√îLES -->
    <div class="header">
        <h2>üèÉ Marathon Hiragana - Dashboard</h2>
        <div id="status">Syst√®me pr√™t</div>
        <button id="btn-run" class="btn btn-start">LANCER LE MARATHON</button>
        <button id="btn-stop" class="btn btn-stop" style="display:none;">ARR√äTER</button>
    </div>

    <!-- DASHBOARD STATISTIQUES PAR HIRAGANA -->
    <div class="stats-dashboard">
        <h3>üìä Statistiques par Hiragana</h3>
        
        <!-- Compteur global -->
        <div class="global-counter">
            <div class="total-tests" id="total-tests">0</div>
            <div class="total-label">Fichiers jou√©s au total</div>
            <div class="success-rate-global" id="global-success-rate">---</div>
        </div>
        
        <div id="hiragana-grid" class="hiragana-grid">
            <div style="text-align: center; color: #888; padding: 20px; grid-column: 1 / -1;">
                Aucune donn√©e pour le moment
            </div>
        </div>
    </div>

    <!-- R√âSULTAT ACTUEL -->
    <div class="current-result">
        <h3>üé§ Test en cours</h3>
        <div id="countdown-display" class="countdown"></div>
        <div class="result-line">
            <span class="result-label">Cible :</span>
            <span id="target-label" class="result-value">---</span>
        </div>
        <div class="result-line">
            <span class="result-label">D√©tect√© (Top 1) :</span>
            <span id="detected-top1" class="result-value">---</span>
        </div>
        <div class="result-line">
            <span class="result-label">Confiance :</span>
            <span id="confidence-top1" class="result-value">---</span>
        </div>
        <div class="result-line">
            <span class="result-label">Top 2 :</span>
            <span id="detected-top2" class="result-value">---</span>
        </div>
        <div class="result-line">
            <span class="result-label">Confiance (Top 2) :</span>
            <span id="confidence-top2" class="result-value">---</span>
        </div>
        <div class="result-line">
            <span class="result-label">Gain actif :</span>
            <span id="gain-val" class="result-value success">1.0x</span>
        </div>
    </div>

    <!-- MINI TABLEUR -->
    <div class="table-container">
        <h3>üìã Historique des 10 derniers tests</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>Fichier</th>
                        <th>Attendu</th>
                        <th>Top1</th>
                        <th>Score1</th>
                        <th>Top2</th>
                        <th>Score2</th>
                        <th>RMS</th>
                        <th>Gain</th>
                    </tr>
                </thead>
                <tbody id="history-table">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #888; padding: 20px;">
                            Aucun test effectu√©
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TM_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/"; 
        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
        // ---------------------

        let recognizer;
        let audioContext, gainNode, analyser, dataArray;
        let isRunning = false;
        let currentGain = 1.0;

        async function setupAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            const source = audioContext.createMediaStreamSource(stream);
            gainNode = audioContext.createGain();
            gainNode.gain.value = currentGain;
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Float32Array(analyser.fftSize);
            source.connect(gainNode);
            gainNode.connect(analyser);
        }

        // üìä MISE √Ä JOUR DU DASHBOARD
        async function updateDashboard() {
            try {
                const response = await fetch(`${SERVER_URL}/get_session_stats`, {
                    headers: { "ngrok-skip-browser-warning": "69420" }
                });
                const data = await response.json();

                // Mise √† jour du compteur global
                const totalTests = data.total_tests;
                document.getElementById('total-tests').innerText = totalTests;
                
                // Calculer le taux de r√©ussite global
                let totalSuccess = 0;
                let totalCount = 0;
                
                for (const [hiragana, info] of Object.entries(data.hiragana_stats)) {
                    totalSuccess += (info.success_rate * info.total_tests) / 100;
                    totalCount += info.total_tests;
                }
                
                const globalSuccessRate = totalCount > 0 ? (totalSuccess / totalCount * 100).toFixed(1) : 0;
                const globalRateElem = document.getElementById('global-success-rate');
                globalRateElem.innerText = totalCount > 0 ? `Taux de r√©ussite global : ${globalSuccessRate}%` : '---';
                
                // Coloration du taux global
                globalRateElem.className = 'success-rate-global';
                if (globalSuccessRate >= 80) globalRateElem.classList.add('excellent');
                else if (globalSuccessRate >= 60) globalRateElem.classList.add('good');
                else if (totalCount > 0) globalRateElem.classList.add('poor');

                // Mise √† jour des stats par hiragana
                const grid = document.getElementById('hiragana-grid');
                const stats = data.hiragana_stats;

                if (Object.keys(stats).length === 0) {
                    grid.innerHTML = '<div style="text-align: center; color: #888; padding: 20px; grid-column: 1 / -1;">Aucune donn√©e pour le moment</div>';
                } else {
                    grid.innerHTML = '';
                    for (const [hiragana, info] of Object.entries(stats)) {
                        const card = document.createElement('div');
                        card.className = 'hiragana-card';
                        
                        // Couleur selon taux de r√©ussite
                        let rateClass = 'poor';
                        if (info.success_rate >= 80) rateClass = 'excellent';
                        else if (info.success_rate >= 60) rateClass = 'good';
                        
                        card.classList.add(rateClass);
                        
                        card.innerHTML = `
                            <div class="hiragana-char">${hiragana}</div>
                            <div class="hiragana-success ${rateClass}">${info.success_rate}%</div>
                            <div class="hiragana-rms">RMS moy: ${info.avg_rms}</div>
                            <div class="hiragana-tests">${info.total_tests} tests</div>
                        `;
                        
                        grid.appendChild(card);
                    }
                }

                // Mise √† jour du tableau historique
                const tbody = document.getElementById('history-table');
                const tests = data.last_10_tests;

                if (tests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #888; padding: 20px;">Aucun test effectu√©</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    tests.forEach((test, index) => {
                        const row = document.createElement('tr');
                        if (index === 0) row.className = 'row-new'; // Highlight derni√®re ligne
                        
                        const time = test.timestamp.split(' ')[1]; // Garder que l'heure
                        const matchClass = test.top1 === test.expected ? 'match-success' : 'match-fail';
                        
                        const scoreClass1 = test.score1 >= 80 ? 'score-high' : (test.score1 >= 60 ? 'score-medium' : 'score-low');
                        const scoreClass2 = test.score2 >= 80 ? 'score-high' : (test.score2 >= 60 ? 'score-medium' : 'score-low');
                        
                        row.innerHTML = `
                            <td>${time}</td>
                            <td style="font-size: 0.75rem;">${test.filename}</td>
                            <td><strong>${test.expected}</strong></td>
                            <td class="${matchClass}">${test.top1}</td>
                            <td class="${scoreClass1}">${test.score1}%</td>
                            <td>${test.top2}</td>
                            <td class="${scoreClass2}">${test.score2}%</td>
                            <td>${test.rms}</td>
                            <td>${test.gain}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }

            } catch (err) {
                console.error("Erreur mise √† jour dashboard:", err);
            }
        }

        async function runCycle() {
            if (!isRunning) return;

            const status = document.getElementById('status');
            const targetLabel = document.getElementById('target-label');
            const countdownDisp = document.getElementById('countdown-display');
            const detectedTop1 = document.getElementById('detected-top1');
            const confidenceTop1 = document.getElementById('confidence-top1');
            const detectedTop2 = document.getElementById('detected-top2');
            const confidenceTop2 = document.getElementById('confidence-top2');

            try {
                // 1. Demander au PC quel est le prochain test
                status.innerText = "Attente du PC...";
                const response = await fetch(`${SERVER_URL}/get_next`, {
                    headers: { "ngrok-skip-browser-warning": "69420" }
                });
                const config = await response.json();
                
                targetLabel.innerText = config.expected;
                detectedTop1.innerText = "---";
                confidenceTop1.innerText = "---";
                detectedTop2.innerText = "---";
                confidenceTop2.innerText = "---";
                
                // 2. Compte √† rebours synchro
                let timeLeft = config.countdown / 1000;
                countdownDisp.innerText = timeLeft;
                
                const timer = setInterval(() => {
                    timeLeft--;
                    countdownDisp.innerText = timeLeft > 0 ? timeLeft : "üé§";
                    if (timeLeft <= 0) clearInterval(timer);
                }, 1000);

                // 3. Pr√©parer la capture du meilleur score sur 3s
                let tempBest = { label1: "---", score1: 0, label2: "---", score2: 0 };
                let maxRMS = 0;

                // On pr√©vient le PC qu'on commence
                fetch(`${SERVER_URL}/play`, { method: 'POST' });

                // 4. Lancement de l'√©coute pendant 3 secondes
                const labels = recognizer.wordLabels();
                recognizer.listen(result => {
                    // Calcul RMS
                    analyser.getFloatTimeDomainData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
                    let rms = Math.sqrt(sum / dataArray.length);
                    if (rms > maxRMS) maxRMS = rms;

                    const scores = Array.from(result.scores).map((s, i) => ({ label: labels[i], score: s }));
                    scores.sort((a, b) => b.score - a.score);

                    if (scores[0].score > tempBest.score1) {
                        tempBest = {
                            label1: scores[0].label, score1: scores[0].score,
                            label2: scores[1].label, score2: scores[1].score
                        };
                        
                        // Mise √† jour temps r√©el du r√©sultat actuel
                        detectedTop1.innerText = tempBest.label1;
                        confidenceTop1.innerText = `${(tempBest.score1 * 100).toFixed(1)}%`;
                        detectedTop2.innerText = tempBest.label2;
                        confidenceTop2.innerText = `${(tempBest.score2 * 100).toFixed(1)}%`;
                        
                        // Coloration selon match
                        if (tempBest.label1 === config.expected) {
                            detectedTop1.className = 'result-value success';
                        } else {
                            detectedTop1.className = 'result-value warning';
                        }
                    }
                }, { probabilityThreshold: 0.05, overlapFactor: 0.5 });

                await new Promise(r => setTimeout(r, 3000));
                await recognizer.stopListening();

                // 5. Envoyer le r√©sultat final au PC
                status.innerText = "Envoi du r√©sultat...";
                await fetch(`${SERVER_URL}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: config.filename,
                        expected: config.expected,
                        top1: tempBest.label1,
                        score1: (tempBest.score1 * 100).toFixed(1),
                        top2: tempBest.label2,
                        score2: (tempBest.score2 * 100).toFixed(1),
                        rms: maxRMS.toFixed(5),
                        gain: currentGain
                    })
                });

                // 6. Mettre √† jour le dashboard apr√®s chaque test
                await updateDashboard();
                
                // 7. Petit repos et on recommence
                if (isRunning) {
                    status.innerText = "Repos...";
                    countdownDisp.innerText = "";
                    await new Promise(r => setTimeout(r, 1000));
                    runCycle();
                }

           } catch (err) {
                status.innerText = "Erreur : " + err.message;
                console.error(err);
                isRunning = false;
            }
        }

        document.getElementById('btn-run').onclick = async () => {
            document.getElementById('btn-run').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'block';
            isRunning = true;
            
            document.getElementById('status').innerText = "Initialisation...";
            await setupAudio();
            recognizer = speechCommands.create("BROWSER_FFT", undefined, TM_URL + "model.json", TM_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            
            runCycle();
        };

        document.getElementById('btn-stop').onclick = () => {
            isRunning = false;
            location.reload();
        };
    </script>
</body>
</html>





