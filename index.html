<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Reconnaissance Hiragana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      border: 2px solid #333;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      border-color: #999;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.98);
    }
    #kana {
      font-size: 4rem;
      margin-top: 1.5rem;
      min-height: 5rem;
    }
    #raw {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    #error {
      margin-top: 1rem;
      color: red;
      font-size: 1rem;
      padding: 0.5rem;
    }
    #debug {
      margin-top: 2rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.85rem;
      text-align: left;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Prononce un hiragana</h1>
  <p>Conseil : dis "C'est [hiragana]" comme "C'est ka" pour une meilleure reconnaissance.</p>
  <button id="mic">Parler</button>
  <div id="kana">â€”</div>
  <div id="raw"></div>
  <div id="error"></div>
  <div id="debug"></div>

<script>
  const micBtn = document.getElementById("mic");
  const kanaDiv = document.getElementById("kana");
  const rawDiv = document.getElementById("raw");
  const errorDiv = document.getElementById("error");
  const debugDiv = document.getElementById("debug");

  // Fonction de debug
  function addDebug(msg, isError = false) {
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div style="color: ${isError ? 'red' : '#333'}">[${time}] ${msg}</div>`;
  }

  addDebug("Script chargÃ©");
  addDebug(`URL: ${window.location.href}`);
  addDebug(`Protocol: ${window.location.protocol}`);

  // VÃ©rification HTTPS (requis sur mobile)
  if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
    errorDiv.textContent = "âš ï¸ HTTPS requis pour la reconnaissance vocale sur mobile";
    micBtn.disabled = true;
    addDebug("HTTPS non dÃ©tectÃ© - reconnaissance vocale impossible", true);
  }

  // VÃ©rification du support de la reconnaissance vocale
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    errorDiv.textContent = "âŒ Reconnaissance vocale non supportÃ©e par votre navigateur";
    micBtn.disabled = true;
    addDebug("SpeechRecognition non disponible", true);
  } else {
    addDebug("SpeechRecognition disponible âœ“", false);
    
    const recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    addDebug("Objet recognition crÃ©Ã©");

    // Mapping Ã©tendu avec variantes courantes
    const kanaMap = {
      "a": "ã‚", "i": "ã„", "u": "ã†", "e": "ãˆ", "o": "ãŠ",
      "ka": "ã‹", "ki": "ã", "ku": "ã", "ke": "ã‘", "ko": "ã“",
      "sa": "ã•", "shi": "ã—", "si": "ã—",
      "su": "ã™", "se": "ã›", "so": "ã",
      "ta": "ãŸ", "chi": "ã¡", "ti": "ã¡",
      "tsu": "ã¤", "tu": "ã¤",
      "te": "ã¦", "to": "ã¨",
      "na": "ãª", "ni": "ã«", "nu": "ã¬", "ne": "ã­", "no": "ã®",
      "ha": "ã¯", "hi": "ã²", "fu": "ãµ", "hu": "ãµ",
      "he": "ã¸", "ho": "ã»",
      "ma": "ã¾", "mi": "ã¿", "mu": "ã‚€", "me": "ã‚", "mo": "ã‚‚",
      "ya": "ã‚„", "yu": "ã‚†", "yo": "ã‚ˆ",
      "ra": "ã‚‰", "ri": "ã‚Š", "ru": "ã‚‹", "re": "ã‚Œ", "ro": "ã‚",
      "wa": "ã‚", "wo": "ã‚’",
      "n": "ã‚“",
      "ji": "ã˜", "zi": "ã˜",
      "ga": "ãŒ", "gi": "ãŽ", "gu": "ã", "ge": "ã’", "go": "ã”",
      "za": "ã–", "zu": "ãš", "ze": "ãœ", "zo": "ãž",
      "da": "ã ", "de": "ã§", "do": "ã©",
      "ba": "ã°", "bi": "ã³", "bu": "ã¶", "be": "ã¹", "bo": "ã¼",
      "pa": "ã±", "pi": "ã´", "pu": "ã·", "pe": "ãº", "po": "ã½"
    };

    micBtn.onclick = () => {
      addDebug("Bouton cliquÃ©");
      kanaDiv.textContent = "ðŸŽ§ Ã‰coute...";
      rawDiv.textContent = "";
      errorDiv.textContent = "";
      micBtn.disabled = true;
      micBtn.textContent = "Ã‰coute en cours...";
      
      try {
        addDebug("Tentative de dÃ©marrage de la reconnaissance");
        recognition.start();
        addDebug("recognition.start() appelÃ©");
      } catch (e) {
        addDebug(`Erreur au dÃ©marrage: ${e.message}`, true);
        errorDiv.textContent = `Erreur: ${e.message}`;
        micBtn.disabled = false;
        micBtn.textContent = "Parler";
      }
    };

    recognition.onstart = () => {
      addDebug("Reconnaissance dÃ©marrÃ©e âœ“");
    };

    recognition.onresult = (event) => {
      addDebug("RÃ©sultat reÃ§u");
      const said = event.results[0][0].transcript.toLowerCase().trim();
      const confidence = event.results[0][0].confidence;

      addDebug(`Transcript: "${said}", Confiance: ${(confidence * 100).toFixed(0)}%`);

      rawDiv.textContent = `Reconnu : "${said}" (confiance : ${(confidence * 100).toFixed(0)}%)`;

      if (confidence < 0.3) {
        kanaDiv.textContent = "â“ Confiance trop faible";
        addDebug("Confiance insuffisante");
        return;
      }

      let found = false;
      for (const [romaji, char] of Object.entries(kanaMap)) {
        if (
          said === romaji ||
          said === `c'est ${romaji}` ||
          said === `sÃ© ${romaji}` ||
          said === `${romaji} desu` ||
          said === `hiragana ${romaji}` ||
          said.endsWith(romaji)
        ) {
          kanaDiv.textContent = char;
          found = true;
          addDebug(`Match trouvÃ©: ${romaji} â†’ ${char}`, false);
          break;
        }
      }

      if (!found) {
        kanaDiv.textContent = "â“ Pas reconnu";
        addDebug("Aucune correspondance trouvÃ©e");
      }
    };

    recognition.onerror = (event) => {
      addDebug(`Erreur: ${event.error}`, true);
      let message = "";
      switch (event.error) {
        case "no-speech":
          message = "Aucun son dÃ©tectÃ©. Parlez plus fort.";
          break;
        case "audio-capture":
          message = "ProblÃ¨me avec le micro. VÃ©rifiez qu'il est autorisÃ©.";
          break;
        case "not-allowed":
          message = "AccÃ¨s au micro refusÃ©. Autorisez-le dans les paramÃ¨tres.";
          break;
        case "service-not-allowed":
          message = "Service de reconnaissance non autorisÃ©.";
          break;
        case "network":
          message = "ProblÃ¨me de rÃ©seau.";
          break;
        case "aborted":
          message = "Reconnaissance interrompue.";
          break;
        case "language-not-supported":
          message = "Langue japonaise non supportÃ©e.";
          break;
        default:
          message = `Erreur : ${event.error}`;
      }
      errorDiv.textContent = `âŒ ${message}`;
      kanaDiv.textContent = "â€”";
    };

    recognition.onend = () => {
      addDebug("Reconnaissance terminÃ©e");
      micBtn.disabled = false;
      micBtn.textContent = "Parler";
    };
  }
</script>
</body>
</html>
