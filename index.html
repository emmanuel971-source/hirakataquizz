<script>
        // --- REMPLACE PAR TON LIEN ---
      //    const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/"; 
</script>        
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labo Calibrage v3 - Pr√©cision</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 15px; background: #f0f2f5; color: #1c1e21; font-size: 14px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .val { font-weight: bold; color: #007bff; }
        #vumeter { width: 100%; height: 12px; background: #e0e0e0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        #vulevel { height: 100%; width: 0%; background: #4caf50; transition: width 0.05s; }
        input[type=range] { width: 90%; margin: 10px 0; }
        .btn { padding: 12px 20px; font-size: 14px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn:disabled { background: #b0bec5; }
        
        #log-container { text-align: left; max-height: 200px; overflow-y: auto; font-size: 12px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .log-entry { border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h3>üõ†Ô∏è Calibrage & Mesure</h3>
        <button id="btn-start" class="btn btn-blue">1. Initialiser Syst√®me</button>
        <button id="btn-shot" class="btn btn-green" disabled>2. Analyse 3s (Coup par coup)</button>
    </div>

    <div class="card">
        <div>Gain Logiciel : <span id="gain-display" class="val">1.0</span>x</div>
        <input type="range" id="gain-slider" min="0.2" max="10" step="0.1" value="1">
        
        <div>Volume Micro (RMS) : <span id="rms-display" class="val">0.0000</span></div>
        <div id="vumeter"><div id="vulevel"></div></div>
    </div>

    <div class="card">
        <h4>D√©tection Temps R√©el (>90%)</h4>
        <div id="res-1" style="font-size: 1.6rem; color: #28a745; min-height: 40px;">En attente...</div>
        <div id="res-2" style="font-size: 1rem; color: #6c757d; min-height: 20px;">---</div>
    </div>

    <div class="card">
        <h4>Journal (Mode Coup par coup)</h4>
        <div id="log-container">Les r√©sultats s'afficheront ici...</div>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/";
        
        let audioContext, gainNode, analyser, dataArray;
        let recognizer;
        let isListening = false;
        let logCount = 0;
        let maxRMSInShot = 0;

        async function init() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });

            const source = audioContext.createMediaStreamSource(stream);
            gainNode = audioContext.createGain();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Float32Array(analyser.fftSize);

            source.connect(gainNode);
            gainNode.connect(analyser);

            recognizer = speechCommands.create("BROWSER_FFT", undefined, URL + "model.json", URL + "metadata.json");
            await recognizer.ensureModelLoaded();

            document.getElementById('btn-shot').disabled = false;
            updateLoop();
            startContinuousListen();
        }

        function startContinuousListen() {
            const labels = recognizer.wordLabels();
            recognizer.listen(result => {
                const scores = Array.from(result.scores).map((s, i) => ({ label: labels[i], score: s }));
                scores.sort((a, b) => b.score - a.score);

                const res1 = document.getElementById('res-1');
                const res2 = document.getElementById('res-2');

                // Filtre 90%
                if (scores[0].score > 0.90) {
                    res1.innerHTML = `<b>${scores[0].label}</b> (${(scores[0].score * 100).toFixed(1)}%)`;
                    res2.innerHTML = `2. ${scores[1].label} (${(scores[1].score * 100).toFixed(1)}%)`;
                } else {
                    res1.innerHTML = "<span style='color:#ccc'>Silence</span>";
                    res2.innerHTML = "---";
                }
            }, { probabilityThreshold: 0.1, overlapFactor: 0.5 });
        }

        // Boucle de mesure RMS
        function updateLoop() {
            analyser.getFloatTimeDomainData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i] * dataArray[i];
            }
            let rms = Math.sqrt(sum / dataArray.length);
            
            // On suit le RMS max si on est en mode "Coup par coup"
            if (rms > maxRMSInShot) maxRMSInShot = rms;

            document.getElementById('rms-display').innerText = rms.toFixed(5);
            let barWidth = Math.min(100, rms * 500); 
            document.getElementById('vulevel').style.width = barWidth + "%";
            
            requestAnimationFrame(updateLoop);
        }

        // Mode Coup par Coup (3 secondes)
        document.getElementById('btn-shot').onclick = async () => {
            const btn = document.getElementById('btn-shot');
            const logContainer = document.getElementById('log-container');
            if (logCount === 0) logContainer.innerHTML = "";
            
            btn.disabled = true;
            btn.innerText = "√âcoute (3s)...";
            maxRMSInShot = 0;
            
            let bestInShot = { label: "Aucun", score: 0, label2: "---", score2: 0 };
            const labels = recognizer.wordLabels();

            // On utilise les r√©sultats du listener d√©j√† actif pour trouver le meilleur sur 3s
            const interval = setInterval(() => {
                // Cette partie est g√©r√©e via les scores globaux, 
                // mais pour le coup par coup on va capturer la meilleure frame
            }, 100);

            // Petit hack : on capture le meilleur r√©sultat affich√© pendant 3s
            const captureBest = (result) => {
                 // TM met √† jour automatiquement, on surveille pendant 3s
            };

            await new Promise(r => setTimeout(r, 3000));
            
            // R√©cup√©ration des derni√®res valeurs de l'interface (les meilleures du moment)
            const top1Label = document.getElementById('res-1').innerText;
            const top2Label = document.getElementById('res-2').innerText;

            logCount++;
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<b>#${logCount}</b> [${time}] | Gain: ${gainNode.gain.value}x | <b>RMS Max: ${maxRMSInShot.toFixed(4)}</b><br>
                               Result: ${top1Label} | ${top2Label}`;
            
            logContainer.prepend(entry);
            
            btn.disabled = false;
            btn.innerText = "2. Analyse 3s (Coup par coup)";
        };

        document.getElementById('btn-start').onclick = () => {
            init();
            document.getElementById('btn-start').disabled = true;
        };

        document.getElementById('gain-slider').oninput = (e) => {
            const val = e.target.value;
            document.getElementById('gain-display').innerText = val;
            if (gainNode) gainNode.gain.value = parseFloat(val);
        };
    </script>
</body>
</html>
