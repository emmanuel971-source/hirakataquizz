// ... (le haut du script reste le mÃªme)

const MODEL_PATH = "model.tar.gz";  // â† Mets ici le nom exact de ton fichier .tar.gz

async function initVosk() {
  if (model) return;
  try {
    addDebug("Tentative de chargement du modÃ¨le : " + MODEL_PATH);
    statusDiv.textContent = "Chargement du modÃ¨le japonais (~48 Mo)... Patience !";
    model = await Vosk.createModel(MODEL_PATH);
    addDebug("ModÃ¨le chargÃ© avec succÃ¨s âœ“");

    recognizer = new model.KaldiRecognizer(16000);
    recognizer.setMaxAlternatives(3);

    recognizer.on("partialresult", (msg) => {
      const partial = msg.result?.text?.trim() || "";
      if (partial) {
        statusDiv.textContent = `En live : ${partial}`;
        addHeard(`Partial â†’ ${partial}`, false, true);
      }
    });

    recognizer.on("result", (msg) => {
      const text = msg.result?.text?.trim() || "";
      if (text) {
        addDebug(`Final : "${text}"`);
        addHeard(`Final â†’ ${text}`, true);
        processKanaResult(text);
      }
    });

    statusDiv.textContent = "PrÃªt ! Prononce des kana...";
  } catch (err) {
    addDebug("Erreur Vosk : " + err.message + " (vÃ©rifie chemin + serveur local)", true);
    statusDiv.innerHTML = '<span class="error">Ã‰chec chargement â€“ voir debug (404 ? chemin ?)</span>';
  }
}

async function startListening() {
  try {
    await initVosk();
    if (!recognizer) {
      addDebug("Recognizer pas prÃªt â€“ recharge page aprÃ¨s fix", true);
      return;
    }

    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });

    const source = audioContext.createMediaStreamSource(mediaStream);
    const node = recognizer.createAudioNode(audioContext);

    source.connect(node);
    node.connect(audioContext.destination);

    // Pas de recognizer.start() â€“ la lib commence auto sur audio input
    addDebug("Micro ouvert + Vosk en Ã©coute");
    statusDiv.textContent = "ðŸŽ¤ Ã‰coute active â€“ parle lentement/clairement";
    toggleBtn.textContent = "ArrÃªter";
    toggleBtn.classList.add("listening");
    isListening = true;
  } catch (err) {
    addDebug("Erreur start : " + err.message, true);
  }
}

// stopListening reste pareil

// ... (processKanaResult reste pareil, il affiche le hiragana directement)
