<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Quiz - Smartphone Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1c2c; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .container {
            background: white; border-radius: 20px; padding: 20px;
            max-width: 450px; width: 100%; text-align: center;
        }
        .target-char { font-size: 100px; font-weight: bold; color: #2d3436; line-height: 1.1; }
        
        .debug-panel {
            background: #222; color: #0f0; font-family: monospace;
            padding: 10px; border-radius: 8px; margin: 15px 0; font-size: 14px;
            text-align: left; border-left: 4px solid #444;
        }
        .bar-container { background: #444; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .bar-fill { background: #0f0; height: 100%; width: 0%; transition: width 0.1s; }

        canvas { width: 100%; height: 60px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; }

        .status { padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; min-height: 45px;}
        .success { background: #d4edda; color: #155724; }
        
        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn-main { background: #667eea; color: white; }
        .btn-next { background: #eee; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; font-weight: bold;">
        <span>Score: <span id="score">0</span></span>
        <span>Question: <span id="qCount">0</span></span>
    </div>

    <div id="targetDisplay" class="target-char">?</div>
    
    <div class="debug-panel">
        <div>Analyse : <span id="bestLabel">---</span></div>
        <div id="bestScoreText">Confiance : 0%</div>
        <div class="bar-container"><div id="scoreBar" class="bar-fill"></div></div>
    </div>

    <div id="status" class="status">Chargement...</div>

    <canvas id="vizCanvas"></canvas>

    <button id="actionBtn" class="btn-main" disabled>DÉMARRER</button>
    <button id="skipBtn" class="btn-next" style="display:none">PASSER À LA SUIVANTE</button>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/";
    const HIRAGANAS = ['あ', 'い', 'う', 'え', 'お'];

    let recognizer;
    let currentTarget = "";
    let score = 0;
    let questionCount = 0;
    let isTransitioning = false;

    async function init() {
        try {
            // Utilisation de la méthode native sans fioritures
            recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Sensei prêt !";
            document.getElementById('actionBtn').disabled = false;
        } catch (e) { 
            document.getElementById('status').innerText = "Erreur : " + e.message; 
        }
    }

    async function startQuiz() {
        document.getElementById('actionBtn').style.display = "none";
        document.getElementById('skipBtn').style.display = "block";
        
        try {
            // On laisse Teachable Machine ouvrir le micro elle-même
            // avec ses propres paramètres internes (souvent plus stables)
            await recognizer.listen(result => {
                if (isTransitioning) return;

                const labels = recognizer.wordLabels();
                let maxScore = 0;
                let winner = "";

                for (let i = 0; i < labels.length; i++) {
                    if (result.scores[i] > maxScore) {
                        maxScore = result.scores[i];
                        winner = labels[i];
                    }
                }

                // Affichage Debug
                document.getElementById('bestLabel').innerText = winner;
                const pct = Math.round(maxScore * 100);
                document.getElementById('bestScoreText').innerText = `Confiance : ${pct}%`;
                document.getElementById('scoreBar').style.width = pct + "%";

                // SI LE SCORE EST TOUJOURS À 100% SANS RIEN DIRE : 
                // C'est un problème de buffer circulaire du téléphone.
                if (winner === currentTarget && maxScore > 0.50) { 
                    handleWin();
                }
            }, { 
                probabilityThreshold: 0.7, 
                overlapFactor: 0.5,
                includeSpectrogram: true,
                invokeCallbackOnNoiseAndUnknown: true 
            });

            nextQuestion();
        } catch (err) {
            alert("Accès micro refusé ou impossible : " + err.message);
        }
    }

    function nextQuestion() {
        isTransitioning = false;
        questionCount++;
        document.getElementById('qCount').innerText = questionCount;
        currentTarget = HIRAGANAS[Math.floor(Math.random() * HIRAGANAS.length)];
        document.getElementById('targetDisplay').innerText = currentTarget;
        document.getElementById('status').innerText = "Dites le son...";
        document.getElementById('status').className = "status";
    }

    function handleWin() {
        isTransitioning = true;
        score++;
        document.getElementById('score').innerText = score;
        document.getElementById('status').innerText = "CORRECT !";
        document.getElementById('status').className = "status success";
        setTimeout(nextQuestion, 1500);
    }

    document.getElementById('actionBtn').onclick = startQuiz;
    document.getElementById('skipBtn').onclick = nextQuestion;
    init();
    
</script>
</body>
</html>

