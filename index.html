<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Quiz - Debug Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1c2c; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .container {
            background: white; border-radius: 20px; padding: 20px;
            max-width: 450px; width: 100%; text-align: center;
        }
        .target-char { font-size: 100px; font-weight: bold; color: #2d3436; line-height: 1.1; }
        
        /* Moniteur de Debug */
        .debug-panel {
            background: #222; color: #0f0; font-family: monospace;
            padding: 10px; border-radius: 8px; margin: 15px 0; font-size: 14px;
            text-align: left; border-left: 4px solid #444;
        }
        .bar-container { background: #444; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .bar-fill { background: #0f0; height: 100%; width: 0%; transition: width 0.1s; }

        canvas { width: 100%; height: 60px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; }

        .status { padding: 12px; border-radius: 10px; margin: 10px 0; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        
        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn-main { background: #667eea; color: white; }
        .btn-next { background: #eee; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; font-weight: bold;">
        <span>Score: <span id="score">0</span></span>
        <span>Question: <span id="qCount">0</span></span>
    </div>

    <div id="targetDisplay" class="target-char">?</div>
    
    <div class="debug-panel">
        <div>Analyse : <span id="bestLabel">---</span></div>
        <div id="bestScoreText">Confiance : 0%</div>
        <div class="bar-container"><div id="scoreBar" class="bar-fill"></div></div>
    </div>

    <div id="status" class="status">Chargement...</div>

    <canvas id="vizCanvas"></canvas>

    <button id="actionBtn" class="btn-main" disabled>DÉMARRER</button>
    <button id="skipBtn" class="btn-next" style="display:none">PASSER À LA SUIVANTE</button>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/ppaw5UWx4/";
    const HIRAGANAS = ['あ', 'い', 'う', 'え', 'お'];

    let recognizer;
    let currentTarget = "";
    let score = 0;
    let questionCount = 0;
    let analyser, dataArray, animationId;

    async function init() {
        try {
            recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Sensei prêt !";
            document.getElementById('actionBtn').disabled = false;
        } catch (e) { document.getElementById('status').innerText = "Erreur chargement."; }
    }

    async function startQuiz() {
        document.getElementById('actionBtn').style.display = "none";
        document.getElementById('skipBtn').style.display = "block";
        
        // Setup Visualisation (Oscilloscope)
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        draw();

        await recognizer.listen(result => {
            const labels = recognizer.wordLabels();
            let maxScore = 0;
            let winner = "";

            for (let i = 0; i < labels.length; i++) {
                if (result.scores[i] > maxScore) {
                    maxScore = result.scores[i];
                    winner = labels[i];
                }
            }

            // Mise à jour Debug
            document.getElementById('bestLabel').innerText = winner;
            const pct = Math.round(maxScore * 100);
            document.getElementById('bestScoreText').innerText = `Confiance : ${pct}%`;
            document.getElementById('scoreBar').style.width = pct + "%";

            // Vérification si correct
            if (winner === currentTarget && maxScore > 0.25) {
                handleWin();
            }
        }, { probabilityThreshold: 0.7, overlapFactor: 0.5 });

        nextQuestion();
    }

    function nextQuestion() {
        questionCount++;
        document.getElementById('qCount').innerText = questionCount;
        currentTarget = HIRAGANAS[Math.floor(Math.random() * HIRAGANAS.length)];
        document.getElementById('targetDisplay').innerText = currentTarget;
        document.getElementById('status').innerText = "Je vous écoute...";
        document.getElementById('status').className = "status";
    }

    function handleWin() {
        score++;
        document.getElementById('score').innerText = score;
        document.getElementById('status').innerText = "BIEN VU !";
        document.getElementById('status').className = "status success";
        // On attend un peu avant de passer automatiquement pour laisser le temps de voir
        setTimeout(nextQuestion, 1500);
    }

    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#667eea';
        ctx.beginPath();
        const sliceWidth = canvas.width / dataArray.length;
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * canvas.height / 2;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            x += sliceWidth;
        }
        ctx.stroke();
    }

    document.getElementById('actionBtn').onclick = startQuiz;
    document.getElementById('skipBtn').onclick = nextQuestion;
    init();
</script>
</body>
</html>
