<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Reconnaissance Hiragana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 2rem;
    }
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #kana {
      font-size: 4rem;
      margin-top: 1.5rem;
    }
    #raw {
      margin-top: 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    #error {
      margin-top: 1rem;
      color: red;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Prononce un hiragana</h1>
  <p>Conseil : dis "C'est [hiragana]" comme "C'est ka" pour une meilleure reconnaissance.</p>
  <button id="mic">Parler</button>
  <div id="kana">â€”</div>
  <div id="raw"></div>
  <div id="error"></div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("La reconnaissance vocale n'est pas supportÃ©e par votre navigateur. Essayez Chrome ou un navigateur compatible.");
    document.getElementById("mic").disabled = true;
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.continuous = false;
  recognition.interimResults = false;

  // Mapping Ã©tendu avec variantes courantes (aliases pour confusions frÃ©quentes)
  const kanaMap = {
    "a": "ã‚", "i": "ã„", "u": "ã†", "e": "ãˆ", "o": "ãŠ",
    "ka": "ã‹", "ki": "ã", "ku": "ã", "ke": "ã‘", "ko": "ã“",
    "sa": "ã•", "shi": "ã—", "si": "ã—", // variante si/shi
    "su": "ã™", "se": "ã›", "so": "ã",
    "ta": "ãŸ", "chi": "ã¡", "ti": "ã¡", // variante ti/chi
    "tsu": "ã¤", "tu": "ã¤", // variante tu/tsu (rare mais possible)
    "te": "ã¦", "to": "ã¨",
    "na": "ãª", "ni": "ã«", "nu": "ã¬", "ne": "ã­", "no": "ã®",
    "ha": "ã¯", "hi": "ã²", "fu": "ãµ", "hu": "ãµ", // fu/hu
    "he": "ã¸", "ho": "ã»",
    "ma": "ã¾", "mi": "ã¿", "mu": "ã‚€", "me": "ã‚", "mo": "ã‚‚",
    "ya": "ã‚„", "yu": "ã‚†", "yo": "ã‚ˆ",
    "ra": "ã‚‰", "ri": "ã‚Š", "ru": "ã‚‹", "re": "ã‚Œ", "ro": "ã‚",
    "wa": "ã‚", "wo": "ã‚’",
    "n": "ã‚“",
    "ji": "ã˜", "zi": "ã˜" // ji/zi
  };

  const micBtn = document.getElementById("mic");
  const kanaDiv = document.getElementById("kana");
  const rawDiv = document.getElementById("raw");
  const errorDiv = document.getElementById("error");

  micBtn.onclick = () => {
    kanaDiv.textContent = "ðŸŽ§ Ã‰coute...";
    rawDiv.textContent = "";
    errorDiv.textContent = "";
    micBtn.disabled = true;
    micBtn.textContent = "Ã‰coute en cours...";
    recognition.start();
  };

  recognition.onresult = (event) => {
    const said = event.results[0][0].transcript.toLowerCase().trim();
    const confidence = event.results[0][0].confidence;

    // Affichage du texte brut avec score de confiance
    rawDiv.textContent = `Reconnu : "${said}" (confiance : ${(confidence * 100).toFixed(0)}%)`;

    // Seulement si confiance > 50% (ajustable)
    if (confidence < 0.5) {
      kanaDiv.textContent = "â“ Confiance trop faible";
      return;
    }

    // Recherche de correspondance exacte, avec ou sans prÃ©fixe
    let found = false;
    for (const [romaji, char] of Object.entries(kanaMap)) {
      if (
        said === romaji ||
        said === `c'est ${romaji}` ||
        said === `${romaji} desu` ||
        said === `hiragana ${romaji}` // Autre variante possible
      ) {
        kanaDiv.textContent = char;
        found = true;
        break;
      }
    }

    if (!found) {
      kanaDiv.textContent = "â“ Pas reconnu";
    }
  };

  recognition.onerror = (event) => {
    let message = "";
    switch (event.error) {
      case "no-speech":
        message = "Aucun son dÃ©tectÃ©. Parlez plus fort ou vÃ©rifiez votre micro.";
        break;
      case "audio-capture":
        message = "ProblÃ¨me avec le micro. VÃ©rifiez qu'il est branchÃ© et autorisÃ©.";
        break;
      case "not-allowed":
        message = "AccÃ¨s au micro refusÃ©. Autorisez-le dans les paramÃ¨tres du navigateur.";
        break;
      case "service-not-allowed":
        message = "Le service de reconnaissance vocale n'est pas autorisÃ©.";
        break;
      case "network":
        message = "ProblÃ¨me de rÃ©seau. VÃ©rifiez votre connexion internet.";
        break;
      case "aborted":
        message = "Reconnaissance interrompue.";
        break;
      case "language-not-supported":
        message = "La langue japonaise n'est pas supportÃ©e.";
        break;
      default:
        message = `Erreur inconnue : ${event.error}`;
    }
    errorDiv.textContent = `âŒ ${message}`;
    kanaDiv.textContent = "â€”";
  };

  recognition.onend = () => {
    micBtn.disabled = false;
    micBtn.textContent = "Parler";
  };
</script>
</body>
</html>
