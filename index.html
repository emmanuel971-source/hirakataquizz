   <script>
//        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
//        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";
   </script>

<!DOCTYPE html>
<html>
<head>
    <title>Hiragana Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        #log-container { background: #000; padding: 10px; height: 400px; overflow-y: auto; font-family: monospace; border: 1px solid #444; }
        button { width: 100%; padding: 20px; background: #4CAF50; color: white; font-weight: bold; border: none; cursor: pointer; }
        .entry { border-bottom: 1px solid #222; padding: 5px; }
    </style>
</head>
<body>

    <button onclick="start()">LANCER LE TEST</button>
    <div id="status">Chargement...</div>
    <div id="log-container"></div>

    <script>
        // --- METS TES LIENS ICI ---
        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";

        let recognizer;
        let isRunning = false;

        async function init() {
            recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            await recognizer.ensureModelLoaded();
            document.getElementById('status').innerText = "Prêt.";
        }

        async function start() {
            if(isRunning) return;
            isRunning = true;
            run();
        }

        async function run() {
            if(!isRunning) return;
            try {
                // 1. Get
                const res = await fetch(`${SERVER_URL}/get_next`, { headers: {"ngrok-skip-browser-warning": "69"} });
                const data = await res.json();
                
                // 2. Play
                await fetch(`${SERVER_URL}/play`, { method: 'POST', headers: {"ngrok-skip-browser-warning": "69"} });

                // 3. Listen
                const result = await new Promise(resolve => {
                    recognizer.listen(res => {
                        recognizer.stopListening();
                        const scores = Array.from(res.scores);
                        const idx = scores.indexOf(Math.max(...scores));
                        resolve({ word: recognizer.wordLabels()[idx], score: Math.round(scores[idx]*100) });
                    }, { probabilityThreshold: 0.7, overlapFactor: 0 });
                });

                // 4. Log
                await fetch(`${SERVER_URL}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', "ngrok-skip-browser-warning": "69" },
                    body: JSON.stringify({
                        expected: data.expected,
                        filename: data.filename,
                        top1: result.word,
                        score1: result.score
                    })
                });

                const log = document.getElementById('log-container');
                log.innerHTML = `<div class="entry">${data.expected === result.word ? '✅' : '❌'} ${data.expected} -> ${result.word} (${result.score}%)</div>` + log.innerHTML;

                setTimeout(run, 1000);
            } catch (e) { isRunning = false; }
        }

        init();
    </script>
</body>
</html>



