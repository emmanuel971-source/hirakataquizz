   <script>
//        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
//        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";
   </script>

<!DOCTYPE html>
<html>
<head>
    <title>Marathon Hiragana Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 10px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; }
        button { width: 100%; padding: 15px; margin: 5px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .btn-start { background: #4CAF50; }
        .btn-calib { background: #2196F3; }
        .btn-stop { background: #f44336; }
        #log-container { height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; background: #000; padding: 10px; margin-top: 10px; border-radius: 5px; }
        .stat-badge { display: inline-block; padding: 4px; background: #333; margin: 2px; border-radius: 4px; font-size: 10px; border: 1px solid #444; }
        .progress-bar { width: 100%; background: #333; height: 8px; border-radius: 4px; margin-top: 10px; }
        #fill { height: 100%; background: #4CAF50; width: 0%; border-radius: 4px; transition: 0.3s; }
    </style>
</head>
<body>

    <div class="card">
        <h3>üìä Session : <span id="count">0</span> / <input type="number" id="limit" value="50" style="width:45px; background: #333; color: white; border: none;"></h3>
        <div id="class-stats"></div>
        <div class="progress-bar"><div id="fill"></div></div>
    </div>

    <div class="card">
        Gain: <input type="range" id="gain" min="1" max="50" value="10" style="width: 70%;"> <span id="gainVal">10</span><br>
        Seuil: <input type="range" id="threshold" min="0" max="100" value="80" style="width: 70%;"> <span id="threshVal">80</span>
    </div>

    <button class="btn-calib" onclick="startTest('calib')">üîß MODE CALIBRAGE (Loop 5)</button>
    <button class="btn-start" onclick="startTest('marathon')">üöÄ LANCER LE MARATHON</button>
    <button class="btn-stop" onclick="stop()">‚èπÔ∏è STOP</button>

    <div id="log-container"></div>

    <script>
        const SERVER_URL = "https://marlitic-demonstratively-euna.ngrok-free.dev"; 
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/";

        let recognizer;
        let isRunning = false;
        let currentMode = "";

        // Mise √† jour visuelle des sliders
        document.getElementById('gain').oninput = function() { document.getElementById('gainVal').innerText = this.value; }
        document.getElementById('threshold').oninput = function() { document.getElementById('threshVal').innerText = this.value; }

        async function init() {
            const checkpointURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";
            recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
            await recognizer.ensureModelLoaded();
            log("‚úÖ Mod√®le Teachable pr√™t.");
        }

        async function startTest(mode) {
            if(isRunning) return;
            isRunning = true;
            currentMode = mode;
            log(`‚ñ∂Ô∏è D√©marrage : ${mode}`);
            runCycle();
        }

        async function runCycle() {
            if(!isRunning) return;
            const headers = { "ngrok-skip-browser-warning": "true" };

            try {
                const res = await fetch(`${SERVER_URL}/get_next`, { headers });
                const test = await res.json();
                
                await fetch(`${SERVER_URL}/play`, { method: 'POST', headers });

                const result = await listenOnce();

                const logRes = await fetch(`${SERVER_URL}/log`, {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        expected: test.expected,
                        filename: test.filename,
                        top1: result.top1,
                        score1: result.score1,
                        rms: result.rms,
                        gain: document.getElementById('gain').value
                    })
                });

                const data = await logRes.json();
                updateUI(data);

                if(currentMode === "marathon" && data.total >= document.getElementById('limit').value) {
                    stop();
                    log("üèÅ Marathon termin√© !");
                } else {
                    setTimeout(runCycle, 1000);
                }

            } catch (err) {
                log("‚ùå Erreur : " + err.message);
                stop();
            }
        }

        async function listenOnce() {
            return new Promise(resolve => {
                const thresh = document.getElementById('threshold').value / 100;
                // CRUCIAL: includeSpectrogram: true pour √©viter l'erreur .data
                recognizer.listen(result => {
                    recognizer.stopListening();
                    const scores = Array.from(result.scores);
                    const sorted = scores.map((s, i) => ({name: recognizer.wordLabels()[i], score: s}))
                                         .sort((a,b) => b.score - a.score);
                    
                    let volume = 0;
                    if(result.spectrogram && result.spectrogram.data) {
                        volume = Math.max(...result.spectrogram.data).toFixed(2);
                    }

                    resolve({
                        top1: sorted[0].score > thresh ? sorted[0].name : "---",
                        score1: Math.round(sorted[0].score * 100),
                        rms: volume
                    });
                }, { probabilityThreshold: 0.1, overlapFactor: 0, includeSpectrogram: true });
            });
        }

        function updateUI(data) {
            document.getElementById('count').innerText = data.total;
            const limit = document.getElementById('limit').value;
            document.getElementById('fill').style.width = Math.min(100, (data.total/limit)*100) + "%";
            
            let html = "";
            for(let c in data.stats) {
                let s = data.stats[c];
                let pc = s.total > 0 ? Math.round((s.reussi/s.total)*100) : 0;
                html += `<span class="stat-badge">${c}: ${pc}% (${s.total})</span>`;
            }
            document.getElementById('class-stats').innerHTML = html;
        }

        function log(m) {
            const c = document.getElementById('log-container');
            c.innerHTML = `> ${m}<br>` + c.innerHTML;
        }

        function stop() { isRunning = false; log("‚èπÔ∏è Arr√™t√©."); }

        init();
    </script>
</body>
</html>
