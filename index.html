<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Vocal Hiragana - Protocole de Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #1c1e21; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Cartes */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; transition: 0.3s; }
        
        /* Zone Quiz */
        #quiz-card { display: none; border: 4px solid transparent; }
        .quiz-active { border-color: #2196f3 !important; }
        .quiz-success { border-color: #4caf50 !important; background-color: #e8f5e9 !important; }
        .quiz-fail { border-color: #f44336 !important; background-color: #ffebee !important; }

        .hiragana-big { font-size: 5rem; font-weight: bold; color: #333; margin: 10px 0; }
        .romaji-hint { font-size: 1.5rem; color: #888; text-transform: uppercase; font-weight: bold; }
        
        /* Timer */
        .timer-bar { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .timer-fill { height: 100%; width: 100%; background: #2196f3; transition: width linear; }

        /* Contr√¥les */
        input[type="text"] { padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; width: 70%; margin-bottom: 10px; }
        .btn { padding: 12px 25px; font-size: 16px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; margin: 5px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: #2196f3; }
        .btn-green { background: #4caf50; }
        .btn-red { background: #f44336; }
        .btn:disabled { background: #b0bec5; cursor: not-allowed; }

        /* Stats et Logs */
        .stats-mini { display: flex; justify-content: space-around; font-size: 0.9rem; color: #555; margin-top: 10px; }
        .hidden { display: none; }

        /* Page R√©sultats */
        #results-page { }
        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px; padding: 20px; margin-bottom: 15px;
            color: white; text-align: center;
        }
        .results-header h2 { font-size: 1.4rem; margin-bottom: 5px; }
        .results-header .subtitle { opacity: 0.9; font-size: 0.9rem; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-mini-card {
            background: #1a1a2e; border-radius: 12px; padding: 14px; text-align: center;
            border: 2px solid #0f3460; color: #eee;
        }
        .stat-mini-card .val { font-size: 1.8rem; font-weight: bold; }
        .stat-mini-card .lbl { font-size: 0.75rem; color: #aaa; margin-top: 4px; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: #667eea; margin: 15px 0 8px; text-transform: uppercase; letter-spacing: 1px; }
        .hiragana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px; }
        .mini-card {
            background: #1a1a2e; border-radius: 10px; padding: 8px 4px;
            text-align: center; border: 2px solid #0f3460;
        }
        .mini-char { font-size: 1.6rem; }
        .mini-romaji { font-size: 2rem; color: #888; }
        .mini-pct { font-size: 1rem; font-weight: bold; }
        .mini-detail { font-size: 0.6rem; color: #666; }
        .confusions-list { background: #1a1a2e; border-radius: 12px; padding: 12px; border: 2px solid #0f3460; margin-bottom: 20px; }
        .confusion-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #0f3460; }
        .confusion-row:last-child { border-bottom: none; }
        .conf-chars { font-size: 1.2rem; }
        .conf-label { font-size: 0.8rem; color: #aaa; flex: 1; margin: 0 10px; }
        .conf-count { font-weight: bold; color: #ff5252; }
        .results-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-restart { background: #2196f3; padding: 14px; border-radius: 10px; border: none; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-export { background: #4caf50; padding: 14px; border-radius: 10px; border: none; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <div class="card" id="setup-card">
            <h1>üéôÔ∏è Calibrage Hiragana</h1>
            <p>Protocole de test v1.0</p>
            
            <div style="margin: 20px 0;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Votre Nom / Appareil :</label>
                <input type="text" id="username" placeholder="ex: Pierre_Android" value="Testeur_01">
            </div>

            <div style="margin: 20px 0;">
                <label>Sensibilit√© Micro : <span id="gain-val">1.0</span>x</label>
                <input type="range" id="gain-slider" min="0.5" max="5" step="0.1" value="1" style="width:100%">
            </div>

            <button id="btn-start" class="btn btn-blue">üöÄ Initialiser & D√©marrer</button>
            <div id="loading" class="hidden">Chargement du mod√®le...</div>
        </div>

        <div class="card" id="quiz-card">
            <div style="display:flex; justify-content:space-between; color:#888;">
                <span>Question: <b id="q-count">0</b></span>
                <span>RMS: <b id="rms-disp">0.00</b></span>
            </div>

            <div class="hiragana-big" id="target-char">?</div>
            <div class="romaji-hint" id="target-romaji">PR√äT ?</div>

            <div class="timer-bar">
                <div class="timer-fill" id="timer-fill"></div>
            </div>

            <div class="stats-mini">
                <span id="feedback-top1">En attente...</span>
            </div>
        </div>

        <div class="card hidden" id="action-card">
            <button id="btn-next" class="btn btn-blue" onclick="nextQuestion()">Suivant (Auto)</button>
            <button id="btn-stop" class="btn btn-red" onclick="stopQuiz()">‚èπÔ∏è Finir & Voir R√©sultats</button>
            <div id="log-count" style="margin-top:10px; color:#666; font-size:0.8rem;">0 r√©sultats enregistr√©s</div>
        </div>

        <div id="results-page" class="hidden">
            <div class="results-header">
                <h2>üìä R√©sultats de la session</h2>
                <div class="subtitle" id="res-username-display"></div>
            </div>

            <div class="stats-row">
                <div class="stat-mini-card">
                    <div class="val" id="res-accuracy" style="color:#00e676">‚Äî</div>
                    <div class="lbl">Pr√©cision globale</div>
                </div>
                <div class="stat-mini-card">
                    <div class="val" style="color:#667eea" id="res-total">‚Äî</div>
                    <div class="lbl">Questions</div>
                </div>
                <div class="stat-mini-card">
                    <div class="val" style="color:#00e676" id="res-correct">‚Äî</div>
                    <div class="lbl">Correctes</div>
                </div>
                <div class="stat-mini-card">
                    <div class="val" style="color:#ffd700; font-size:1.2rem" id="res-rms">‚Äî</div>
                    <div class="lbl">RMS moyen</div>
                </div>
            </div>

            <div class="section-title">% de r√©ussite par hiragana</div>
            <div class="hiragana-grid" id="res-hiragana-grid"></div>

            <div class="section-title">Principales confusions</div>
            <div class="confusions-list" id="res-confusions"></div>

            <div class="results-btns">
                <button class="btn-restart" onclick="restartQuiz()">üîÑ Recommencer</button>
                <button class="btn-export" onclick="exportCSV()">üíæ Exporter CSV</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Remplace par ton URL Teachable Machine
        const URL_MODEL = "https://teachablemachine.withgoogle.com/models/SJdR1p2tx/"; 
        
        // Mapping Romaji -> Hiragana pour l'affichage
        // (Assure-toi que les cl√©s correspondent aux √©tiquettes de ton mod√®le Teachable Machine)
        const HIRAGANA_MAP = {
            'a': '„ÅÇ', 'i': '„ÅÑ', 'u': '„ÅÜ', 'e': '„Åà', 'o': '„Åä'
        };
        const VOWELS = ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä'];

        // --- VARIABLES GLOBALES ---
        let recognizer, audioContext, gainNode, analyser, dataArray;
        let isListening = false;
        let quizStopped = false;
        let currentTarget = "";
        let logs = [];
        let questionCount = 0;
        
        // Variables de capture pendant les 3 secondes
        let sessionBest = { label: "", score: 0, label2: "", score2: 0 };
        let sessionMaxRMS = 0;
        let sessionAvgRMS = 0;
        let rmsSum = 0;
        let rmsCount = 0;

        // --- INITIALISATION ---
        document.getElementById('btn-start').onclick = async () => {
            const btn = document.getElementById('btn-start');
            const name = document.getElementById('username').value.trim();
            if(!name) { alert("Merci d'entrer un nom !"); return; }

            btn.disabled = true;
            document.getElementById('loading').classList.remove('hidden');

            try {
                // 1. Audio Setup
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                
                gainNode = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Float32Array(analyser.fftSize);

                source.connect(gainNode);
                gainNode.connect(analyser); // Pour visualisation RMS
                // On ne connecte pas √† destination pour √©viter le feedback audio

                // 2. Load Model
                recognizer = speechCommands.create("BROWSER_FFT", undefined, URL_MODEL + "model.json", URL_MODEL + "metadata.json");
                await recognizer.ensureModelLoaded();

                // 3. UI Switch
                document.getElementById('setup-card').classList.add('hidden');
                document.getElementById('quiz-card').style.display = 'block';
                document.getElementById('action-card').classList.remove('hidden');

                // 4. Start Loop
                updateRMSLoop();
                startContinuousRecognition();
                
                // Lancer la premi√®re question apr√®s 1s
                setTimeout(nextQuestion, 1000);

            } catch (e) {
                alert("Erreur micro ou mod√®le : " + e);
                console.error(e);
                btn.disabled = false;
            }
        };

       // --- BOUCLE DE RECONNAISSANCE CONTINUE (CORRIG√âE) ---
        function startContinuousRecognition() {
            recognizer.listen(result => {
                if (!isListening) return;

                const labels = recognizer.wordLabels();
                const scores = Array.from(result.scores).map((s, i) => ({ label: labels[i], score: s }));
                
                // Trier par score d√©croissant
                scores.sort((a, b) => b.score - a.score);

                const top1 = scores[0];
                const top2 = scores[1] || {label: "none", score: 0};

                // --- CORRECTION MAGIQUE ICI ---
                
                // 1. D√©tecter si c'est du bruit de fond (adapte les mots-cl√©s si besoin)
                const isBackground = top1.label.toLowerCase().includes("background") || 
                                     top1.label.toLowerCase().includes("bruit");

                // 2. Si c'est du bruit de fond, on l'ignore (sauf si on n'a encore rien trouv√©)
                if (isBackground) {
                    // On ne fait rien, on attend que tu parles
                    // (Sauf si on veut afficher "Silence" √† l'√©cran)
                    return; 
                }

                // 3. LOGIQUE DE PRIORIT√â :
                // Si on entend la BONNE r√©ponse avec un score correct (> 70%), on la verrouille presque √† coup s√ªr
                // Sinon, on garde la meilleure r√©ponse entendue qui n'est pas du bruit.
                
                // Est-ce que ce qu'on entend correspond √† la cible ?
                const isTarget = top1.label === currentTarget;

                // Cas A : On entend la CIBLE avec un bon score
                if (isTarget && top1.score > 0.70) {
                    // On force la mise √† jour car c'est ce qu'on voulait entendre
                    // On privil√©gie la cible m√™me si un autre bruit bizarre avait eu un score un peu plus haut avant
                    if (top1.score > sessionBest.score || sessionBest.label !== currentTarget) {
                         updateSessionBest(top1, top2);
                    }
                } 
                // Cas B : On entend autre chose (une erreur), mais avec un score tr√®s fort
                else if (top1.score > sessionBest.score) {
                    // On met √† jour seulement si c'est mieux que ce qu'on avait avant
                    // Et on v√©rifie qu'on n'√©crase pas une bonne r√©ponse d√©j√† trouv√©e avec une confiance similaire
                    const alreadyFoundTarget = sessionBest.label === currentTarget;
                    
                    if (!alreadyFoundTarget) {
                        updateSessionBest(top1, top2);
                    }
                }

            }, { probabilityThreshold: 0.1, overlapFactor: 0.5 });
        }

        // Petite fonction utilitaire pour √©viter de r√©p√©ter le code
        function updateSessionBest(s1, s2) {
            sessionBest.label = s1.label;
            sessionBest.score = s1.score;
            sessionBest.label2 = s2.label;
            sessionBest.score2 = s2.score;
            
            // Feedback visuel imm√©diat (pour rassurer l'utilisateur)
            const isCorrect = sessionBest.label === currentTarget;
            const color = isCorrect ? "green" : "#d32f2f";
            const icon = isCorrect ? "‚úÖ" : "üëÇ";
            
            document.getElementById('feedback-top1').innerHTML = 
                `<span style="color:${color}; font-weight:bold;">${icon} Retenu: ${sessionBest.label} (${(sessionBest.score*100).toFixed(0)}%)</span>`;
        }
        // --- GESTION DU QUIZ ---
        function nextQuestion() {
            if (quizStopped) return; // Ne pas relancer si arr√™t√©
            // Reset de l'√©tat
            questionCount++;
            document.getElementById('q-count').innerText = questionCount;
            
            // Choisir une voyelle au hasard
            const randKey = VOWELS[Math.floor(Math.random() * VOWELS.length)];
            currentTarget = randKey;

            // UI Reset
            const card = document.getElementById('quiz-card');
            card.className = "card quiz-active";
            document.getElementById('target-char').innerText = HIRAGANA_MAP[randKey] || randKey;
            document.getElementById('target-romaji').innerText = randKey;
            document.getElementById('feedback-top1').innerText = "√âcoute en cours...";
            
            // Reset Stats Session
            sessionBest = { label: "Silence", score: 0, label2: "-", score2: 0 };
            sessionMaxRMS = 0;
            rmsSum = 0;
            rmsCount = 0;
            
            // Animation Timer (3 secondes)
            const timer = document.getElementById('timer-fill');
            timer.style.transition = 'none';
            timer.style.width = '100%';
            
            setTimeout(() => {
                timer.style.transition = 'width 3s linear';
                timer.style.width = '0%';
                isListening = true; // D√©but √©coute
            }, 50);

            // Fin de la question apr√®s 3s
            setTimeout(finishQuestion, 3050);
        }

        function finishQuestion() {
            isListening = false;
            
            // Calculer Moyenne RMS
            sessionAvgRMS = rmsCount > 0 ? (rmsSum / rmsCount) : 0;

            // Enregistrer le log
            const timestamp = new Date().toLocaleString('fr-FR');
            const username = document.getElementById('username').value.replace(/[^a-zA-Z0-9_-]/g, ""); // Clean name
            const filenameMock = `LiveTest_${username}`; // Pour matcher ton dashboard

            const logEntry = {
                timestamp: timestamp,
                filename: filenameMock,
                expected: currentTarget, // ex: 'a'
                top1: sessionBest.label,
                score1: sessionBest.score.toFixed(4),
                top2: sessionBest.label2,
                score2: sessionBest.score2.toFixed(4),
                rms: sessionAvgRMS.toFixed(6),
                gain: gainNode.gain.value.toFixed(2)
            };
            logs.push(logEntry);
            document.getElementById('log-count').innerText = `${logs.length} r√©sultats enregistr√©s`;

            // Feedback Visuel
            const card = document.getElementById('quiz-card');
            const isCorrect = sessionBest.label === currentTarget;
            
            if (isCorrect) {
                card.classList.remove('quiz-active');
                card.classList.add('quiz-success');
                document.getElementById('feedback-top1').innerHTML = `‚úÖ Bravo ! (${(sessionBest.score*100).toFixed(0)}%)`;
            } else {
                card.classList.remove('quiz-active');
                card.classList.add('quiz-fail');
                document.getElementById('feedback-top1').innerHTML = `‚ùå Entendu : ${sessionBest.label}`;
            }

            // Auto-next rapide (sauf si le quiz a √©t√© arr√™t√©)
            if (!quizStopped) {
                setTimeout(nextQuestion, 1500);
            }
        }

        // --- STOP & PAGE R√âSULTATS ---
        function stopQuiz() {
            if (logs.length === 0) { alert("Aucune donn√©e √† exporter."); return; }
            
            // Stopper proprement
            isListening = false;
            quizStopped = true;

            // Cacher le quiz, montrer la page r√©sultats
            document.getElementById('quiz-card').style.display = 'none';
            document.getElementById('action-card').classList.add('hidden');
            document.getElementById('results-page').classList.remove('hidden');

            buildResultsPage();
        }

        function buildResultsPage() {
            const total = logs.length;
            const correct = logs.filter(l => l.top1 === l.expected).length;
            const accuracy = total > 0 ? (correct / total * 100) : 0;
            const avgRms = logs.reduce((s, l) => s + parseFloat(l.rms), 0) / total;
            const user = document.getElementById('username').value;
            document.getElementById('res-username-display').innerText = user;

            // Stats globales
            document.getElementById('res-total').innerText = total;
            document.getElementById('res-correct').innerText = correct;
            document.getElementById('res-accuracy').innerText = accuracy.toFixed(1) + '%';
            document.getElementById('res-rms').innerText = avgRms.toFixed(4);

            // Couleur accuracy
            const accEl = document.getElementById('res-accuracy');
            accEl.style.color = accuracy >= 80 ? '#00e676' : accuracy >= 60 ? '#ffd700' : '#ff5252';

            // Stats par hiragana
            const hiraganaStats = {};
            logs.forEach(l => {
                if (!hiraganaStats[l.expected]) hiraganaStats[l.expected] = { total: 0, correct: 0 };
                hiraganaStats[l.expected].total++;
                if (l.top1 === l.expected) hiraganaStats[l.expected].correct++;
            });

            const hiraganaGrid = document.getElementById('res-hiragana-grid');
            hiraganaGrid.innerHTML = '';
            const romajiToHiragana = { 'a':'„ÅÇ','i':'„ÅÑ','u':'„ÅÜ','e':'„Åà','o':'„Åä' };
            Object.entries(hiraganaStats).sort().forEach(([key, val]) => {
                const pct = (val.correct / val.total * 100);
                const color = pct >= 80 ? '#00e676' : pct >= 60 ? '#ffd700' : '#ff5252';
                const char = romajiToHiragana[key] || key;
                hiraganaGrid.innerHTML += `
                    <div class="mini-card">
                        <div class="mini-char">${char}</div>
                        <div class="mini-romaji">${key}</div>
                        <div class="mini-pct" style="color:${color}">${pct.toFixed(0)}%</div>
                        <div class="mini-detail">${val.correct}/${val.total}</div>
                    </div>`;
            });

            // Confusions principales
            const confusions = {};
            logs.filter(l => l.top1 !== l.expected).forEach(l => {
                const key = `${l.expected}‚Üí${l.top1}`;
                confusions[key] = (confusions[key] || 0) + 1;
            });
            const sortedConf = Object.entries(confusions).sort((a,b) => b[1]-a[1]).slice(0, 4);
            const confEl = document.getElementById('res-confusions');
            confEl.innerHTML = '';
            if (sortedConf.length === 0) {
                confEl.innerHTML = '<p style="color:#00e676; text-align:center">üéâ Aucune confusion !</p>';
            } else {
                sortedConf.forEach(([pair, count]) => {
                    const [exp, got] = pair.split('‚Üí');
                    const expH = romajiToHiragana[exp] || exp;
                    const gotH = romajiToHiragana[got] || got;
                    confEl.innerHTML += `
                        <div class="confusion-row">
                            <span class="conf-chars">${expH}‚Üí${gotH}</span>
                            <span class="conf-label">${exp}‚Üí${got}</span>
                            <span class="conf-count">${count}√ó</span>
                        </div>`;
                });
            }
        }

        // --- EXPORT CSV ---
        function exportCSV() {
            let csvContent = "Horodatage,NomFichier,Attendu,Top1,Score1,Top2,Score2,RMS,Gain\n";

            logs.forEach(row => {
                csvContent += `${row.timestamp},${row.filename},${row.expected},${row.top1},${row.score1},${row.top2},${row.score2},${row.rms},${row.gain}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            // Nom fichier avec date et utilisateur
            const dateStr = new Date().toISOString().slice(0,10);
            const user = document.getElementById('username').value;
            link.setAttribute("href", url);
            link.setAttribute("download", `resultats_marathon_${user}_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function restartQuiz() {
            logs = [];
            questionCount = 0;
            quizStopped = false;
            isListening = false;
            sessionBest = { label: "", score: 0, label2: "", score2: 0 };

            document.getElementById('results-page').classList.add('hidden');
            document.getElementById('quiz-card').style.display = 'block';
            document.getElementById('action-card').classList.remove('hidden');
            document.getElementById('log-count').innerText = '0 r√©sultats enregistr√©s';

            setTimeout(nextQuestion, 500);
        }

        // --- UTILITAIRES ---
        function updateRMSLoop() {
            if (analyser) {
                analyser.getFloatTimeDomainData(dataArray);
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) { sum += dataArray[i] * dataArray[i]; }
                let rms = Math.sqrt(sum / dataArray.length);
                
                document.getElementById('rms-disp').innerText = rms.toFixed(4);
                
                if (isListening) {
                    rmsSum += rms;
                    rmsCount++;
                    if (rms > sessionMaxRMS) sessionMaxRMS = rms;
                }
            }
            requestAnimationFrame(updateRMSLoop);
        }

        document.getElementById('gain-slider').oninput = (e) => {
            const val = e.target.value;
            document.getElementById('gain-val').innerText = val;
            if (gainNode) gainNode.gain.value = parseFloat(val);
        };
    </script>
</body>
</html>
